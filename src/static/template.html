<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Ê≠•Â±•‰∏çÂÅú - ÊàëÁöÑÂõõ‰∏áÂÖ¨ÈáåË∑ëÈáèÊåëÊàò</title>
  <link rel="icon" type="image/png" href="https://run.linwn.net/images/favicon.png">
  <meta property="og:title" content="Ê≠•Â±•‰∏çÂÅú - ÊàëÁöÑÂõõ‰∏áÂÖ¨ÈáåË∑ëÈáèÊåëÊàò" />
  <meta property="og:description" content="ÁõÆÂâçÁ¥ØËÆ°{{ "%.2f"|format(overall_stats.dist_km) }}ÂÖ¨Èáå | {% if recent_runs %}ÊúÄËøëË∑ëÊ≠•Ôºö{{ recent_runs[0].date.strftime('%m-%d') }}, {{ "%.2f"|format(recent_runs[0].distance / 1000) }}ÂÖ¨Èáå, Áî®Êó∂{{ format_duration(recent_runs[0].duration) }}, ÈÖçÈÄü{{ recent_runs[0].pace }}
{% endif %}" />
  <meta property="og:image" content="https://run.linwn.net/images/card.png" />
  <meta property="og:url" content="https://run.linwn.net/fun" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="https://run.linwn.net/images/card.png" />
  <meta name="twitter:title" content="Ê≠•Â±•‰∏çÂÅú - ÊàëÁöÑÂõõ‰∏áÂÖ¨ÈáåË∑ëÈáèÊåëÊàò" />
  <meta name="twitter:description" content="ÂΩìÂâçÁ¥ØËÆ°Ë∑ëÈáè {{ "%.2f"|format(overall_stats.dist_km) }} ÂÖ¨Èáå„ÄÇ{% if recent_runs %}ÊúÄËøë‰∏ÄÊ¨°Ë∑ëÊ≠•Ôºöüïê{{ recent_runs[0].date.strftime('%Y-%m-%d %H:%M') }}Ôºåüö©{{ recent_runs[0].city[:-1] if recent_runs[0].city and recent_runs[0].city.endswith("Â∏Ç") else recent_runs[0].city }}Ôºå{{ "%.2f"|format(recent_runs[0].distance / 1000) }}ÂÖ¨ÈáåÔºåÁî®Êó∂ {{ format_duration(recent_runs[0].duration) }}ÔºåÈÖçÈÄü {{ recent_runs[0].pace }}„ÄÇ
{% endif %}" />
  <meta name="twitter:image" content="https://run.linwn.net/images/card.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css" rel="stylesheet" media="print" onload="this.media='all'">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" rel="stylesheet" media="print" onload="this.media='all'">
  <noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" rel="stylesheet">
  </noscript>
  <script>
    // È°µÈù¢ÊúÄÊó©Èò∂ÊÆµËÆæÁΩÆ‰∏ªÈ¢ò
    (function() {
      const storedTheme = localStorage.getItem('theme');
      const preferredTheme = storedTheme 
          ? storedTheme 
          : (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
      document.documentElement.setAttribute('data-bs-theme', preferredTheme);
    })();
  </script>
  <style>
    /* Light Theme Variables */
    [data-bs-theme="light"] {
      --bg-color: #f0f2f5;
      --card-bg: #ffffff;
      --text-primary: #1c1e21;
      --text-secondary: #65676b;
      --border-color: #ced4da;
      --accent-color: #0d6efd;
      --success-color: #198754;
      --trophy-color: #ffc107;
      --hover-bg: #e9ecef;
      --marathon-color: #fd7e14;
      --danger-color: #dc3545;
    }
    /* Dark Theme Variables */
    [data-bs-theme="dark"] {
      --bg-color: #1c1e21;
      --card-bg: #282a2d;
      --text-primary: #e4e6eb;
      --text-secondary: #a8b3cf;
      --border-color: #495057;
      --accent-color: #4dabf7;
      --success-color: #20c997;
      --trophy-color: #fcc419;
      --hover-bg: #3a3b3c;
      --marathon-color: #ff8700;
      --danger-color: #ff6b6b;
    }
    /* ÊåâÈíÆÂõæÊ†áÁî® Bootstrap Icons ÁöÑ content */
    #theme-toggle::before {
      font-family: "bootstrap-icons";
      font-size: 1.2rem;
      display: inline-block;
      vertical-align: middle;
    }
    /* Dark Ê®°Âºè ‚Üí ‰∫ÆÂ§™Èò≥ÂõæÊ†á */
    [data-bs-theme="dark"] #theme-toggle::before {
      content: "\f1d1"; /* bi-brightness-high-fill */
    }
    /* Light Ê®°Âºè ‚Üí Êúà‰∫ÆÊòüÊòüÂõæÊ†á */
    [data-bs-theme="light"] #theme-toggle::before {
      content: "\f495"; /* bi-moon-stars-fill */
    }
    html {
      scroll-behavior: smooth;
      scrollbar-gutter: stable;
    }
    body {
      background-color: var(--bg-color);
      color: var(--text-primary);
      font-family: 'Noto Sans SC', -apple-system, sans-serif;
      line-height: 1.6;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .main-title-container {
      padding: 1.5rem 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .main-title {
      font-weight: 700;
      font-size: 2rem;
    }
    .main-subtitle {
      font-weight: 400;
      font-size: 1.1rem;
    }
    .theme-toggle-btn {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .theme-toggle-btn:hover {
        border-color: var(--accent-color);
        color: var(--accent-color);
    }
    .stat-card-base {
        background-color: var(--card-bg);
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        transition: all 0.2s ease;
        overflow: hidden;
    }
    .stat-card-content {
      display: flex;
      flex-direction: column;
      justify-content: center;
      height: 100%;
      width: 100%;
    }
    .stat-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 0.5rem;
	  min-height: 1.0rem;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.2;
	  min-height: 2.4rem;
    }
    .stat-value-small {
        font-size: 1.5rem;
    }
    .stat-details {
	  margin-top: auto;
	  width: 100%;
	}
    .stat-card-flip-container {
        perspective: 1000px;
        min-height: 140px;
        cursor: pointer;
    }
    .stat-card-flipper {
		text-align: center;
        position: relative;
        width: 100%;
        height: 100%;
        transition: transform 0.6s;
        transform-style: preserve-3d;
    }
    .stat-card-flipper.flipped {
        transform: rotateY(180deg);
    }
    .stat-card-front, .stat-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--card-bg);
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 1.5rem;
    }
    .stat-card-back {
        transform: rotateY(180deg);
    }
    .small-muted {
        color: var(--text-secondary);
    }
    .progress {
        --bs-progress-bg: var(--hover-bg);
    }
    .progress-bar {
        --bs-progress-bar-bg: var(--success-color);
    }
    .card-title-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .btn-group .btn, .btn-secondary, .btn-sm, #saveProfileButton, .btn-outline-secondary {
        --bs-btn-bg: var(--hover-bg);
        --bs-btn-border-color: var(--border-color);
        --bs-btn-hover-bg: var(--accent-color);
        --bs-btn-hover-border-color: var(--accent-color);
        --bs-btn-active-bg: var(--accent-color);
        --bs-btn-active-border-color: var(--accent-color);
		--bs-btn-active-color: var(--text-primary);
        font-size: 0.8rem;
		color: var(--text-secondary);
    }
    #saveProfileButton {
        --bs-btn-bg: var(--accent-color);
        --bs-btn-border-color: var(--accent-color);
        --bs-btn-hover-bg: #63baff;
        --bs-btn-hover-border-color: #63baff;
        color: var(--text-primary);
    }
    .btn-group .btn.active {
		color: var(--text-primary);
		font-weight: 500;
	}
    @media (max-width: 767.98px) {
      .stat-value { font-size: 1.8rem; }
    }
    @media (max-width: 576px) {
      .stat-value { font-size: 1.5rem; }
      .main-title { font-size: 1.5rem; }
      .main-subtitle { font-size: 0.9rem; }
    }
    .card-title {
        color: var(--text-primary);
        margin-bottom: 0;
    }
    .collapsing {
      transition: height 0.2s ease !important;
    }
    .accordion-button {
      background-color: var(--card-bg);
      color: var(--text-primary);
      padding-left: 0.75rem;
      padding-right: 0.75rem;
    }
    .accordion-button:not(.collapsed) {
      background-color: var(--hover-bg);
      color: var(--text-primary);
    }
    .accordion-button:focus {
      box-shadow: none;
    }
    .accordion-item {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
    }
    .table-light {
        --bs-table-color: var(--text-primary);
        --bs-table-bg: var(--hover-bg);
    }
    .table {
      --bs-table-bg: var(--card-bg);
      --bs-table-striped-bg: var(--hover-bg);
      --bs-table-color: var(--text-primary);
      --bs-table-border-color: var(--border-color);
    }
    .run-detail-row, .recent-run-card {
        cursor: pointer;
    }
    .modal-content, .card {
      background-color: var(--card-bg);
      color: var(--text-primary);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .modal-header {
      border-bottom-color: var(--border-color);
    }
    .pb-entry {
      border-bottom: 1px solid var(--border-color) !important;
    }
    .details-row > td {
      padding: 0 !important;
      border-top: none;
    }
    .details-row .card-body {
      background-color: var(--hover-bg);
      color: var(--text-secondary);
      padding-left: 1rem;
    }
    .badge.bg-success {
      font-size: 0.75em;
      padding: 0.25em 0.5em;
      font-weight: 500;
    }
    .clickable-certificate {
        color: var(--accent-color);
        cursor: pointer;
        text-decoration: none;
        border-bottom: 1px dashed var(--accent-color);
        transition: all 0.2s;
    }
    .clickable-certificate:hover {
        color: var(--accent-color);
        border-bottom-style: solid;
    }
    .modal-header .btn-close {
        filter: invert(0.8);
    }
    [data-bs-theme="light"] .modal-header .btn-close {
        filter: none;
    }
    .text-primary-emphasis {
      color: var(--text-primary) !important;
    }
    .text-body-secondary {
      color: var(--text-secondary) !important;
    }
    .classification-text {
      color: var(--success-color);
      font-weight: 500;
      font-size: 0.9em;
    }
    .certificate-link {
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
    }
    .certificate-link:hover {
      text-decoration: none;
      transform: scale(1.05);
    }
    .comment-link {
      font-size: 0.85rem;
      color: var(--text-secondary);
      text-decoration: none;
      border-bottom: 1px dotted var(--text-secondary);
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .comment-link:hover {
      color: var(--accent-color);
      border-bottom: 1px solid var(--accent-color);
    }
    .leaflet-popup-content-wrapper {
        background: var(--card-bg);
        color: var(--text-primary);
        border-radius: 8px;
    }
    .leaflet-popup-content {
        margin: 12px;
    }
    .leaflet-popup-tip {
        background: var(--card-bg);
    }
    .leaflet-popup-close-button {
        color: var(--text-primary) !important;
        padding: 4px 4px 0 0 !important;
    }
    /* Responsive Nav Tabs */
    .nav-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none; /* Firefox */
    }
    .nav-wrapper::-webkit-scrollbar {
        display: none; /* Safari and Chrome */
    }
    .nav-tabs {
        --bs-nav-tabs-border-color: var(--border-color);
        --bs-nav-tabs-link-hover-border-color: var(--border-color);
        flex-wrap: nowrap;
        white-space: nowrap;
        border-bottom: none; /* The wrapper will have the border */
    }
    .nav-wrapper .nav-item {
        flex-shrink: 0;
    }
    .nav-tabs .nav-link {
        color: var(--text-secondary);
        background: none;
    }
    .nav-tabs .nav-link.active {
        color: var(--text-primary);
        background-color: var(--hover-bg);
        border-color: var(--border-color) var(--border-color) var(--hover-bg);
    }
    #cityMap {
      width: 100%;
      height: 400px;
      background-color: var(--card-bg);
      border-radius: .75rem;
    }
    .content-card {
        background-color: var(--card-bg);
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 1.5rem;
        border: 1px solid var(--border-color);
    }
    .streak-badge {
      font-size: 0.7em;
      font-weight: bold;
      padding: 0.2em 0.5em;
      border-radius: 0.35rem;
      background-color: #fd7e14;
      color: #fff;
      margin-left: 8px;
      vertical-align: middle;
      display: inline-block;
      line-height: 1;
    }
    .form-select, .form-control {
        background-color: var(--hover-bg);
        border-color: var(--border-color);
        color: var(--text-secondary);
    }
    .form-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23a8b3cf' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
    }
    [data-bs-theme="light"] .form-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%2365676b' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
    }
    .form-select:focus, .form-control:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.25rem rgba(var(--accent-color-rgb), .25);
        background-color: var(--hover-bg);
        color: var(--text-primary);
    }
    .form-control::placeholder {
        color: var(--text-secondary);
        opacity: 0.7;
    }
    label.form-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
    }
    .sortable-header {
      cursor: pointer;
      user-select: none;
    }
    .sortable-header .sort-icon {
      opacity: 0.5;
      transition: opacity 0.2s;
      vertical-align: middle;
    }
    .sortable-header:hover .sort-icon {
      opacity: 1;
    }
    .sortable-header[aria-sort] .sort-icon {
        opacity: 1;
    }
    .sortable-header .bi-arrow-down-up { display: inline-block; }
    .sortable-header .bi-arrow-down, .sortable-header .bi-arrow-up { display: none; }
    .sortable-header[aria-sort="ascending"] .bi-arrow-up { display: inline-block; }
    .sortable-header[aria-sort="descending"] .bi-arrow-down { display: inline-block; }
    .sortable-header[aria-sort] .bi-arrow-down-up { display: none; }
    .timeline {
        position: relative;
        padding-left: 2rem;
        margin-left: 1rem;
        border-left: 2px solid var(--border-color);
    }
    .timeline-item {
        position: relative;
        padding-bottom: 1.5rem;
    }
    .timeline-item:last-child {
        padding-bottom: 0;
    }
    .timeline-marker {
        position: absolute;
        top: 5px;
        left: calc(-2rem - 1px - 0.6rem);
        width: 1.2rem;
        height: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        background-color: var(--bg-color);
    }
    .trophy-color-text { color: var(--trophy-color); }
    .accent-color-text { color: var(--accent-color); }
    .marathon-calendar-container .month-grid {
        background-color: var(--card-bg);
        padding: 1.5rem;
        border-radius: 0.75rem;
        margin-bottom: 2rem;
    }
    .calendar-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }
    .calendar-table th {
        text-align: center;
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 0.8rem;
        padding-bottom: 0.5rem;
    }
    .calendar-table td {
        border: 1px solid var(--border-color);
        height: 50px;
        vertical-align: top;
        padding: 5px;
        transition: background-color: 0.2s;
        position: relative;
    }
    .calendar-table td.empty {
       background-color: transparent;
       border-color: var(--card-bg);
    }
    .calendar-table td:not(.empty) {
        background-color: var(--hover-bg);
    }
    .day-number {
        font-weight: 700;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }
    .day-markers {
        padding-top: 4px;
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
    }
    .day-marker {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }
    .day-marker.race { background-color: var(--marathon-color); }
    .day-marker.registration { background-color: var(--accent-color); }
    .day-marker.registration-start { background-color: var(--accent-color); }
    .day-marker.registration-end { background-color: var(--danger-color); }
    .day-marker.lottery { background-color: var(--success-color); }
    .day-popup-details {
      position: absolute;
      z-index: 10;
      bottom: calc(100% + 5px);
      left: 50%;
      transform: translateX(-50%);
      width: auto;
      min-width: 150%;
      padding: 0.5rem;
      background-color: var(--card-bg);
      border: 1px solid var(--accent-color);
      border-radius: 6px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
      pointer-events: none;
    }
    .calendar-table td:hover .day-popup-details {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
    }
    .popup-event-item {
        font-size: 0.8rem;
        margin-bottom: 0.5rem;
    }
    .popup-event-item:last-child {
        margin-bottom: 0;
    }
    .popup-event-title {
        font-weight: bold;
        display: block;
    }
    .popup-event-type {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }
    /* Countdown Timer Styles */
    #countdown-timer .time-block {
        text-align: center;
        padding: 0 1rem;
    }
    #countdown-timer .time-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        color: var(--accent-color);
    }
    #countdown-timer .time-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        color: var(--text-secondary);
    }
     .stat-filter-button {
        padding: 0.25rem 0.75rem;
        font-size: 0.8rem;
        cursor: pointer;
        border-radius: 0.5rem;
        background-color: var(--hover-bg);
        border: 1px solid var(--border-color);
        transition: all 0.2s ease;
        color: var(--text-secondary);
        user-select: none;
    }
    .stat-filter-button:hover {
        border-color: var(--accent-color);
    }
    .stat-filter-button.active {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
        color: var(--card-bg);
        font-weight: 500;
    }
    .stat-filter-button .stat-filter-badge {
        font-size: 0.8em;
        padding: .1em .4em;
        border-radius: .25rem;
        background-color: rgba(0,0,0,0.1);
    }
    .stat-filter-button.active .stat-filter-badge {
        background-color: rgba(255,255,255,0.2);
    }
    @media (max-width: 767.98px) {
        .marathon-calendar-container .month-grid { padding: 1rem; }
        #countdown-timer .time-value { font-size: 2rem; }
        #countdown-timer .time-block { padding: 0 0.5rem; }
    }
    .comment-media-thumb {
        max-width: 80px;
        max-height: 80px;
        border-radius: 4px;
        margin: 4px;
        cursor: pointer;
        object-fit: cover;
        transition: transform 0.2s;
        display: inline-block;
        vertical-align: middle;
    }
    .comment-media-thumb:hover {
        transform: scale(1.05);
        box-shadow: 0 0 5px var(--accent-color);
    }
    #mediaGalleryModal .modal-content {
      background-color: rgba(0,0,0,0.85);
      backdrop-filter: blur(5px);
    }
    #mediaGalleryModal .btn-close {
      filter: invert(1) grayscale(100%) brightness(200%);
      position: absolute;
      top: 1rem;
      right: 1rem;
      z-index: 20;
    }
    #galleryCarouselInner .carousel-item {
        text-align: center;
    }
    #galleryCarouselInner .carousel-item img,
    #galleryCarouselInner .carousel-item video {
        max-height: 85vh;
        width: auto;
        max-width: 100%;
    }
    #runDetailModal .modal-content {
        background-color: var(--bg-color);
        color: var(--text-primary);
    }
    #runDetailModal .modal-body {
        padding: 0;
        overflow-y: auto;
    }
    #runDetailModal .modal-header {
      background: rgba(var(--bg-color-rgb), 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 10;
      border-bottom: 1px solid var(--border-color);
    }
    #runDetailModal .modal-title {
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--text-primary);
    }
    #detail-map-item {
        height: 250px;
        border-radius: 12px;
        background-color: var(--hover-bg);
    }
    #runDetailModal h4.data-section-title {
        font-weight: 600;
        font-size: 1.2rem;
        margin-bottom: 1.25rem;
        color: var(--text-primary);
    }
    #runDetailModal .data-point-value {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: var(--text-primary);
    }
     #runDetailModal .data-point-unit {
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-secondary);
        margin-left: 4px;
    }
    #runDetailModal .data-point-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    #runDetailModal .analysis-summary, .analysis-summary {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }
    #runDetailModal .analysis-summary strong, .analysis-summary strong {
        color: var(--text-primary);
        font-weight: 600;
    }
    #runDetailModal #runDetailComments hr {
        border-top: 1px solid var(--border-color);
    }
    #runDetailModal #runDetailCommentForm {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: .75rem;
    }
     #runDetailModal #runDetailCommentForm textarea {
        background-color: var(--hover-bg);
        color: var(--text-primary);
        border-color: var(--border-color);
     }
     #runDetailModal #runDetailCommentForm textarea:focus {
        background-color: var(--bg-color);
     }
     #runDetailModal #runDetailCommentForm .btn-primary {
         background-color: var(--accent-color);
         border-color: var(--accent-color);
     }
     #runDetailModal #runDetailCommentForm .text-secondary {
        color: var(--text-secondary) !important;
     }
     #routeMap {
        height: 75vh;
        border-radius: .75rem;
     }
     #calendarEditorModal .list-group-item {
        background-color: var(--hover-bg);
        border-color: var(--border-color);
     }
    .calendar-table td.lottery-win {
        border: 1px solid var(--success-color);
        box-shadow: 0 0 8px 1px rgba(var(--success-color-rgb), 0.5);
    }
    .calendar-table td.today {
      background-color: var(--bs-danger-bg-subtle);
    }
    #profileModal {
        z-index: 1060;
    }
    /* Styles for Photo Management Modal */
    #photo-manager-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 1rem;
    }
    .photo-manager-item {
      position: relative;
    }
    .photo-manager-item img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 0.5rem;
    }
    .photo-manager-item .delete-photo-btn {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: var(--danger-color);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      cursor: pointer;
    }
    @media (min-width: 992px) {
      .border-start-lg {
        border-left: 1px solid;
      }
    }
  </style>
</head>
<body>
<div class="container position-relative">
  <div class="main-title-container">
    <h1 class="main-title">Ê≠•Â±•‰∏çÂÅú <small class="main-subtitle text-body-secondary"> ‚Äî ÊàëÁöÑÂõõ‰∏áÂÖ¨ÈáåË∑ëÈáèÊåëÊàò</small></h1>
    <button id="theme-toggle" class="theme-toggle-btn" title="ÂàáÊç¢‰∏ªÈ¢ò"></button>
  </div>
  <div class="nav-wrapper border-bottom border-secondary-subtle mb-4">
    <ul class="nav nav-tabs" id="main-nav-tabs" role="tablist">
        <li class="nav-item" role="presentation">
        <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary-pane" type="button" role="tab" aria-controls="summary-pane" aria-selected="false" data-hash="summary">Ê¶ÇËßà</button>
        </li>
        <li class="nav-item" role="presentation">
        <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-pane" type="button" role="tab" aria-controls="data-pane" aria-selected="false" data-hash="data">ËÆ∞ÂΩï</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="marathon-tab" data-bs-toggle="tab" data-bs-target="#marathon-pane" type="button" role="tab" aria-controls="marathon-pane" aria-selected="false" data-hash="marathon">ËµõÂéÜ</button>
        </li>
        <li class="nav-item" role="presentation">
        <button class="nav-link" id="events-tab" data-bs-toggle="tab" data-bs-target="#events-pane" type="button" role="tab" aria-controls="events-pane" aria-selected="false" data-hash="events">ÊàêÂ∞±</button>
        </li>
        <li class="nav-item" role="presentation">
        <button class="nav-link" id="about-tab" data-bs-toggle="tab" data-bs-target="#about-pane" type="button" role="tab" aria-controls="about-pane" aria-selected="false" data-hash="about">ÂÖ≥‰∫é</button>
        </li>
    </ul>
  </div>
  <div class="tab-content" id="mainTabContent">
    <div class="tab-pane fade" id="summary-pane" role="tabpanel" aria-labelledby="summary-tab" tabindex="0">
        <div class="row g-3 mb-4">
            <div class="col-12 col-md-6 col-lg-5">
                <div class="stat-card-flip-container h-100" id="dist-card-container">
                    <div class="stat-card-flipper h-100">
                      <div class="stat-card-front">
                        <div class="stat-card-content">
                          <div>
                            <div class="stat-label">Á¥ØËÆ°Ë∑ëÈáè</div>
                            <div class="stat-value">{{ "%.2f"|format(overall_stats.dist_km) }} <small class="small-muted">km</small></div>
                          </div>
                          <div class="stat-details">
                            <div class="stat-label" id="running-quote"></div>
                            <div class="progress mt-1" style="height: 4px;">
                              <div class="progress-bar" role="progressbar" style="width: {{ '%.4f'|format(progress_around_earth) }}%;"></div>
                            </div>
                            <small class="small-muted">ËøõÂ∫¶ {{ '%.4f'|format(progress_around_earth) }}%</small>
                          </div>
                        </div>
                      </div>
                      <div class="stat-card-back">
                        <div class="stat-card-content">
                          <div>
                            <div class="stat-label">ÁªßÁª≠ÂùöÊåÅ</div>
                            <div class="stat-value">{{ estimated_info.days_left }}</div>
                          </div>
                          <div class="stat-details">
                            <div class="stat-label"><small class="small-muted">È¢ÑËÆ°</small>{{ estimated_info.date_str }}<small>ÁªïÂú∞ÁêÉ‰∏ÄÂúà</small></div>
                          </div>
                        </div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 d-none d-lg-block">
                <div class="stat-card-flip-container h-100" id="count-card-container">
                    <div class="stat-card-flipper h-100">
                      <div class="stat-card-front">
                        <div class="stat-card-content">
                          <div class="stat-label">Ë∑ëÊ≠•Ê¨°Êï∞</div>
                          <div class="stat-value">{{ overall_stats.count }}</div>
                        </div>
                      </div>
                      <div class="stat-card-back">
                        <div class="stat-card-content">
                          <div class="stat-label">ÊÄªËÄóÊó∂</div>
                          <div class="stat-value stat-value-small">{{ overall_stats.duration_str }}</div>
                        </div>
                      </div>
                    </div>
                  </div>
            </div>
            <div class="col-6 col-md-6 col-lg-2">
                <div class="stat-card-flip-container h-100" id="pace-card-container">
                    <div class="stat-card-flipper h-100">
                      <div class="stat-card-front">
                        <div class="stat-card-content">
                          <div class="stat-label">Âπ≥ÂùáÈÖçÈÄü</div>
                          <div class="stat-value">{{ overall_stats.pace }}</div>
                        </div>
                      </div>
                      <div class="stat-card-back">
                        <div class="stat-card-content">
						  <div>
							  <div class="stat-label">ÊúÄÂø´ÈÖçÈÄü</div>
							  <div class="stat-value">{{ fastest_pace_info.pace }}</div>
						  </div>
                          <div class="stat-details">
                            <small class="small-muted">{{ fastest_pace_info.date }}</small>
                          </div>						  
                        </div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-6 col-lg-3">
              <div class="stat-card-flip-container h-100" id="month-card-container">
                <div class="stat-card-flipper h-100">
                  <div class="stat-card-front">
                    <div class="stat-card-content">
                      <div class="stat-label">Êú¨ÊúàË∑ëÈáè</div>
                      <div class="stat-value">{{ "%.2f"|format(monthly_comparison.current_month_dist) }} <small class="small-muted">km</small></div>
                    </div>
                  </div>
                  <div class="stat-card-back">
                    <div class="stat-card-content">
                        <div>
                            <div class="stat-label">ËæÉ‰∏äÊúàÂêåÊúü</div>
                            <div class="stat-value stat-value-small {% if monthly_comparison.diff_km > 0 %}text-success{% elif monthly_comparison.diff_km < 0 %}text-danger{% endif %}">
                                {% if monthly_comparison.diff_km > 0 %}+{% endif %}{{ "%.2f"|format(monthly_comparison.diff_km) }}
                                <small class="small-muted">km</small>
                            </div>
                        </div>
                        <div class="stat-details">
                            <a href="#run-analysis-section" class="comment-link" id="view-analysis-link">Êü•ÁúãÂõæË°® &rarr;</a>
                        </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
        </div>
        {% if recent_runs %}
        <div class="card mb-4" style="border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div class="card-header bg-transparent border-0 pt-3 ps-4">
                <h5 class="card-title mb-0"><i class="bi bi-stopwatch-fill me-2"></i>ÊúÄËøë‰∏âÊ¨°Ë∑ëÊ≠•</h5>
            </div>
            <div class="card-body pt-2">
                <div class="row g-3">
                {% for run in recent_runs %}
                <div class="col-lg-4">
                    <div class="p-3 rounded h-100 d-flex flex-column recent-run-card" 
                      data-run-id="{{ run.id }}" 
                      data-distance="{{ run.distance }}"
                      data-distance-formatted="{{ "%.2f"|format(run.distance / 1000) }}"
                      data-pace-str="{{ run.pace }}"
                      data-date="{{ run.date.strftime('%Y-%m-%d %H:%M') }}"
                      data-city="{{ run.city[:-1] if run.city and run.city.endswith("Â∏Ç") else run.city }}"
                      data-duration="{{ format_duration(run.duration) }}"
                      data-heart-rate="{{ run.heart_rate }}"                      
                      style="background-color: var(--hover-bg);
                    ">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="fw-bold text-primary-emphasis">{{ "%.2f"|format(run.distance / 1000) }} km</span>
                            <span class="small text-body-secondary recent-run-timestamp">{{ run.date.strftime('%Y-%m-%d %H:%M') }}</span>
                        </div>
                        <div class="row g-2 h-100">
                            <div class="col-3 d-flex align-items-center justify-content-center">
                                <object class="route-svg" data="/images/routesvg/{{ run.id }}.svg" type="image/svg+xml" style="display:none;">
                                </object>
                            </div>
                            <div class="col-9 d-flex flex-column justify-content-between">
                                <div>
                                    <div class="row g-2 small text-body-secondary ms-2">
                                        <div class="col-4">
                                            <div class="stat-label mb-0">ÈÖçÈÄü</div>
                                            <div class="fw-bold text-primary-emphasis">{{ run.pace }}</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="stat-label mb-0">Áî®Êó∂</div>
                                            <div class="fw-bold text-primary-emphasis">{{ format_duration(run.duration) }}</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="stat-label mb-0">ÂøÉÁéá</div>
                                            <div class="fw-bold text-primary-emphasis">{{ run.heart_rate or 'N/A' }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-auto text-end">
                          <a href="#" class="comment-link small text-body-secondary" data-run-id="{{ run.id }}" data-scroll-to-comment="true">üí¨ ËØ¥ÁÇπ‰ªÄ‰πà (<span class="comment-count" data-run-id="{{ run.id }}">0</span>)</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
                </div>
                <div class="text-center mt-3">
                    <a href="#data" id="goto-data-tab" class="text-decoration-none text-body-secondary">Êü•ÁúãÊâÄÊúâËÆ∞ÂΩï &rarr;</a>
                </div>
            </div>
        </div>
        {% endif %}
        <div class="card mb-4" id="run-analysis-section" style="border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div class="card-header bg-transparent border-0 pt-3">
                <div class="card-title-container">
                    <h5 class="card-title">Ë∑ëÈáèÂàÜÊûê</h5>
                    <div class="btn-group btn-group-sm" role="group" id="chart-toggle">
                        <button type="button" class="btn active" data-chart="month-over-month">Êú¨Êúà</button>
                        <button type="button" class="btn" data-chart="daily">30Â§©</button>
                        <button type="button" class="btn" data-chart="monthly">Ëøë12Êúà</button>
                        <button type="button" class="btn" data-chart="yearly-dual-axis">‰ªäÂπ¥</button>
                        <button type="button" class="btn" data-chart="yearly">Ê±áÊÄª</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="monthOverMonthChartContainer" style="display: block;">
                    <div id="monthOverMonthChartStats" class="analysis-summary mb-2 text-center"></div>
                    <div style="height: 300px;">
                        <canvas id="monthOverMonthChart" aria-label="Êú¨Êúà‰∏é‰∏äÊúàË∑ëÈáèÂØπÊØîÂõæË°®"></canvas>
                    </div>
                </div>                
				<div id="dailyChartContainer" style="display: none;">
                    <div id="dailyChartStats" class="analysis-summary mb-2 text-center"></div>
                    <div style="height: 300px;">
                        <canvas id="dailyDistanceChart" aria-label="ÊúÄËøë30Â§©Ë∑ëÊ≠•Ë∑ùÁ¶ªÁªüËÆ°ÂõæË°®"></canvas>
                    </div>
                </div>
                <div id="monthlyChartContainer" style="display: none;">
                    <div id="monthlyChartStats" class="analysis-summary mb-2 text-center"></div>
                    <div style="height: 300px;">
                        <canvas id="monthlyDistanceChart" aria-label="ÊúÄËøë12‰∏™ÊúàË∑ëÊ≠•Ë∑ùÁ¶ªÁªüËÆ°ÂõæË°®"></canvas>
                    </div>
                </div>
                <div id="yearlyDualAxisChartContainer" style="display: none;">
                    <div id="yearlyDualAxisChartStats" class="analysis-summary mb-2 text-center"></div>
                    <div style="height: 300px;">
                        <canvas id="yearlyDualAxisChart" aria-label="Êú¨Âπ¥Â∫¶Á¥ØËÆ°Ë∑ëÈáèÂõæË°®"></canvas>
                    </div>
                </div>
                <div id="yearlyChartContainer" style="display: none;">
                    <div id="yearlyChartStats" class="analysis-summary mb-2 text-center"></div>
                    <div style="height: 300px;">
                        <canvas id="yearlyDistanceChart" aria-label="Âπ¥Â∫¶Ë∑ëÊ≠•Ë∑ùÁ¶ªÁªüËÆ°ÂõæË°®"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="tab-pane fade" id="data-pane" role="tabpanel" aria-labelledby="data-tab" tabindex="0">
        <div class="row">
            <div class="col-lg-3">
                <div class="position-sticky" style="top: 1rem;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="btn-group btn-group-sm" id="data-view-toggle" role="group">
                            <button type="button" class="btn active" data-view="summary">Ê±áÊÄªÊ®°Âºè</button>
                            <button type="button" class="btn" data-view="yearly">Âπ¥Â∫¶Ê®°Âºè</button>
                        </div>
                        <button class="btn btn-sm d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#data-controls-collapse" aria-expanded="false" aria-controls="data-controls-collapse" id="summary-controls-toggle">
                            <i class="bi bi-funnel"></i> Á≠õÈÄâ
                        </button>
                    </div>
                    <div class="collapse d-lg-block" id="data-controls-collapse">
                        <div class="content-card p-3 mb-3">
                            <h6 class="mb-3 small-muted">Á≠õÈÄâÈÄâÈ°π</h6>
                            <div class="mb-3">
                                <label class="form-label">ÊåâÊó•Êúü</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="date" id="date-filter-start" class="form-control form-control-sm" placeholder="Ëµ∑Âßã">
                                    </div>
                                    <div class="col">
                                        <input type="date" id="date-filter-end" class="form-control form-control-sm" placeholder="ÁªìÊùü">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ÊåâË∑ùÁ¶ª</label>
                                <div class="btn-group btn-group-sm w-100" id="data-dist-filter-toggle">
                                    <button type="button" class="btn active" data-dist="0">ÂÖ®ÈÉ®</button>
                                    <button type="button" class="btn" data-dist="5000">&gt;5km</button>
                                    <button type="button" class="btn" data-dist="10000">&gt;10km</button>
                                    <button type="button" class="btn" data-dist="21097">&gt;ÂçäÈ©¨</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ÊåâÈÖçÈÄü</label>
                                <div class="btn-group btn-group-sm w-100" id="data-pace-filter-toggle">
                                    <button type="button" class="btn active" data-pace="9999">ÂÖ®ÈÉ®</button>
                                    <button type="button" class="btn" data-pace="360">&lt;6'</button>
                                    <button type="button" class="btn" data-pace="330">&lt;5'30</button>
                                    <button type="button" class="btn" data-pace="300">&lt;5'</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="data-city-filter" class="form-label">ÊåâÂüéÂ∏Ç</label>
                                <select class="form-select form-select-sm" id="data-city-filter">
                                    <option value="all" selected>ÂÖ®ÈÉ®ÂüéÂ∏Ç</option>
                                    {% for city in city_stats %}
                                    <option value="{{ city.name[:-1] if city.name and city.name.endswith('Â∏Ç') else city.name }}">{{ city.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="" id="data-media-filter">
                                    <label class="form-check-label small" for="data-media-filter">
                                        Âè™ÁúãÊúâÂõæ/ËßÜÈ¢ëÁöÑËÆ∞ÂΩï
                                    </label>
                                </div>
                            </div>                          
                            <button id="clear-filters-btn" class="btn btn-sm btn-outline-secondary w-100">Ê∏ÖÈô§ÊâÄÊúâÁ≠õÈÄâ</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-9">
                <div id="summary-data-view">
                    <div class="content-card table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th class="sortable-header" data-sort="date" aria-sort="descending">
                                        Êó•Êúü <span class="sort-icon"><i class="bi bi-arrow-down-up"></i><i class="bi bi-arrow-down"></i><i class="bi bi-arrow-up"></i></span>
                                    </th>
                                    <th class="sortable-header" data-sort="distance">
                                        Ë∑ùÁ¶ª <span class="sort-icon"><i class="bi bi-arrow-down-up"></i><i class="bi bi-arrow-down"></i><i class="bi bi-arrow-up"></i></span>
                                    </th>
                                    <th class="d-none d-sm-table-cell">Áî®Êó∂</th>
                                    <th class="sortable-header" data-sort="pace">
                                        ÈÖçÈÄü <span class="sort-icon"><i class="bi bi-arrow-down-up"></i><i class="bi bi-arrow-down"></i><i class="bi bi-arrow-up"></i></span>
                                    </th>
                                    <th>ÂüéÂ∏Ç</th>
                                </tr>
                            </thead>
                            <tbody id="summary-table-body">
                                {% for year, year_data in summarized_by_year.items() %}
                                    {% for r in year_data.all_runs %}
                                    <tr class="run-detail-row"
                                        data-run-id="{{ r.id }}"
                                        data-distance="{{ r.distance }}"
                                        data-distance-formatted="{{ "%.2f"|format(r.distance / 1000) }}"
                                        data-pace-str="{{ r.pace }}"
                                        data-date="{{ r.date.strftime('%Y-%m-%d %H:%M') }}"
                                        data-city="{{ r.city[:-1] if r.city and r.city.endswith("Â∏Ç") else r.city }}"
                                        data-duration="{{ format_duration(r.duration) }}"
                                        data-heart-rate="{{ r.heart_rate }}"
                                      >
                                        <td><code>{{ r.date.strftime('%Y-%m-%d') }}</code></td>
                                        <td>{{ "%.2f"|format(r.distance / 1000) }} <span class="small-muted">km</span></td>
                                        <td class="d-none d-sm-table-cell">{{ format_duration(r.duration) }}</td>
                                        <td>{{ r.pace }}</td>
                                        <td>{{ r.city[:-1] if r.city and r.city.endswith("Â∏Ç") else r.city }}</td>
                                    </tr>
                                    {% endfor %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="yearly-data-view" style="display: none;">
                    {% for year, year_data in summarized_by_year.items() %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h4 class="mb-0">{{ year }} Âπ¥</h4>
                        <span class="small-muted small">
                        {{ year_data.summary.count }}Ê¨° | {{ "%.2f"|format(year_data.summary.dist_km) }} km | {{ year_data.summary.duration_str }} |  {{ year_data.summary.pace }}
                        </span>
                    </div>
                    <div class='accordion mb-4' id='accordion{{ year }}'>
                        {% for month_num, month_data in year_data.months.items()|sort(reverse=True) %}
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-m{{ year }}{{ month_num }}" aria-expanded="false" aria-controls="collapse-m{{ year }}{{ month_num }}">
                                {{ months_map[month_num] }} &nbsp; 
                                <span class="small-muted small">({{ month_data.summary.count }}Ê¨° | {{ "%.2f"|format(month_data.summary.dist_km) }} km | {{ month_data.summary.duration_str }} | {{ month_data.summary.pace }})</span>
                                </button>
                            </h2>
                            <div id="collapse-m{{ year }}{{ month_num }}" class="accordion-collapse collapse" data-bs-parent="#accordion{{ year }}">
                                <div class="accordion-body">
                                    <table class="table table-hover table-borderless align-middle mb-0">
                                        <tbody>
                                        {% for r in month_data.runs %}
                                        <tr>
                                            <td>
                                                <code>{{ r.date.strftime('%d') }}</code>
                                                {% if r.streak and r.streak > 1 %}
                                                <span class="streak-badge">{{ r.streak }}Ëøû</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ "%.2f"|format(r.distance / 1000) }} <span class="text-muted small">km</span></td>
                                            <td><span class="text-body">{{ format_duration(r.duration) }}</span></td>
                                            <td><span class="text-body">{{ r.pace }}</span></td>
                                        </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="tab-pane fade" id="marathon-pane" role="tabpanel" aria-labelledby="marathon-tab" tabindex="0">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
            <div id="marathon-controls-container" class="d-flex align-items-center gap-2 flex-wrap">
                <div class="stat-filter-button active" data-filter-type="status" data-filter-value="all">
                    ÂÖ®ÈÉ®
                </div>
                <div class="stat-filter-button" data-filter-type="status" data-filter-value="‰∏≠Á≠æÔºåÂèÇËµõ">
                    Â∑≤‰∏≠Á≠æ <span class="stat-filter-badge" id="stat-pending">0</span>
                </div>
                <div class="stat-filter-button" data-filter-type="status" data-filter-value="Â∑≤Êä•ÂêçÔºåÂæÖÊäΩÁ≠æ">
                    ÂæÖÊäΩÁ≠æ <span class="stat-filter-badge" id="stat-lottery">0</span>
                </div>
                <div class="stat-filter-button" data-filter-type="view" data-filter-value="calendar">Êó•ÂéÜ</div>
                <button id="editCalendarBtn" class="btn btn-sm" style="display: none;"><i class="bi bi-pencil-square"></i></button>
            </div>
        </div>
        <div id="race-countdown-container" class="content-card text-center mb-4" style="display: none; border-color: var(--accent-color);">
            <h6 class="card-title mb-1 text-body-secondary">‰∏ã‰∏ÄÂú∫ÊØîËµõÂÄíËÆ°Êó∂</h6>
            <p id="countdown-race-name" class="h4 accent-color-text fw-bold">Ëµõ‰∫ãÂêçÁß∞</p>
            <div id="countdown-timer" class="d-flex justify-content-center my-3">
                <div class="time-block"><div id="cd-days" class="time-value">00</div><div class="time-label">Â§©</div></div>
                <div class="time-block"><div id="cd-hours" class="time-value">00</div><div class="time-label">Â∞èÊó∂</div></div>
                <div class="time-block"><div id="cd-minutes" class="time-value">00</div><div class="time-label">ÂàÜÈíü</div></div>
                <div class="time-block"><div id="cd-seconds" class="time-value">00</div><div class="time-label">Áßí</div></div>
            </div>
            <p id="countdown-race-date" class="text-body-secondary small mb-0">YYYY-MM-DD</p>
        </div>
        <div id="marathon-calendar-view" style="display: none;">
            <div id="marathon-calendar-container"></div>
        </div>
        <div id="marathon-list-view">
            <div id="marathon-list-container"></div>
        </div>
    </div>
    <div class="tab-pane fade" id="events-pane" role="tabpanel" aria-labelledby="events-tab" tabindex="0">
        <div class="d-flex justify-content-end mb-4">
            <div class="btn-group btn-group-sm" id="events-view-toggle" role="group" aria-label="Events View Toggle">
                <button type="button" class="btn active" data-view="category">ÊåâÁ±ªÂà´</button>
                <button type="button" class="btn" data-view="timeline">ÊåâÊó∂Èó¥Á∫ø</button>
            </div>
        </div>
        <div id="events-category-view">
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="content-card h-100 d-flex flex-column">
                        <h5 class="card-title mb-3"><i class="bi bi-flag-fill text-success"></i> ÈáåÁ®ãÁ¢ë</h5>
                        {% set milestones = [
                        {'name': 'Ë∏èÂá∫Á¨¨‰∏ÄÊ≠•', 'distance': first_run_distance, 'date': first_run_date, 'is_first': True},
                        {'name': '1000ÂÖ¨Èáå', 'distance': 1000, 'date': milestone_dates.get(1000)},
                        {'name': '10000ÂÖ¨Èáå', 'distance': 10000, 'date': milestone_dates.get(10000)},
                        {'name': '20000ÂÖ¨Èáå', 'distance': 20000, 'date': milestone_dates.get(20000)},
                        {'name': '30000ÂÖ¨Èáå', 'distance': 30000, 'date': milestone_dates.get(30000)},
                        {'name': '40000ÂÖ¨Èáå', 'distance': 40000, 'date': milestone_dates.get(40000)}
                        ] %}
                        {% set ns = namespace(next_milestone_index=-1) %}
                        {% for m in milestones %}
                            {% if not m.date and not m.is_first and ns.next_milestone_index == -1 %}
                                {% set ns.next_milestone_index = loop.index0 %}
                            {% endif %}
                        {% endfor %}
                        {% for m in milestones %}
                        <div class="d-flex justify-content-between align-items-center py-2 pb-entry">
                            <div>
                                <span class="fw-bold">{{ m.name }}</span>
                                {% if m.date %}
                                    <span class="badge bg-success ms-2" style="font-size: 0.8em; font-weight: 500;">Â∑≤ÂÆåÊàê</span>
                                {% elif loop.index0 == ns.next_milestone_index %}
                                    <span class="badge ms-2" style="font-size: 0.8em; font-weight: 500; background-color: var(--accent-color); color: var(--card-bg);">ËøõË°å‰∏≠</span>
                                {% endif %}
                            </div>
                            <div class="text-end" style="min-width: 130px;">
                                {% if m.date %}
                                    <small class="text-body-secondary">{{ m.date.strftime('%YÂπ¥%mÊúà%dÊó•') }}</small>
                                {% elif loop.index0 == ns.next_milestone_index %}
                                    {% set prev_milestone_dist = milestones[loop.index0 - 1].distance if loop.index0 > 0 else 0 %}
                                    {% set progress = (overall_stats.dist_km - prev_milestone_dist) / (m.distance - prev_milestone_dist) * 100 %}
                                    {% if progress > 100 %}{% set progress = 100 %}{% endif %}
                                    {% if progress < 0 %}{% set progress = 0 %}{% endif %}
                                    <div class="w-100">
                                        <div class="progress mb-1" style="height: 6px; background-color: var(--hover-bg);">
                                            <div class="progress-bar" role="progressbar" style="width: {{ '%.2f'|format(progress) }}%;" aria-valuenow="{{ '%.2f'|format(progress) }}" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <small class="text-body-secondary" style="font-size: 0.8em;">ËøõÂ∫¶ {{ '%.2f'|format(progress) }}%</small>
                                    </div>
                                {% else %}
                                    <small class="text-body-secondary">Êú™ËææÊàê</small>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="content-card h-100 d-flex flex-column">
                        <h5 class="card-title mb-3"><i class="bi bi-award-fill trophy-color-text"></i> ‰∏™‰∫∫ÊúÄ‰Ω≥ (PB)</h5>
                        <div class="flex-grow-1">
                            {% for label, pb in personal_bests.items() %}
                            <div class="d-flex justify-content-between align-items-center py-2 pb-entry">
                                <div>
                                <div class="fw-bold">{{ label }}</div>
                                <small class="small-muted">{{ pb.date }}</small>
                                </div>
                                <div class="text-end">
                                <div class="fw-bold">{{ pb.time }}</div>
                                <small class="small-muted">ÈÖçÈÄü: {{ pb.pace }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="content-card h-100 d-flex flex-column">
                        <h5 class="card-title mb-3"><i class="bi bi-trophy-fill accent-color-text"></i> ÊØîËµõËÆ∞ÂΩï</h5>
                        <div class="flex-grow-1" style="overflow-y: auto;">
                            {% if events %}
                            {% for event in events %}
                                <div class="border-bottom py-2 pb-entry">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="fw-bold text-primary-emphasis">
                                    {{ event.name }}
                                    <small class="text-body-secondary">{{ event.category }}</small>
                                    </div>
                                    <div class="flex-grow-1 text-center px-2">
                                    {% if event.certified %}
                                        <abbr title="ÁÇπÂáªÊü•ÁúãËØÅ‰π¶" class="certificate-link text-decoration-none" 
                                            data-img="{{ event.certificate }}" style="cursor: pointer; border-bottom: 1px dotted var(--text-secondary)">
                                        <span class="classification-text">{{ event.certified }}</span>
                                        </abbr>
                                    {% endif %}
                                    </div>
                                    <div class="text-nowrap text-primary-emphasis">{{ format_duration(event.duration) }}</div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-1">
                                    <div>
                                    <small class="text-body-secondary">
                                        {% if event.date %}{{ event.date.strftime('%Y.%m.%d') }}{% else %}Êó•ÊúüÊú™Áü•{% endif %}
                                    </small>
                                    <small class="text-body-secondary ms-2">{{ event.city }}</small>
                                    </div>
                                    <div class="text-end"><small class="text-body-secondary">ÈÖçÈÄü: {{ event.pace }}</small></div>
                                </div>
                                </div>
                            {% endfor %}
                            {% else %}
                            <div class="text-center py-4 text-body-secondary">ÊöÇÊó†ÊØîËµõËÆ∞ÂΩï</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="content-card h-100 d-flex flex-column">
                        <h5 class="card-title mb-3"><i class="bi bi-geo-alt-fill text-primary"></i> Ëß£ÈîÅÊñ∞ÂüéÂ∏Ç</h5>
                        <div class="flex-grow-1" style="overflow-y: auto; max-height: 250px;">
                            {% if city_stats %}
                                {% for city in city_stats|sort(attribute='first_date', reverse=True) %}
                                    {% if city.first_date %}
                                    <div class="d-flex justify-content-between align-items-center py-2 pb-entry">
                                        <div>
                                            <div class="fw-bold">{{ city.name }}</div>
                                        </div>
                                        <div class="text-end">
                                            <div class="text-nowrap text-primary-emphasis">{{ city.first_date }}</div>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-4 text-body-secondary">ÊöÇÊó†ÂüéÂ∏ÇËÆ∞ÂΩï</div>
                            {% endif %}
                        </div>
                        <div class="mt-4">
                            <h6 class="card-title mb-3 small-muted"><i class="bi bi-map-fill"></i> Ë∂≥ËøπÂú∞Âõæ</h6>
                            <div class="row">
                                <div class="col-12">
                                  <div id="cityMap"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% set all_events = [] %}
        {% for m in milestones %}{% if m.date %}{% set dist_str = ("%.0f"|format(m.distance)) if not m.is_first else ("%.2f"|format(m.distance)) %}{% set details_str = 'ËææÊàê ' ~ dist_str ~ 'km ÈáåÁ®ãÁ¢ë' if not m.is_first else 'È¶ñË∑ëË∑ùÁ¶ª ' ~ dist_str ~ 'km' %}{% set _ = all_events.append({'date': m.date.strftime('%Y-%m-%d'), 'type': 'ÈáåÁ®ãÁ¢ë', 'icon': 'bi-flag-fill', 'color': 'text-success', 'title': m.name, 'details': details_str}) %}{% endif %}{% endfor %}
        {% for label, pb in personal_bests.items() %}{% set _ = all_events.append({'date': pb.date, 'type': '‰∏™‰∫∫ÊúÄ‰Ω≥', 'icon': 'bi-award-fill', 'color': 'trophy-color-text', 'title': 'PB: ' ~ label, 'details': 'Êó∂Èó¥ ' ~ pb.time ~ ' (ÈÖçÈÄü ' ~ pb.pace ~ ')'}) %}{% endfor %}
        {% for event in events %}{% if event.date %}{% set _ = all_events.append({'date': event.date.strftime('%Y-%m-%d'), 'type': 'ÊØîËµõËÆ∞ÂΩï', 'icon': 'bi-trophy-fill', 'color': 'accent-color-text', 'title': event.name, 'details': event.category ~ ' - ÂÆåËµõÊó∂Èó¥: ' ~ format_duration(event.duration)}) %}{% endif %}{% endfor %}
        {% for city in city_stats %}{% if city.first_date %}{% set _ = all_events.append({'date': city.first_date, 'type': 'Ëß£ÈîÅÊñ∞ÂüéÂ∏Ç', 'icon': 'bi-geo-alt-fill', 'color': 'text-primary', 'title': 'Ëß£ÈîÅ: ' ~ city.name, 'details': '‰∫é ' ~ city.first_date ~ ' È¶ñÊ¨°Âú®ËØ•ÂüéÂ∏ÇË∑ëÊ≠•'}) %}{% endif %}{% endfor %}
        {% set sorted_events = all_events|sort(attribute='date', reverse=True) %}
        <div id="events-timeline-view" style="display: none;">
            <div class="content-card">
                <div class="timeline">
                    {% if not sorted_events %}
                        <div class="text-center py-4 text-body-secondary">ÊöÇÊó†‰∫ã‰ª∂ËÆ∞ÂΩï</div>
                    {% else %}
                        {% for event in sorted_events %}
                        <div class="timeline-item">
                            <div class="timeline-marker">
                                <i class="bi {{ event.icon }} {{ event.color }}"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="small text-body-secondary mb-1">{{ event.date }} &middot; {{ event.type }}</div>
                                <h6 class="mb-1 fw-bold">{{ event.title }}</h6>
                                <p class="mb-0 small text-body-secondary">{{ event.details }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="tab-pane fade" id="about-pane" role="tabpanel" aria-labelledby="about-tab" tabindex="0">
        <div class="content-card">
            <h5 class="card-title mb-4">ÂÖ≥‰∫éËøô‰∏™ÁΩëÁ´ô</h5>
            <p>Ëøô‰∏™Ë∑ëÊ≠•ËÆ∞ÂΩïÁΩëÁ´ôÁöÑÁÅµÊÑüÔºåÊù•Ëá™ÊàëÂú®Ê∞¥Êú®Á§æÂå∫ÁúãÂà∞ÁöÑ‰∏Ä‰∏™Â∏ñÂ≠ê„ÄÇ</p>
            <p>‰∏Ä‰ΩçË∑ëÂèãÂàÜ‰∫´‰∫Ü‰ªñÂùöÊåÅË∑ëÊ≠•ÂçÅÂπ¥ÁöÑÁªèÂéÜÔºåÁ¥ØËÆ°Ë∑ëÈáèËææÂà∞‰∫Ü‰∏â‰∏áÂÖ¨Èáå„ÄÇ‰ªñÊé•‰∏ãÊù•ÁöÑÁõÆÊ†áÊòØË∑ëÂà∞Âõõ‰∏áÂÖ¨Èáå‚Äî‚ÄîÊ≠£Â•ΩÊòØÁªïÂú∞ÁêÉËµ§ÈÅì‰∏ÄÂúàÁöÑË∑ùÁ¶ª„ÄÇ</p>
            <p>Ëøô‰∏™ÁõÆÊ†áËÆ©ÊàëÂæàÂèóËß¶Âä®„ÄÇÂõõ‰∏áÂÖ¨ÈáåÔºåÁõ∏ÂΩì‰∫éÊØèÂ§©Ë∑ë<span style="text-decoration: line-through;text-decoration-color: #ff6b6b;text-decoration-thickness: 2px;">ÂçÅÂÖ¨Èáå</span>‰∫îÂÖ¨ÈáåÔºåËøûÁª≠Ë∑ë<span style="text-decoration: line-through;text-decoration-color: #ff6b6b;text-decoration-thickness: 2px;">ÂçÅ‰∏ÄÂπ¥</span>‰∫åÂçÅ‰∫åÂπ¥„ÄÇËôΩÁÑ∂ÁúãËµ∑Êù•ÂæàËøúÔºå‰ΩÜÂàÜËß£Âà∞ÊØè‰∏ÄÂ§©ÔºåÂ∞±ÊòØÂùöÊåÅË∑ë‰∏ãÂéª„ÄÇ</p>
            <p>Êàë‰∏çÊòØ‰∏ì‰∏öË∑ëËÄÖÔºå<span style="text-decoration: line-through;text-decoration-color: #ff6b6b;text-decoration-thickness: 2px;">‰πü‰∏çËøΩÊ±ÇÈÄüÂ∫¶</span>(ÊúâÈÇ£‰πà‰∏ÄÁÇπÁÇπËøΩÊ±Ç)„ÄÇÂØπÊàëÊù•ËØ¥ÔºåË∑ëÊ≠•Êõ¥ÈáçË¶ÅÁöÑÊòØ‰øùÊåÅÂÅ•Â∫∑ÂíåÂùöÊåÅÁöÑ‰π†ÊÉØ„ÄÇËøô‰∏™ÁΩëÁ´ôËÆ∞ÂΩïÊàëÁöÑË∑ëÊ≠•ÂéÜÁ®ãÔºåÁúãÁùÄÊï∞Â≠ó‰∏ÄÁÇπÁÇπÂ¢ûÈïøÔºåÂ∞±ÊòØÊúÄÂ•ΩÁöÑÂä®Âäõ„ÄÇ</p>
            <p>Â¶ÇÊûú‰Ω†‰πüÊúâÁ±ª‰ººÁöÑË∑ëÊ≠•ÁõÆÊ†áÔºåÊ¨¢Ëøé‰∏ÄËµ∑ÂùöÊåÅ„ÄÇË∑ëÊ≠•Ë∑Ø‰∏äÔºåÊàë‰ª¨ÈÉΩ‰∏çÂ≠§Âçï„ÄÇ</p>
            <p class="text-end mt-4">2025Âπ¥7Êúà¬∑ÂπøÂ∑û</p>
        </div>
    </div>
  </div>
</div>
<div class="modal fade" id="certificateModal" tabindex="-1" aria-labelledby="certificateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="certificateModalLabel">Á≠âÁ∫ßËØÅ‰π¶</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="certificateImage" src="" class="img-fluid" style="max-height: 70vh;" alt="Ë∑ëÊ≠•Á≠âÁ∫ßËØÅ‰π¶">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">ÂÖ≥Èó≠</button>
      </div>
    </div>
  </div>
</div>
<footer class="container text-center py-4 mt-4">
    <small class="text-body-secondary">
        Ê≠•Â±•‰∏çÂÅú &copy; {% if summarized_by_year %}{{ summarized_by_year.keys()|max }}{% endif %}
         | <a href="?admin=true" class="text-decoration-none text-body-secondary">Admin</a> {% if last_build_time %} | {{ last_build_time }} {% endif %}
    </small>
</footer>
<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ë∑ëÊ≠•ËØÑËÆ∫</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ÂÖ≥Èó≠"></button>
      </div>
      <div class="modal-body">
        <div id="commentList" class="mb-3" style="max-height: 250px; overflow-y: auto;"></div>
        <textarea class="form-control" id="commentText" rows="3" placeholder="ÂÜô‰∏ã‰Ω†ÁöÑÊÑüÊÉ≥Âêß... ÂèØ‰ΩøÁî®[img]url[/img]Êàñ[video]url[/video]ÂàÜ‰∫´ÂõæÁâáÂíåËßÜÈ¢ë„ÄÇ"></textarea>
        <input type="hidden" id="commentRunId">
      </div>
      <div class="modal-footer d-flex justify-content-between align-items-center">
        <div id="editProfileTrigger" style="cursor: pointer;" title="ÁÇπÂáª‰øÆÊîπÊòµÁß∞">
            <span class="small text-body-secondary">
                ÂèëË®ÄË∫´‰ªΩ: <span id="commentUserIcon"></span> <span id="commentUserNickname"></span>
                <i class="bi bi-pencil-fill small ms-1"></i>
            </span>
        </div>
        <div>
            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">ÂèñÊ∂à</button>
            <button type="button" class="btn btn-primary btn-sm" id="submitComment">Êèê‰∫§</button>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profileModalLabel">ÁºñËæë‰∏™‰∫∫‰ø°ÊÅØ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="nicknameInput" class="form-label">ÊòµÁß∞</label>
                    <input type="text" class="form-control" id="nicknameInput" placeholder="ËØ∑ËæìÂÖ•‰Ω†ÁöÑÊòµÁß∞">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">ÂÖ≥Èó≠</button>
                <button type="button" class="btn btn-sm" id="saveProfileButton">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="runDetailModal" tabindex="-1" aria-labelledby="runDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailTitle">Ë∑ëÊ≠•ËØ¶ÊÉÖ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="runDetailContent" class="container-fluid">
                  <div class="row">
                    <div class="col-lg-7 order-lg-1">
                        <div class="d-flex justify-content-center mb-2 mt-2">
                            <div class="btn-group btn-group-sm" role="group" id="detail-view-toggle">
                                <button type="button" class="btn active" data-view="map">
                                    <i class="bi bi-map-fill me-1"></i> Ë∑ØÁ∫øÂú∞Âõæ
                                </button>
                                <button type="button" class="btn" data-view="media">
                                    <i class="bi bi-images me-1"></i> ÂΩ±Èü≥ËÆ∞ÂΩï
                                </button>
                            </div>
                        </div>
                        
                        <div id="detail-view-content" class="position-relative">
                            <div id="routeMapContainer" class="py-2">
                                </div>
                        
                            <div id="mediaViewerContainer" class="p-2" style="display: none;">
                                <div class="text-center p-5">
                                    <div class="spinner-border text-secondary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="detailWeather" class="text-center small text-body-secondary mb-3"></div>
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <h4 class="data-section-title">ËøêÂä®Êï∞ÊçÆ</h4>
                                <div>
                                    <button id="viewPhotoBtn" class="btn btn-sm mb-3 me-2" style="display: none;"><i class="bi bi-images"></i> Ë∑ëÊ≠•ÁÖßÁâá</button>
                                    <button id="managePhotoBtn" class="btn btn-sm btn-outline-primary mb-3" style="display: none;"><i class="bi bi-pencil-square"></i> ÁÆ°ÁêÜÁÖßÁâá</button>
                                </div>
                            </div>
                            <div class="row g-4 text-center" id="detailDataGrid"></div>
                        </div>
                        <div id="detailAnalysisSectionsLoading" class="text-center p-4">
                            <div class="spinner-border text-secondary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="detailAnalysisSections" style="display: none;">
                            <div class="mb-4">
                                <h4 class="data-section-title">ÂàÜÊÆµ‰ø°ÊÅØ</h4>
                                <div class="table-responsive" style="max-height: 250px;">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr><th>ÂúàÊï∞</th><th>Êó∂Èó¥</th><th>Ë∑ùÁ¶ª</th><th>ÈÖçÈÄü</th><th>ÂøÉÁéá</th><th>Ê≠•È¢ë</th></tr>
                                        </thead>
                                        <tbody id="detailLapsTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="mb-4">
                                <h4 class="data-section-title">ÈÖçÈÄü</h4>
                                 <p class="analysis-summary mb-3">Âπ≥ÂùáÈÖçÈÄü: <strong id="detailAvgPace">--</strong><span class="mx-2">|</span>ÊúÄÂø´ÈÖçÈÄü: <strong id="detailBestPace">--</strong></p>
                                <div style="height: 200px;"><canvas id="paceChart"></canvas></div>
                            </div>
                            <div class="mb-4">
                                <h4 class="data-section-title">ÂøÉÁéá</h4>
                                 <p class="analysis-summary mb-3">Âπ≥ÂùáÂøÉÁéá: <strong id="detailAvgHr">--</strong><span class="mx-2">|</span>ÊúÄÂ§ßÂøÉÁéá: <strong id="detailMaxHr">--</strong></p>
                                <div style="height: 200px;"><canvas id="hrChart"></canvas></div>
                            </div>
                            <div class="mb-4">
                                <h4 class="data-section-title">Êµ∑Êãî</h4>
                                <div style="height: 200px;"><canvas id="elevationChart"></canvas></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-5 order-lg-2 border-start-lg">
                        <div class="py-3">
                            <div id="runDetailTagsSection" class="mb-4">
                                <h4 class="data-section-title">Ê†áÁ≠æ</h4>
                                <div id="runDetailTagsContainer" class="mb-2"></div>
                                <div id="runDetailTagsEditor" style="display:none;">
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control" id="runDetailTagInput" placeholder="Ê∑ªÂä†Êñ∞Ê†áÁ≠æ...">
                                        <button class="btn btn-outline-secondary" type="button" id="addTagButton" style="--bs-btn-border-color: var(--border-color); --bs-btn-hover-bg: var(--accent-color); --bs-btn-hover-border-color: var(--accent-color); --bs-btn-active-bg: var(--accent-color); --bs-btn-active-border-color: var(--accent-color); color: var(--text-secondary);">Ê∑ªÂä†</button>
                                    </div>
                                    <div id="suggestedTagsContainer" class="mt-2"></div>
                                </div>
                            </div>
                            <div id="runDetailComments">
                                <hr>
                                <h4 class="data-section-title mt-4">ËØÑËÆ∫</h4>
                                <div id="runDetailCommentList" class="mb-3" style="max-height: 40vh; overflow-y: auto;"></div>
                                <div id="runDetailCommentForm" class="p-3">
                                    <h6 class="mb-3">ÂèëË°®ËØÑËÆ∫</h6>
                                    <textarea class="form-control" id="runDetailCommentText" rows="3" placeholder="ÂÜô‰∏ã‰Ω†ÁöÑÊÑüÊÉ≥Âêß..."></textarea>
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <div id="detailEditProfileTrigger" style="cursor: pointer;" title="ÁÇπÂáª‰øÆÊîπÊòµÁß∞">
                                            <span class="small text-secondary">ÂèëË®ÄË∫´‰ªΩ: <span id="detailCommentUserIcon"></span> <span id="detailCommentUserNickname"></span><i class="bi bi-pencil-fill small ms-1"></i></span>
                                        </div>
                                        <button type="button" class="btn btn-primary btn-sm" id="submitRunDetailComment"><i class="bi bi-send-fill"></i> Êèê‰∫§</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                  </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="mediaGalleryModal" tabindex="-1" aria-labelledby="mediaGalleryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body p-0">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        <div id="mediaCarousel" class="carousel slide">
          <div class="carousel-inner" id="galleryCarouselInner">
            </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#mediaCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#mediaCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="mediaManagerModal" tabindex="-1" aria-labelledby="mediaManagerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mediaManagerModalLabel">ÁÆ°ÁêÜÂΩ±Èü≥ËÆ∞ÂΩï</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>Â∑≤ÊúâÂ™í‰Ωì</h6>
                <div id="media-manager-list" class="mb-4">
                    </div>
                <hr>
                <h6>Ê∑ªÂä†Êñ∞Â™í‰Ωì</h6>
            
                <div class="p-3 rounded" style="background-color: var(--hover-bg);">
                    <p class="small text-body-secondary">Áõ¥Êé•‰∏ä‰º†Êñá‰ª∂ (Êé®Ëçê) Êàñ Á≤òË¥¥ R2 URL„ÄÇ</p>
                    <div class="mb-2">
                        <input class="form-control form-control-sm" type="file" id="media-file-input" multiple>
                    </div>
                    <div id="upload-progress-container"></div>
                    
                    <div class="accordion accordion-flush" id="pasteUrlAccordion">
                      <div class="accordion-item" style="background: transparent;">
                        <h2 class="accordion-header">
                          <button class="accordion-button collapsed py-1 px-0" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne" style="background: transparent; box-shadow: none;">
                            <small>Êàñ‰ªé URL Ê∑ªÂä†</small>
                          </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#pasteUrlAccordion">
                          <div class="accordion-body p-0 pt-2">
                            <textarea id="new-media-urls" class="form-control" rows="2" placeholder="‰∏ÄË°å‰∏Ä‰∏™ URL..."></textarea>
                            <button id="add-media-from-urls" class="btn btn-sm btn-secondary mt-2">Ê∑ªÂä†Âà∞ÂàóË°®</button>
                          </div>
                        </div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                <button type="button" class="btn btn-success" id="saveMediaChanges">
                    <i class="bi bi-check-circle me-1"></i> ‰øùÂ≠òÊõ¥ÊîπÂà∞ÊúçÂä°Âô®
                </button>
            </div>
        </div>
    </div>
</div>
  
<div class="modal fade" id="calendarEditorModal" tabindex="-1" aria-labelledby="calendarEditorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="calendarEditorModalLabel">ËµõÂéÜÁºñËæëÂô®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>ÂΩìÂâçËµõ‰∫ã</h6>
                <div id="calendarEditorList" class="list-group mb-4"></div>
                <hr>
                <h6 id="calendarFormTitle">Ê∑ªÂä†Êñ∞Ëµõ‰∫ã</h6>
                <form id="calendarEventForm">
                    <input type="hidden" id="event-id">
                     <div class="row g-2 mb-2">
                        <div class="col-md-8">
                            <label for="event-name" class="form-label">Ëµõ‰∫ãÂêçÁß∞</label>
                            <input type="text" class="form-control form-control-sm" id="event-name" required>
                        </div>
                        <div class="col-md-4">
                            <label for="event-willingness" class="form-label">Êä•ÂêçÊÑèÊÑø</label>
                            <select class="form-select form-select-sm" id="event-willingness">
                                <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ (ÂøÖÂéª)</option>
                                <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ (ÂæàÊÉ≥Âéª)</option>
                                <option value="3" selected>‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ (ËÄÉËôë‰∏≠)</option>
                                <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ (‰∏çÂ§™ÊÉ≥)</option>
                                <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ (‰ªÖÂÖ≥Ê≥®)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label for="event-channel" class="form-label">Êä•ÂêçÊ∏†ÈÅì (ÈìæÊé•ÊàñÂêçÁß∞)</label>
                        <input type="text" class="form-control form-control-sm" id="event-channel" placeholder="https://....">
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-md-4">
                            <label for="event-category" class="form-label">Á±ªÂà´ (Â¶Ç: ÂÖ®È©¨)</label>
                            <input type="text" class="form-control form-control-sm" id="event-category" required>
                        </div>
                        <div class="col-md-4">
                            <label for="event-level" class="form-label">Ëµõ‰∫ãÁ≠âÁ∫ß</label>
                            <select class="form-select form-select-sm" id="event-level">
                                <option value="ÊôÆÈÄöËµõ‰∫ã" selected>ÊôÆÈÄöËµõ‰∫ã</option>
                                <option value="‰∏ñÁïåÁî∞ËÅîÁôΩÈáëÊ†á">‰∏ñÁïåÁî∞ËÅîÁôΩÈáëÊ†á</option>
                                <option value="‰∏ñÁïåÁî∞ËÅîÈáëÊ†á">‰∏ñÁïåÁî∞ËÅîÈáëÊ†á</option>
                                <option value="‰∏ñÁïåÁî∞ËÅîÁ≤æËã±Ê†á">‰∏ñÁïåÁî∞ËÅîÁ≤æËã±Ê†á</option>
                                <option value="‰∏≠ÂõΩÁî∞Âçè A1">‰∏≠ÂõΩÁî∞Âçè A1</option>
                                <option value="‰∏≠ÂõΩÁî∞Âçè A2">‰∏≠ÂõΩÁî∞Âçè A2</option>
                                <option value="‰∏≠ÂõΩÁî∞Âçè B">‰∏≠ÂõΩÁî∞Âçè B</option>
                                <option value="‰∏≠ÂõΩÁî∞Âçè C">‰∏≠ÂõΩÁî∞Âçè C</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="event-status" class="form-label">Áä∂ÊÄÅ</label>
                            <select class="form-select form-select-sm" id="event-status" required>
                                <option value="Êú™ÂêØÂä®">Êú™ÂêØÂä®</option>
                                <option value="Êä•Âêç‰∏≠">Êä•Âêç‰∏≠</option>
                                <option value="Â∑≤Êä•ÂêçÔºåÂæÖÊäΩÁ≠æ">Â∑≤Êä•ÂêçÔºåÂæÖÊäΩÁ≠æ</option>
                                <option value="Êú™‰∏≠Á≠æ">Êú™‰∏≠Á≠æ</option>
                                <option value="‰∏≠Á≠æÔºåÂèÇËµõ">‰∏≠Á≠æÔºåÂèÇËµõ</option>
                                <option value="‰∏≠Á≠æÔºåÊîæÂºÉ">‰∏≠Á≠æÔºåÊîæÂºÉ</option>
                                <option value="Â∑≤ÂÆåËµõ">Â∑≤ÂÆåËµõ</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-md">
                            <label for="event-reg-start" class="form-label">Êä•ÂêçÂºÄÂßãÊó•Êúü</label>
                            <input type="date" class="form-control form-control-sm" id="event-reg-start">
                        </div>
                        <div class="col-md">
                            <label for="event-reg-end" class="form-label">Êä•ÂêçÁªìÊùüÊó•Êúü</label>
                            <input type="text" class="form-control form-control-sm" id="event-reg-end" placeholder="YYYY-MM-DD Êàñ ÊñáÂ≠ó">
                        </div>
                    </div>
                    <div class="row g-2 mb-3">
                       <div class="col-md">
                            <label for="event-lottery-date" class="form-label">Âá∫Á≠æÊó•Êúü</label>
                            <input type="text" class="form-control form-control-sm" id="event-lottery-date" placeholder="YYYY-MM-DD Êàñ ÊñáÂ≠ó">
                        </div>
                        <div class="col-md">
                            <label for="event-date" class="form-label">ÊØîËµõÊó•Êúü</label>
                            <input type="date" class="form-control form-control-sm" id="event-date" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-sm btn-primary">‰øùÂ≠òËµõ‰∫ã</button>
                    <button type="button" id="cancelEditBtn" class="btn btn-sm btn-secondary" style="display: none;">ÂèñÊ∂àÁºñËæë</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÂÖ≥Èó≠</button>
                <button type="button" class="btn btn-success" id="saveAllCalendarChanges">‰øùÂ≠òÊâÄÊúâÊõ¥ÊîπÂà∞ÊúçÂä°Âô®</button>
            </div>
        </div>
    </div>
</div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.5.0/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.1.0/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
    // Global variables...
    let monthlyDistanceChart = null;
    let dailyDistanceChart = null;
    let yearlyDistanceChart = null;
    let monthOverMonthChart = null;
    let yearlyDualAxisChart = null;
    let paceChart = null;
    let elevationChart = null;
    let hrChart = null;
    let cityMap = null;
    let modalMapInstance = null;
    let detailMapInstance = null;
    let countdownInterval = null;
    let currentPolyline = null;
    let allRunRows = [];
    const API_BASE = 'https://workerrunapi.linwn.net';
    const cityStatsData = {{ city_stats|tojson }};
    let currentRunMedia = null;
    let hasFetchedMedia = false;
    let mediaRunIds = new Set();
    let detailPhotoUrls = [];
    let currentDetailRunId = null;
    let mediaManagerModalInstance = null;
    let currentEditingMedia = []; 
    let currentRunTags = [];
    const suggestedTags = ['ÈïøË∑ùÁ¶ª', 'ÊÅ¢Â§çË∑ë', 'ËäÇÂ•èË∑ë', 'Èó¥Ê≠áË∑ë', 'Ë∂äÈáé', 'ÊØîËµõ', 'ËøêÂä®Âú∫'];
    let marathonEventsCache = [];
    // --- THEME SWITCHER LOGIC ---
    const themeToggle = document.getElementById('theme-toggle');
    const getPreferredTheme = () => {
        const storedTheme = localStorage.getItem('theme');
        if (storedTheme) return storedTheme;
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };
    const setTheme = (theme) => {
        document.documentElement.setAttribute('data-bs-theme', theme);
        localStorage.setItem('theme', theme);
        updateRootColors();
        if (monthlyDistanceChart) {
            recreateAllCharts();
        }
    };
    const updateRootColors = () => {
        const root = document.documentElement;
        const computedStyle = getComputedStyle(root);
        const setRgbVar = (name) => {
            const color = computedStyle.getPropertyValue(`--${name}`).trim();
            if (color.startsWith('#')) {
                const r = parseInt(color.substring(1, 3), 16);
                const g = parseInt(color.substring(3, 5), 16);
                const b = parseInt(color.substring(5, 7), 16);
                root.style.setProperty(`--${name}-rgb`, `${r}, ${g}, ${b}`);
            }
        };
        ['bg-color', 'card-bg', 'text-primary', 'hover-bg', 'success-color', 'accent-color'].forEach(setRgbVar);
    };
    setTheme(getPreferredTheme());
    themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-bs-theme');
        setTheme(currentTheme === 'dark' ? 'light' : 'dark');
    });
    // --- END THEME SWITCHER LOGIC ---
    function sanitizeHTML(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }  
    let isHandlingPopState = false; // A flag to prevent event loops
    function decodePolyline(encoded) {
        if (!encoded) return [];
        let index = 0, len = encoded.length, lat = 0, lng = 0, array = [];
        while (index < len) {
            let b, shift = 0, result = 0;
            do { b = encoded.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
            let dlat = ((result & 1) ? ~(result >> 1) : (result >> 1)); lat += dlat;
            shift = 0; result = 0;
            do { b = encoded.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
            let dlng = ((result & 1) ? ~(result >> 1) : (result >> 1)); lng += dlng;
            array.push([lat * 1e-5, lng * 1e-5]);
        }
        return array;
    }
    async function refreshDetailComments(runId) {
        const listContainer = document.getElementById('runDetailCommentList');
        try {
            const res = await fetch(`${API_BASE}/comments?runId=${encodeURIComponent(runId)}`);
            if(!res.ok) throw new Error("Failed to fetch comments");
            const data = await res.json();
            renderCommentList(listContainer, data);
        } catch(e) {
            listContainer.innerHTML = '<div class="text-danger">ËØÑËÆ∫Âä†ËΩΩÂ§±Ë¥•</div>';
        }
    }  
    async function showRunDetailModal(runId, preloadedData = {}, scrollToComments = false) {
        const newHash = `#data/run/${runId}`;
        if (window.location.hash !== newHash) {
                history.pushState({ runId: runId }, `Ë∑ëÊ≠•ËØ¶ÊÉÖ: ${runId}`, newHash);
        }          
        currentDetailRunId = runId;
        currentRunMedia = null;
        hasFetchedMedia = false;
        // Make sure to show the map and hide the media viewer by default
        document.getElementById('routeMapContainer').style.display = 'block';
        document.getElementById('mediaViewerContainer').style.display = 'none';
        document.querySelector('#detail-view-toggle .btn[data-view="map"]').classList.add('active');
        document.querySelector('#detail-view-toggle .btn[data-view="media"]').classList.remove('active');
          
        const modalEl = document.getElementById('runDetailModal');
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
        const runDate = new Date(preloadedData.date);
        const weekdays = ['ÊòüÊúüÊó•', 'ÊòüÊúü‰∏Ä', 'ÊòüÊúü‰∫å', 'ÊòüÊúü‰∏â', 'ÊòüÊúüÂõõ', 'ÊòüÊúü‰∫î', 'ÊòüÊúüÂÖ≠'];
        const dayName = weekdays[runDate.getDay()];
        const formattedDate = preloadedData.date.replace(' ', ` (${dayName}) `);
        document.getElementById('detailTitle').textContent = `Ë∑ëÊ≠•ËØ¶ÊÉÖ: ${formattedDate}`;
        const detailDataGrid = document.getElementById('detailDataGrid');
        detailDataGrid.innerHTML = `
            <div class="col-4"><div class="data-point-value">${preloadedData.distanceFormatted || '--'}</div><div class="data-point-label">ÊÄªÂÖ¨Èáå</div></div>
            <div class="col-4"><div class="data-point-value">${preloadedData.duration || '--'}</div><div class="data-point-label">ÊÄªÊó∂Èïø</div></div>
            <div class="col-4"><div class="data-point-value">${preloadedData.paceStr || '--'}</div><div class="data-point-label">Âπ≥ÂùáÈÖçÈÄü</div></div>
            <div class="col-4"><div class="data-point-value">${preloadedData.heartRate || '--'}</div><div class="data-point-label">Âπ≥ÂùáÂøÉÁéá</div></div>
        `;
        document.getElementById('viewPhotoBtn').style.display = 'none';
        document.getElementById('managePhotoBtn').style.display = localStorage.getItem('run_role') === 'admin' ? 'inline-block' : 'none';
        document.getElementById('detailAnalysisSectionsLoading').style.display = 'block';
        document.getElementById('detailAnalysisSections').style.display = 'none';
        document.getElementById('detailLapsTableBody').innerHTML = '';
        if(paceChart) paceChart.destroy();
        if(elevationChart) elevationChart.destroy();
        if(hrChart) hrChart.destroy();
        try {
            const response = await fetch(`https://run.linwn.net/data/details/${runId}.json`);
            if (!response.ok) throw new Error(`Could not load run data. Status: ${response.status}`);
            const data = await response.json();
            if(data.summary) {
              const max_hr = data.summary.max_hr || '--';
              const calories = data.summary.calories_kcal || '--';
              const avg_cadence = data.summary.avg_cadence || '--';
              const total_ascent = data.summary.total_ascent_m || '--';
              const avg_power = data.summary.avg_power_w || '--';
              detailDataGrid.innerHTML = `
                <div class="col-4"><div class="data-point-value">${preloadedData.distanceFormatted || '--'}</div><div class="data-point-label">ÊÄªÂÖ¨Èáå</div></div>
                <div class="col-4"><div class="data-point-value">${preloadedData.duration || '--'}</div><div class="data-point-label">ÊÄªÊó∂Èïø</div></div>
                <div class="col-4"><div class="data-point-value">${preloadedData.paceStr || '--'}</div><div class="data-point-label">Âπ≥ÂùáÈÖçÈÄü</div></div>
                <div class="col-4"><div class="data-point-value">${preloadedData.heartRate || '--'}</div><div class="data-point-label">Âπ≥ÂùáÂøÉÁéá</div></div>
                <div class="col-4"><div class="data-point-value">${max_hr}</div><div class="data-point-label">ÊúÄÈ´òÂøÉÁéá</div></div>
                <div class="col-4"><div class="data-point-value">${calories}</div><div class="data-point-label">Ê∂àËÄóÂçÉÂç°</div></div>
                <div class="col-4"><div class="data-point-value">${avg_cadence}</div><div class="data-point-label">Âπ≥ÂùáÊ≠•È¢ë</div></div>
                <div class="col-4"><div class="data-point-value">${total_ascent}</div><div class="data-point-label">Á¥ØËÆ°‰∏äÂçá(Á±≥)</div></div>
                <div class="col-4"><div class="data-point-value">${avg_power}</div><div class="data-point-label">Âπ≥ÂùáÂäüÁéá</div></div>
              `;
            }
            detailPhotoUrls = data.photos ? data.photos.map(p => p.url) : [];
            currentPolyline = data.route.encoded_polyline;
            const routeMapContainer = document.getElementById('routeMapContainer');
            routeMapContainer.innerHTML = '';
            if (detailMapInstance) {
                detailMapInstance.remove();
                detailMapInstance = null;
            }
            if (currentPolyline) {
                const mapItem = document.createElement('div');
                mapItem.innerHTML = `<div id="detail-map-item" class="d-block w-100" style="z-index: 5;"></div>`;
                routeMapContainer.appendChild(mapItem);
                setTimeout(() => {
                    const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
                    const tileUrl = isDark ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
                    detailMapInstance = L.map('detail-map-item', { 
                        attributionControl: false, 
                        dragging: false, zoomControl: false, scrollWheelZoom: false, 
                        doubleClickZoom: false, boxZoom: false, keyboard: false, 
                        tap: false, touchZoom: false
                    });
                    L.tileLayer(tileUrl, { subdomains: 'abcd' }).addTo(detailMapInstance);
                    const polyline = L.polyline(decodePolyline(currentPolyline), { color: getComputedStyle(document.documentElement).getPropertyValue('--accent-color'), weight: 4 }).addTo(detailMapInstance);
                    detailMapInstance.fitBounds(polyline.getBounds().pad(0.1));
                    detailMapInstance.invalidateSize();
                }, 100); 
            }
            document.getElementById('viewPhotoBtn').style.display = detailPhotoUrls.length > 0 ? 'inline-block' : 'none';
            let weatherString = '';
            if(data.weather) {
            if(data.weather.type && data.weather.type == 'forecast_api'){
              weatherString = '[È¢Ñ] ';
            }
            weatherString += `${data.weather.temperature_c}¬∞C, ${data.weather.condition}`;
            if(data.weather.wind_speed_kmh) {
                weatherString += ` | È£éÈÄü: ${data.weather.wind_speed_kmh} km/h`;
            }
            }
            document.getElementById('detailWeather').textContent = weatherString;
            const lapsBody = document.getElementById('detailLapsTableBody');
            if (data.laps && data.laps.length > 0) {
                lapsBody.innerHTML = data.laps.map(lap => {
                    let displayDuration = lap.duration;
                    if (displayDuration && displayDuration.startsWith('00:')) {
                        displayDuration = displayDuration.substring(3);
                    }
                    return `<tr><td>${lap.lap_number}</td><td>${displayDuration}</td><td>${lap.distance_km} km</td><td>${lap.pace}</td><td>${lap.avg_hr || 'N/A'}</td><td>${lap.avg_cadence || 'N/A'}</td></tr>`
                }).join('');
            }
            document.getElementById('detailAvgPace').textContent = data.summary.avg_pace || '--';
            document.getElementById('detailBestPace').textContent = data.summary.best_pace || '--';
            document.getElementById('detailAvgHr').textContent = data.summary.avg_hr || '--';
            document.getElementById('detailMaxHr').textContent = data.summary.max_hr || '--';
            const colors = getChartColors();
            const chartOptions = { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false }, ticks: { color: colors.tickColor } }, y: { grid: { color: colors.gridColor }, ticks: { color: colors.tickColor } } }, plugins: { legend: { display: false } } };
            if (data.charts.pace?.labels.length) {
                const avgPaceSeconds = parsePaceToSeconds(data.summary.avg_pace);
                const paceCtx = document.getElementById('paceChart').getContext('2d');
                paceChart = new Chart(paceCtx, { 
                    type: 'line', 
                    data: { labels: data.charts.pace.labels, datasets: [{ data: data.charts.pace.data, borderColor: colors.accentColor, borderWidth: 2, pointRadius: 0, fill: false, tension: 0.1 }] }, 
                    options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, reverse: true, ticks: { ...chartOptions.scales.y.ticks, callback: (value) => formatPaceFromSeconds(value) } } },
                    plugins: { ...chartOptions.plugins, annotation: { annotations: { avgLine: { type: 'line', yMin: avgPaceSeconds, yMax: avgPaceSeconds, borderColor: colors.annotationColor, borderWidth: 1.5, borderDash: [6, 6] } } } }
                    } 
                });
            }
            if (data.charts.hr?.labels.length) {
                const avgHr = data.summary.avg_hr;
                const hrCtx = document.getElementById('hrChart').getContext('2d');
                hrChart = new Chart(hrCtx, { 
                    type: 'line', 
                    data: { labels: data.charts.hr.labels, datasets: [{ data: data.charts.hr.data, borderColor: '#ff6b6b', borderWidth: 2, pointRadius: 0, fill: false, tension: 0.1 }] }, 
                    options: { ...chartOptions, 
                        plugins: { ...chartOptions.plugins, annotation: { annotations: { avgLine: { type: 'line', yMin: avgHr, yMax: avgHr, borderColor: colors.annotationColor, borderWidth: 1.5, borderDash: [6, 6] } } } }
                    }
                });
            }
            if (data.charts.elevation?.labels.length) {
                const elevationCtx = document.getElementById('elevationChart').getContext('2d');
                elevationChart = new Chart(elevationCtx, { type: 'line', data: { labels: data.charts.elevation.labels, datasets: [{ data: data.charts.elevation.data, borderColor: colors.accentColor, borderWidth: 2, pointRadius: 0, fill: { target: 'origin', above: `${colors.accentColor}33` } , tension: 0.1 }] }, options: chartOptions });
            }
            document.getElementById('detailAnalysisSectionsLoading').style.display = 'none';
            document.getElementById('detailAnalysisSections').style.display = 'block';
            await loadRunTags(runId);
            renderSuggestedTags();
            await refreshDetailComments(runId);
            if (scrollToComments) {
                document.getElementById('runDetailComments').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        } catch (error) {
            console.error("Error loading run detail:", error);
            document.getElementById('detailAnalysisSectionsLoading').style.display = 'none';
            currentPolyline = null;
        }
    }    
    /**
     * Core router function. Reads the URL hash and updates the UI accordingly.
     */
    function handleStateFromHash() {
        const hash = window.location.hash;
        const parts = hash.replace(/^#/, '').split('/'); // e.g., ["data", "run", "RUN_ID"]
    
        const tabId = parts[0] || 'summary';
        const tabTrigger = document.querySelector(`.nav-link[data-hash="${tabId}"]`);
        
        // Ensure the correct main tab is active
        if (tabTrigger && !tabTrigger.classList.contains('active')) {
            bootstrap.Tab.getOrCreateInstance(tabTrigger).show();
        }
    
        const runDetailModalEl = document.getElementById('runDetailModal');
        const modalInstance = bootstrap.Modal.getInstance(runDetailModalEl);
    
        // Check if the URL requests a specific run detail
        if (parts[1] === 'run' && parts[2]) {
            const runId = parts[2];
            
            // If the modal is not already shown for this run, open it
            if (!modalInstance || !modalInstance._isShown || currentDetailRunId !== runId) {
                const row = document.querySelector(`.run-detail-row[data-run-id="${runId}"], .recent-run-card[data-run-id="${runId}"]`);
                if (row) {
                    const preloadedData = {
                        distanceFormatted: row.dataset.distanceFormatted,
                        duration: row.dataset.duration,
                        paceStr: row.dataset.paceStr,
                        date: row.dataset.date,
                        heartRate: row.dataset.heartRate,
                    };
                    showRunDetailModal(runId, preloadedData);
                } else {
                     console.warn(`Run ID ${runId} from URL not found in the currently loaded list.`);
                }
            }
        } else {
            // If the URL does NOT specify a run, ensure the modal is closed
            if (modalInstance && modalInstance._isShown) {
                isHandlingPopState = true; // Set flag to prevent history change on hide
                modalInstance.hide();
            }
        }
    }  
    function setRandomQuote() {
        const quotes = [ "Ë∑ØÊº´Êº´ÂÖ∂‰øÆËøúÂÖÆ", "ÈÅìÈòª‰∏îÈïø" ];
        const quoteElement = document.getElementById('running-quote');
        if (quoteElement) {
            const randomIndex = Math.floor(Math.random() * quotes.length);
            quoteElement.textContent = quotes[randomIndex];
        }
    }
    function generateRandomProfile() {
        const adjectives = ['Âø´‰πê', 'ÂùöÂÆö', 'Èó™‰∫Æ', 'Ëø∑Ë∑Ø', 'Ê∏©Êüî'];
        const nouns = ['Â∞èÈπø', 'ÁªøË±ÜËäΩ', 'ÊòüÊòü', 'Áå´Âí™', 'Á∫∏È£ûÊú∫'];
        const icons = ['üå±','üå∏','üåü','üçÉ','üåä','üêæ','üåÄ','üåº'];
        return {
            icon: icons[Math.floor(Math.random() * icons.length)],
            nickname: `ÂåøÂêç${adjectives[Math.floor(Math.random() * adjectives.length)]}${nouns[Math.floor(Math.random() * nouns.length)]}`
        };
    }
    function loadProfileIntoModals() {
        let profile;
        const isAdmin = localStorage.getItem('run_role') === 'admin';
        if (isAdmin) {
            profile = { icon: 'üëë', nickname: 'ÁÆ°ÁêÜÂëò' };
            document.getElementById('editCalendarBtn').style.display = 'block';
        } else {
            document.getElementById('editCalendarBtn').style.display = 'none';
            try {
                profile = JSON.parse(localStorage.getItem('run_profile'));
                if (!profile || !profile.icon || !profile.nickname) { throw new Error("Invalid profile"); }
            } catch (e) {
                profile = generateRandomProfile();
                localStorage.setItem('run_profile', JSON.stringify(profile));
            }
        }
        document.getElementById('commentUserIcon').textContent = profile.icon;
        document.getElementById('commentUserNickname').textContent = profile.nickname;
        document.getElementById('detailCommentUserIcon').textContent = profile.icon;
        document.getElementById('detailCommentUserNickname').textContent = profile.nickname;
        document.getElementById('nicknameInput').value = profile.nickname;
        document.getElementById('nicknameInput').disabled = isAdmin;
        document.getElementById('saveProfileButton').style.display = isAdmin ? 'none' : 'inline-block';
    }
    // Helper function to get the admin secret via a prompt
    function getAdminSecret() {
        // This will show a dialog box asking for the password.
        // If the user clicks "Cancel", it returns null.
        const secret = prompt("ËØ∑ËæìÂÖ•ÁÆ°ÁêÜÂëòÂØÜÈí•:");
        return secret;
    }
    function initializeUserProfile() {
        const params = new URLSearchParams(window.location.search);
        const admin = params.get('admin');
        if (admin === 'yes') { 
            localStorage.setItem('run_role', 'admin');
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + window.location.hash;
            window.history.replaceState({path: newUrl}, '', newUrl);
        }
        loadProfileIntoModals();
        document.getElementById('saveProfileButton').addEventListener('click', () => {
            const newNickname = document.getElementById('nicknameInput').value.trim();
            if (newNickname) {
                const currentProfile = JSON.parse(localStorage.getItem('run_profile')) || generateRandomProfile();
                currentProfile.nickname = newNickname;
                localStorage.setItem('run_profile', JSON.stringify(currentProfile));
                loadProfileIntoModals();
                bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
            }
        });
    }
    function parsePaceToSeconds(paceStr) {
        if (!paceStr || !paceStr.includes("'")) { return 9999; }
        try {
            const parts = paceStr.replace('"', '').split("'");
            const minutes = parseInt(parts[0], 10);
            const seconds = parseInt(parts[1], 10);
            if (isNaN(minutes) || isNaN(seconds)) { return 9999; }
            return (minutes * 60) + seconds;
        } catch (e) {
            return 9999;
        }
    }
    function formatPaceFromSeconds(totalSeconds) {
        if (totalSeconds === null || totalSeconds === 0) return "0'00\"";
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = Math.round(totalSeconds % 60);
        return `${minutes}'${seconds.toString().padStart(2, '0')}"`;
    }
    async function loadCommentCounts() {
        document.querySelectorAll('.comment-count').forEach(async (el) => {
            const runId = el.dataset.runId;
            try {
                const res = await fetch(`${API_BASE}/count?runId=${encodeURIComponent(runId)}`);
                const data = await res.json();
                el.textContent = data.count ?? 0;
            } catch {
                el.textContent = 0;
            }
        });
    }
    function formatRelativeDate(dateString) {
        const runDate = new Date(dateString);
        const now = new Date();
        const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const startOfRunDate = new Date(runDate.getFullYear(), runDate.getMonth(), runDate.getDate());
        const diff = startOfToday - startOfRunDate;
        const diffInDays = diff / (1000 * 60 * 60 * 24);
        const timeStr = runDate.toTimeString().substring(0, 5);
        switch(diffInDays) {
            case 0: return `‰ªäÂ§© ${timeStr}`;
            case 1: return `Êò®Â§© ${timeStr}`;
            case 2: return `ÂâçÂ§© ${timeStr}`;
            default: return `${diffInDays}Â§©Ââç ${timeStr}`;
        }
    }
	  function updateRelativeTimestamps() {
        document.querySelectorAll('.recent-run-timestamp').forEach(el => {
            const dateString = el.closest('.recent-run-card').dataset.date;
            if (dateString) {
                el.textContent = formatRelativeDate(dateString);
            }
        });
    }  
    function initializeRaceCountdown() {
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
        const now = new Date();
        const upcomingRaces = marathonEventsCache
            .filter(event => event.status === '‰∏≠Á≠æÔºåÂèÇËµõ' && new Date(event.date.replace(/-/g, '/')) > now)
            .sort((a, b) => new Date(a.date.replace(/-/g, '/')) - new Date(b.date.replace(/-/g, '/')));
        const countdownContainer = document.getElementById('race-countdown-container');
        if (upcomingRaces.length === 0) {
            countdownContainer.style.display = 'none';
            return;
        }
        const nextRace = upcomingRaces[0];
        const targetDate = new Date(nextRace.date + "T07:00:00"); // Assuming race starts at 7 AM
        document.getElementById('countdown-race-name').textContent = `${nextRace.name} (${nextRace.category})`;
        document.getElementById('countdown-race-date').textContent = nextRace.date;
        countdownContainer.style.display = 'block';
        const updateCountdown = () => {
            const currentTime = new Date();
            const diff = targetDate - currentTime;
            if (diff <= 0) {
                clearInterval(countdownInterval);
                // Automatically find and start countdown for the next race
                setTimeout(initializeRaceCountdown, 2000);
                return;
            }
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            document.getElementById('cd-days').textContent = String(days).padStart(2, '0');
            document.getElementById('cd-hours').textContent = String(hours).padStart(2, '0');
            document.getElementById('cd-minutes').textContent = String(minutes).padStart(2, '0');
            document.getElementById('cd-seconds').textContent = String(seconds).padStart(2, '0');
        };
        updateCountdown();
        countdownInterval = setInterval(updateCountdown, 1000);
    }
    async function updateMarathonStats() {
        const pending = marathonEventsCache.filter(e => e.status === '‰∏≠Á≠æÔºåÂèÇËµõ').length;
        const lottery = marathonEventsCache.filter(e => e.status === 'Â∑≤Êä•ÂêçÔºåÂæÖÊäΩÁ≠æ').length;
        document.getElementById('stat-pending').textContent = pending;
        document.getElementById('stat-lottery').textContent = lottery;
    }
    async function generateMarathonList(filterStatus = 'all') {
        const container = document.getElementById('marathon-list-container');
        if (!container) return;
        container.innerHTML = '<div class="content-card text-center text-body-secondary">Âä†ËΩΩËµõÂéÜÊï∞ÊçÆ‰∏≠...</div>';
        let eventsToDisplay = marathonEventsCache;
        if (filterStatus !== 'all') {
            eventsToDisplay = marathonEventsCache.filter(e => e.status === filterStatus);
        }
        if (eventsToDisplay.length === 0) {
            container.innerHTML = `<div class="content-card text-center text-body-secondary">ÊöÇÊó†${filterStatus === 'all' ? '' : `‚Äú${filterStatus}‚ÄùÁä∂ÊÄÅÁöÑ`}Ëµõ‰∫ãËÆ°Âàí</div>`;
            return;
        }
        const sortedEvents = [...eventsToDisplay].sort((a, b) => new Date(a.date) - new Date(b.date));
        const statusBadges = {
            '‰∏≠Á≠æÔºåÂèÇËµõ': 'text-bg-success',
            'Â∑≤ÂÆåËµõ': 'text-bg-secondary',
            'Â∑≤Êä•ÂêçÔºåÂæÖÊäΩÁ≠æ': 'text-bg-primary',
            'Êú™‰∏≠Á≠æ': 'text-bg-danger',
            'Êä•Âêç‰∏≠': 'text-bg-info',
        };
        container.innerHTML = sortedEvents.map(event => {
            const levelBadge = (event.level && event.level !== 'ÊôÆÈÄöËµõ‰∫ã') 
                ? `<span class="badge rounded-pill text-bg-warning ms-2" style="font-size: 0.7em; vertical-align: middle;">${event.level}</span>` 
                : '';
            let willingnessStars = '';
            const willingness = parseInt(event.willingness, 10) || 0;
            if (willingness > 0) {
                let starsHtml = '';
                for (let i = 1; i <= 5; i++) {
                    starsHtml += `<i class="bi ${i <= willingness ? 'bi-star-fill' : 'bi-star'}" style="color: var(--trophy-color); font-size: 0.9em;"></i>`;
                }
                willingnessStars = `<span class="ms-2" title="ÊÑèÊÑøÂ∫¶: ${willingness}/5">${starsHtml}</span>`;
            }
            let channelInfo = '';
            if (event.channel) {
                const isLink = event.channel.startsWith('http');
                const channelContent = isLink
                    ? `<a href="${event.channel}" target="_blank" class="btn btn-sm btn-outline-primary py-0 px-1" style="font-size: 0.75rem;">ÂâçÂæÄÊä•Âêç</a>`
                    : `<span class="text-body-secondary">${event.channel}</span>`;
                channelInfo = `<div class="mt-1"><i class="bi bi-link-45deg me-1"></i><strong>Êä•ÂêçÊ∏†ÈÅì:</strong> ${channelContent}</div>`;
            }
            return `
            <div class="content-card mb-3">
                 <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center flex-wrap">
                        <h6 class="mb-0 fw-bold me-2">${event.name} <small class="text-body-secondary fw-normal">(${event.category})</small></h6>
                        ${levelBadge}
                        ${willingnessStars}
                    </div>
                    <span class="badge ${statusBadges[event.status] || 'text-bg-light'} text-nowrap">${event.status}</span>
                </div>
                <hr class="my-2" style="border-color: var(--border-color) !important; opacity: 0.5;">
                <div class="row g-2 small">
                    <div class="col-sm-4">
                        <i class="bi bi-flag-fill me-1" style="color:var(--marathon-color);"></i>
                        <strong>ÊØîËµõÊó•Êúü:</strong>
                        <span class="text-body-secondary ms-1">${event.date || 'ÂæÖÂÆö'}</span>
                    </div>
                    <div class="col-sm-4">
                        <i class="bi bi-pencil-square me-1" style="color:var(--accent-color);"></i>
                        <strong>Êä•ÂêçÊó∂ÊÆµ:</strong>
                        <span class="text-body-secondary ms-1">${(event.registration_start && event.registration_end) ? `${event.registration_start} ~ ${event.registration_end}` : 'ÂæÖÂÆö'}</span>
                    </div>
                    <div class="col-sm-4">
                        <i class="bi bi-ticket-detailed-fill me-1" style="color:var(--success-color);"></i>
                        <strong>Âá∫Á≠æÊó•Êúü:</strong>
                        <span class="text-body-secondary ms-1">${event.lottery_date || 'N/A'}</span>
                    </div>
                </div>
                <div class="race-details small">${channelInfo}</div>
            </div>`;
        }).join('');
    }
    async function generateMarathonCalendar() {
        const container = document.getElementById('marathon-calendar-container');
        const containerMarathonList = document.getElementById('marathon-list-container');
        if (!container || !containerMarathonList) return;
        containerMarathonList.innerHTML = '<div class="content-card text-center text-body-secondary">Âä†ËΩΩËµõÂéÜÊï∞ÊçÆ‰∏≠...</div>';
        try {
            if (marathonEventsCache.length === 0) {
                const response = await fetch(`${API_BASE}/marathon-events`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                marathonEventsCache = await response.json();
            }
            initializeRaceCountdown();
            await generateMarathonList(); 
            await updateMarathonStats();
        } catch (error) {
            console.error("Could not fetch marathon data:", error);
            containerMarathonList.innerHTML = '<div class="content-card text-center text-danger">Êó†Ê≥ïÂä†ËΩΩËµõÂéÜÊï∞ÊçÆÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ</div>';
            return;
        }
        // Process events into a date-keyed object
        const eventsByDate = {};
        marathonEventsCache.forEach(event => {
            const addEvent = (date, type) => {
                if (!date) return;
                if (!eventsByDate[date]) {
                    eventsByDate[date] = [];
                }
                eventsByDate[date].push({ ...event, type });
            };
            addEvent(event.date, 'race');
            addEvent(event.registration_start, 'registration_start');
            addEvent(event.registration_end, 'registration_end');
            addEvent(event.lottery_date, 'lottery');
        });
        if (marathonEventsCache.length === 0) {
            container.innerHTML = '<div class="content-card text-center text-body-secondary">ÊöÇÊó†Ëµõ‰∫ãËÆ°Âàí</div>';
            return;
        }
        let calendarHTML = '';
        const today = new Date();
        const today_num = today.getDate();
        today.setDate(1); // Start from the first day of the current month
        for (let i = 0; i < 6; i++) {
            const year = today.getFullYear();
            const month = today.getMonth() + 1; // getMonth is 0-indexed
            calendarHTML += `<div class="marathon-calendar-container">`;
            calendarHTML += `<div class="month-grid">`;
            calendarHTML += `<h4 class="mb-3">${year}Âπ¥ ${month}Êúà</h4>`;
            let gridHtml = `<table class="calendar-table">`;
            gridHtml += `<thead><tr>${['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'].map(d => `<th>${d}</th>`).join('')}</tr></thead>`;
            let tbodyHtml = '<tbody>';
            const firstDayOfMonth = new Date(year, month - 1, 1);
            const daysInMonth = new Date(year, month, 0).getDate();
            const startingDay = firstDayOfMonth.getDay();
            let date = 1;
            for (let row = 0; row < 6; row++) {
                if (date > daysInMonth) break;
                tbodyHtml += '<tr>';
                for (let col = 0; col < 7; col++) {
                    if ((row === 0 && col < startingDay) || date > daysInMonth) {
                        tbodyHtml += '<td class="empty"></td>';
                    } else {                        
                        const currentDateStr = `${year}-${String(month).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                        const eventsOnThisDay = eventsByDate[currentDateStr] || [];
                        let cellClass = '';
                        if (eventsOnThisDay.some(e => e.status === 'ÂæÖÊØîËµõ')) {
                            cellClass += ' lottery-win';
                        }
                        if(i === 0 && today_num === date ) {
                          cellClass += ' today';
                        }
                        tbodyHtml += `<td class="${cellClass}">`;
                        tbodyHtml += `<div class="day-number">${date}</div>`;
                        if (eventsOnThisDay.length > 0) {
                            const uniqueEventTypes = [...new Set(eventsOnThisDay.map(e => e.type))];
                            tbodyHtml += `<div class="day-markers">`;
                            uniqueEventTypes.forEach(type => {
                                tbodyHtml += `<div class="day-marker ${type.replaceAll('_', '-')}"></div>`;
                            });
                            tbodyHtml += `</div>`;
                            tbodyHtml += '<div class="day-popup-details">';
                            eventsOnThisDay.forEach(event => {
                                let typeText = '';
                                let eventTitleClass = '';
                                let eventTitleAfterIcon = '';
                                const levelInfo = (event.level && event.level !== 'ÊôÆÈÄöËµõ‰∫ã') ? `<div class="popup-event-type" style="color: var(--trophy-color);">${event.level}</div>` : '';
                                if(event.status === 'ÂæÖÊØîËµõ') {
                                  eventTitleClass = 'text-success';
                                  eventTitleAfterIcon = '<i class="bi bi-person-walking"></i>';
                                }                              
                                switch(event.type) {
                                    case 'race': typeText = 'ÊØîËµõÊó•'; break;
                                    case 'registration_start': 
                                        typeText = 'Êä•ÂêçÂºÄÂßã' + `<small class="small-muted">${event.registration_start}~${event.registration_end}</small>`;
                                        break;
                                    case 'registration_end': 
                                        typeText = 'Êä•ÂêçÊà™Ê≠¢' + `<small class="small-muted">${event.registration_start}~${event.registration_end}</small>`;
                                        break;                                    
                                    case 'lottery': typeText = 'Âá∫Á≠æÊó•'; break;
                                }
                                tbodyHtml += `<div class="popup-event-item">`;
                                tbodyHtml += `<span class="popup-event-title ${eventTitleClass}">${event.name} ${eventTitleAfterIcon}</span>`;
                                tbodyHtml += levelInfo;
                                tbodyHtml += `<span class="popup-event-type">${typeText}</span>`;
                                tbodyHtml += `</div>`;
                            });
                            tbodyHtml += '</div>';
                        }
                        tbodyHtml += '</td>';
                        date++;
                    }
                }
                tbodyHtml += '</tr>';
            }
            tbodyHtml += '</tbody></table></div></div>';
            gridHtml += tbodyHtml;
            calendarHTML += gridHtml;
            today.setMonth(today.getMonth() + 1);
        }
        container.innerHTML = calendarHTML;
    }
    async function initMarathonView() {
        const container = document.getElementById('marathon-calendar-container');
        if (container && (container.innerHTML.trim() === '' || container.innerHTML.includes('Âä†ËΩΩ'))) {
            await generateMarathonCalendar();
        }
    }
    function openMediaGallery(photoUrls, startIndex) {
        const galleryCarouselInner = document.getElementById('galleryCarouselInner');
        galleryCarouselInner.innerHTML = '';
        photoUrls.forEach((url, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'carousel-item';
            if (index === startIndex) {
                itemDiv.classList.add('active');
            }
            itemDiv.innerHTML = `<img src="${url}" class="d-block" alt="gallery image">`;
            galleryCarouselInner.appendChild(itemDiv);
        });
        const mediaGalleryModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('mediaGalleryModal'));
        mediaGalleryModal.show();
    }
    function renderRunTags() {
        const isAdmin = localStorage.getItem('run_role') === 'admin';
        const container = document.getElementById('runDetailTagsContainer');
        let tagsHtml = currentRunTags.map((tag, index) =>
            `<span class="badge rounded-pill text-bg-secondary me-1 mb-1" style="font-weight: 500; background-color: var(--hover-bg) !important; color: var(--text-secondary) !important; padding: 0.3em 0.5em;">
                ${sanitizeHTML(tag)}
                ${isAdmin ? `<button type="button" class="btn-close ms-1" aria-label="Remove tag" data-tag-index="${index}" style="font-size: 0.6em; filter: invert(0.8);"></button>` : ''}
            </span>`
        ).join('');
        if (currentRunTags.length === 0 && !isAdmin) {
            tagsHtml = '<p class="small text-body-secondary">ÊöÇÊó†Ê†áÁ≠æ</p>';
        }
        container.innerHTML = tagsHtml;
        document.getElementById('runDetailTagsEditor').style.display = isAdmin ? 'block' : 'none';
    }
    function renderSuggestedTags() {
        const container = document.getElementById('suggestedTagsContainer');
        container.innerHTML = suggestedTags.map(tag =>
            `<button type="button" class="btn btn-sm" data-tag-name="${tag}" style="font-size: 0.75rem; --bs-btn-padding-y: .1rem; --bs-btn-padding-x: .4rem; margin: 2px;">${tag}</button>`
        ).join('');
    }
    async function loadRunTags(runId) {
        try {
            const res = await fetch(`${API_BASE}/tags?runId=${encodeURIComponent(runId)}`);
            if (res.ok) {
                const data = await res.json();
                currentRunTags = data.tags || [];
            } else {
                currentRunTags = [];
            }
        } catch (e) {
            console.error("Failed to load tags:", e);
            currentRunTags = [];
        }
        renderRunTags();
    }
    async function saveRunTags(runId) {
        try {
            // NOTE: In a real app, this would require an admin secret key
            await fetch(`${API_BASE}/tags`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ runId: runId, tags: currentRunTags })
            });
        } catch (e) {
            console.error("Failed to save tags:", e);
            alert('Ê†áÁ≠æ‰øùÂ≠òÂ§±Ë¥•ÔºÅ');
        }
    }
    async function addTag(tag) {
        const trimmedTag = tag.trim();
        if (trimmedTag && !currentRunTags.includes(trimmedTag)) {
            currentRunTags.push(trimmedTag);
            renderRunTags();
            await saveRunTags(currentDetailRunId);
        }
    }
    async function removeTag(index) {
        currentRunTags.splice(index, 1);
        renderRunTags();
        await saveRunTags(currentDetailRunId);
    }
    function getChartColors() {
        const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
        if (isDark) {
            return {
                gridColor: 'rgba(128, 128, 128, 0.2)',
                tickColor: '#a8b3cf',
                accentColor: '#4dabf7',
                successColor: '#20c997',
                accentColorSecondary: '#fcc419',
                annotationColor: '#d63384'
            };
        } else {
            return {
                gridColor: 'rgba(0, 0, 0, 0.1)',
                tickColor: '#65676b',
                accentColor: '#0d6efd',
                successColor: '#198754',
                accentColorSecondary: '#ffc107',
                annotationColor: '#6f42c1'
            };
        }
    }
    function createAllCharts() {
        if (document.getElementById('dailyDistanceChart')) {
            const monthlyData = {{ chart_monthly_data|tojson }};
            const dailyRawData = {{ chart_30_days|tojson }};
            const yearlyData = {{ chart_yearly_data|tojson }};
            const monthOverMonthData = {{ chart_month_over_month|tojson }};
            const yearlyDualAxisData = {{ chart_yearly_dual_axis|tojson }};
            const today = new Date();
            const currentDay = today.getDate();
            const currentMonth = today.getMonth();
            const colors = getChartColors();
            const monthlyTotal = monthlyData.reduce((a, b) => a + b, 0);
            const monthlyAvg = monthlyData.filter(d => d > 0).length > 0 ? (monthlyTotal / monthlyData.filter(d => d > 0).length) : 0;
            const dailyTotal = dailyRawData.data.reduce((a, b) => a + b, 0);
            const dailyAvg = dailyRawData.data.filter(d => d > 0).length > 0 ? (dailyTotal / dailyRawData.data.filter(d => d > 0).length) : 0; 
            const yearlyTotal = yearlyData.reduce((a, b) => a + b, 0);
            const yearlyAvg = yearlyData.filter(d => d > 0).length > 0 ? (yearlyTotal / yearlyData.filter(d => d > 0).length) : 0;
            Chart.defaults.font.family = "'Noto Sans SC', sans-serif";
            const annotationDefaults = (avg) => ({ type: 'line', yMin: avg, yMax: avg, borderColor: colors.annotationColor, borderWidth: 1.5, borderDash: [6, 6] });
            // Daily Chart
            const dailyCtx = document.getElementById('dailyDistanceChart').getContext('2d');
            document.getElementById('dailyChartStats').innerHTML = `ÊÄªË∑ëÈáè: <strong>${dailyTotal.toFixed(1)}</strong> km <span class="mx-2">|</span> Ê¨°Âùá: <strong>${dailyAvg.toFixed(1)}</strong> km`;
            dailyDistanceChart = new Chart(dailyCtx, { 
                type: 'bar', 
                data: { labels: dailyRawData.labels, datasets: [{ label: 'Ë∑ùÁ¶ª (km)', data: dailyRawData.data, backgroundColor: dailyRawData.colors, borderColor: dailyRawData.colors.map(c => c.replace('0.6', '1')), borderWidth: 1, borderRadius: 2 }] }, 
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { color: colors.tickColor, callback: (v) => v + ' km'}}, x: { grid: { display: false }, ticks: { color: colors.tickColor, maxRotation: 0, minRotation: 0 }}}, plugins: { legend: { display: false }, title: { display: false }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.raw} km` }}, annotation: { annotations: { avgLine: annotationDefaults(dailyAvg) } } } } 
            });
            // Monthly Chart
            const monthlyCtx = document.getElementById('monthlyDistanceChart').getContext('2d');
            document.getElementById('monthlyChartStats').innerHTML = `ÊÄªË∑ëÈáè: <strong>${monthlyTotal.toFixed(1)}</strong> km <span class="mx-2">|</span> ÊúàÂùá: <strong>${monthlyAvg.toFixed(1)}</strong> km`;
            monthlyDistanceChart = new Chart(monthlyCtx, { type: 'bar', data: { labels: {{ chart_monthly_labels|tojson }}, datasets: [{ label: 'Ë∑ùÁ¶ª (km)', data: monthlyData, backgroundColor: colors.accentColor + '99', borderColor: colors.accentColor, borderWidth: 1, borderRadius: 4, hoverBackgroundColor: colors.accentColor }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { color: colors.tickColor, callback: (v) => v + ' km'}}, x: { grid: { display: false }, ticks: { color: colors.tickColor, maxRotation: 0, minRotation: 0 }}}, plugins: { legend: { display: false }, title: { display: false }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.raw} km` }}, annotation: { annotations: { avgLine: annotationDefaults(monthlyAvg) } } } } });
            // Yearly Chart
            const yearlyCtx = document.getElementById('yearlyDistanceChart').getContext('2d');
            document.getElementById('yearlyChartStats').innerHTML = `ÊÄªË∑ëÈáè: <strong>${yearlyTotal.toFixed(1)}</strong> km <span class="mx-2">|</span> Âπ¥Âùá: <strong>${yearlyAvg.toFixed(1)}</strong> km`;
            yearlyDistanceChart = new Chart(yearlyCtx, { type: 'bar', data: { labels: {{ chart_yearly_labels|tojson }}, datasets: [{ label: 'Ë∑ùÁ¶ª (km)', data: yearlyData, backgroundColor: colors.accentColor + '99', borderColor: colors.accentColor, borderWidth: 1, borderRadius: 4, hoverBackgroundColor: colors.accentColor }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { color: colors.tickColor, callback: (v) => v + ' km'}}, x: { grid: { display: false }, ticks: { color: colors.tickColor, maxRotation: 0, minRotation: 0 } } }, plugins: { legend: { display: false }, title: { display: false }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.raw} km` }}, annotation: { annotations: { avgLine: annotationDefaults(yearlyAvg) } } } } });
            // Month-over-Month Chart
            const monthOverMonthCtx = document.getElementById('monthOverMonthChart').getContext('2d');
            const diffText = monthOverMonthData.summary.diff_km >= 0 ? `+${monthOverMonthData.summary.diff_km}` : monthOverMonthData.summary.diff_km;
            document.getElementById('monthOverMonthChartStats').innerHTML = `Êú¨ÊúàË∑ëÈáè: <strong>${monthOverMonthData.summary.this_month_total}</strong> km <span class="mx-2">|</span> ËæÉ‰∏äÊúàÂêåÊúü: <strong>${diffText}</strong> km`;
            const thisMonthTruncatedData = monthOverMonthData.this_month_data.slice(0, currentDay);
            monthOverMonthChart = new Chart(monthOverMonthCtx, {
                type: 'line',
                data: {
                    labels: monthOverMonthData.labels,
                    datasets: [
                        { label: 'Êú¨Êúà', data: thisMonthTruncatedData, borderColor: colors.accentColor, borderWidth: 3, pointRadius: 1, fill: false, tension: 0.1 },
                        { label: '‰∏äÊúà', data: monthOverMonthData.last_month_data, borderColor: 'rgba(128, 128, 128, 0.7)', borderWidth: 2, borderDash: [5, 5], pointRadius: 1, fill: false, tension: 0.1 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { color: colors.tickColor, callback: v => v + ' km' } }, x: { grid: { display: false }, ticks: { color: colors.tickColor } } }, plugins: { legend: { labels: { color: colors.tickColor } }, title: { display: false }, annotation: { annotations: { todayLine: { type: 'line', xMin: currentDay - 1, xMax: currentDay - 1, borderColor: 'rgba(128, 128, 128, 0.5)', borderWidth: 1.5, borderDash: [6, 6] } } } } }
            });
            // Yearly Dual Axis Chart
            const yearlyDualAxisCtx = document.getElementById('yearlyDualAxisChart').getContext('2d');
            document.getElementById('yearlyDualAxisChartStats').innerHTML = `‰ªäÂπ¥ÊÄªË∑ëÈáè: <strong>${yearlyDualAxisData.total}</strong> km`;
            const cumulativeTruncatedData = yearlyDualAxisData.cumulative_data.slice(0, currentMonth + 1);
            yearlyDualAxisChart = new Chart(yearlyDualAxisCtx, {
                type: 'bar',
                data: {
                    labels: yearlyDualAxisData.labels,
                    datasets: [
                        { type: 'bar', label: 'ÊúàÂ∫¶Ë∑ëÈáè', data: yearlyDualAxisData.monthly_data, backgroundColor: colors.accentColor + '99', borderColor: colors.accentColor, yAxisID: 'y' },
                        { type: 'line', label: 'Á¥ØËÆ°Ë∑ëÈáè', data: cumulativeTruncatedData, borderColor: colors.accentColorSecondary, borderWidth: 3, pointRadius: 2, fill: false, tension: 0.1, yAxisID: 'y1' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { x: { grid: { display: false }, ticks: { color: colors.tickColor } }, y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'ÊúàÂ∫¶Ë∑ëÈáè (km)', color: colors.tickColor }, grid: { color: colors.gridColor }, ticks: { color: colors.tickColor } }, y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Á¥ØËÆ°Ë∑ëÈáè (km)', color: colors.tickColor }, grid: { drawOnChartArea: false }, ticks: { color: colors.tickColor } } }, plugins: { legend: { labels: { color: colors.tickColor } }, title: { display: false } } }
            });
        }
    }
    function destroyAllCharts() {
      if(monthlyDistanceChart) monthlyDistanceChart.destroy();
      if(dailyDistanceChart) dailyDistanceChart.destroy();
      if(yearlyDistanceChart) yearlyDistanceChart.destroy();
      if(monthOverMonthChart) monthOverMonthChart.destroy();
      if(yearlyDualAxisChart) yearlyDualAxisChart.destroy();
    }
    function recreateAllCharts() {
        destroyAllCharts();
        createAllCharts();
    } 
    function renderMediaEditorList() {
        const listContainer = document.getElementById('media-manager-list');
        if (currentEditingMedia.length === 0) {
            listContainer.innerHTML = '<p class="text-secondary">Ê≠§ËÆ∞ÂΩïÊöÇÊó†Â™í‰ΩìÊñá‰ª∂„ÄÇ</p>';
            return;
        }
    
        listContainer.innerHTML = currentEditingMedia.map((item, index) => `
            <div class="d-flex align-items-start p-2 mb-2 rounded" style="background-color: var(--hover-bg);" data-index="${index}">
                <img src="${sanitizeHTML(item.thumb_url || item.poster_url || item.url)}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;" class="me-3 flex-shrink-0">
                <div class="flex-grow-1">
                    <textarea class="form-control form-control-sm description-input" rows="2" placeholder="Ê∑ªÂä†ÊèèËø∞...">${sanitizeHTML(item.description) || ''}</textarea>
                    <div class="mt-1 input-group input-group-sm">
                        <span class="input-group-text" style="font-size: 0.7rem;">URL</span>
                        <input type="text" class="form-control url-input" value="${item.url}">
                    </div>
                </div>
                <div class="ms-2 d-flex flex-column">
                    <button class="btn btn-sm btn-outline-danger delete-media-btn mb-1" title="Âà†Èô§">&times;</button>
                    <button class="btn btn-sm btn-secondary move-up-btn" title="‰∏äÁßª" ${index === 0 ? 'disabled' : ''}>‚ñ≤</button>
                    <button class="btn btn-sm btn-secondary move-down-btn mt-1" title="‰∏ãÁßª" ${index === currentEditingMedia.length - 1 ? 'disabled' : ''}>‚ñº</button>
                </div>
            </div>
        `).join('');
    }              
    async function uploadFile(file, progressContainer, adminSecret) {
        const progressId = `progress-${Date.now()}`;
        const progressHtml = `
            <div id="${progressId}" class="progress mt-2" style="height: 5px;">
                <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <small class="text-secondary">${file.name}</small>
        `;
        progressContainer.innerHTML += progressHtml;
        const progressBar = document.querySelector(`#${progressId} .progress-bar`);
        // Simulate progress for better UX as fetch doesn't support it natively
        let width = 0;
        const interval = setInterval(() => {
            if (width < 90) {
                width += 5;
                progressBar.style.width = width + '%';
            }
        }, 100);
    
        try {
            const formData = new FormData();
            formData.append('file', file);
    
            const response = await fetch(`${API_BASE}/api/upload`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${adminSecret}` },
                body: formData,
            });
    
            clearInterval(interval);
            progressBar.style.width = '100%';
    
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || 'Upload failed');
            }
    
            const result = await response.json();
            
            // Add new media to the editing list
            currentEditingMedia.push({
                id: `media-item-${Date.now()}`,
                type: file.type.startsWith('video/') ? 'video' : 'image',
                url: result.url,
                thumb_url: result.url, // For simplicity, thumb is same as full
                poster_url: '',
                description: ''
            });
            
            renderMediaEditorList(); // Refresh the list
            document.getElementById(progressId).remove(); // Clean up progress bar
    
        } catch (error) {
            clearInterval(interval);
            progressBar.classList.add('bg-danger');
            alert(`Upload failed for ${file.name}: ${error.message}`);
        }
    }              
    document.addEventListener('DOMContentLoaded', function() {
        setTheme(getPreferredTheme());        
        initializeUserProfile();
        loadCommentCounts();
        updateRelativeTimestamps();
        document.querySelectorAll("object[type='image/svg+xml']").forEach(obj => {
          const url = obj.getAttribute("data");
          fetch(url)
            .then(resp => resp.text())
            .then(svgText => {
              const parser = new DOMParser();
              const svgDoc = parser.parseFromString(svgText, "image/svg+xml");
              const svgEl = svgDoc.documentElement;
              obj.replaceWith(svgEl);
            })
            .catch(err => console.error("SVG load error:", err));
        });
        createAllCharts(); 
        const runDetailModalEl = document.getElementById('runDetailModal');
        runDetailModalEl.addEventListener('hidden.bs.modal', () => {
            // This event fires when the modal has finished being hidden
            if (isHandlingPopState) {
                isHandlingPopState = false; // Reset flag and do nothing
                return;
            }
            
            // If the modal was closed manually (not by back button), update the URL
            if (window.location.hash.includes('/run/')) {
                const baseTabHash = '#' + document.querySelector('#main-nav-tabs .nav-link.active').dataset.hash;
                history.pushState(null, "", baseTabHash);
            }
            currentDetailRunId = null; // Clear the current run ID
        });
        // Listen for browser back/forward button clicks
        window.addEventListener('popstate', handleStateFromHash);
    
        // Handle the initial URL state when the page loads
        // We wrap it in a setTimeout to ensure the rest of the page, especially the run list, has had a chance to render.
        setTimeout(handleStateFromHash, 100);
    
        // The existing 'shown.bs.tab' listener for updating the hash when changing tabs is still good,
        // but we need to make sure it doesn't interfere.
        document.querySelectorAll('#main-nav-tabs .nav-link').forEach(tabEl => {
            tabEl.addEventListener('shown.bs.tab', event => {
                const newHash = '#' + event.target.dataset.hash;
                // Only update the hash if we are not already in a detailed view
                if (!window.location.hash.includes('/run/')) {
                     if (window.location.hash !== newHash) {
                        history.pushState(null, '', newHash);
                     }
                }
            });
        });      
        // Fetch the list of runs that have media
        (async () => {
            try {
                const response = await fetch(`${API_BASE}/api/media/list`);
                if (response.ok) {
                    const ids = await response.json();
                    mediaRunIds = new Set(ids);
                    //console.log('Successfully loaded media list.', mediaRunIds);
                } else {
                    console.error('Server responded with an error for media list:', response.status);
                }
            } catch (error) {
                console.error('Could not fetch media list:', error);
            }
        })();      
        document.getElementById('editProfileTrigger').addEventListener('click', () => { new bootstrap.Modal(document.getElementById('profileModal')).show(); });
        document.getElementById('detailEditProfileTrigger').addEventListener('click', () => { new bootstrap.Modal(document.getElementById('profileModal')).show(); });
        document.getElementById('addTagButton').addEventListener('click', async () => {
            const input = document.getElementById('runDetailTagInput');
            await addTag(input.value);
            input.value = '';
        });
        document.getElementById('runDetailTagInput').addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const input = document.getElementById('runDetailTagInput');
                await addTag(input.value);
                input.value = '';
            }
        });
        document.getElementById('runDetailTagsContainer').addEventListener('click', (e) => {
            if (e.target.matches('button.btn-close')) {
                const index = parseInt(e.target.dataset.tagIndex, 10);
                removeTag(index);
            }
        });
        document.getElementById('suggestedTagsContainer').addEventListener('click', async (e) => {
            if (e.target.matches('button')) {
                const tagName = e.target.dataset.tagName;
                await addTag(tagName);
            }
        });
        document.getElementById('goto-data-tab')?.addEventListener('click', e => {
            e.preventDefault();
            const dataTab = document.getElementById('data-tab');
            if (dataTab) {
                bootstrap.Tab.getOrCreateInstance(dataTab).show();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });
        const mediaManagerModalEl = document.getElementById('mediaManagerModal');
        if (mediaManagerModalEl) {
            mediaManagerModalInstance = new bootstrap.Modal(mediaManagerModalEl);
        }  
        // Listen for file selection
        document.getElementById('media-file-input')?.addEventListener('change', async (e) => {
            const files = e.target.files;
            const progressContainer = document.getElementById('upload-progress-container');
            if (!files.length) return;
        
            // Prompt for the secret ONCE before uploading all selected files.
            const adminSecret = getAdminSecret();
            if (!adminSecret) {
                alert("Êú™Êèê‰æõÂØÜÈí•Ôºå‰∏ä‰º†Êìç‰ΩúÂ∑≤ÂèñÊ∂à„ÄÇ");
                e.target.value = ''; // Reset the file input
                return;
            }
            
            e.target.disabled = true;
            for (const file of files) {
                // Pass the prompted secret to the upload function
                await uploadFile(file, progressContainer, adminSecret);
            }
            e.target.disabled = false;
            e.target.value = ''; // Reset file input
        });
      
        // ---- Â§ÑÁêÜÂºπÁ™óÂÜÖÁöÑÁÇπÂáª‰∫ã‰ª∂ ----
        mediaManagerModalEl.addEventListener('click', (e) => {
            const target = e.target;
            const itemEl = target.closest('[data-index]');
            const index = itemEl ? parseInt(itemEl.dataset.index, 10) : -1;
        
            // Âà†Èô§
            if (target.classList.contains('delete-media-btn')) {
                if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Â™í‰ΩìÈ°πÂêóÔºü')) {
                    currentEditingMedia.splice(index, 1);
                    renderMediaEditorList();
                }
            }
            // ‰∏äÁßª
            else if (target.classList.contains('move-up-btn') && index > 0) {
                [currentEditingMedia[index], currentEditingMedia[index - 1]] = [currentEditingMedia[index - 1], currentEditingMedia[index]];
                renderMediaEditorList();
            }
            // ‰∏ãÁßª
            else if (target.classList.contains('move-down-btn') && index < currentEditingMedia.length - 1) {
                [currentEditingMedia[index], currentEditingMedia[index + 1]] = [currentEditingMedia[index + 1], currentEditingMedia[index]];
                renderMediaEditorList();
            }
            // ‰ªéURLÊñáÊú¨Ê°ÜÊ∑ªÂä†Êñ∞Â™í‰Ωì
            else if (target.id === 'add-media-from-urls') {
                const urlsText = document.getElementById('new-media-urls');
                const urls = urlsText.value.split('\n').map(u => u.trim()).filter(Boolean);
                urls.forEach(url => {
                    currentEditingMedia.push({
                        id: `media-item-${Date.now()}-${Math.random()}`, // ‰∏¥Êó∂ÂîØ‰∏ÄID
                        type: url.toLowerCase().endsWith('.mp4') ? 'video' : 'image',
                        url: url,
                        description: ''
                    });
                });
                urlsText.value = '';
                renderMediaEditorList();
            }
        });
        
        // ---- Â§ÑÁêÜÂºπÁ™óÂÜÖÁöÑËæìÂÖ•‰∫ã‰ª∂ (ÂÆûÊó∂Êõ¥Êñ∞Êï∞ÊçÆ) ----
        mediaManagerModalEl.addEventListener('input', (e) => {
            const target = e.target;
            const itemEl = target.closest('[data-index]');
            if (!itemEl) return;
            const index = parseInt(itemEl.dataset.index, 10);
        
            if (target.classList.contains('description-input')) {
                currentEditingMedia[index].description = target.value;
            } else if (target.classList.contains('url-input')) {
                currentEditingMedia[index].url = target.value;
            }
        });      

        document.getElementById('saveMediaChanges').addEventListener('click', async () => {
            const saveButton = document.getElementById('saveMediaChanges');
            const adminSecret = getAdminSecret();
            if (!adminSecret) {
                alert("Êìç‰ΩúÂ∑≤ÂèñÊ∂à„ÄÇ");
                return; // Abort if the user cancels the prompt
            }          
            saveButton.disabled = true;
            saveButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ‰øùÂ≠ò‰∏≠...`;
        
            try {
              const response = await fetch(`${API_BASE}/api/media/${currentDetailRunId}`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${adminSecret}`
                  },
                  body: JSON.stringify({ media: currentEditingMedia })
              });
      
              if (!response.ok) throw new Error('Save failed, server returned an error.');
      
              // Success
              currentRunMedia.media = JSON.parse(JSON.stringify(currentEditingMedia));
              renderMediaViewer(); // Re-render the main view
              mediaManagerModalInstance.hide();
              // Also update the main page filter data
              mediaRunIds.add(currentDetailRunId);
        
            } catch (error) {
                console.error('‰øùÂ≠òÂ™í‰ΩìÊï∞ÊçÆÊó∂Âá∫Èîô:', error);
                alert(`‰øùÂ≠òÂ§±Ë¥•: ${error.message}`);
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="bi bi-check-circle me-1"></i> ‰øùÂ≠òÊõ¥ÊîπÂà∞ÊúçÂä°Âô®';
            }
        });
      
        let startX = 0, startY = 0;
        const tabContent = document.querySelector('.tab-content');
        const minSwipeDistance = 100;
        tabContent.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; startY = e.touches[0].clientY; }, { passive: true });
        tabContent.addEventListener('touchend', (e) => {
          if (e.target.closest('#cityMap') || e.target.closest('.calendar-table')) return;
          const endX = e.changedTouches[0].clientX;
          const diffX = endX - startX;
          if (Math.abs(diffX) > minSwipeDistance && Math.abs(diffX) > Math.abs(e.changedTouches[0].clientY - startY)) {
            const activeTab = document.querySelector('#main-nav-tabs .nav-link.active');
            const tabs = Array.from(document.querySelectorAll('#main-nav-tabs .nav-link'));
            const currentIndex = tabs.indexOf(activeTab);
            if (diffX > 0 && currentIndex > 0) {
                bootstrap.Tab.getOrCreateInstance(tabs[currentIndex - 1]).show();
            } else if (diffX < 0 && currentIndex < tabs.length - 1) {
                bootstrap.Tab.getOrCreateInstance(tabs[currentIndex + 1]).show();
            }
          }
        }, { passive: true });
        /*const activateTabFromHash = () => {
          let hash = window.location.hash.substring(1);
          const tabTrigger = document.querySelector(`.nav-link[data-hash="${hash}"]`);
          if (tabTrigger) { 
              bootstrap.Tab.getOrCreateInstance(tabTrigger).show(); 
          } else {
              bootstrap.Tab.getOrCreateInstance(document.getElementById('summary-tab')).show();
          }
        };*/
        document.querySelectorAll('#main-nav-tabs .nav-link').forEach(tabEl => {
          tabEl.addEventListener('shown.bs.tab', event => {
            const hash = event.target.dataset.hash;
            if (hash && ('#' + hash) !== window.location.hash) { 
                history.pushState(null, '', '#' + hash); 
            }
            if (hash === 'marathon') { initMarathonView(); }
            if (hash === 'events' && !cityMap) {
                const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
                const tileUrl = isDark ? 
                    'https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png' :
                    'https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png';
                cityMap = L.map('cityMap', { center: [36, 108], zoom: 4, zoomControl: false });
                L.tileLayer(tileUrl, { attribution: '', subdomains: 'abcd', minZoom: 3, maxZoom: 18 }).addTo(cityMap);
                cityMap.attributionControl.setPrefix('');
                cityStatsData.forEach(city => {
                    if (city.coordinates && city.coordinates.length === 2) {
                        L.circleMarker([city.coordinates[0], city.coordinates[1]], { 
                            radius: Math.log(city.count) + 3, 
                            fillColor: "var(--accent-color)", 
                            color: "var(--text-primary)", 
                            weight: 1.5, 
                            opacity: 1, 
                            fillOpacity: 0.7 
                        }).addTo(cityMap).bindPopup(`<b>${city.name}</b><br>Ë∑ëÊ≠•Ê¨°Êï∞: ${city.count}<br>ÊÄªË∑ùÁ¶ª: ${city.distance} km`);
                    }
                });
            } else if (hash === 'events' && cityMap) {
                cityMap.invalidateSize();
            }
          });
        });
        //window.addEventListener('popstate', activateTabFromHash);
        //activateTabFromHash(); // Initial load
        if (window.location.hash === '#marathon') { initMarathonView(); }
        document.querySelectorAll('.stat-card-flip-container').forEach(container => {
            container.addEventListener('click', (event) => {
                event.currentTarget.querySelector('.stat-card-flipper').classList.toggle('flipped');
            });
        });
        document.querySelectorAll('#chart-toggle .btn').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('#chart-toggle .btn').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                const chartType = this.dataset.chart;
                const containers = {
                    monthly: document.getElementById('monthlyChartContainer'),
                    daily: document.getElementById('dailyChartContainer'),
                    yearly: document.getElementById('yearlyChartContainer'),
                    'month-over-month': document.getElementById('monthOverMonthChartContainer'),
                    'yearly-dual-axis': document.getElementById('yearlyDualAxisChartContainer')
                };
                Object.values(containers).forEach(c => c.style.display = 'none');
                containers[chartType].style.display = 'block';
            });
        });        
        const dataPane = document.getElementById('data-pane');
        if (dataPane) {
            allRunRows = Array.from(document.querySelectorAll('#summary-table-body tr'));
            const updateDataView = () => {
                const minDist = parseFloat(document.querySelector('#data-dist-filter-toggle .active').dataset.dist);
                const maxPace = parseFloat(document.querySelector('#data-pace-filter-toggle .active').dataset.pace);
                const selectedCity = document.getElementById('data-city-filter').value;
                const startDate = document.getElementById('date-filter-start').value;
                const endDate = document.getElementById('date-filter-end').value;
                const mediaOnly = document.getElementById('data-media-filter').checked;
                const activeSortHeader = document.querySelector('.sortable-header[aria-sort]');
                const sortProp = activeSortHeader ? activeSortHeader.dataset.sort : 'date';
                const sortOrder = activeSortHeader ? activeSortHeader.getAttribute('aria-sort') : 'descending';
                let filteredRows = allRunRows.filter(row => {
                    const runId = row.dataset.runId;
                    const mediaCondition = !mediaOnly || mediaRunIds.has(runId);
                    const isVisible = (parseFloat(row.dataset.distance) >= minDist) &&
                                    (parsePaceToSeconds(row.dataset.paceStr) <= maxPace) &&
                                    (selectedCity === 'all' || row.dataset.city === selectedCity) &&
                                    (!startDate || row.dataset.date >= startDate) &&
                                    (!endDate || row.dataset.date <= endDate) &&
                                    (mediaCondition);
                    row.style.display = isVisible ? '' : 'none';
                    return isVisible;
                });
                filteredRows.sort((a, b) => {
                    let valA, valB;
                    if (sortProp === 'distance') { [valA, valB] = [parseFloat(a.dataset.distance), parseFloat(b.dataset.distance)]; } 
                    else if (sortProp === 'pace') { [valA, valB] = [(-1)*parsePaceToSeconds(a.dataset.paceStr), (-1)*parsePaceToSeconds(b.dataset.paceStr)]; } 
                    else { [valA, valB] = [a.dataset.date, b.dataset.date]; }
                    if (valA < valB) return sortOrder === 'ascending' ? -1 : 1;
                    if (valA > valB) return sortOrder === 'ascending' ? 1 : -1;
                    return 0;
                });
                document.getElementById('summary-table-body').append(...filteredRows);
            };
            const clearFilters = () => {
                document.getElementById('date-filter-start').value = '';
                document.getElementById('date-filter-end').value = '';
                document.getElementById('data-city-filter').value = 'all';                
                document.querySelector('#data-dist-filter-toggle .active').classList.remove('active');
                document.querySelector('#data-dist-filter-toggle button[data-dist="0"]').classList.add('active');
                document.querySelector('#data-pace-filter-toggle .active').classList.remove('active');
                document.querySelector('#data-pace-filter-toggle button[data-pace="9999"]').classList.add('active');
                updateDataView();
            };
            document.getElementById('clear-filters-btn').addEventListener('click', clearFilters);
            document.getElementById('data-view-toggle').addEventListener('click', (e) => {
                if (!e.target.matches('button')) return;
                document.querySelector('#data-view-toggle .active').classList.remove('active');
                e.target.classList.add('active');
                const isSummary = e.target.dataset.view === 'summary';
                document.getElementById('summary-data-view').style.display = isSummary ? '' : 'none';
                document.getElementById('yearly-data-view').style.display = isSummary ? 'none' : '';
                document.getElementById('data-controls-collapse').classList.toggle('d-lg-block', isSummary);
                document.getElementById('summary-controls-toggle').style.display = isSummary ? '' : 'none';
                if(isSummary) updateDataView();
            });
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', () => {
                    const currentSort = header.getAttribute('aria-sort');
                    let newSort = (currentSort === 'descending') ? 'ascending' : 'descending';
                    document.querySelectorAll('.sortable-header').forEach(h => h.removeAttribute('aria-sort'));
                    header.setAttribute('aria-sort', newSort);
                    updateDataView();
                });
            });
            [...document.querySelectorAll('#data-dist-filter-toggle, #data-pace-filter-toggle')].forEach(group => {
                group.addEventListener('click', e => {
                    if(e.target.tagName === 'BUTTON') {
                        group.querySelector('.active').classList.remove('active');
                        e.target.classList.add('active');
                        updateDataView();
                    }
                });
            });
            ['data-city-filter', 'date-filter-start', 'date-filter-end', 'data-media-filter'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateDataView);
            });
            updateDataView();
        }
        const eventsPane = document.getElementById('events-pane');
        if (eventsPane) {
            eventsPane.querySelector('#events-view-toggle').addEventListener('click', (e) => {
                if (!e.target.matches('button')) return;
                eventsPane.querySelector('#events-view-toggle .active').classList.remove('active');
                e.target.classList.add('active');
                const isCategory = e.target.dataset.view === 'category';
                eventsPane.querySelector('#events-category-view').style.display = isCategory ? '' : 'none';
                eventsPane.querySelector('#events-timeline-view').style.display = isCategory ? 'none' : 'block';
            });
        }
        const marathonPane = document.getElementById('marathon-pane');
        if (marathonPane) {
            document.getElementById('marathon-controls-container').addEventListener('click', (e) => {
                const button = e.target.closest('.stat-filter-button');
                if (!button) return;
                document.querySelectorAll('#marathon-controls-container .stat-filter-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const filterType = button.dataset.filterType;
                const filterValue = button.dataset.filterValue;
                if (filterType === 'status') {
                    document.getElementById('marathon-list-view').style.display = 'block';
                    document.getElementById('marathon-calendar-view').style.display = 'none';
                    generateMarathonList(filterValue);
                } else if (filterType === 'view' && filterValue === 'calendar') {
                    document.getElementById('marathon-list-view').style.display = 'none';
                    document.getElementById('marathon-calendar-view').style.display = 'block';
                }
            });
        }
        const viewToggleButtonGroup = document.getElementById('detail-view-toggle');
        const routeMapContainer = document.getElementById('routeMapContainer');
        const mediaViewerContainer = document.getElementById('mediaViewerContainer');
        mediaViewerContainer.addEventListener('click', (e) => {
            // Ê£ÄÊü•ÁÇπÂáªÁöÑÊòØÂê¶ÊòØ‚Äú‰∏ä‰º†/ÁÆ°ÁêÜ‚ÄùÊåâÈíÆ
            const uploadButton = e.target.closest('.btn-primary');
            if (uploadButton) {
                // ÂÖ≥ÈîÆÊìç‰ΩúÔºöÊ∑±Êã∑Ë¥ùÂΩìÂâçÂ™í‰ΩìÊï∞ÊçÆÂà∞‰∏¥Êó∂ÂèòÈáèÔºåÈÅøÂÖçÁõ¥Êé•‰øÆÊîπÂéüÂßãÊï∞ÊçÆ
                currentEditingMedia = JSON.parse(JSON.stringify(currentRunMedia.media || []));
        
                // Ê∏≤ÊüìÁºñËæëÂô®ÂàóË°®
                renderMediaEditorList();
        
                // ÊòæÁ§∫ÂºπÁ™ó
                mediaManagerModalInstance.show();
            }
        });
        viewToggleButtonGroup.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
        
            // Update active button state
            viewToggleButtonGroup.querySelector('.active').classList.remove('active');
            button.classList.add('active');
        
            const view = button.dataset.view;
            if (view === 'map') {
                mediaViewerContainer.style.display = 'none';
                routeMapContainer.style.display = 'block';
                if (detailMapInstance) {
                    detailMapInstance.invalidateSize(); // Important for Leaflet
                }
            } else if (view === 'media') {
                routeMapContainer.style.display = 'none';
                mediaViewerContainer.style.display = 'block';
        
                // Lazy load media data only on the first click
                if (!hasFetchedMedia) {
                    try {
                        // This is a placeholder for your actual API call
                        const response = await fetch(`${API_BASE}/api/media/${currentDetailRunId}`);
                        if (response.ok) {
                            currentRunMedia = await response.json();
                        } else {
                            currentRunMedia = { media: [] }; // Assume no media on 404
                        }
                    } catch (error) {
                        console.error("Failed to fetch media:", error);
                        currentRunMedia = { media: [] };
                    } finally {
                        hasFetchedMedia = true;
                        renderMediaViewer();
                    }
                }
            }
        });
        
        function renderMediaViewer() {
            const isAdmin = localStorage.getItem('run_role') === 'admin';
            let content = '';
        
            if (currentRunMedia && currentRunMedia.media.length > 0) {
                content = `<div class="row g-2">` + currentRunMedia.media.map(item => `
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100">
                            <img src="${sanitizeHTML(item.thumb_url || item.poster_url || item.url)}" class="card-img-top" style="height: 150px; object-fit: cover;">
                            <div class="card-body">
                                <p class="card-text small">${sanitizeHTML(item.description) || ''}</p>
                            </div>
                        </div>
                    </div>
                `).join('') + `</div>`;
            } else {
                content = `<div class="text-center p-5 text-body-secondary">
                    <i class="bi bi-camera" style="font-size: 3rem;"></i>
                    <p class="mt-2">ÊöÇÊó†ÂΩ±Èü≥ËÆ∞ÂΩï</p>
                </div>`;
            }
        
            // Add "Upload" button for admin
            if (isAdmin) {
                content += `<div class="text-center mt-4 border-top pt-3">
                    <button class="btn btn-primary btn-sm"><i class="bi bi-upload me-1"></i> ‰∏ä‰º†/ÁÆ°ÁêÜÂΩ±Èü≥</button>
                </div>`;
            }
        
            mediaViewerContainer.innerHTML = content;
        }      
        function renderCommentList(container, comments) {
            container.style.color = 'var(--text-primary)';
            if (Array.isArray(comments) && comments.length > 0) {
                container.innerHTML = comments.map(c => 
                    `<div class="border-bottom py-2" style="border-color: var(--border-color) !important;">
                        <small class="text-secondary">${sanitizeHTML(c.nickname) || 'üå± ÂåøÂêç'} ¬∑ ${new Date(c.ts).toLocaleString()}</small>
                        <div class="mt-1" style="color: var(--text-primary);">${sanitizeHTML(c.text)}</div>
                    </div>`
                ).join('');
            } else {
                container.innerHTML = '<div class="text-secondary text-center py-2">ÊöÇÊó†ËØÑËÆ∫</div>';
            }
        }

    
        document.getElementById('submitRunDetailComment').addEventListener('click', async () => {
            const runId = currentDetailRunId;
            const text = document.getElementById('runDetailCommentText').value.trim();
            if (!text || !runId) return;
            const profile = JSON.parse(localStorage.getItem('run_profile')) || generateRandomProfile();
            const nicknameForComment = `${profile.icon} ${profile.nickname}`;
            const res = await fetch(`${API_BASE}/comment`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ runId, text, nickname: nicknameForComment }) });
            if (res.ok) {
                document.getElementById('runDetailCommentText').value = '';
                await refreshDetailComments(runId);
                const countEl = document.querySelector(`.comment-count[data-run-id="${runId}"]`);
                if(countEl) countEl.textContent = parseInt(countEl.textContent, 10) + 1;
            } else {
                alert('Êèê‰∫§Â§±Ë¥•');
            } 
        });
        document.addEventListener('click', async e => {
            const runRow = e.target.closest('.run-detail-row');
            const recentCard = e.target.closest('.recent-run-card');
            if (runRow) {
                e.preventDefault();
                const preloadedData = {
                    distanceFormatted: runRow.dataset.distanceFormatted,
                    duration: runRow.dataset.duration,
                    paceStr: runRow.dataset.paceStr,
                    date: runRow.dataset.date,
                    heartRate: runRow.dataset.heartRate,
                };          
                showRunDetailModal(runRow.dataset.runId, preloadedData, false);
            } else if (recentCard) {
                e.preventDefault();
                const preloadedData = {
                    distanceFormatted: recentCard.dataset.distanceFormatted,
                    duration: recentCard.dataset.duration,
                    paceStr: recentCard.dataset.paceStr,
                    date: recentCard.dataset.date,
                    heartRate: recentCard.dataset.heartRate,
                };          
                const isCommentLink = e.target.closest('.comment-link');
                showRunDetailModal(recentCard.dataset.runId, preloadedData, !!isCommentLink);
            }
        });
        document.getElementById('viewPhotoBtn').addEventListener('click', () => {
            if (detailPhotoUrls.length > 0) {
                openMediaGallery(detailPhotoUrls, 0);
            }
        });
        document.getElementById('managePhotoBtn').addEventListener('click', () => {
            const photoManagerModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('photoManagerModal'));
            photoManagerModal.show();
            const grid = document.getElementById('photo-manager-grid');
            grid.innerHTML = detailPhotoUrls.map((url, index) => `
                <div class="photo-manager-item">
                    <img src="${url}" alt="photo ${index+1}">
                    <button class="delete-photo-btn" data-url="${url}">&times;</button>
                </div>
            `).join('');
            if (detailPhotoUrls.length === 0) {
                grid.innerHTML = '<p class="text-secondary">Ê≠§ËÆ∞ÂΩïÊöÇÊó†ÁÖßÁâá</p>';
            }
        });
        const calendarEditorModalEl = document.getElementById('calendarEditorModal');
        const calendarEditorModal = bootstrap.Modal.getOrCreateInstance(calendarEditorModalEl);
        const calendarForm = document.getElementById('calendarEventForm');
        const editorList = document.getElementById('calendarEditorList');
        let editorEvents = [];
        document.getElementById('editCalendarBtn').addEventListener('click', () => {
            editorEvents = JSON.parse(JSON.stringify(marathonEventsCache)); 
            renderCalendarEditor();
            calendarEditorModal.show();
        });
        function renderCalendarEditor() {
            editorList.innerHTML = '';
            if (editorEvents.length === 0) {
                editorList.innerHTML = '<p class="text-secondary">ÊöÇÊó†Ëµõ‰∫ã</p>';
                return;
            }
            editorEvents.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach((event, index) => {
                const originalIndex = editorEvents.indexOf(event);
                editorList.innerHTML += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${event.name}</strong> (${event.category})<br>
                        <small class="text-secondary">${event.date} - ${event.status}</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editCalendarEvent(${originalIndex})"><i class="bi bi-pencil-fill"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCalendarEvent(${originalIndex})"><i class="bi bi-trash-fill"></i></button>
                    </div>
                </div>`;
            });
        }
        window.editCalendarEvent = (index) => {
            const event = editorEvents[index];
            document.getElementById('event-id').value = index;
            document.getElementById('event-name').value = event.name;
            document.getElementById('event-willingness').value = event.willingness || '3';
            document.getElementById('event-channel').value = event.channel || '';
            document.getElementById('event-category').value = event.category;
            document.getElementById('event-status').value = event.status;
            document.getElementById('event-level').value = event.level || 'ÊôÆÈÄöËµõ‰∫ã';
            document.getElementById('event-date').value = event.date;
            document.getElementById('event-reg-start').value = event.registration_start || '';
            document.getElementById('event-reg-end').value = event.registration_end || '';
            document.getElementById('event-lottery-date').value = event.lottery_date || '';
            document.getElementById('calendarFormTitle').textContent = 'ÁºñËæëËµõ‰∫ã';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';
        }
        window.deleteCalendarEvent = (index) => {
            if(confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÈ°πËµõ‰∫ãÂêó?')) {
                editorEvents.splice(index, 1);
                renderCalendarEditor();
            }
        }
        document.getElementById('cancelEditBtn').addEventListener('click', () => {
            calendarForm.reset();
            document.getElementById('event-id').value = '';
            document.getElementById('calendarFormTitle').textContent = 'Ê∑ªÂä†Êñ∞Ëµõ‰∫ã';
            document.getElementById('cancelEditBtn').style.display = 'none';
        });
        calendarForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const eventIndexStr = document.getElementById('event-id').value;
            const eventData = {
                name: document.getElementById('event-name').value,
                willingness: document.getElementById('event-willingness').value,
                channel: document.getElementById('event-channel').value,
                category: document.getElementById('event-category').value,
                status: document.getElementById('event-status').value,
                level: document.getElementById('event-level').value,
                date: document.getElementById('event-date').value,
                registration_start: document.getElementById('event-reg-start').value || null,
                registration_end: document.getElementById('event-reg-end').value || null,
                lottery_date: document.getElementById('event-lottery-date').value || null
            };
            if (eventIndexStr !== '') {
                const index = parseInt(eventIndexStr, 10);
                const originalEvent = editorEvents[index];
                eventData.id = originalEvent ? originalEvent.id : `evt_${new Date().getTime()}`;
                editorEvents[index] = eventData;
            } else {
                eventData.id = `evt_${new Date().getTime()}`;
                editorEvents.push(eventData);
            }
            renderCalendarEditor();
            document.getElementById('cancelEditBtn').click();
        });
        document.getElementById('saveAllCalendarChanges').addEventListener('click', async () => {
            const secret = prompt("ËØ∑ËæìÂÖ•ÁÆ°ÁêÜÂëòÂØÜÈí•:");
            if (!secret) return;
            try {
                const res = await fetch(`${API_BASE}/marathon-events`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ events: editorEvents, secret: secret })
                });
                if (res.ok) {
                    alert('ËµõÂéÜÂ∑≤ÊàêÂäüÊõ¥Êñ∞!');
                    marathonEventsCache = JSON.parse(JSON.stringify(editorEvents)); 
                    calendarEditorModal.hide();
                    await generateMarathonCalendar();
                } else {
                    const error = await res.json();
                    alert(`‰øùÂ≠òÂ§±Ë¥•: ${error.error}`);
                }
            } catch (e) {
                alert(`ÂèëÁîüÁΩëÁªúÈîôËØØ: ${e.message}`);
            }
        });
        window.addEventListener('beforeunload', () => {
          destroyAllCharts();
          if(paceChart) paceChart.destroy();
          if(elevationChart) elevationChart.destroy();
          if(hrChart) hrChart.destroy();
          if(cityMap) cityMap.remove();
          if(modalMapInstance) modalMapInstance.remove();
          if(detailMapInstance) detailMapInstance.remove();
          if(countdownInterval) clearInterval(countdownInterval);
        });
    });
</script>
</html>
