<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>步履不停 - 已绕地球{{ "%.2f"|format(overall_stats.dist_km/40075.017) }}圈儿</title>
  <link rel="icon" type="image/png" href="https://run.linwn.net/images/favicon.png">
	<meta property="og:title" content="步履不停 - 我的四万公里跑量挑战" />
	<meta property="og:description" content="一个跑者的跑步记录网站，记录跑量与坚持。你也可以挑战地球一圈！" />
  <meta property="og:image" content="https://run.linwn.net/images/card.png" />
	<meta property="og:url" content="https://run.linwn.net/fun" />
	<meta property="og:type" content="website" />

	<meta name="twitter:card" content="https://run.linwn.net/images/card.png" />
	<meta name="twitter:title" content="步履不停 - 我的四万公里跑量挑战" />
	<meta name="twitter:description" content="一个跑者的跑步记录网站，记录跑量与坚持。你也可以挑战地球一圈！" />
  <meta name="twitter:image" content="https://run.linwn.net/images/card.png" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">

  <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css" rel="stylesheet" media="print" onload="this.media='all'">
  <link href="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.min.css" rel="stylesheet" media="print" onload="this.media='all'">
  
  <noscript>
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.min.css" rel="stylesheet">
  </noscript>

  <style>
    :root {
      --bg-color: #1c1e21;
      --card-bg: #282a2d;
      --text-primary: #e4e6eb;
      --text-secondary: #a8b3cf;
      --border-color: #495057;
      --accent-color: #4dabf7;
      --success-color: #20c997;
      --trophy-color: #fcc419;
      --hover-bg: #3a3b3c;
      --marathon-color: #ff8700;
    }
    html {
      scrollbar-gutter: stable;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-primary);
      font-family: 'Noto Sans SC', -apple-system, sans-serif;
      line-height: 1.6;
    }

    .main-title-container {
      padding: 1.5rem 0;
    }

    .main-title {
      font-weight: 700;
      font-size: 2rem;
    }

    .main-subtitle {
      font-weight: 400;
      font-size: 1.1rem;
    }
    
    .stat-card-base {
        background-color: var(--card-bg);
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        transition: all 0.2s ease;
        overflow: hidden;
    }
    
    .stat-card-content {
      display: flex;
      flex-direction: column;
      justify-content: center;
      height: 100%;
      width: 100%;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 0.5rem;
	  min-height: 1.0rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.2;
	  min-height: 2.4rem;
    }

    .stat-value-small {
        font-size: 1.5rem;
    }
    
    .stat-details {
	  margin-top: auto;
	  width: 100%;
	}

    .stat-card-flip-container {
        perspective: 1000px;
        min-height: 140px;
    }

    .stat-card-flipper {
		text-align: center;
        position: relative;
        width: 100%;
        height: 100%;
        transition: transform 0.6s;
        transform-style: preserve-3d;
    }

    .stat-card-flipper.flipped {
        transform: rotateY(180deg);
    }

    .stat-card-front, .stat-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--card-bg);
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 1.5rem;
    }

    .stat-card-back {
        transform: rotateY(180deg);
    }

	.flip-icon-container {
		position: absolute;
		top: 10px;
		right: 15px;
		font-size: 1.1rem;
		color: var(--text-secondary);
		cursor: pointer;
		opacity: 0.6;
		transition: opacity 0.2s ease, transform 0.2s ease;
		z-index: 5;
	}

	.flip-icon-container:hover {
		opacity: 1;
		transform: scale(1.1) rotate(30deg);
	}
	.stat-card-flipper.flipped .stat-card-front .flip-icon-container {
		display: none;
	}  
    .small-muted {
        color: var(--text-secondary);
    }

    .progress {
        --bs-progress-bg: var(--hover-bg);
    }
    
    .progress-bar {
        --bs-progress-bar-bg: var(--success-color);
    }

    .card-title-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn-group .btn, .btn-secondary, .btn-sm, #saveProfileButton {
        --bs-btn-bg: var(--hover-bg);
        --bs-btn-border-color: var(--border-color);
        --bs-btn-hover-bg: var(--accent-color);
        --bs-btn-hover-border-color: var(--accent-color);
        --bs-btn-active-bg: var(--accent-color);
        --bs-btn-active-border-color: var(--accent-color);
		--bs-btn-active-color: var(--text-primary);
        font-size: 0.8rem;
		color: var(--text-secondary);
    }
    #saveProfileButton {
        --bs-btn-bg: var(--accent-color);
        --bs-btn-border-color: var(--accent-color);
        --bs-btn-hover-bg: #63baff;
        --bs-btn-hover-border-color: #63baff;
        color: var(--text-primary);
    }

    .btn-group .btn.active {
		color: var(--text-primary);
		font-weight: 500;
	}
    @media (max-width: 767.98px) {
      .stat-value { font-size: 1.8rem; }
    }

    @media (max-width: 576px) {
      .stat-value { font-size: 1.5rem; }
      .main-title { font-size: 1.5rem; }
      .main-subtitle { font-size: 0.9rem; }
    }

    .card-title {
        color: var(--text-primary);
        margin-bottom: 0;
    }
    
    .collapsing {
      transition: height 0.2s ease !important;
    }
    .accordion-button {
      background-color: var(--card-bg);
      color: var(--text-primary);
      padding-left: 0.75rem;
      padding-right: 0.75rem;
    }
    .accordion-button:not(.collapsed) {
      background-color: var(--hover-bg);
      color: var(--text-primary);
    }
    .accordion-button:focus {
      box-shadow: none;
    }
    .accordion-item {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
    }
    .table-light {
        --bs-table-color: var(--text-primary);
        --bs-table-bg: var(--hover-bg);
    }
    .table {
      --bs-table-bg: var(--card-bg);
      --bs-table-striped-bg: var(--hover-bg);
      --bs-table-color: var(--text-primary);
      --bs-table-border-color: var(--border-color);
    }
    .run-detail-row, .recent-run-card {
        cursor: pointer;
    }
    .modal-content {
      background-color: var(--card-bg);
      color: var(--text-primary);
    }
    .modal-header {
      border-bottom-color: var(--border-color);
    }
    .pb-entry {
      border-bottom: 1px solid var(--border-color) !important;
    }
    .details-row > td {
      padding: 0 !important;
      border-top: none;
    }
    .details-row .card-body {
      background-color: var(--hover-bg);
      color: var(--text-secondary);
      padding-left: 1rem;
    }
    
    .badge.bg-success {
      font-size: 0.75em;
      padding: 0.25em 0.5em;
      font-weight: 500;
    }

    .clickable-certificate {
        color: var(--accent-color);
        cursor: pointer;
        text-decoration: none;
        border-bottom: 1px dashed var(--accent-color);
        transition: all 0.2s;
    }
    .clickable-certificate:hover {
        color: var(--accent-color);
        border-bottom-style: solid;
    }

    .modal-header .btn-close {
        filter: invert(0.8);
    }

    .text-primary-emphasis {
      color: var(--text-primary) !important;
    }

    .text-body-secondary {
      color: var(--text-secondary) !important;
    }

    .classification-text {
      color: var(--success-color);
      font-weight: 500;
      font-size: 0.9em;
    }

    .certificate-link {
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
    }

    .certificate-link:hover {
      text-decoration: none;
      transform: scale(1.05);
    }
    .comment-link {
      font-size: 0.85rem;
      color: var(--text-secondary);
      text-decoration: none;
      border-bottom: 1px dotted var(--text-secondary);
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .comment-link:hover {
      color: var(--accent-color);
      border-bottom: 1px solid var(--accent-color);
    }
    .leaflet-popup-content-wrapper {
        background: var(--card-bg);
        color: var(--text-primary);
        border-radius: 8px;
    }
    .leaflet-popup-content {
        margin: 12px;
    }
    .leaflet-popup-tip {
        background: var(--card-bg);
    }
    .leaflet-popup-close-button {
        color: var(--text-primary) !important;
        padding: 4px 4px 0 0 !important;
    }
    
    /* Responsive Nav Tabs */
    .nav-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none; /* Firefox */
    }
    .nav-wrapper::-webkit-scrollbar {
        display: none; /* Safari and Chrome */
    }
    .nav-tabs {
        --bs-nav-tabs-border-color: var(--border-color);
        --bs-nav-tabs-link-hover-border-color: var(--border-color);
        flex-wrap: nowrap;
        white-space: nowrap;
        border-bottom: none; /* The wrapper will have the border */
    }
    .nav-wrapper .nav-item {
        flex-shrink: 0;
    }
    .nav-tabs .nav-link {
        color: var(--text-secondary);
        background: none;
    }
    .nav-tabs .nav-link.active {
        color: var(--text-primary);
        background-color: var(--hover-bg);
        border-color: var(--border-color) var(--border-color) var(--hover-bg);
    }
    #cityMap {
      width: 100%;
      height: 400px;
      background-color: var(--card-bg);
      border-radius: .75rem;
    }
    .content-card {
        background-color: var(--card-bg);
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 1.5rem;
        border: 1px solid var(--border-color);
    }
    .streak-badge {
      font-size: 0.7em;
      font-weight: bold;
      padding: 0.2em 0.5em;
      border-radius: 0.35rem;
      background-color: #fd7e14;
      color: #fff;
      margin-left: 8px;
      vertical-align: middle;
      display: inline-block;
      line-height: 1;
    }
    .form-select, .form-control {
        background-color: var(--hover-bg);
        border-color: var(--border-color);
        color: var(--text-secondary);
    }
    .form-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23a8b3cf' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
    }
    .form-select:focus, .form-control:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.25rem rgba(77, 171, 247, .25);
        background-color: var(--hover-bg);
        color: var(--text-primary);
    }
    .form-control::placeholder {
        color: var(--text-secondary);
        opacity: 0.7;
    }
    label.form-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
    }
    .sortable-header {
      cursor: pointer;
      user-select: none;
    }
    .sortable-header .sort-icon {
      opacity: 0.5;
      transition: opacity 0.2s;
      vertical-align: middle;
    }
    .sortable-header:hover .sort-icon {
      opacity: 1;
    }
    .sortable-header[aria-sort] .sort-icon {
        opacity: 1;
    }
    .sortable-header .bi-arrow-down-up { display: inline-block; }
    .sortable-header .bi-arrow-down, .sortable-header .bi-arrow-up { display: none; }
    .sortable-header[aria-sort="ascending"] .bi-arrow-up { display: inline-block; }
    .sortable-header[aria-sort="descending"] .bi-arrow-down { display: inline-block; }
    .sortable-header[aria-sort] .bi-arrow-down-up { display: none; }
    .timeline {
        position: relative;
        padding-left: 2rem;
        margin-left: 1rem;
        border-left: 2px solid var(--border-color);
    }
    .timeline-item {
        position: relative;
        padding-bottom: 1.5rem;
    }
    .timeline-item:last-child {
        padding-bottom: 0;
    }
    .timeline-marker {
        position: absolute;
        top: 5px;
        left: calc(-2rem - 1px - 0.6rem);
        width: 1.2rem;
        height: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        background-color: var(--bg-color);
    }
    .trophy-color-text { color: var(--trophy-color); }
    .accent-color-text { color: var(--accent-color); }
    /* --- START: 修正后的日历弹出样式 --- */
    .marathon-calendar-container .month-grid {
        background-color: var(--card-bg);
        padding: 1.5rem;
        border-radius: 0.75rem;
        margin-bottom: 2rem;
    }
    .calendar-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }
    .calendar-table th {
        text-align: center;
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 0.8rem;
        padding-bottom: 0.5rem;
    }
    .calendar-table td {
        border: 1px solid var(--border-color);
        height: 70px;
        vertical-align: top;
        padding: 5px;
        transition: background-color 0.2s;
    }
    .calendar-table td.empty {
       background-color: transparent;
       border-color: var(--card-bg);
    }
    .calendar-table td:not(.empty) {
        background-color: var(--hover-bg);
    }
    .day-number {
        font-weight: 700;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }
    .calendar-table td.event {
        background-color: #3b2f21;
        border: 1px solid var(--marathon-color);
        position: relative;
    }
    .day-number.has-event {
        color: var(--marathon-color);
    }
    .event-details {
      padding-top: 2px;
    }
    .event-item {
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--text-primary);
        background-color: rgba(0,0,0,0.2);
        border-radius: 4px;
        padding: 2px 4px;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .event-item .category {
      font-size: 0.8em;
      padding: 1px 4px;
      border-radius: 3px;
      background-color: var(--marathon-color);
      color: var(--bg-color);
      margin-left: 4px;
      font-weight: bold;
    }
    .event-status {
        font-size: 0.7rem;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .event-details.popup {
      position: absolute;
      z-index: 10;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      width: auto;
      min-width: 180%;
      padding: 0.6rem;
      background-color: var(--hover-bg);
      border: 1px solid var(--accent-color);
      border-radius: 6px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
      pointer-events: none;
    }
    .event-details.popup.visible {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
    }
    .event-details.popup.edge-left {
        left: 5px;
        transform: translateX(0);
    }
    .event-details.popup.edge-right {
        left: auto;
        right: 5px;
        transform: translateX(0);
    }

    .event-details.popup .event-item,
    .event-details.popup .event-status {
      overflow: visible;
      white-space: normal;
      text-overflow: initial;
    }
    .event-details.popup .event-status {
        margin-top: 4px;
    }


    /* Mobile list view for calendar */
    .calendar-list-view {
        display: none;
    }
    .calendar-list-item {
        display: flex;
        gap: 1rem;
        padding: 0.75rem 0.25rem;
        border-bottom: 1px solid var(--border-color);
    }
    .calendar-list-item:last-child {
        border-bottom: none;
    }
    .list-date {
        flex-shrink: 0;
        text-align: center;
    }
    .list-date .day {
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 1;
        color: var(--marathon-color);
    }
    .list-date .weekday {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }
    .list-details {
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .list-details .name {
        font-weight: 500;
    }
    .list-details .status {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    @media (max-width: 767.98px) {
        .calendar-table { display: none; }
        .calendar-list-view { display: block; }
        
        #marathon-pane.view-grid .calendar-table { display: table; }
        #marathon-pane.view-grid .calendar-list-view { display: none; }

        #marathon-pane.view-list .calendar-table { display: none; }
        #marathon-pane.view-list .calendar-list-view { display: block; }
        
        .marathon-calendar-container .month-grid { padding: 1rem; }
    }
    /* Comment Media Styles */
    .comment-media-thumb {
        max-width: 80px;
        max-height: 80px;
        border-radius: 4px;
        margin: 4px;
        cursor: pointer;
        object-fit: cover;
        transition: transform 0.2s;
        display: inline-block;
        vertical-align: middle;
    }
    .comment-media-thumb:hover {
        transform: scale(1.05);
        box-shadow: 0 0 5px var(--accent-color);
    }

    /* Gallery Modal Styles */
    #mediaGalleryModal .modal-content {
      background-color: rgba(0,0,0,0.85);
      backdrop-filter: blur(5px);
    }
    #mediaGalleryModal .btn-close {
      filter: invert(1) grayscale(100%) brightness(200%);
      position: absolute;
      top: 1rem;
      right: 1rem;
      z-index: 20;
    }
    #galleryCarouselInner .carousel-item {
        text-align: center;
    }
    #galleryCarouselInner .carousel-item img,
    #galleryCarouselInner .carousel-item video {
        max-height: 85vh;
        width: auto;
        max-width: 100%;
    }

    /* Marathon Calendar Styles */
    .calendar-list-view {
        display: none;
    }
    @media (max-width: 767.98px) {
        .calendar-table { display: none; }
        .calendar-list-view { display: block; }
        #marathon-pane.view-grid .calendar-table { display: table; }
        #marathon-pane.view-grid .calendar-list-view { display: none; }
        #marathon-pane.view-list .calendar-table { display: none; }
        #marathon-pane.view-list .calendar-list-view { display: block; }
        .marathon-calendar-container .month-grid { padding: 1rem; }
    }

    /* New Run Detail Modal Styles */
    #runDetailModal .modal-content {
        background-color: var(--bg-color);
        color: var(--text-primary);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    #runDetailModal .modal-body {
        padding: 0;
        overflow-y: auto;
    }
    #runDetailModal .detail-header {
        position: sticky;
        top: 0;
        background: rgba(28, 30, 33, 0.8);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 10;
        border-bottom: 1px solid var(--border-color);
        padding: 0.75rem 1rem;
    }
    #runDetailModal .detail-header .btn-back {
        background: none;
        border: none;
        font-size: 1.5rem;
        padding: 0;
        line-height: 1;
        color: var(--text-primary);
    }
    #runDetailModal .detail-header .detail-title {
        font-weight: 600;
        font-size: 1.1rem;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        color: var(--text-primary);
    }
    #runDetailModal #detailHeroDistance .distance-value {
        font-size: 4.5rem;
        font-weight: 700;
        line-height: 1;
        letter-spacing: -2px;
        color: var(--text-primary);
    }
    #runDetailModal #detailHeroDistance .distance-unit {
        font-size: 1rem;
        color: var(--text-secondary);
        margin-left: 0.25rem;
    }
    #runDetailModal .carousel-item img.gallery-item {
        cursor: pointer;
    }
    #runDetailModal .carousel-item img {
        height: 250px;
        object-fit: cover;
        border-radius: 12px;
        background-color: var(--hover-bg);
    }
    #runDetailModal .carousel-control-prev,
    #runDetailModal .carousel-control-next {
        width: 10%;
    }
    #runDetailModal .carousel-control-prev-icon,
    #runDetailModal .carousel-control-next-icon {
        filter: invert(1) grayscale(0.5);
    }
    #runDetailModal .carousel-indicators [data-bs-target] {
        background-color: var(--text-secondary);
    }
    #runDetailModal h4.data-section-title {
        font-weight: 600;
        font-size: 1.2rem;
        margin-bottom: 1.25rem;
        color: var(--text-primary);
    }
    #runDetailModal .data-point-value {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: var(--text-primary);
    }
     #runDetailModal .data-point-unit {
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-secondary);
        margin-left: 4px;
    }
    #runDetailModal .data-point-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    #runDetailModal .analysis-summary {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }
    #runDetailModal .analysis-summary strong {
        color: var(--text-primary);
        font-weight: 600;
    }
    #runDetailModal #runDetailComments hr {
        border-top: 1px solid var(--border-color);
    }
    #runDetailModal #runDetailCommentForm {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: .75rem;
    }
     #runDetailModal #runDetailCommentForm textarea {
        background-color: var(--hover-bg);
        color: var(--text-primary);
        border-color: var(--border-color);
     }
     #runDetailModal #runDetailCommentForm textarea:focus {
        background-color: var(--bg-color);
     }
     #runDetailModal #runDetailCommentForm .btn-primary {
         background-color: var(--accent-color);
         border-color: var(--accent-color);
         color: var(--bg-color);
     }
     #runDetailModal #runDetailCommentForm .text-secondary {
        color: var(--text-secondary) !important;
     }
     #routeMap {
        height: 75vh;
        border-radius: .75rem;
     }
     #calendarEditorModal .list-group-item {
        background-color: var(--hover-bg);
        border-color: var(--border-color);
     }
  </style>
</head>
<body>

<div class="container position-relative">

  <div class="main-title-container">
    <h1 class="main-title">步履不停 <small class="main-subtitle text-body-secondary"> — 我的四万公里跑量挑战</small></h1>
  </div>

  <div class="nav-wrapper border-bottom border-secondary-subtle mb-4">
    <ul class="nav nav-tabs" id="main-nav-tabs" role="tablist">
        <li class="nav-item" role="presentation">
        <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary-pane" type="button" role="tab" aria-controls="summary-pane" aria-selected="true" data-hash="summary">概览</button>
        </li>
        <li class="nav-item" role="presentation">
        <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-pane" type="button" role="tab" aria-controls="data-pane" aria-selected="false" data-hash="data">记录</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="marathon-tab" data-bs-toggle="tab" data-bs-target="#marathon-pane" type="button" role="tab" aria-controls="marathon-pane" aria-selected="false" data-hash="marathon">赛历</button>
        </li>
        <li class="nav-item" role="presentation">
        <button class="nav-link" id="events-tab" data-bs-toggle="tab" data-bs-target="#events-pane" type="button" role="tab" aria-controls="events-pane" aria-selected="false" data-hash="events">成就</button>
        </li>
        <li class="nav-item" role="presentation">
        <button class="nav-link" id="about-tab" data-bs-toggle="tab" data-bs-target="#about-pane" type="button" role="tab" aria-controls="about-pane" aria-selected="false" data-hash="about">关于</button>
        </li>
    </ul>
  </div>

  <div class="tab-content" id="mainTabContent">
    <div class="tab-pane fade show active" id="summary-pane" role="tabpanel" aria-labelledby="summary-tab" tabindex="0">
        <div class="row g-3 mb-4">
            <div class="col-12 col-md-6 col-lg-5">
                <div class="stat-card-flip-container h-100" id="dist-card-container">
                    <div class="stat-card-flipper h-100">
                      <div class="stat-card-front">
                        <div class="stat-card-content">
                          <div>
                            <div class="stat-label">当前跑量</div>
                            <div class="stat-value">{{ "%.2f"|format(overall_stats.dist_km) }} <small class="small-muted">km</small></div>
                          </div>
                          <div class="stat-details">
                            <div class="stat-label" id="running-quote"></div>
                            <div class="progress mt-1" style="height: 4px;">
                              <div class="progress-bar" role="progressbar" style="width: {{ '%.4f'|format(progress_around_earth) }}%;"></div>
                            </div>
                            <small class="small-muted">进度 {{ "%.4f"|format(progress_around_earth) }}%</small>
                          </div>
                        </div>
                        <div class="flip-icon-container"><i class="bi bi-phone-flip"></i></div>
                      </div>
                      <div class="stat-card-back">
                        <div class="stat-card-content">
                          <div>
                            <div class="stat-label">继续坚持</div>
                            <div class="stat-value">{{ estimated_info.days_left }}</div>
                          </div>
                          <div class="stat-details">
                            <div class="stat-label"><small class="small-muted">预计</small>{{ estimated_info.date_str }}<small>绕地球一圈</small></div>
                          </div>
                        </div>
                        <div class="flip-icon-container"><i class="bi bi-phone-flip"></i></div>
                      </div>
                    </div>
                </div>
            </div><div class="col-6 col-md-6 col-lg-2">
                <div class="stat-card-flip-container h-100" id="count-card-container">
                    <div class="stat-card-flipper h-100">
                      <div class="stat-card-front">
                        <div class="stat-card-content">
                          <div class="stat-label">跑步次数</div>
                          <div class="stat-value">{{ overall_stats.count }}</div>
                        </div>
                        <div class="flip-icon-container"><i class="bi bi-phone-flip"></i></div>
                      </div>
                      <div class="stat-card-back">
                        <div class="stat-card-content">
                          <div class="stat-label">总耗时</div>
                          <div class="stat-value stat-value-small">{{ overall_stats.duration_str }}</div>
                        </div>
                        <div class="flip-icon-container"><i class="bi bi-phone-flip"></i></div>
                      </div>
                    </div>
                  </div>
            </div>
            <div class="col-6 col-md-6 col-lg-2">
                <div class="stat-card-flip-container h-100" id="pace-card-container">
                    <div class="stat-card-flipper h-100">
                      <div class="stat-card-front">
                        <div class="stat-card-content">
                          <div class="stat-label">平均配速</div>
                          <div class="stat-value">{{ overall_stats.pace }}</div>
                        </div>
                        <div class="flip-icon-container"><i class="bi bi-phone-flip"></i></div>
                      </div>
                      <div class="stat-card-back">
                        <div class="stat-card-content">
                          <div class="stat-label">最快配速</div>
                          <div class="stat-value">{{ fastest_pace_info.pace }}</div>
                        </div>
                        <div class="flip-icon-container"><i class="bi bi-phone-flip"></i></div>
                      </div>
                    </div>
                </div>
            </div>
        </div>

        {% if recent_runs %}
        <div class="card mb-4" style="background-color: var(--card-bg); border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div class="card-header bg-transparent border-0 pt-3 ps-4">
                <h5 class="card-title mb-0"><i class="bi bi-stopwatch-fill me-2"></i>最近三次跑步</h5>
            </div>
            <div class="card-body pt-2">
                <div class="row g-3">
                {% for run in recent_runs %}
                <div class="col-lg-4">
                    <div class="p-3 rounded h-100 d-flex flex-column recent-run-card" data-run-id="{{ run.id }}" style="background-color: var(--hover-bg);">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold text-primary-emphasis">{{ "%.2f"|format(run.distance / 1000) }} km</span>
                            <span class="small text-body-secondary">{{ run.date.strftime('%Y-%m-%d %H:%M') }}</span>
                        </div>
                        
                        <div class="d-flex justify-content-around text-center mt-3 flex-grow-1 align-items-center">
                            <div>
                                <div class="stat-label mb-1">配速</div>
                                <div class="fw-bold">{{ run.pace }}</div>
                            </div>
                            <div>
                                <div class="stat-label mb-1">用时</div>
                                <div class="fw-bold">{{ format_duration(run.duration) }}</div>
                            </div>
                            <div>
                                <div class="stat-label mb-1">心率</div>
                                <div class="fw-bold">
                                    {{ run.heart_rate or 'N/A' }}
                                </div>
                            </div>
                            <div>
                                <div class="stat-label mb-1">城市</div>
                                <div class="fw-bold">{{ run.city or 'N/A' }}</div>
                            </div>
                        </div>

                        <div class="mt-auto pt-3 text-end">
                          <a href="#" class="comment-link small text-body-secondary" data-run-id="{{ run.id }}" data-scroll-to-comment="true">💬 说点什么 (<span class="comment-count" data-run-id="{{ run.id }}">0</span>)</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
                </div>
                <div class="text-center mt-3">
                    <a href="#data" id="goto-data-tab" class="text-decoration-none text-body-secondary">查看所有记录 &rarr;</a>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card mb-4" style="background-color: var(--card-bg); border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div class="card-header bg-transparent border-0 pt-3">
                <div class="card-title-container">
                    <h5 class="card-title">跑量分析</h5>
                    <div class="btn-group btn-group-sm" role="group" id="chart-toggle">
                        <button type="button" class="btn active" data-chart="daily">近30天</button>
                        <button type="button" class="btn" data-chart="monthly">近12月</button>
                        <button type="button" class="btn" data-chart="yearly">年度汇总</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
            <div id="dailyChartContainer" style="display: block; height: 300px;">
                <canvas id="dailyDistanceChart" aria-label="最近30天跑步距离统计图表"></canvas>
            </div>
            <div id="monthlyChartContainer" style="display: none; height: 300px;">
                <canvas id="monthlyDistanceChart" aria-label="最近12个月跑步距离统计图表"></canvas>
            </div>
            <div id="yearlyChartContainer" style="display: none; height: 300px;">
                <canvas id="yearlyDistanceChart" aria-label="年度跑步距离统计图表"></canvas>
            </div>
            </div>
        </div>
    </div>
    
    <div class="tab-pane fade" id="data-pane" role="tabpanel" aria-labelledby="data-tab" tabindex="0">
        <div class="row">
            <div class="col-lg-3">
                <div class="position-sticky" style="top: 1rem;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="btn-group btn-group-sm" id="data-view-toggle" role="group">
                            <button type="button" class="btn active" data-view="summary">汇总模式</button>
                            <button type="button" class="btn" data-view="yearly">年度模式</button>
                        </div>
                        <button class="btn btn-sm d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#data-controls-collapse" aria-expanded="false" aria-controls="data-controls-collapse" id="summary-controls-toggle">
                            <i class="bi bi-funnel"></i> 筛选
                        </button>
                    </div>

                    <div class="collapse d-lg-block" id="data-controls-collapse">
                        <div class="content-card p-3 mb-3">
                            <h6 class="mb-3 small-muted">筛选选项</h6>
                            <div class="mb-3">
                                <label class="form-label">按日期</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="date" id="date-filter-start" class="form-control form-control-sm" placeholder="起始">
                                    </div>
                                    <div class="col">
                                        <input type="date" id="date-filter-end" class="form-control form-control-sm" placeholder="结束">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">按距离</label>
                                <div class="btn-group btn-group-sm w-100" id="data-dist-filter-toggle">
                                    <button type="button" class="btn active" data-dist="0">全部</button>
                                    <button type="button" class="btn" data-dist="5000">&gt;5km</button>
                                    <button type="button" class="btn" data-dist="10000">&gt;10km</button>
                                    <button type="button" class="btn" data-dist="21097">&gt;半马</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">按配速</label>
                                <div class="btn-group btn-group-sm w-100" id="data-pace-filter-toggle">
                                    <button type="button" class="btn active" data-pace="9999">全部</button>
                                    <button type="button" class="btn" data-pace="360">&lt;6'</button>
                                    <button type="button" class="btn" data-pace="330">&lt;5'30</button>
                                    <button type="button" class="btn" data-pace="300">&lt;5'</button>
                                </div>
                            </div>
                            <div>
                                <label for="data-city-filter" class="form-label">按城市</label>
                                <select class="form-select form-select-sm" id="data-city-filter">
                                    <option value="all" selected>全部城市</option>
                                    {% for city in city_stats %}
                                    <option value="{{ city.name }}">{{ city.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-9">
                <div id="summary-data-view">
                    <div class="content-card table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th class="sortable-header" data-sort="date" aria-sort="descending">
                                        日期 <span class="sort-icon"><i class="bi bi-arrow-down-up"></i><i class="bi bi-arrow-down"></i><i class="bi bi-arrow-up"></i></span>
                                    </th>
                                    <th class="sortable-header" data-sort="distance">
                                        距离 <span class="sort-icon"><i class="bi bi-arrow-down-up"></i><i class="bi bi-arrow-down"></i><i class="bi bi-arrow-up"></i></span>
                                    </th>
                                    <th class="d-none d-sm-table-cell">用时</th>
                                    <th class="sortable-header" data-sort="pace">
                                        配速 <span class="sort-icon"><i class="bi bi-arrow-down-up"></i><i class="bi bi-arrow-down"></i><i class="bi bi-arrow-up"></i></span>
                                    </th>
                                    <th>城市</th>
                                </tr>
                            </thead>
                            <tbody id="summary-table-body">
                                {% for year, year_data in summarized_by_year.items() %}
                                    {% for r in year_data.all_runs %}
                                    <tr class="run-detail-row"
                                        data-run-id="{{ r.id }}"
                                        data-distance="{{ r.distance }}"
                                        data-distance-formatted="{{ "%.2f"|format(r.distance / 1000) }}"
                                        data-pace-str="{{ r.pace }}"
                                        data-date="{{ r.date.strftime('%Y-%m-%d') }}"
                                        data-city="{{ r.city[:-1] if r.city and r.city.endswith("市") else r.city }}"
                                        data-duration="{{ format_duration(r.duration) }}">
                                        <td><code>{{ r.date.strftime('%Y-%m-%d') }}</code></td>
                                        <td>{{ "%.2f"|format(r.distance / 1000) }} <span class="small-muted">km</span></td>
                                        <td class="d-none d-sm-table-cell">{{ format_duration(r.duration) }}</td>
                                        <td>{{ r.pace }}</td>
                                        <td>{{ r.city[:-1] if r.city and r.city.endswith("市") else r.city }}</td>
                                    </tr>
                                    {% endfor %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="yearly-data-view" style="display: none;">
                    {% for year, year_data in summarized_by_year.items() %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h4 class="mb-0">{{ year }} 年</h4>
                        <span class="small-muted small">
                        {{ year_data.summary.count }}次 | {{ "%.2f"|format(year_data.summary.dist_km) }} km | {{ year_data.summary.duration_str }} |  {{ year_data.summary.pace }}
                        </span>
                    </div>
                    <div class='accordion mb-4' id='accordion{{ year }}'>
                        {% for month_num, month_data in year_data.months.items()|sort(reverse=True) %}
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-m{{ year }}{{ month_num }}" aria-expanded="false" aria-controls="collapse-m{{ year }}{{ month_num }}">
                                {{ months_map[month_num] }} &nbsp; 
                                <span class="small-muted small">({{ month_data.summary.count }}次 | {{ "%.2f"|format(month_data.summary.dist_km) }} km | {{ month_data.summary.duration_str }} | {{ month_data.summary.pace }})</span>
                                </button>
                            </h2>
                            <div id="collapse-m{{ year }}{{ month_num }}" class="accordion-collapse collapse" data-bs-parent="#accordion{{ year }}">
                                <div class="accordion-body">
                                    <table class="table table-hover table-borderless align-middle mb-0">
                                        <tbody>
                                        {% for r in month_data.runs %}
                                        <tr>
                                            <td>
                                                <code>{{ r.date.strftime('%d') }}</code>
                                                {% if r.streak and r.streak > 1 %}
                                                <span class="streak-badge">{{ r.streak }}连</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ "%.2f"|format(r.distance / 1000) }} <span class="text-muted small">km</span></td>
                                            <td><span class="text-body">{{ format_duration(r.duration) }}</span></td>
                                            <td><span class="text-body">{{ r.pace }}</span></td>
                                        </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="marathon-pane" role="tabpanel" aria-labelledby="marathon-tab" tabindex="0">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <div class="btn-group btn-group-sm d-md-none" id="calendar-view-toggle" role="group">
                    <button type="button" class="btn" data-view="list">列表</button>
                    <button type="button" class="btn active" data-view="grid">日历</button>
                </div>
            </div>
            <button id="editCalendarBtn" class="btn btn-sm" style="display: none;"><i class="bi bi-pencil-square"></i> 编辑赛历</button>
        </div>
        <div id="marathon-calendar-container">
            </div>
    </div>

    <div class="tab-pane fade" id="events-pane" role="tabpanel" aria-labelledby="events-tab" tabindex="0">
        <div class="d-flex justify-content-end mb-4">
            <div class="btn-group btn-group-sm" id="events-view-toggle" role="group" aria-label="Events View Toggle">
                <button type="button" class="btn active" data-view="category">按类别</button>
                <button type="button" class="btn" data-view="timeline">按时间线</button>
            </div>
        </div>
        
        <div id="events-category-view">
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="content-card h-100 d-flex flex-column">
                        <h5 class="card-title mb-3"><i class="bi bi-flag-fill text-success"></i> 里程碑</h5>
                        {% set milestones = [
                        {'name': '踏出第一步', 'distance': first_run_distance, 'date': first_run_date, 'is_first': True},
                        {'name': '1000公里', 'distance': 1000, 'date': milestone_dates.get(1000)},
                        {'name': '10000公里', 'distance': 10000, 'date': milestone_dates.get(10000)},
                        {'name': '20000公里', 'distance': 20000, 'date': milestone_dates.get(20000)},
                        {'name': '30000公里', 'distance': 30000, 'date': milestone_dates.get(30000)},
                        {'name': '40000公里', 'distance': 40000, 'date': milestone_dates.get(40000)}
                        ] %}
                        
                        {% for m in milestones %}
                        <div class="d-flex justify-content-between align-items-center py-2 pb-entry 
                                    {% if m.date %}border-success border-2{% endif %}">
                            <div>
                            <div class="fw-bold {% if m.date %}text-success{% endif %}">
                                {{ m.name }}
                                {% if m.date %}<span class="badge bg-success ms-2">已完成</span>{% endif %}
                            </div>
                            <small class="{% if m.date %}text-success{% else %}small-muted{% endif %}">
                                {% if m.date %}{{ m.date.strftime('%Y年%m月%d日') }}{% else %}{% if m.is_first %}初次跑步{% else %}未达成{% endif %}{% endif %}
                            </small>
                            </div>
                            <div class="text-end">
                            <div class="fw-bold {% if m.date %}text-success{% elif not m.date and not m.is_first %}text-muted{% endif %}">
                                {% if m.is_first %}{{ "%.2f"|format(m.distance) }} km{% else %}{{ "%.0f"|format(m.distance) }} km{% endif %}
                            </div>
                            <small class="{% if m.date %}text-success{% else %}small-muted{% endif %}">
                                {% if m.is_first %}首跑{% elif m.date %}里程碑达成{% else %}进行中{% endif %}
                            </small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="content-card h-100 d-flex flex-column">
                        <h5 class="card-title mb-3"><i class="bi bi-award-fill trophy-color-text"></i> 个人最佳 (PB)</h5>
                        <div class="flex-grow-1">
                            {% for label, pb in personal_bests.items() %}
                            <div class="d-flex justify-content-between align-items-center py-2 pb-entry">
                                <div>
                                <div class="fw-bold">{{ label }}</div>
                                <small class="small-muted">{{ pb.date }}</small>
                                </div>
                                <div class="text-end">
                                <div class="fw-bold">{{ pb.time }}</div>
                                <small class="small-muted">配速: {{ pb.pace }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="content-card h-100 d-flex flex-column">
                        <h5 class="card-title mb-3"><i class="bi bi-trophy-fill accent-color-text"></i> 比赛记录</h5>
                        <div class="flex-grow-1" style="overflow-y: auto;">
                            {% if events %}
                            {% for event in events %}
                                <div class="border-bottom py-2 pb-entry">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="fw-bold text-primary-emphasis">
                                    {{ event.name }}
                                    <small class="text-body-secondary">{{ event.category }}</small>
                                    </div>
                                    <div class="flex-grow-1 text-center px-2">
                                    {% if event.certified %}
                                        <abbr title="点击查看证书" class="certificate-link text-decoration-none" 
                                            data-img="{{ event.certificate }}" style="cursor: pointer; border-bottom: 1px dotted var(--text-secondary)">
                                        <span class="classification-text">{{ event.certified }}</span>
                                        </abbr>
                                    {% endif %}
                                    </div>
                                    <div class="text-nowrap text-primary-emphasis">{{ format_duration(event.duration) }}</div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-1">
                                    <div>
                                    <small class="text-body-secondary">
                                        {% if event.date %}{{ event.date.strftime('%Y.%m.%d') }}{% else %}日期未知{% endif %}
                                    </small>
                                    <small class="text-body-secondary ms-2">{{ event.city }}</small>
                                    </div>
                                    <div class="text-end"><small class="text-body-secondary">配速: {{ event.pace }}</small></div>
                                </div>
                                </div>
                            {% endfor %}
                            {% else %}
                            <div class="text-center py-4 text-body-secondary">暂无比赛记录</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="content-card h-100 d-flex flex-column">
                        <h5 class="card-title mb-3"><i class="bi bi-geo-alt-fill text-primary"></i> 解锁新城市</h5>
                        <div class="flex-grow-1" style="overflow-y: auto; max-height: 250px;">
                            {% if city_stats %}
                                {% for city in city_stats|sort(attribute='first_date', reverse=True) %}
                                    {% if city.first_date %}
                                    <div class="d-flex justify-content-between align-items-center py-2 pb-entry">
                                        <div>
                                            <div class="fw-bold">{{ city.name }}</div>
                                        </div>
                                        <div class="text-end">
                                            <div class="text-nowrap text-primary-emphasis">{{ city.first_date }}</div>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-4 text-body-secondary">暂无城市记录</div>
                            {% endif %}
                        </div>
                        <div class="mt-4">
                            <h6 class="card-title mb-3 small-muted"><i class="bi bi-map-fill"></i> 足迹地图</h6>
                            <div class="row">
                                <div class="col-12">
                                  <div id="cityMap"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% set all_events = [] %}
        {% for m in milestones %}{% if m.date %}{% set dist_str = ("%.0f"|format(m.distance)) if not m.is_first else ("%.2f"|format(m.distance)) %}{% set details_str = '达成 ' ~ dist_str ~ 'km 里程碑' if not m.is_first else '首跑距离 ' ~ dist_str ~ 'km' %}{% set _ = all_events.append({'date': m.date.strftime('%Y-%m-%d'), 'type': '里程碑', 'icon': 'bi-flag-fill', 'color': 'text-success', 'title': m.name, 'details': details_str}) %}{% endif %}{% endfor %}
        {% for label, pb in personal_bests.items() %}{% set _ = all_events.append({'date': pb.date, 'type': '个人最佳', 'icon': 'bi-award-fill', 'color': 'trophy-color-text', 'title': 'PB: ' ~ label, 'details': '时间 ' ~ pb.time ~ ' (配速 ' ~ pb.pace ~ ')'}) %}{% endfor %}
        {% for event in events %}{% if event.date %}{% set _ = all_events.append({'date': event.date.strftime('%Y-%m-%d'), 'type': '比赛记录', 'icon': 'bi-trophy-fill', 'color': 'accent-color-text', 'title': event.name, 'details': event.category ~ ' - 完赛时间: ' ~ format_duration(event.duration)}) %}{% endif %}{% endfor %}
        {% for city in city_stats %}{% if city.first_date %}{% set _ = all_events.append({'date': city.first_date, 'type': '解锁新城市', 'icon': 'bi-geo-alt-fill', 'color': 'text-primary', 'title': '解锁: ' ~ city.name, 'details': '于 ' ~ city.first_date ~ ' 首次在该城市跑步'}) %}{% endif %}{% endfor %}
        {% set sorted_events = all_events|sort(attribute='date', reverse=True) %}

        <div id="events-timeline-view" style="display: none;">
            <div class="content-card">
                <div class="timeline">
                    {% if not sorted_events %}
                        <div class="text-center py-4 text-body-secondary">暂无事件记录</div>
                    {% else %}
                        {% for event in sorted_events %}
                        <div class="timeline-item">
                            <div class="timeline-marker">
                                <i class="bi {{ event.icon }} {{ event.color }}"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="small text-body-secondary mb-1">{{ event.date }} &middot; {{ event.type }}</div>
                                <h6 class="mb-1 fw-bold">{{ event.title }}</h6>
                                <p class="mb-0 small text-body-secondary">{{ event.details }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-pane fade" id="about-pane" role="tabpanel" aria-labelledby="about-tab" tabindex="0">
        <div class="content-card">
            <h5 class="card-title mb-4">关于这个网站</h5>
            <p>这个跑步记录网站的灵感，来自我在水木社区看到的一个帖子。</p>
            <p>一位跑友分享了他坚持跑步十年的经历，累计跑量达到了三万公里。他接下来的目标是跑到四万公里——正好是绕地球赤道一圈的距离。</p>
            <p>这个目标让我很受触动。四万公里，相当于每天跑<span style="text-decoration: line-through;text-decoration-color: #ff6b6b;text-decoration-thickness: 2px;">十公里</span>五公里，连续跑<span style="text-decoration: line-through;text-decoration-color: #ff6b6b;text-decoration-thickness: 2px;">十一年</span>二十二年。虽然看起来很远，但分解到每一天，就是坚持跑下去。</p>
            <p>我不是专业跑者，<span style="text-decoration: line-through;text-decoration-color: #ff6b6b;text-decoration-thickness: 2px;">也不追求速度</span>(有那么一点点追求)。对我来说，跑步更重要的是保持健康和坚持的习惯。这个网站记录我的跑步历程，看着数字一点点增长，就是最好的动力。</p>
            <p>如果你也有类似的跑步目标，欢迎一起坚持。跑步路上，我们都不孤单。</p>
            <p class="text-end mt-4">2025年7月·广州</p>
        </div>
    </div>
  </div>
</div>

<div class="modal fade" id="certificateModal" tabindex="-1" aria-labelledby="certificateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="certificateModalLabel">等级证书</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="certificateImage" src="" class="img-fluid" style="max-height: 70vh;" alt="跑步等级证书">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">关闭</button>
      </div>
    </div>
  </div>
</div>

<footer class="container text-center py-4 mt-4">
    <small class="text-body-secondary">
        步履不停 &copy; {% if summarized_by_year %}{{ summarized_by_year.keys()|max }}{% endif %}
        {% if last_build_time %} | Last updated: {{ last_build_time }} {% endif %}
    </small>
</footer>



<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">跑步评论</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <div class="modal-body">
        <div id="commentList" class="mb-3" style="max-height: 250px; overflow-y: auto;"></div>
        <textarea class="form-control" id="commentText" rows="3" placeholder="写下你的感想吧... 可使用[img]url[/img]或[video]url[/video]分享图片和视频。"></textarea>
        <input type="hidden" id="commentRunId">
      </div>
      <div class="modal-footer d-flex justify-content-between align-items-center">
        <div id="editProfileTrigger" style="cursor: pointer;" title="点击修改昵称">
            <span class="small text-body-secondary">
                发言身份: <span id="commentUserIcon"></span> <span id="commentUserNickname"></span>
                <i class="bi bi-pencil-fill small ms-1"></i>
            </span>
        </div>
        <div>
            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary btn-sm" id="submitComment">提交</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profileModalLabel">编辑个人信息</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="nicknameInput" class="form-label">昵称</label>
                    <input type="text" class="form-control" id="nicknameInput" placeholder="请输入你的昵称">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-sm" id="saveProfileButton">保存</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="runDetailModal" tabindex="-1" aria-labelledby="runDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-body">
                <div class="detail-header d-flex align-items-center">
                    <button type="button" class="btn-back" data-bs-dismiss="modal" aria-label="Close"><i class="bi bi-chevron-left"></i></button>
                    <h5 class="detail-title" id="detailTitle">跑步详情</h5>
                </div>

                <div id="runDetailLoading" class="text-center p-5">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-secondary">正在加载跑步数据...</p>
                </div>

                <div id="runDetailContent" class="d-none">
                    <div class="container-fluid px-4">
                        <div class="text-center my-4" id="detailHeroDistance">
                            <span class="distance-value">--</span>
                            <span class="distance-unit">公里</span>
                        </div>

                        <div id="runMediaCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
                            <div class="carousel-indicators"></div>
                            <div class="carousel-inner"></div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#runMediaCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#runMediaCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                        
                        <div id="detailTimeAndWeather" class="text-center small text-body-secondary mb-5"></div>

                        <div class="mb-5">
                            <div class="d-flex justify-content-between align-items-center">
                                <h4 class="data-section-title">运动数据</h4>
                                <button id="viewRouteBtn" class="btn btn-sm mb-3" style="display: none;"><i class="bi bi-map-fill"></i> 查看路线</button>
                            </div>
                            <div class="row g-4 text-center" id="detailDataGrid">
                                </div>
                        </div>

                        <div id="detailAnalysisSections">
                            <div class="mb-5">
                                <h4 class="data-section-title">分段信息</h4>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>圈数</th>
                                                <th>时间</th>
                                                <th>距离</th>
                                                <th>配速</th>
                                                <th>心率</th>
                                                <th>步频</th>
                                            </tr>
                                        </thead>
                                        <tbody id="detailLapsTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="mb-5">
                                <h4 class="data-section-title">配速</h4>
                                <p class="analysis-summary mb-3">
                                    平均配速: <strong id="detailAvgPace">--</strong>
                                    <span class="mx-2">|</span>
                                    最快配速: <strong id="detailBestPace">--</strong>
                                </p>
                                <div style="height: 200px;"><canvas id="paceChart"></canvas></div>
                            </div>
                            
                            <div class="mb-5">
                                <h4 class="data-section-title">海拔</h4>
                                <div style="height: 200px;"><canvas id="elevationChart"></canvas></div>
                            </div>
                            
                            <div class="mb-5">
                                <h4 class="data-section-title">心率</h4>
                                 <p class="analysis-summary mb-3">
                                    平均心率: <strong id="detailAvgHr">--</strong>
                                    <span class="mx-2">|</span>
                                    最大心率: <strong id="detailMaxHr">--</strong>
                                </p>
                                <div style="height: 200px;"><canvas id="hrChart"></canvas></div>
                            </div>
                        </div>

                        <div id="runDetailTagsSection" class="mb-5">
                            <h4 class="data-section-title">标签</h4>
                            <div id="runDetailTagsContainer" class="mb-2">
                            </div>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="runDetailTagInput" placeholder="添加新标签...">
                                <button class="btn btn-outline-secondary" type="button" id="addTagButton" style="--bs-btn-border-color: var(--border-color); --bs-btn-hover-bg: var(--accent-color); --bs-btn-hover-border-color: var(--accent-color); --bs-btn-active-bg: var(--accent-color); --bs-btn-active-border-color: var(--accent-color); color: var(--text-secondary);">添加</button>
                            </div>
                            <div id="suggestedTagsContainer" class="mt-2">
                            </div>
                        </div>

                        <div id="runDetailComments" class="pb-4">
                            <hr>
                            <h4 class="data-section-title mt-4">评论</h4>
                            <div id="runDetailCommentList" class="mb-3"></div>
                            <div id="runDetailCommentForm" class="p-3">
                                <h6 class="mb-3">发表评论</h6>
                                <textarea class="form-control" id="runDetailCommentText" rows="3" placeholder="写下你的感想吧..."></textarea>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div id="detailEditProfileTrigger" style="cursor: pointer;" title="点击修改昵称">
                                        <span class="small text-secondary">
                                            发言身份: <span id="detailCommentUserIcon"></span> <span id="detailCommentUserNickname"></span>
                                            <i class="bi bi-pencil-fill small ms-1"></i>
                                        </span>
                                    </div>
                                    <button type="button" class="btn btn-primary btn-sm" id="submitRunDetailComment">
                                        <i class="bi bi-send-fill"></i> 提交
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mediaGalleryModal" tabindex="-1" aria-labelledby="mediaGalleryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body p-0">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        <div id="mediaCarousel" class="carousel slide">
          <div class="carousel-inner" id="galleryCarouselInner">
            </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#mediaCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#mediaCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="routeMapModal" tabindex="-1" aria-labelledby="routeMapModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="routeMapModalLabel">跑步路线</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="routeMap"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="calendarEditorModal" tabindex="-1" aria-labelledby="calendarEditorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="calendarEditorModalLabel">赛历编辑器</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>当前赛事</h6>
                <div id="calendarEditorList" class="list-group mb-4"></div>
                
                <hr>
                
                <h6 id="calendarFormTitle">添加新赛事</h6>
                <form id="calendarEventForm">
                    <input type="hidden" id="event-id">
                    <div class="mb-2">
                        <label for="event-date" class="form-label">日期</label>
                        <input type="date" class="form-control form-control-sm" id="event-date" required>
                    </div>
                    <div class="mb-2">
                        <label for="event-name" class="form-label">赛事名称</label>
                        <input type="text" class="form-control form-control-sm" id="event-name" required>
                    </div>
                    <div class="mb-2">
                        <label for="event-category" class="form-label">类别 (如: 全马)</label>
                        <input type="text" class="form-control form-control-sm" id="event-category" required>
                    </div>
                    <div class="mb-3">
                        <label for="event-status" class="form-label">状态 (如: 已报名)</label>
                        <input type="text" class="form-control form-control-sm" id="event-status" required>
                    </div>
                    <button type="submit" class="btn btn-sm btn-primary">保存赛事</button>
                    <button type="button" id="cancelEditBtn" class="btn btn-sm btn-secondary" style="display: none;">取消编辑</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-success" id="saveAllCalendarChanges">保存所有更改到服务器</button>
            </div>
        </div>
    </div>
</div>


</body>
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/chartjs-plugin-annotation/3.1.0/chartjs-plugin-annotation.min.js "></script>
<script src="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
	let monthlyDistanceChart = null;
	let dailyDistanceChart = null;
	let yearlyDistanceChart = null;
    let paceChart = null;
    let elevationChart = null;
    let hrChart = null;
	let cityMap = null;
    let routeMapInstance = null;
    let currentPolyline = null;
    let allRunRows = [];
    const commentApiBase = 'https://kv.linwn.net';
    let detailPhotoUrls = [];
    let currentDetailRunId = null;
    let currentRunTags = [];
    const suggestedTags = ['长距离', '恢复跑', '节奏跑', '间歇跑', '越野', '比赛', '运动场'];
    let marathonEventsCache = [];


	document.documentElement.setAttribute('data-bs-theme', 'dark');

    function setRandomQuote() {
        const quotes = [ "路漫漫其修远兮", "道阻且长" ];
        const quoteElement = document.getElementById('running-quote');
        if (quoteElement) {
            const randomIndex = Math.floor(Math.random() * quotes.length);
            quoteElement.textContent = quotes[randomIndex];
        }
    }

    function generateRandomProfile() {
        const adjectives = ['快乐', '坚定', '闪亮', '迷路', '温柔'];
        const nouns = ['小鹿', '绿豆芽', '星星', '猫咪', '纸飞机'];
        const icons = ['🌱','🌸','🌟','🍃','🌊','🐾','🌀','🌼'];
        return {
            icon: icons[Math.floor(Math.random() * icons.length)],
            nickname: `匿名${adjectives[Math.floor(Math.random() * adjectives.length)]}${nouns[Math.floor(Math.random() * nouns.length)]}`
        };
    }

    function loadProfileIntoModals() {
        let profile;
        const isAdmin = localStorage.getItem('run_role') === 'admin';
        if (isAdmin) {
            profile = { icon: '👑', nickname: '管理员' };
            document.getElementById('editCalendarBtn').style.display = 'block';
        } else {
            document.getElementById('editCalendarBtn').style.display = 'none';
            try {
                profile = JSON.parse(localStorage.getItem('run_profile'));
                if (!profile || !profile.icon || !profile.nickname) { throw new Error("Invalid profile"); }
            } catch (e) {
                profile = generateRandomProfile();
                localStorage.setItem('run_profile', JSON.stringify(profile));
            }
        }
        document.getElementById('commentUserIcon').textContent = profile.icon;
        document.getElementById('commentUserNickname').textContent = profile.nickname;
        document.getElementById('detailCommentUserIcon').textContent = profile.icon;
        document.getElementById('detailCommentUserNickname').textContent = profile.nickname;
        document.getElementById('nicknameInput').value = profile.nickname;
        document.getElementById('nicknameInput').disabled = isAdmin;
        document.getElementById('saveProfileButton').style.display = isAdmin ? 'none' : 'inline-block';
    }

    function initializeUserProfile() {
        const params = new URLSearchParams(window.location.search);
        const adminKey = params.get('admin_key');
        if (adminKey === 'runpage123') { // Replace with a real key mechanism if needed
            localStorage.setItem('run_role', 'admin');
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + window.location.hash;
            window.history.replaceState({path: newUrl}, '', newUrl);
        }
        loadProfileIntoModals();
        document.getElementById('saveProfileButton').addEventListener('click', () => {
            const newNickname = document.getElementById('nicknameInput').value.trim();
            if (newNickname) {
                const currentProfile = JSON.parse(localStorage.getItem('run_profile')) || generateRandomProfile();
                currentProfile.nickname = newNickname;
                localStorage.setItem('run_profile', JSON.stringify(currentProfile));
                loadProfileIntoModals();
                bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
            }
        });
    }

    function parsePaceToSeconds(paceStr) {
        if (!paceStr || !paceStr.includes("'")) { return 9999; }
        try {
            const parts = paceStr.replace('"', '').split("'");
            const minutes = parseInt(parts[0], 10);
            const seconds = parseInt(parts[1], 10);
            if (isNaN(minutes) || isNaN(seconds)) { return 9999; }
            return (minutes * 60) + seconds;
        } catch (e) {
            return 9999;
        }
    }
    
    function formatPaceFromSeconds(totalSeconds) {
        if (totalSeconds === null || totalSeconds === 0) return "0'00\"";
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = Math.round(totalSeconds % 60);
        return `${minutes}'${seconds.toString().padStart(2, '0')}"`;
    }

    async function loadCommentCounts() {
        document.querySelectorAll('.comment-count').forEach(async (el) => {
            const runId = el.dataset.runId;
            try {
                const res = await fetch(`${commentApiBase}/count?runId=${encodeURIComponent(runId)}`);
                const data = await res.json();
                el.textContent = data.count ?? 0;
            } catch {
                el.textContent = 0;
            }
        });
    }

    async function generateMarathonCalendar() {
        const container = document.getElementById('marathon-calendar-container');
        if (!container) return;
        container.innerHTML = '<div class="content-card text-center text-body-secondary">加载赛历数据中...</div>';

        try {
            const response = await fetch(`${commentApiBase}/marathon-events`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            marathonEventsCache = await response.json();
        } catch (error) {
            console.error("Could not fetch marathon data:", error);
            container.innerHTML = '<div class="content-card text-center text-danger">无法加载赛历数据，请稍后重试。</div>';
            return;
        }
        
        const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
        const eventsByMonth = marathonEventsCache.reduce((acc, event) => {
            const month = event.date.substring(0, 7);
            if (!acc[month]) acc[month] = [];
            acc[month].push(event);
            return acc;
        }, {});

        const sortedMonths = Object.keys(eventsByMonth).sort();
        
        if (sortedMonths.length === 0) {
            container.innerHTML = '<div class="content-card text-center text-body-secondary">暂无赛事计划</div>';
            return;
        }

        let calendarHTML = '';
        sortedMonths.forEach(monthStr => {
            const [year, month] = monthStr.split('-').map(Number);
            const monthEvents = eventsByMonth[monthStr];
            
            calendarHTML += `<div class="month-grid">`;
            calendarHTML += `<h4 class="mb-3">${year}年 ${month}月</h4>`;
            
            calendarHTML += `<div class="calendar-list-view">`;
            monthEvents.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(event => {
                const eventDate = new Date(event.date.replace(/-/g, '/'));
                calendarHTML += `
                    <div class="calendar-list-item">
                        <div class="list-date">
                            <div class="day">${eventDate.getDate()}</div>
                            <div class="weekday">${weekdays[eventDate.getDay()]}</div>
                        </div>
                        <div class="list-details">
                            <div class="name">${event.name} <span class="category">${event.category}</span></div>
                            <div class="status">${event.status}</div>
                        </div>
                    </div>`;
            });
            calendarHTML += `</div>`;

            let gridHtml = `<table class="calendar-table">`;
            gridHtml += `<thead><tr>${['日', '一', '二', '三', '四', '五', '六'].map(d => `<th>${d}</th>`).join('')}</tr></thead>`;
            
            let tbodyHtml = '<tbody>';
            const firstDay = new Date(year, month - 1, 1);
            const daysInMonth = new Date(year, month, 0).getDate();
            const startingDay = firstDay.getDay();
            let date = 1;

            for (let i = 0; i < 6; i++) {
                if (date > daysInMonth) break;
                tbodyHtml += '<tr>';
                for (let j = 0; j < 7; j++) {
                    if ((i === 0 && j < startingDay) || date > daysInMonth) {
                        tbodyHtml += '<td class="empty"></td>';
                    } else {
                        const eventsOnThisDay = monthEvents.filter(e => parseInt(e.date.substring(8, 10), 10) === date);
                        let cellClass = eventsOnThisDay.length > 0 ? 'event' : '';
                        let dayClass = eventsOnThisDay.length > 0 ? 'has-event' : '';
                        
                        tbodyHtml += `<td class="${cellClass}">`;
                        tbodyHtml += `<div class="day-number ${dayClass}">${date}</div>`;
                        if(eventsOnThisDay.length > 0) {
                            eventsOnThisDay.forEach(event => {
                                tbodyHtml += `<div class="event-item" title="${event.name}">${event.name}</div>`;
                            });
                            tbodyHtml += '<div class="event-details popup">';
                             eventsOnThisDay.forEach(event => {
                                tbodyHtml += `<div class="event-item">${event.name} <span class="category">${event.category}</span></div>`;
                                tbodyHtml += `<div class="event-status">${event.status}</div>`;
                            });
                            tbodyHtml += '</div>';
                        }
                        tbodyHtml += '</td>';
                        date++;
                    }
                }
                tbodyHtml += '</tr>';
            }
            tbodyHtml += '</tbody></table>';
            gridHtml += tbodyHtml;
            calendarHTML += `<div class="calendar-grid-view">${gridHtml}</div></div>`;
        });
        container.innerHTML = calendarHTML;
        setupCalendarHovers();
    }

    function setupCalendarHovers() {
        const eventCells = document.querySelectorAll('.calendar-table td.event');
        eventCells.forEach(cell => {
            const popup = cell.querySelector('.event-details.popup');
            if (!popup) return;

            cell.addEventListener('mouseenter', () => {
                const rect = cell.getBoundingClientRect();
                const popupWidth = popup.offsetWidth;
                const viewportWidth = window.innerWidth;
                
                popup.classList.remove('edge-left', 'edge-right');

                if (rect.left + rect.width / 2 + popupWidth / 2 > viewportWidth - 10) {
                    popup.classList.add('edge-right');
                } 
                else if (rect.left + rect.width / 2 - popupWidth / 2 < 10) {
                    popup.classList.add('edge-left');
                }
                popup.classList.add('visible');
            });

            cell.addEventListener('mouseleave', () => {
                popup.classList.remove('visible');
            });
        });
    }

    async function initMarathonView() {
        const container = document.getElementById('marathon-calendar-container');
        if (container && (container.innerHTML.trim() === '' || container.innerHTML.includes('加载'))) {
            await generateMarathonCalendar();
        }
    }

    function openMediaGallery(photoUrls, startIndex) {
        const galleryCarouselInner = document.getElementById('galleryCarouselInner');
        galleryCarouselInner.innerHTML = '';
        photoUrls.forEach((url, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'carousel-item';
            if (index === startIndex) {
                itemDiv.classList.add('active');
            }
            itemDiv.innerHTML = `<img src="${url}" class="d-block" alt="gallery image">`;
            galleryCarouselInner.appendChild(itemDiv);
        });
        const mediaGalleryModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('mediaGalleryModal'));
        mediaGalleryModal.show();
    }
    
    // --- TAGS FEATURE ---
    function renderRunTags() {
        const container = document.getElementById('runDetailTagsContainer');
        container.innerHTML = currentRunTags.map((tag, index) =>
            `<span class="badge rounded-pill text-bg-secondary me-1 mb-1" style="font-weight: 500; background-color: var(--hover-bg) !important; color: var(--text-secondary) !important; padding: 0.3em 0.5em;">
                ${tag}
                <button type="button" class="btn-close ms-1" aria-label="Remove tag" data-tag-index="${index}" style="font-size: 0.6em; filter: invert(0.8);"></button>
            </span>`
        ).join('');
    }

    function renderSuggestedTags() {
        const container = document.getElementById('suggestedTagsContainer');
        container.innerHTML = suggestedTags.map(tag =>
            `<button type="button" class="btn btn-sm" data-tag-name="${tag}" style="font-size: 0.75rem; --bs-btn-padding-y: .1rem; --bs-btn-padding-x: .4rem; margin: 2px;">${tag}</button>`
        ).join('');
    }

    async function loadRunTags(runId) {
        try {
            const res = await fetch(`${commentApiBase}/tags?runId=${encodeURIComponent(runId)}`);
            if (res.ok) {
                const data = await res.json();
                currentRunTags = data.tags || [];
            } else {
                currentRunTags = [];
            }
        } catch (e) {
            console.error("Failed to load tags:", e);
            currentRunTags = [];
        }
        renderRunTags();
    }

    async function saveRunTags(runId) {
        try {
            await fetch(`${commentApiBase}/tags`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ runId: runId, tags: currentRunTags })
            });
        } catch (e) {
            console.error("Failed to save tags:", e);
            alert('标签保存失败！');
        }
    }

    async function addTag(tag) {
        const trimmedTag = tag.trim();
        if (trimmedTag && !currentRunTags.includes(trimmedTag)) {
            currentRunTags.push(trimmedTag);
            renderRunTags();
            await saveRunTags(currentDetailRunId);
        }
    }

    async function removeTag(index) {
        currentRunTags.splice(index, 1);
        renderRunTags();
        await saveRunTags(currentDetailRunId);
    }
    // --- END TAGS FEATURE ---


    document.addEventListener('DOMContentLoaded', function() {
		
    initializeUserProfile();
    loadCommentCounts();

    document.getElementById('editProfileTrigger').addEventListener('click', () => { new bootstrap.Modal(document.getElementById('profileModal')).show(); });
    document.getElementById('detailEditProfileTrigger').addEventListener('click', () => { new bootstrap.Modal(document.getElementById('profileModal')).show(); });
    
    // --- TAGS EVENT LISTENERS ---
    document.getElementById('addTagButton').addEventListener('click', async () => {
        const input = document.getElementById('runDetailTagInput');
        await addTag(input.value);
        input.value = '';
    });
    document.getElementById('runDetailTagInput').addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const input = document.getElementById('runDetailTagInput');
            await addTag(input.value);
            input.value = '';
        }
    });
    document.getElementById('runDetailTagsContainer').addEventListener('click', (e) => {
        if (e.target.matches('button.btn-close')) {
            const index = parseInt(e.target.dataset.tagIndex, 10);
            removeTag(index);
        }
    });
    document.getElementById('suggestedTagsContainer').addEventListener('click', async (e) => {
        if (e.target.matches('button')) {
            const tagName = e.target.dataset.tagName;
            await addTag(tagName);
        }
    });
    // --- END TAGS EVENT LISTENERS ---

    document.getElementById('goto-data-tab')?.addEventListener('click', e => {
        e.preventDefault();
        const dataTab = document.getElementById('data-tab');
        if (dataTab) {
            bootstrap.Tab.getOrCreateInstance(dataTab).show();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    });

    let startX = 0, startY = 0;
    const tabContent = document.querySelector('.tab-content');
    const minSwipeDistance = 100;
    
    tabContent.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; startY = e.touches[0].clientY; }, false);
    
    tabContent.addEventListener('touchend', (e) => {
      if (e.target.closest('#cityMap') || e.target.closest('.calendar-table')) return;
      const endX = e.changedTouches[0].clientX;
      const diffX = endX - startX;
      if (Math.abs(diffX) > minSwipeDistance && Math.abs(diffX) > Math.abs(e.changedTouches[0].clientY - startY)) {
        const activeTab = document.querySelector('#main-nav-tabs .nav-link.active');
        const tabs = Array.from(document.querySelectorAll('#main-nav-tabs .nav-link'));
        const currentIndex = tabs.indexOf(activeTab);
        if (diffX > 0 && currentIndex > 0) {
            bootstrap.Tab.getOrCreateInstance(tabs[currentIndex - 1]).show();
        } else if (diffX < 0 && currentIndex < tabs.length - 1) {
            bootstrap.Tab.getOrCreateInstance(tabs[currentIndex + 1]).show();
        }
      }
    }, false);
    
    const activateTabFromHash = () => {
      const hash = window.location.hash.substring(1);
      if (hash) {
        const tabTrigger = document.querySelector(`.nav-link[data-hash="${hash}"]`);
        if (tabTrigger) { bootstrap.Tab.getOrCreateInstance(tabTrigger).show(); }
      }
    };
    
    document.querySelectorAll('#main-nav-tabs .nav-link').forEach(tabEl => {
      tabEl.addEventListener('shown.bs.tab', event => {
        const hash = event.target.dataset.hash;
        if (hash) { history.pushState(null, '', '#' + hash); }
        if (hash === 'marathon') { initMarathonView(); }
      });
    });

    window.addEventListener('popstate', activateTabFromHash);
    activateTabFromHash();
    if (window.location.hash === '#marathon') { initMarathonView(); }
    const marathonTab = document.querySelector('#marathon-tab');
    if (marathonTab) {
        const marathonPane = document.getElementById('marathon-pane');
        const calendarToggle = document.getElementById('calendar-view-toggle');
        
        marathonPane.classList.add('view-grid'); 

        if(calendarToggle) {
            calendarToggle.addEventListener('click', (e) => {
                if (e.target.matches('button')) {
                    const view = e.target.dataset.view;
                    marathonPane.classList.remove('view-list', 'view-grid');
                    marathonPane.classList.add(`view-${view}`);
                    calendarToggle.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                }
            });
        }
    }
    
    const eventsTab = document.querySelector('#events-tab');
    if(eventsTab) {
        eventsTab.addEventListener('shown.bs.tab', function() {
            if (!cityMap) {
              cityMap = L.map('cityMap', { center: [36, 108], zoom: 4, zoomControl: false });
              L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', { attribution: '', subdomains: 'abcd', minZoom: 3, maxZoom: 18 }).addTo(cityMap);
              cityMap.attributionControl.setPrefix('');
              {% for city in city_stats %}
              {% if city.coordinates and city.coordinates|length == 2 %}
                  L.circleMarker([{{ city.coordinates[0] }}, {{ city.coordinates[1] }}], { radius: Math.log({{ city.count }}) + 3, fillColor: "var(--accent-color)", color: "var(--bg-color)", weight: 1.5, opacity: 1, fillOpacity: 0.7 }).addTo(cityMap).bindPopup(`<b>{{ city.name }}</b><br>跑步次数: {{ city.count }}<br>总距离: {{ city.distance }}km`);
              {% endif %}
              {% endfor %}
            } else {
              cityMap.invalidateSize();
            }
        });
    }
    
    document.querySelectorAll('.flip-icon-container').forEach(icon => {
        icon.addEventListener('click', (event) => {
            event.stopPropagation();
            icon.closest('.stat-card-flipper').classList.toggle('flipped');
        });
    });

	const monthlyData = {{ chart_monthly_data|tojson }};
	const dailyData = {{ chart_30_days.data|tojson }};
	const yearlyData = {{ chart_yearly_data|tojson }};
    if (document.getElementById('dailyDistanceChart')) {
        const gridColor = 'rgba(128, 128, 128, 0.2)';
        const tickColor = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim();
        const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
        const annotationColor = getComputedStyle(document.documentElement).getPropertyValue('--bs-code-color').trim();
        const monthlyTotal = monthlyData.reduce((a, b) => a + b, 0);
        const monthlyAvg = monthlyData.filter(d => d > 0).length > 0 ? (monthlyTotal / monthlyData.filter(d => d > 0).length) : 0;
        const dailyTotal = dailyData.reduce((a, b) => a + b, 0);
        const dailyAvg = dailyData.filter(d => d > 0).length > 0 ? (dailyTotal / dailyData.filter(d => d > 0).length) : 0; 
        const yearlyTotal = yearlyData.reduce((a, b) => a + b, 0);
        const yearlyAvg = yearlyData.filter(d => d > 0).length > 0 ? (yearlyTotal / yearlyData.filter(d => d > 0).length) : 0;
        Chart.defaults.font.family = "'Noto Sans SC', sans-serif";
        const annotationDefaults = (avg) => ({ type: 'line', yMin: avg, yMax: avg, borderColor: annotationColor, borderWidth: 1.5, borderDash: [6, 6] });
        
        const dailyCtx = document.getElementById('dailyDistanceChart').getContext('2d');
        dailyDistanceChart = new Chart(dailyCtx, { type: 'bar', data: { labels: {{ chart_30_days.labels|tojson }}, datasets: [{ label: '距离 (km)', data: dailyData, backgroundColor: accentColor + '99', borderColor: accentColor, borderWidth: 1, borderRadius: 2, hoverBackgroundColor: accentColor }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: tickColor, callback: (v) => v + ' km'}}, x: { grid: { display: false }, ticks: { color: tickColor, maxRotation: 0, minRotation: 0 }}}, plugins: { legend: { display: false }, title: { display: true, text: `总 ${dailyTotal.toFixed(1)}km / 日均 ${dailyAvg.toFixed(1)}km`, align: 'start', color: annotationColor, }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.raw} km` }}, annotation: { annotations: { avgLine: annotationDefaults(dailyAvg) } } } } });
        const monthlyCtx = document.getElementById('monthlyDistanceChart').getContext('2d');
        monthlyDistanceChart = new Chart(monthlyCtx, { type: 'bar', data: { labels: {{ chart_monthly_labels|tojson }}, datasets: [{ label: '距离 (km)', data: monthlyData, backgroundColor: accentColor + '99', borderColor: accentColor, borderWidth: 1, borderRadius: 4, hoverBackgroundColor: accentColor }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: tickColor, callback: (v) => v + ' km'}}, x: { grid: { display: false }, ticks: { color: tickColor, maxRotation: 0, minRotation: 0 }}}, plugins: { legend: { display: false }, title: { display: true, text: `总 ${monthlyTotal.toFixed(1)}km / 月均 ${monthlyAvg.toFixed(1)}km`, align: 'start', color: annotationColor, }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.raw} km` }}, annotation: { annotations: { avgLine: annotationDefaults(monthlyAvg) } } } } });
        const yearlyCtx = document.getElementById('yearlyDistanceChart').getContext('2d');
        yearlyDistanceChart = new Chart(yearlyCtx, { type: 'bar', data: { labels: {{ chart_yearly_labels|tojson }}, datasets: [{ label: '距离 (km)', data: yearlyData, backgroundColor: accentColor + '99', borderColor: accentColor, borderWidth: 1, borderRadius: 4, hoverBackgroundColor: accentColor }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: tickColor, callback: (v) => v + ' km'}}, x: { grid: { display: false }, ticks: { color: tickColor, maxRotation: 0, minRotation: 0 } } }, plugins: { legend: { display: false }, title: { display: true, text: `总 ${yearlyTotal.toFixed(1)}km / 年均 ${yearlyAvg.toFixed(1)}km`, align: 'start', color: annotationColor, }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.raw} km` }}, annotation: { annotations: { avgLine: annotationDefaults(yearlyAvg) } } } } });

        document.querySelectorAll('#chart-toggle .btn').forEach(button => { button.addEventListener('click', function() { document.querySelectorAll('#chart-toggle .btn').forEach(btn => btn.classList.remove('active')); this.classList.add('active'); const chartType = this.dataset.chart; Object.values({ monthly: document.getElementById('monthlyChartContainer'), daily: document.getElementById('dailyChartContainer'), yearly: document.getElementById('yearlyChartContainer') }).forEach(c => c.style.display = 'none'); document.getElementById(`${chartType}ChartContainer`).style.display = 'block'; }); });
    }
    
    const dataPane = document.getElementById('data-pane');
    if (dataPane) {
        allRunRows = Array.from(document.querySelectorAll('#summary-table-body tr'));
        const updateDataView = () => {
            const minDist = parseFloat(document.querySelector('#data-dist-filter-toggle .active').dataset.dist);
            const maxPace = parseFloat(document.querySelector('#data-pace-filter-toggle .active').dataset.pace);
            const selectedCity = document.getElementById('data-city-filter').value;
            const startDate = document.getElementById('date-filter-start').value;
            const endDate = document.getElementById('date-filter-end').value;
            const activeSortHeader = document.querySelector('.sortable-header[aria-sort]');
            const sortProp = activeSortHeader ? activeSortHeader.dataset.sort : 'date';
            const sortOrder = activeSortHeader ? activeSortHeader.getAttribute('aria-sort') : 'descending';

            let filteredRows = allRunRows.filter(row => {
                const isVisible = (parseFloat(row.dataset.distance) >= minDist) &&
                                (parsePaceToSeconds(row.dataset.paceStr) <= maxPace) &&
                                (selectedCity === 'all' || row.dataset.city === selectedCity) &&
                                (!startDate || row.dataset.date >= startDate) &&
                                (!endDate || row.dataset.date <= endDate);
                row.style.display = isVisible ? '' : 'none';
                return isVisible;
            });
            
            filteredRows.sort((a, b) => {
                let valA, valB;
                if (sortProp === 'distance') { [valA, valB] = [parseFloat(a.dataset.distance), parseFloat(b.dataset.distance)]; } 
                else if (sortProp === 'pace') { [valA, valB] = [(-1)*parsePaceToSeconds(a.dataset.paceStr), (-1)*parsePaceToSeconds(b.dataset.paceStr)]; } 
                else { [valA, valB] = [a.dataset.date, b.dataset.date]; }
                if (valA < valB) return sortOrder === 'ascending' ? -1 : 1;
                if (valA > valB) return sortOrder === 'ascending' ? 1 : -1;
                return 0;
            });
            document.getElementById('summary-table-body').append(...filteredRows);
        };

        document.getElementById('data-view-toggle').addEventListener('click', (e) => {
            if (!e.target.matches('button')) return;
            document.querySelector('#data-view-toggle .active').classList.remove('active');
            e.target.classList.add('active');
            const isSummary = e.target.dataset.view === 'summary';
            document.getElementById('summary-data-view').style.display = isSummary ? '' : 'none';
            document.getElementById('yearly-data-view').style.display = isSummary ? 'none' : '';
            document.getElementById('data-controls-collapse').classList.toggle('d-lg-block', isSummary);
            document.getElementById('summary-controls-toggle').style.display = isSummary ? '' : 'none';
            if(isSummary) updateDataView();
        });

        document.querySelectorAll('.sortable-header').forEach(header => {
            header.addEventListener('click', () => {
                const currentSort = header.getAttribute('aria-sort');
                let newSort = (currentSort === 'descending') ? 'ascending' : 'descending';
                document.querySelectorAll('.sortable-header').forEach(h => h.removeAttribute('aria-sort'));
                header.setAttribute('aria-sort', newSort);
                updateDataView();
            });
        });

        [...document.querySelectorAll('#data-dist-filter-toggle, #data-pace-filter-toggle')].forEach(group => {
            group.addEventListener('click', e => {
                if(e.target.tagName === 'BUTTON') {
                    group.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    updateDataView();
                }
            });
        });
        ['data-city-filter', 'date-filter-start', 'date-filter-end'].forEach(id => {
            document.getElementById(id).addEventListener('change', updateDataView);
        });
        
        updateDataView();
    }
    
    const eventsPane = document.getElementById('events-pane');
    if (eventsPane) {
        eventsPane.querySelector('#events-view-toggle').addEventListener('click', (e) => {
            if (!e.target.matches('button')) return;
            eventsPane.querySelector('#events-view-toggle .active').classList.remove('active');
            e.target.classList.add('active');
            const isCategory = e.target.dataset.view === 'category';
            eventsPane.querySelector('#events-category-view').style.display = isCategory ? '' : 'none';
            eventsPane.querySelector('#events-timeline-view').style.display = isCategory ? 'none' : 'block';
        });
    }

    function renderCommentList(container, comments) {
        container.style.color = 'var(--text-primary)';
        if (Array.isArray(comments) && comments.length > 0) {
            container.innerHTML = comments.map(c => 
                `<div class="border-bottom py-2" style="border-color: var(--border-color) !important;">
                    <small class="text-secondary">${c.nickname || '🌱 匿名'} · ${new Date(c.ts).toLocaleString()}</small>
                    <div class="mt-1" style="color: var(--text-primary);">${c.text}</div>
                 </div>`
            ).join('');
        } else {
             container.innerHTML = '<div class="text-secondary text-center py-2">暂无评论</div>';
        }
    }
    
    function decodePolyline(encoded) {
        if (!encoded) return [];
        let index = 0, len = encoded.length, lat = 0, lng = 0, array = [];
        while (index < len) {
            let b, shift = 0, result = 0;
            do { b = encoded.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
            let dlat = ((result & 1) ? ~(result >> 1) : (result >> 1)); lat += dlat;
            shift = 0; result = 0;
            do { b = encoded.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
            let dlng = ((result & 1) ? ~(result >> 1) : (result >> 1)); lng += dlng;
            array.push([lat * 1e-5, lng * 1e-5]);
        }
        return array;
    }

    async function refreshDetailComments(runId) {
        const listContainer = document.getElementById('runDetailCommentList');
        try {
            const res = await fetch(`${commentApiBase}/comments?runId=${encodeURIComponent(runId)}`);
            if(!res.ok) throw new Error("Failed to fetch comments");
            const data = await res.json();
            renderCommentList(listContainer, data);
        } catch(e) {
            listContainer.innerHTML = '<div class="text-danger">评论加载失败</div>';
        }
    }

    async function showRunDetailModal(runId, preloadedData = {}, scrollToComments = false) {
        currentDetailRunId = runId;
        console.log(JSON.stringify(preloadedData, null, 2))
        const modalEl = document.getElementById('runDetailModal');
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        
        document.getElementById('runDetailContent').classList.add('d-none');
        document.getElementById('runDetailLoading').style.display = 'block';
        
        modal.show();

        // --- OPTIMIZATION: Pre-populate data ---
        document.getElementById('detailTitle').textContent = `跑步详情`;
        document.getElementById('detailHeroDistance').querySelector('.distance-value').textContent = preloadedData.distanceFormatted || '--';
        const dataGrid = document.getElementById('detailDataGrid');
        dataGrid.innerHTML = `
            <div class="col-4"><div class="data-point-value">${preloadedData.duration || '--'}</div><div class="data-point-label">训练时长</div></div>
            <div class="col-4"><div class="data-point-value">${preloadedData.paceStr || '--'}</div><div class="data-point-label">平均配速</div></div>
            <div class="col-4"><div class="data-point-value">--</div><div class="data-point-label">运动消耗</div></div>
        `;
        // Clear old detailed data
        document.getElementById('detailAnalysisSections').style.display = 'none';
        document.getElementById('detailLapsTableBody').innerHTML = '';
        if(paceChart) paceChart.destroy();
        if(elevationChart) elevationChart.destroy();
        if(hrChart) hrChart.destroy();
        
        try {
            //const response = await fetch(`https://run.linwn.net/data/runs/${runId}.json`);
            //if (!response.ok) throw new Error(`Could not load run data. Status: ${response.status}`);
            //const data = await response.json();
            const data = {
              "weather": { "temperature_c": 28.5, "condition": "多云", "wind_speed_kmh": 12.3 },
              "route": { "encoded_polyline": "q|noCgr_qT?C?E?C?E?C?E?E?E?E?E@E?G?E?E?G?E?GAE?E?E?E?E?E?E?E@E?E?E?E?E?E?E@C?E?E?E?E?E?E?E?E?C?E?E?C?EAE?E?C?E?C?E?E?C?E?C?E?C?E?E?E?E?EAE?E?E?E?E?E?E?E?E?E?EAE?E?E?C?E?E?E?E?E?E?E?E@E?C?E?E?E?E?E?C?E@E?E?C?E?E?C?E?E?C?E?E?C?E?E?C?E@E?E@E?E?E@E?E?E?E?E?E?E?E@CAE?E?C?E?E?C?E?E?E?C?E?E?CAE?E?E?E@E?C?E?E?E?E?C?E?E?E?C?E?C?E?C?C?E?C?C?E?C?E?C?E?C?E?C?E?C?C?E?C@E?E?C?E?E?E?C?E?E?E?E?C?E?E?C?E@CAE?E@C?E?C?EAC?C?E?C?EAC?E?C?CAE?C?E?C?E?C?E?C?E?E@E?E@C?E?E@C?E?C?E@E?C?E?E?E?E?E?EAG?E?EAE?EAE?EAEAEACAEAECCCECAECEACAEAE?G?EAE@E?E?E?E@E?E@E?E@E?E@E@E?E?C@E?E?C@E?E?C@E?C?E?C?C?EAC?E?C?EAC?E?EAE?C?E?C?E?C?EAC?E?C?CAE?E?CAEAC?E?EAC?E?EAE?E?E?E?E?C?E?E@E?C@E?E?E@C?E?E?E?C?E?E?E?C?E?C@E?C?C?CAC?E@C?C?C@E?C?E?C@E?E?E?E?E?E?C?E?C?E?CAE?C?E?CAE?C?EAC?E?E?C?E?C?C?E?C?C?E?C?C?C@C?E?C?C?C?E?C?C?E?C?C?E?C?C?CAE?C?C?E?EAC?E?E@E?E?C?E?E?E?E?E?E@C?E?E?E@C?E?E?C?E?E?E?C?E@C?C?E@C?C?C?C?C?C@CAC?C?E?C?E?CAE?C?E?C?E?C?E?C?C?E?C@E?C?C?E?C?C?E?E?C?EAE?C?E?E?E?C?E?E?E?C?E?E?C?E?CAE?C?E?CAE?EAC?C?EAC?E?C@E?C?C?C@C?C?A?E?C?C?EAC?E?E?E?C@E?E@E?E@E@E?C@E?E?E?C?EAC?E?E?EAC?EAE?E?EAE?E?C?E?E?E@C?E?C?E?C?E?C@E?C?E?C@E?C@E?E@C?C?E@C?E?C@E?C?EAC?E?C?C?E?E?C@E@C?E@C@E?C?E@E?C?E?E?C?E?C@E?C?E@C?E?E?E?C?E?C?E?C?E?C?C?E?C?E?C?E@C?E@C?C@E?E?C@E?C?E?CAE?C?C?E?C?C@C?C@E@C?C@E?C?E?C?E?EAC?E?CAE?E?C?C?E?C?C?CAE?CAC?EAC?CAC?C?E?C?C?C?C?C@C?E?C?C?E@C?CAC?C?C?C?E?C?C?C?E?C?C?C?C?C?C?E?C?C?C?CACAACACACAE?E?E?E?G?E?E?E?G?E@E?E?E@G?E?E?C@E?E?E@E?E?E?E?E?E?E?G?E@E?E?E@E?E?E@E?E?G?E@E?E@C?E@E?E@E@E?E@C@E@E@E@E?E@E@E@E@E@C@E@E@E@E@C?E@E@C@E@E@E@E@E@C@E@E@E@E@EBE@C@E@C@E?E@E@C@E?E@C@E?E@C@E?C@E@C@E?C@E@C@C?E@C@E@C@C?E@E@C@E@C@E@E?C@E@C@E@C@C@E@C@E@C?E@E@C@E@E@E@EBE@E@E@G@E@E@E@E@E@EBE@C@E@E@E?C@E@C@E@C?C@C@C?E@C@C@E?E@C@E@C@E@C@E@E@C@E@E@E@E@E@E@E@E?E@E@E@E@E@E?E@E@C@E@E@E@C@E@E@E?C@G@E?E@E?E@E?E@E@E@E@C@EBE@E@E@C@EBE@E@E@E@E@EBE@C@E@E@E?E@E@E@E@E@E@E?G@E@E@E@E@E@E@E?E@E@C@E@E@C@E@E@C@E@E?E@C@E?E@E@E@E@E@E@E@E@E@E@E@C@E@E@C@E@E@E@G?E@E@E@E?G@E@E?E@E@E?E@E@E?E@C?E?E@E?E@C?E@E?E@E?E@E?E@E?E@E@E?C@E@E?E@E@E@E?E@E@E?E@G@E?E@E@G@E@E?E@E@G@E?E@E@E?E@E?E@G?E@E@C?E@E?E@E@E?C@E@E?E@E?C@E?E@E?E@E?E@E@E?E@E@E?E@E@E?E@E?E?E@C?E@E?E@E@E?E@G@E?E@E@G@E?E@E@E?E@E?E@E@E?E@E?E@E?E@E@C?E@E@E@E?E@E@E@E?C@E@E@C?E@E@E@C?E@E@E@E@G?E@E@E@E?E@E@E@E?E@E@E?E@E?E@E@E?E@C@E@E?E@E@E?E@E?E@C@E?E@E?E@E?E@E@C?E@E?E@E?E@E?E@C?E@E?E@C@E?E@E@C?E@C?E@C?E@C?E?C@E?E?E@E?E@E@E@E?E@E@E?E@E@E?E@E@C@E?E@E?E@E?E@E?E@E?E@E?E@E?C?E@E?E?E?C?E@E?C?E?E?EAE?E?G?E?E?E?E?E?E?G?E?E?G?EAE?E?E?E?E?E?C?E?C@E?E?C?E?EAE?EAEAE?EAC?EAE?E?EAC?EAE?CAE?E?E?EAG?E?E?G?E?E?E?E?EAE?E?E?E?E?C?E?E?E@E?C?E@E?E?E?E@E?C?E?E?G?EAE?E?G?GAE?G?GAE?G?EAG?E?EAE?EAG?EAE?E?E?E?E?EAC?E?E?E?E?E?C?E?E?E?E?E?E?E?G?E?E?G?E?G?E?G?EAE?C?E?E@E?E?CAE?E?E?E?EAE?E?C?E?E?E?E?E?EAE?E?C?E?E?E?C?E?E?EAE?EAE?EAEAGAEAE?GAE?EAE?GAE?E?EAEAE?EAEAE?EAE?EAE?EAEAEAEAE?EAEAEACAEAE?EAEAC?EAE?EAEAE?EAG?EAEAE?EAE?EAE?EAG?E?EAEAE?EACAEAEAEAE?EAEAGAEAEAEAECEAEACAEAE?EAEAEAEAE?EACAEAE?EAE?EAE?EAEAE?EAG?EAEAE?EAEAC?EAGAEAEAE?EAGAE?EAEAE?EAEACAEAEAEAEAEAECGAEAEAE?EAEAEAE?EAE?EAC?EAE?EAEAEAG?EAEAGAEAGAEAGAEAGAEAEAEAGAEAEAEAEAEAGAE?EAEAGAEAEAEAEAEAE?GAEAE?EAG?EAE?EAEAGAEAEAEAEAEACAE?EAEAEAE?EAEAE?EAEAEAE?EAEAE?EAEAC?EAEAE?EAEAEAEAEAE?EAEAEAGAEAEACAEAE?EACAEAEAE?EAGAE?EAGAEAEAE?EAEAEAEAE?EAEAEAEAE?EAEAEAEAE?CAEAEAE?EACAEAECEACAEAECEAEAEAEAEAGAEAEAEAEAEAEAEAEAEAGAEAEAEAGAEAEAEAGAEAEAECEAEAECEAEACCEAEAEAEAEAECEACAEAEAEAEACCEAEAEAEAEAECEAEACAEAEAEAGAEAEAEAE?EAEAE?E?E?G?GAE?GAEAECECECECECECEACCEAECEAEAEACAEAEAE?CAEAEAEACAEAEACCEACCEACCEAECCCECEACCECECECCCECCCEECCECCCECCCCCCCECCECCCCCECCEECCCCCCCECCCCCCCEACCCCCCCCCACCCCCCCCCCCCCCCCACCECCECCCCCCACCCCCCCCCCCCCCCCCCCACCCCCCCCCEECCCECCECCCCCCCCCCCCCCCCCCCAECCAECCAEACCCACCCACCCCCCCACCCCCACCCCCCCACCCCCCCACCCCCCCCCCCACCCCCCCAECCCCACCCACCCCECCCCACCECCCCCCCCCCCCCCCCCCCCCCACCCCCCCCECCACCCCCCCACCCCCACCCCCAACCCCCCCCAECCCCACCCACCCCCCCCCCCCCCCCCCCCCCCCCECCECCCCCECCCCCECCCCACCECCACCEAEACAECCAECCACCECCCECCCCCCCCCECCCCCCCCCCCCCCCCCCCCCECCCCCECECCCECEEECCEECECCCECCCCCECCCCCCCECCCCCECCECCCCEECCCCECCECCECCCCCEECCECCCECCCCCCECCCCCCEECCCCECCCECCECCECCECCCEECCECCCEECCECECCCECCEECCCECECCCECECCEECECCCECECECEAECECEAECECEAECECECECEAECCCECEAECGAECECEAECECEAECECEAECEAECEAECECEACCECEAECGAECEAECECEAECEAECGCEAECEAECECEAECECEAECEACCECEAECEAECEAECEAECEAGCEAECEAEAGCEAEAECEAEAEAEAEACAEACCEACAEAEAGAEAGAEAEAGAECEAGAECEAEAEAEAEAEAEAEAEAGAEAEAEAEAEAG?EAEAGAEAEAEAEAGAE?EAEAEAE?EAGAE?EAEAE?GAEAE?EAEAEAEAE?EAGAE?EAE?EAE?EAG?E?E?E?G?E?E?E?E?E?E?E@E?G?E@E?E@E?E@C?E?E?E@E?E?C?E?E?E?E?E?E@G?E?E?E?E@E?E?G?E?E@E?E?E?E?E?G@E?E@E?E?E?E?E?E?C?E?E?C?E?E?C?E@E?E?E?E@E?E?E?E@E?G@E?E@G?E?G?E?G@E?G?E@G@E?G@E@E@G?E@G@E?E@G?E?E@E?G@E?E@E@G@E?G@E?G@E?E?G?E@E?E?E@E?E@E?E@E?E@E@G?E@E@E@E@G@E@E@G@E@E?E@G@E?E@E@E?E@E@E?E@E?E@E@G?E@E?E@E@G@E?E@G@E@G@E?E@G@E?G@E@E?G@E?E@E@E?E@E@E@E?E@G@E?G?E@G@E?G@E@G?E@E@G?E@G@E?G@E?E@G@E?E@G?E@E?G@E?G@E@G@E?E@G@E@E@G?E@E@E@E@E?E@E?E@E@E?E@E@E?E@E?E@E?E@E@E?E@E?E@C@E?E@E?E@E?E@E?E?E@C?E@E?C?E@E?E?E@E?C?E?E?E?E@C?E?C?C?C?C?C?C?C?E?E?E?E@E?G?E?E?G?E?G?E?GAE?E?E?G?EAE?G?E?E?GAE?E?GAE?E?EAE?E?E?EAE?E?EAE?EAE?E?EAE?E?E?EAE?E?E?EAE?E?EAC?EACAE?EAE?EAE?EAE?EAE?EAE?EAE?GAE?EAEAE?EAEAE?EAG?EAEAEAG?EAGAEAEAG?EAEAGAECGAEAEAGAEAEAECEAGAEAEAEAEAEAEAGAE?EAEAGAECEAECEAECEAEAECEAEAECEAECEACCCECA@C@ADAD@F?DBF@FBFBFBFBD@FBFBD@D@FBD@F@D@F@DBF@D@D@D@F@D@D@F@D@D@F@D@F@D@DBD@F@D@D@F@DBD@D@F@D@D@D@F@D@F@D@F?D@F?D@F@D@D?F@D@D@D@F?D@D@D@D@D@F@D?D@D?D@F@D?D@D?F?D@F?D?F?D?F?D?F?D?F?D?F?D?F?D?F@D?D?D?F?D?D?D?D?DAD?D?D?D?D?D?D?DAF?D?D?D?D?D?DAF?D?D?D?FAD?D?D?D?D?D?DAF?D?DAF?DAFAD?DAFAD?DAF?D?DAF?D?DADAF?DAFAD?DAFAD?FAD?FAD?FADADAFADAFAD?FAD?FAD?DAF?D?DAFADAD?FADADAFAD?DAF?DADAD?DADAD?BADAF?DADAD?FAD?DAF?DAFAD?DAD?DAD?DAD?DADADADAF?DADADAD?FADAD?DAD?FAD?DAD?DADAD?DADAFAD?DADADADAFADADAFAD?DAFAD?FADADAD?FADAD?FAD?DAF?D?DAF?D?DAFAD?DAFAD?FAD?DAD?FAD?DADAF?DAD?DADAD?DADAFADADADAF?DADAF?DAF?DAF?DAF?DAF?FAD?FAD?F?F?D?FAF?D?FAF?D?FAF?D?F?F?D?F?D?F?F?DAF?F?D?F?D?FAF?D?F@D?F?D?FAF?D?FAD?FADAFAD?FAD?FAD?FAD?D?F?D?F?D?F?D?F@F?D?F?D?F@D?F?D?F?D?D@F?D?D@D?D@D?D@D?D@D?D@D?D@D?D@D?D@D?D@D?B?D@D?D@D?D@D@D?F@D@D?D@D@D?D@F@D@D?D@D@D@D@D?D@D?D@D?D?D?D@F?D?DAD?F?D?DAF?DAF?DADADADAFADADADABAFAD?DADADADADADADADCBADCDCBCDADCDCBCDABCDCBCDCBCDCBCDCBCBCDABCBCDCBCBCDCBCDCBCBCDABCDCBCDCBCBCDCBCBCDCBCBCDCBCBADCBCDCBCDCBCDCBCDCBADCBCDCBCBCDCBABCBCBCDCBCDCBCDCDABCDCBCBADCBCDCBCDABCBCDCBCDCBCDCBCDCBCDCBCDADCBCDCBCDCDCBADCBCDCBCDCBCDCBCDADCBCDCBCDCDCDCBCDABCDCBCDCBCDCBCBCDCDCBCDCDCBCDCDCBADCDCBCDCDCBCDCBCDCBCDCBEDCDCBCDCDCBCDCDCBCDCDCBEBCDCBCDEBCDCDCBCDCDCBCDEDCDCBCDCDCBCDCDCDCBCDCDCBCDCDCDEBCDCDCBCDCDCBCDCDCBCDCDEBCDCBCDCDCBCDCDCDCBCDCDCDCDCBCDEDCBCDCDEBCDCDCBEDCBCDCBCDCDEBCDCDCDCBCDCDCDCBCDCDCBADCBCDADCBCDCBCDCBCDCBCDCDCBCDCDCDEBCDCDCDCDCBCDCDCDCDCBCDEDCDCDCDCDCDCDEDCDCBCDCDCDCDEDCDCBCDCDCDEDCDCBCDCDEDCBCDCDCDCDCDCBCDCDEDCDCBCDCDEDCBEDCDCDCDCDCDCDCDCDCDCDCDCBCDCDCBCDCDCDEBCDCDCDCDCDCBCDEDCDCDCDCDEBCDCDCDCDEDCBCDCDCDEDCDCBCDCDCDCDCDEDCBCDCDCDCBCDCDCDCDCDCDEBCDCDCDCBCDEDCDCBEDCDCDCDCBEDCDCBEDCDEBCDCBCDEBCDCDCDCBEDCBCDEBCDCDEBCDCBEDCBCDCBEBCDCBEDCBCDCBEDCDCBCDEDCBEDCBEDCDEBCDEBCDEBCDEBCDEBCDEBCBEDCBEBCBEBCBEBEBCBEBEBCBEBCBCBCBEBCBCBCBCDCBEBCBEBCBCBEBCBEBEBEBEBCBEBEBEBCBEBEBCBE@EBCBEBEBCBEBC@EBEBEBCBEBEBEBCBEBEBCBEBEBCBEBCBEBEBC@EBEBEBC@EBE@EBEBC@EBEBE@CBE@EBEBC@EBE@CBEBE@E@CBE@EBE@EBEBE@EBE@CBEBE@EBE@EBE@EBE@E@EBE@EBE@E@EBE@CBE@E@C@EBE@C@E@E@E@E@E@EBE@E@E@EBE@E@E@E@EBE@E@E@G@E@E@EBE@C@E@E@E@E@E@E@E@E@E@E@E@E@E@E?C@E@C@E@C?E@E?C@E@C@E@C?E@C@E@C?C@E@C@E?E@E@E@E?E@C@E@E?E@C@E@E@C?E@E@C?E@E@C?E@C?E@E?C@E@E?C@E@C?C@C?A?CAHIEAG?E?G?G?E?G@E@G?E?G?E@EBCBGBE@E@GBEAG?G?E@G?E?G?G?E?G?E?G@GAEAGAE?G@E@GBE@G?E?G@E@GBE@G@EBE@GBEBEBEBEBEBEBG@G?E@G?E@G?E@G?GAE?G@EBG?G?AFCDG?G?EAGAECGAECECGAEAGAE?G?E?G?G?E@G@EAGCEAECAE?EEAGA[AEAE?E?G?EAE?G?E?EAG?E?E?G?E@E?E?E@G?E?E?E?E?G?EAE?EAE?EAEAEAE?EAEAEAGAEAEAEAE?G?E?E?E@E@CBABAF?D?F?F?F?F@F?F?DAF?F?F?D?F@F?F?D?F?F@D?F?F?D?F?F?D@F?D?F?F?D?F@D?F?D?F@D?F?F?D?F?F?D?F?F?F?D?F?F?F?D@F?F?D?F?F@F?D?F?F?D?F?D?F?D?FAD?D?F?D?D?FAD?F?D?D?F?D?D?D?F?D?DAF?D?D?F?D?F?D?D?F?D?D?F?D?F@DAD?F?D?F?D?F?D?F?D?F?D?D?F?D?D?F?D?F?D?F?DAF?D?F?D?F?D?F?D?F?D?F?D?F?D?F?D?F?D?F?F?D?F?D@F?D?F?D?D?F?D?D?F?D?DAF?D?D?F?D?F?D?F?F?D?F?F?F?F?F?FAF?F?F?F?F?F?D?F?F?D?F@F?D?F?FAD?F?FAD?F?D?D?F?D?D?F@D?F?D?F?D?F?D?D?F?D?F?F?D?F?D?F?D?F?D?F?F?F?D?F?F?F?D?F?F?F?F?F@D?F?F?F?F?F?F?D?F?D?F?FAF?D?F?F?D?F?D?F?D?F?D?F?F?F?D?F?D?F?D?F?F?D?F?D?F?F?F?D?F?F?D?F?D?F?DAF?D?D?F?DAD?D?F?D@D?D?F?D?D?F?D?F?D?F?D?F?F?D?F?F?D?F?D?F?FAD?F?D@FAD?F?D?F?F@D?F?D?F?D?F?D?F@D?FAD?F?F?D?F?F?D?F?F?F?F?F?D?F?F?F?D?F@F?D?F@F?F@F?D?F@F?F?F?F?F?F?F?D?F?F?F?D?F?DAF?D?F?D?F?D?F@D?F@D@D@DBFBDBDDBBDDBDBFBD@D@F@D?F?D?F?D?FAD?F?D?FAD?D?F?D?DAD?FAD?FAD?DAD?FAD?FAD?DAFAD?FADADAFADADAFAD?DAFAD?DAFADADCFADADADAFADADADAFADADADADAFADCDADCDADCDADCDCDADCDABCDCDCDCBCDCDCDCDCBCDCDCDEDCBCDADCDCDADCDADCDCDADCDCDADCBCDCDADCBCDCDCBADCDCBCDCBCDCBCDCDCBCDCBCDCDCBADCBCDCDCBCDCDCDCBCDADCDCBCDCDCDCDCBCDCDCBCDCDCBCDEBCDADCDCBCDCDABCDCDABCDCDABCDCBADCBCDCBADCDCBCDADCBCDADCDCBADCDADADCDADCDADADCDADADAFAD?DAFAD?DAFAD?DADAF?DAD?DAD?DAF?DAD?DAF?DAD?F?DAD?F?D?D?D?F?D?D?DAD?D?DAF?DAD?D?DAF?D?D?DAF?DADAD?DADADADCDADAFADCDADADCDADCBCDAFCDCDADCDCDCBCDCDCDCDCDCBCDCDCDCDCDCBCDCDCDADCDCDCDEDCDCDCDCDCDCDCBCFCDADCDCDADCDCFADADCFADAFADADAFADADAFADAD?DAFADADAD?DADAFCDADADADADAFADADADAFADADADADADAF?DADAD?FADAD?D?DAF?D?D?DAD?DADADADADADABABABABAD?BADADADAD?FADAFAD?FAD?DAFAD?DAFAD?DAFAD?DAFAD?DAFADAFADCDAFADADAFADADAFADAD?DAF?DADADAFADADAFADADAF?DADAFADAD?DADAF?DADAD?DADAFADAD?DADADABAD?DADADCDADABADADADAF?DADAD?DADAD?FADADADAD?FADADADAFADADAD?FADADAFADADADADAF?DADADAD?FADADAFADADADAF?DADAD?FADADAD?DADADADAD?FADADADADADADADADADADAD?DADADADADADADAD?FADAD?DAF?DAD?DAF?DADAD?DAF?DAD?DADAD?DADADAD?BADADAD?DADADAD?DAD?DADADAB?DADAD?DADADABAD?DADADADAD?DADADAB?DADAD?DADADADADAD?DADAD?DAD?DAD?DAD?DAD?DAD?DAFAD?DADADADADAD?DABADADADAD?DADAD?DAD?D?DADAD?DADADAD?DADADADAD?DADADADADADADADAB?DADAD?DABAD?BADAD?BADAB?DAD?DAD?DAF?DAD?DADADAD?DADADADAD?DADADAF?DADAD?DADADAD?DADADADAD?FADADAD?DADAD?DADAD?BAD?DAD?DAD?DAD?DAB?DAD?DAD?DAD?DAD?D?DAD?DAD?D?DAF?DAD?D?DAD?DAD?D?DAD?D?D?DAD?D?D?DAD?D?DAD?D?DAD?D?DAD?D?D?DAD?D?D?DAD?D?D?DAD?D?D?D?DAB?D?DAD?DAD?DAD?DAD?DAD?DAD?D?DAD?B?DAD?D?DAD?DADAB?DADAD?D?DAD?D?D?DAD?D?D?DAD?F?DAD?D?DAD?DAD?DAD?DAD?D?F?DAD?D?DAD?D?F?DAD?D?D?DAF?D?DAD?DAF?D?DAD?F?DAD?FAD?D?FAD?D?DAF?D?D?FAD?D?D?DAD?DAF?D?DAD?D?DAD?FAD?DADAF?D?DAF?D?DAD?D?D?FAD?DAD?F?DAD?DAF?D?DAF?D?DAF?DAD?FAD?DAF?D?DAF?D?DAF?D?DAD?FAD?D?D?DAF?D?FAD?D?FAD?FAD?F?DAD?F?D?D?F?DAD?D?D?FADAD?FAD?DAF?DAD?F?D?FAD?F?DAF?D?DAF?D?F?F?DAF?D?FAD?FAD?FAD?F?DAF?D?F?DAF?D?D?F?D?D?FAD?FAD?DAF?DAD?F?DAD?FAD?FAD?FAFAD?FAF?DAF?FAD?F?FAD?F?DAF?FAD?FAD?FAFADAF?DAF?FAF?D?FAF?D?F?F?FAD?F?F?FAD?F?FAF?DAF?F?DAF?FAF?DAF?FAF?DAF?FAD?F?FAD?FAF?FAF?DAFAF?FAF?F?F?FAF?F?D?F?F?DAF?DAF?DAFAD?FAD?F?DAF?FAD?FAD?FADAD?FAD?FAD?FAD?DAF?DAFADAFAD?FADAFADAFADAFADAFCDAFADADCFADADAFADADCFADADCFADCDAFCDADCFADCFADADCFADCDAFADCFADAFCDAFADCFADADCFADCFADCDAFCDAFCDADCDAFCDAFADADCFADCDAFADCDAFCDADAFCDCDAFCDAFCDAF?D?D@FBDBDBBDBF@D@F@H@F?F@F@F?F@F?F@F@F@F@D?F@F@D@F?F@F?D@F?F?F@D?F?F@F?D@F?F@F?D@F?F?D?F@F?F?D?F@F?D@F?F@F?D@F?F@F?F@D?F@D?F?F@D?F?F@D?F@D?F?F@D?F@D?F?D?F@D?F@F@D?F@F?F@F?D?F@F?F?F@D?F@F?D@F?F@F?D@F?F@F?F@F?D@F@F?F@F?D@F?F?F@F?F?D@F?F?F@D?F@F?F@D?F@D@F?F@D?F@D?F@F?D@F?F?D@F?F@D?F?F@D?F?F?F@F?D?F@F?F?F@F?F?D?F?F?F@D?F?F?D?F@F?D@F?F?F@D?F@F?D?F?F@F?F?D?F?F?D?F?F?D?FAD?D?FAD?F?DAF?DAF?D?FAF?D?DAF?D?DAD?F?DAD?D?FAD?FAD?D?FAD?F?DAD?F?D?DAF?D?F?DAD?F?DAD?F?D?F?D?F?D?FAF?D?F?D?F?D?FAD?F?DAF?DAF?D?F?DAF?D?F?DAF?F?D?FAD?F?DAF?D?FAD?D?FAD?FAD?DAF?DAF?DAD?FAD?FAD?F?DAF?D?DAF?DAF?DAD?FADAF?DAFADAFADADAF?DAFADAF?DAFADAFADAFADAFADCFADAFCDADCDAFADCFADADCDADCFCDADCDAFCDADCFADCFADCDAFCDCDAFCDCFCDADCFADCFCDADCFCDADCFADCDAFCDADCDAFCDADCFADCDADCFADCDAFCDADCDAFCDADCDAFCDADCDADCDCFADCDCDADCDCDAFCDADCDAFCDADCFCDADCDADCDCDAFCDCDCDAFCDCDCDAFCDADCDCFADCDCDADCFADCDAFADADAFAFADAF?DAFADCFADCFADCDCDCDCBCDCDCBCDCDCDADCDCDADCDADADCFADADCDABCDADCDADADAFADCDADAFADCDADCFADADCDADCFADCDCDADCDCFADCDADADCDAFCDADCDADCDADADCDADAFADADCFADADAFADADCFADADADCDADAFADCDADADADADCFADADCDADAFADCDADADAFADADADADAFADADAFADADADAFADCDADADAF?DAD?F?D?F?F?D?F@D@FBDBBBDDBDBD@D@F@D?F@D?F?D?D?F?D?D?F?D?D?F?D?D?FAD?F?FADAF?DAD?FAD?D?D?DAD?D?D?D?F?D?D?D?F?D?FAD?F?D?F?F?DAD?F?DAF?DAD?F?DAF?D?F?D@D?F?D?D?D?F?D?D@D?D?F?D?D@D?D?D?D?D?D?D@D?D?D?D?D@D?D?D?D?F?D?D?D@D?F?D?D?FAD?D?F?D?D?F?D?F?D?F?F?D?D?F?D?F?D?F?D?F?D?DAD?FAD?D?DAF?D?D?F?D@D?D?D?D@D@D?D@DBBBBFBD@FBF@F@F@F@F?F?F?F?F?F?F?F?F?F?F@F?F?F?F?D?F?F?F?F?F?D?F?D?F?D?F?D@F?F?DAF?D?F@F?F?DAF?F?D?FAF?D?FAD?F?F?D?F?FAD@F?F?F?D?F?D?F@D?D?FAD?D?D?F?D?D?D?F?D?DAD?F?D?D?D?FAD?D?F?D?F@D?D?F?D?F?F?D?F?D?FAF?FAD?FADAF?FAD?F?F?DAF?F@D?F?D?F?D?F?D@F?D?F?D?F?F?D?F?F?D?F?F?D?F?F?D?F?F?F@F?F?D?F?F@F?F?F?F?F@F?D?F?F?D?FAD?F?D?F?DAF@D?F?D?F?F?F?D?F?FAF?F?F?FAF?F?F?F?F?F?F?H?F?F?H?F?F?H?F" },
              "summary": { "distance_km": 10.02, "duration": "01:15:33", "avg_pace": "07'32\"" },
              "photos": [ { "url": `https://picsum.photos/seed/${runId}/600/400` }, { "url": `https://picsum.photos/seed/${runId}a/600/400` } ]
            };
            detailPhotoUrls = data.photos.map(p => p.url);
            currentPolyline = data.route.encoded_polyline;

            document.getElementById('detailTitle').textContent = `跑步详情`;
            //document.querySelector('#detailHeroDistance .distance-value').textContent = data.summary.distance_km;

            const carouselInner = document.querySelector('#runMediaCarousel .carousel-inner');
            const carouselIndicators = document.querySelector('#runMediaCarousel .carousel-indicators');
            carouselInner.innerHTML = '';
            carouselIndicators.innerHTML = '';

            if (data.photos && data.photos.length > 0) {
                 document.getElementById('runMediaCarousel').style.display = 'block';
                data.photos.forEach((photo, index) => {
                    carouselInner.innerHTML += `<div class="carousel-item ${index === 0 ? 'active' : ''}"><img src="${photo.url}" class="d-block w-100 gallery-item" alt="跑步照片" data-photo-index="${index}"></div>`;
                    carouselIndicators.innerHTML += `<button type="button" data-bs-target="#runMediaCarousel" data-bs-slide-to="${index}" class="${index === 0 ? 'active' : ''}" aria-current="true"></button>`;
                });
            } else {
                document.getElementById('runMediaCarousel').style.display = 'none';
            }
            
            document.getElementById('viewRouteBtn').style.display = currentPolyline ? 'block' : 'none';
            
            const startTime = new Date(data.start_time);
            const timeWeatherString = `${startTime.toLocaleString('zh-CN', {year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'})}`;
            document.getElementById('detailTimeAndWeather').textContent = timeWeatherString;
/*
            const dataMap = {
                '训练时长': data.summary.duration || '--', '平均配速': data.summary.avg_pace || '--', '运动消耗': `${data.summary.calories_kcal} 千卡` || '--',
                '爬升高度': `${data.summary.total_ascent_m} 米` || '--', '平均步频': data.summary.avg_cadence || '--', '平均功率': `${data.summary.avg_power_w} 瓦` || '--'
            };
            dataGrid.innerHTML = '';
            for (const [label, value] of Object.entries(dataMap)) {
                const match = String(value).match(/^(.+?)\s?([a-zA-Z\u4e00-\u9fa5'"]+)$/);
                let valueHtml = match 
                    ? `${match[1]}<span class="data-point-unit">${match[2]}</span>`
                    : value;
                dataGrid.innerHTML += `<div class="col-4"><div class="data-point-value">${valueHtml}</div><div class="data-point-label">${label}</div></div>`;
            }*/
            
            // Populate Laps
            const lapsBody = document.getElementById('detailLapsTableBody');
            if (data.laps && data.laps.length > 0) {
                lapsBody.innerHTML = data.laps.map(lap => `
                    <tr>
                        <td>${lap.lap_number}</td>
                        <td>${lap.duration}</td>
                        <td>${lap.distance_km} km</td>
                        <td>${lap.pace}</td>
                        <td>${lap.avg_hr || 'N/A'}</td>
                        <td>${lap.avg_cadence || 'N/A'}</td>
                    </tr>
                `).join('');
            }

            // Populate Analysis Summaries
            document.getElementById('detailAvgPace').textContent = data.summary.avg_pace || '--';
            document.getElementById('detailBestPace').textContent = data.summary.best_pace || '--';
            document.getElementById('detailAvgHr').textContent = data.summary.avg_hr || '--';
            document.getElementById('detailMaxHr').textContent = data.summary.max_hr || '--';
            
            // --- Render Charts ---
            const gridColor = 'rgba(128, 128, 128, 0.2)';
            const tickColor = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim();
            const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
            
            const chartOptions = { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false }, ticks: { color: tickColor } }, y: { grid: { color: gridColor }, ticks: { color: tickColor } } }, plugins: { legend: { display: false } } };
            /*
            if (data.charts.pace?.labels.length) {
                const paceCtx = document.getElementById('paceChart').getContext('2d');
                paceChart = new Chart(paceCtx, { type: 'line', data: { labels: data.charts.pace.labels, datasets: [{ data: data.charts.pace.data, borderColor: accentColor, borderWidth: 2, pointRadius: 0, fill: false, tension: 0.1 }] }, options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, reverse: true, ticks: { ...chartOptions.scales.y.ticks, callback: (value) => formatPaceFromSeconds(value) } } } } });
            }
            if (data.charts.elevation?.labels.length) {
                const elevationCtx = document.getElementById('elevationChart').getContext('2d');
                elevationChart = new Chart(elevationCtx, { type: 'line', data: { labels: data.charts.elevation.labels, datasets: [{ data: data.charts.elevation.data, borderColor: accentColor, borderWidth: 2, pointRadius: 0, fill: { target: 'origin', above: 'rgba(77, 171, 247, 0.2)' } , tension: 0.1 }] }, options: chartOptions });
            }
            if (data.charts.hr?.labels.length) {
                const hrCtx = document.getElementById('hrChart').getContext('2d');
                hrChart = new Chart(hrCtx, { type: 'line', data: { labels: data.charts.hr.labels, datasets: [{ data: data.charts.hr.data, borderColor: '#ff6b6b', borderWidth: 2, pointRadius: 0, fill: false, tension: 0.1 }] }, options: chartOptions });
            }*/

            document.getElementById('detailAnalysisSections').style.display = 'block';
            await loadRunTags(runId);
            renderSuggestedTags();
            await refreshDetailComments(runId);

            document.getElementById('runDetailLoading').style.display = 'none';
            document.getElementById('runDetailContent').classList.remove('d-none');
            
            if (scrollToComments) {
                document.getElementById('runDetailComments').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

        } catch (error) {
            console.error("Error loading run detail:", error);
            document.getElementById('runDetailLoading').innerHTML = `<div class="alert alert-danger">加载失败: ${error.message}</div>`;
        }
    }
    
    document.getElementById('submitRunDetailComment').addEventListener('click', async () => {
        const runId = currentDetailRunId;
        const text = document.getElementById('runDetailCommentText').value.trim();
        if (!text || !runId) return;
        
        const profile = JSON.parse(localStorage.getItem('run_profile')) || generateRandomProfile();
        const nicknameForComment = `${profile.icon} ${profile.nickname}`;
        
        const res = await fetch(`${commentApiBase}/comment`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ runId, text, nickname: nicknameForComment }) });
        if (res.ok) {
            document.getElementById('runDetailCommentText').value = '';
            await refreshDetailComments(runId);
            const countEl = document.querySelector(`.comment-count[data-run-id="${runId}"]`);
            if(countEl) countEl.textContent = parseInt(countEl.textContent, 10) + 1;
        } else {
            alert('提交失败');
        }	
	});
    
    document.addEventListener('click', async e => {
        const runRow = e.target.closest('.run-detail-row');
        const recentCard = e.target.closest('.recent-run-card');

        if (runRow) {
            e.preventDefault();
            const preloadedData = {
                distanceFormatted: runRow.dataset.distanceFormatted,
                duration: runRow.dataset.duration,
                paceStr: runRow.dataset.paceStr,
                date: runRow.dataset.date
            };
            showRunDetailModal(runRow.dataset.runId, preloadedData, false);
        } else if (recentCard) {
            e.preventDefault();
            const isCommentLink = e.target.closest('.comment-link');
            // For recent cards, we don't have all the pre-loadable data easily, so we pass an empty object.
            showRunDetailModal(recentCard.dataset.runId, {}, !!isCommentLink);
        } else if (e.target.classList.contains('gallery-item')) {
            const index = parseInt(e.target.dataset.photoIndex, 10);
            if (!isNaN(index)) { openMediaGallery(detailPhotoUrls, index); }
        }
    });

    const detailModalEl = document.getElementById('runDetailModal');
    let gestureStartX = 0;
    let gestureIsEligible = false;
    const gestureThreshold = 50;
    const gestureMinSwipe = 100;

    detailModalEl.addEventListener('touchstart', e => {
        if (e.touches.length !== 1 || e.target.closest('.carousel')) {
            gestureIsEligible = false;
            return;
        }
        gestureStartX = e.touches[0].clientX;
        gestureIsEligible = gestureStartX < gestureThreshold;
    }, {passive: true});

    detailModalEl.addEventListener('touchend', e => {
        if (!gestureIsEligible || e.changedTouches.length !== 1) return;
        const endX = e.changedTouches[0].clientX;
        const diffX = endX - gestureStartX;
        if (diffX > gestureMinSwipe) {
            bootstrap.Modal.getInstance(detailModalEl).hide();
        }
        gestureIsEligible = false;
    }, {passive: true});
    
    document.getElementById('viewRouteBtn').addEventListener('click', () => {
        bootstrap.Modal.getOrCreateInstance(document.getElementById('routeMapModal')).show();
    });

    document.getElementById('routeMapModal').addEventListener('shown.bs.modal', () => {
        if (!routeMapInstance) {
            routeMapInstance = L.map('routeMap', { attributionControl: false, zoomControl: true });
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', { subdomains: 'abcd' }).addTo(routeMapInstance);
        }
        if (currentPolyline) {
            const polyline = L.polyline(decodePolyline(currentPolyline), { color: getComputedStyle(document.documentElement).getPropertyValue('--accent-color'), weight: 4 }).addTo(routeMapInstance);
            routeMapInstance.fitBounds(polyline.getBounds().pad(0.1));
        }
        setTimeout(() => routeMapInstance.invalidateSize(), 10);
    });

    // Calendar Editor Logic
    const calendarEditorModalEl = document.getElementById('calendarEditorModal');
    const calendarEditorModal = bootstrap.Modal.getOrCreateInstance(calendarEditorModalEl);
    const calendarForm = document.getElementById('calendarEventForm');
    const editorList = document.getElementById('calendarEditorList');
    
    let editorEvents = [];

    document.getElementById('editCalendarBtn').addEventListener('click', () => {
        editorEvents = JSON.parse(JSON.stringify(marathonEventsCache)); // Deep copy
        renderCalendarEditor();
        calendarEditorModal.show();
    });

    function renderCalendarEditor() {
        editorList.innerHTML = '';
        if (editorEvents.length === 0) {
            editorList.innerHTML = '<p class="text-secondary">暂无赛事</p>';
            return;
        }
        editorEvents.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach((event, index) => {
            editorList.innerHTML += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <strong>${event.name}</strong> (${event.category})<br>
                    <small class="text-secondary">${event.date} - ${event.status}</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="editCalendarEvent(${index})"><i class="bi bi-pencil-fill"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCalendarEvent(${index})"><i class="bi bi-trash-fill"></i></button>
                </div>
            </div>`;
        });
    }

    window.editCalendarEvent = (index) => {
        const event = editorEvents[index];
        document.getElementById('event-id').value = index;
        document.getElementById('event-date').value = event.date;
        document.getElementById('event-name').value = event.name;
        document.getElementById('event-category').value = event.category;
        document.getElementById('event-status').value = event.status;
        document.getElementById('calendarFormTitle').textContent = '编辑赛事';
        document.getElementById('cancelEditBtn').style.display = 'inline-block';
    }

    window.deleteCalendarEvent = (index) => {
        if(confirm('确定要删除这项赛事吗?')) {
            editorEvents.splice(index, 1);
            renderCalendarEditor();
        }
    }

    document.getElementById('cancelEditBtn').addEventListener('click', () => {
        calendarForm.reset();
        document.getElementById('event-id').value = '';
        document.getElementById('calendarFormTitle').textContent = '添加新赛事';
        document.getElementById('cancelEditBtn').style.display = 'none';
    });

    calendarForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const eventData = {
            date: document.getElementById('event-date').value,
            name: document.getElementById('event-name').value,
            category: document.getElementById('event-category').value,
            status: document.getElementById('event-status').value,
        };
        const eventId = document.getElementById('event-id').value;

        if (eventId !== '') { // Editing
            editorEvents[parseInt(eventId)] = eventData;
        } else { // Adding
            editorEvents.push(eventData);
        }
        renderCalendarEditor();
        calendarForm.reset();
        document.getElementById('cancelEditBtn').click();
    });
    
    document.getElementById('saveAllCalendarChanges').addEventListener('click', async () => {
        const secret = prompt("请输入管理员密钥:");
        if (!secret) return;

        try {
            const res = await fetch(`${commentApiBase}/marathon-events`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ events: editorEvents, secret: secret })
            });
            if (res.ok) {
                alert('赛历已成功更新!');
                calendarEditorModal.hide();
                await generateMarathonCalendar(); // Refresh main view
            } else {
                const error = await res.json();
                alert(`保存失败: ${error.error}`);
            }
        } catch (e) {
            alert(`发生网络错误: ${e.message}`);
        }
    });


    window.addEventListener('beforeunload', () => {
      if(monthlyDistanceChart) monthlyDistanceChart.destroy();
      if(dailyDistanceChart) dailyDistanceChart.destroy();
      if(yearlyDistanceChart) yearlyDistanceChart.destroy();
      if(paceChart) paceChart.destroy();
      if(elevationChart) elevationChart.destroy();
      if(hrChart) hrChart.destroy();
      if(cityMap) cityMap.remove();
      if(routeMapInstance) routeMapInstance.remove();
    });
});
</script>
</html>
