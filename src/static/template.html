<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>步履不停 - 已绕地球{{ "%.2f"|format(overall_stats.dist_km/40075.017) }}圈儿</title>
  <link rel="icon" type="image/png" href="https://run.linwn.net/images/favicon.png">
	<meta property="og:title" content="步履不停 - 我的四万公里跑量挑战" />
	<meta property="og:description" content="一个跑者的跑步记录网站，记录跑量与坚持。你也可以挑战地球一圈！" />
  <meta property="og:image" content="https://run.linwn.net/images/card.png" />
	<meta property="og:url" content="https://run.linwn.net/fun" />
	<meta property="og:type" content="website" />

	<meta name="twitter:card" content="https://run.linwn.net/images/card.png" />
	<meta name="twitter:title" content="步履不停 - 我的四万公里跑量挑战" />
	<meta name="twitter:description" content="一个跑者的跑步记录网站，记录跑量与坚持。你也可以挑战地球一圈！" />
  <meta name="twitter:image" content="https://run.linwn.net/images/card.png" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">

  <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css" rel="stylesheet" media="print" onload="this.media='all'">
  <link href="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.min.css" rel="stylesheet" media="print" onload="this.media='all'">
  
  <noscript>
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.min.css" rel="stylesheet">
  </noscript>

  <style>
    :root {
      --bg-color: #1c1e21;
      --card-bg: #282a2d;
      --text-primary: #e4e6eb;
      --text-secondary: #a8b3cf;
      --border-color: #495057;
      --accent-color: #4dabf7;
      --success-color: #20c997;
      --trophy-color: #fcc419;
      --hover-bg: #3a3b3c;
      --marathon-color: #ff8700;
    }
    html {
      scrollbar-gutter: stable;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-primary);
      font-family: 'Noto Sans SC', -apple-system, sans-serif;
      line-height: 1.6;
    }

    .main-title-container {
      padding: 1.5rem 0;
    }

    .main-title {
      font-weight: 700;
      font-size: 2rem;
    }

    .main-subtitle {
      font-weight: 400;
      font-size: 1.1rem;
    }
    
    .stat-card-base {
        background-color: var(--card-bg);
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        transition: all 0.2s ease;
        overflow: hidden;
    }
    
    .stat-card-content {
      display: flex;
      flex-direction: column;
      justify-content: center;
      height: 100%;
      width: 100%;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 0.5rem;
	  min-height: 1.0rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.2;
	  min-height: 2.4rem;
    }

    .stat-value-small {
        font-size: 1.5rem;
    }
    
    .stat-details {
	  margin-top: auto;
	  width: 100%;
	}

    .stat-card-flip-container {
        perspective: 1000px;
        min-height: 140px;
    }

    .stat-card-flipper {
		text-align: center;
        position: relative;
        width: 100%;
        height: 100%;
        transition: transform 0.6s;
        transform-style: preserve-3d;
    }

    .stat-card-flipper.flipped {
        transform: rotateY(180deg);
    }

    .stat-card-front, .stat-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--card-bg);
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 1.5rem;
    }

    .stat-card-back {
        transform: rotateY(180deg);
    }

	.flip-icon-container {
		position: absolute;
		top: 10px;
		right: 15px;
		font-size: 1.1rem;
		color: var(--text-secondary);
		cursor: pointer;
		opacity: 0.6;
		transition: opacity 0.2s ease, transform 0.2s ease;
		z-index: 5;
	}

	.flip-icon-container:hover {
		opacity: 1;
		transform: scale(1.1) rotate(30deg);
	}
	.stat-card-flipper.flipped .stat-card-front .flip-icon-container {
		display: none;
	}  
    .small-muted {
        color: var(--text-secondary);
    }

    .progress {
        --bs-progress-bg: var(--hover-bg);
    }
    
    .progress-bar {
        --bs-progress-bar-bg: var(--success-color);
    }

    .card-title-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn-group .btn, .btn-secondary, .btn-sm, #saveProfileButton {
        --bs-btn-bg: var(--hover-bg);
        --bs-btn-border-color: var(--border-color);
        --bs-btn-hover-bg: var(--accent-color);
        --bs-btn-hover-border-color: var(--accent-color);
        --bs-btn-active-bg: var(--accent-color);
        --bs-btn-active-border-color: var(--accent-color);
		--bs-btn-active-color: var(--text-primary);
        font-size: 0.8rem;
		color: var(--text-secondary);
    }
    #saveProfileButton {
        --bs-btn-bg: var(--accent-color);
        --bs-btn-border-color: var(--accent-color);
        --bs-btn-hover-bg: #63baff;
        --bs-btn-hover-border-color: #63baff;
        color: var(--text-primary);
    }

    .btn-group .btn.active {
		color: var(--text-primary);
		font-weight: 500;
	}
    @media (max-width: 767.98px) {
      .stat-value { font-size: 1.8rem; }
    }

    @media (max-width: 576px) {
      .stat-value { font-size: 1.5rem; }
      .main-title { font-size: 1.5rem; }
      .main-subtitle { font-size: 0.9rem; }
    }

    .card-title {
        color: var(--text-primary);
        margin-bottom: 0;
    }
    
    .collapsing {
      transition: height 0.2s ease !important;
    }
    .accordion-button {
      background-color: var(--card-bg);
      color: var(--text-primary);
      padding-left: 0.75rem;
      padding-right: 0.75rem;
    }
    .accordion-button:not(.collapsed) {
      background-color: var(--hover-bg);
      color: var(--text-primary);
    }
    .accordion-button:focus {
      box-shadow: none;
    }
    .accordion-item {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
    }
    .table-light {
        --bs-table-color: var(--text-primary);
        --bs-table-bg: var(--hover-bg);
    }
    .table {
      --bs-table-bg: var(--card-bg);
      --bs-table-striped-bg: var(--hover-bg);
      --bs-table-color: var(--text-primary);
      --bs-table-border-color: var(--border-color);
    }
    .run-detail-row, .recent-run-card {
        cursor: pointer;
    }
    .modal-content {
      background-color: var(--card-bg);
      color: var(--text-primary);
    }
    .modal-header {
      border-bottom-color: var(--border-color);
    }
    .pb-entry {
      border-bottom: 1px solid var(--border-color) !important;
    }
    .details-row > td {
      padding: 0 !important;
      border-top: none;
    }
    .details-row .card-body {
      background-color: var(--hover-bg);
      color: var(--text-secondary);
      padding-left: 1rem;
    }
    
    .badge.bg-success {
      font-size: 0.75em;
      padding: 0.25em 0.5em;
      font-weight: 500;
    }

    .clickable-certificate {
        color: var(--accent-color);
        cursor: pointer;
        text-decoration: none;
        border-bottom: 1px dashed var(--accent-color);
        transition: all 0.2s;
    }
    .clickable-certificate:hover {
        color: var(--accent-color);
        border-bottom-style: solid;
    }

    .modal-header .btn-close {
        filter: invert(0.8);
    }

    .text-primary-emphasis {
      color: var(--text-primary) !important;
    }

    .text-body-secondary {
      color: var(--text-secondary) !important;
    }

    .classification-text {
      color: var(--success-color);
      font-weight: 500;
      font-size: 0.9em;
    }

    .certificate-link {
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
    }

    .certificate-link:hover {
      text-decoration: none;
      transform: scale(1.05);
    }
    .comment-link {
      font-size: 0.85rem;
      color: var(--text-secondary);
      text-decoration: none;
      border-bottom: 1px dotted var(--text-secondary);
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .comment-link:hover {
      color: var(--accent-color);
      border-bottom: 1px solid var(--accent-color);
    }
    .leaflet-popup-content-wrapper {
        background: var(--card-bg);
        color: var(--text-primary);
        border-radius: 8px;
    }
    .leaflet-popup-content {
        margin: 12px;
    }
    .leaflet-popup-tip {
        background: var(--card-bg);
    }
    .leaflet-popup-close-button {
        color: var(--text-primary) !important;
        padding: 4px 4px 0 0 !important;
    }
    
    /* Responsive Nav Tabs */
    .nav-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none; /* Firefox */
    }
    .nav-wrapper::-webkit-scrollbar {
        display: none; /* Safari and Chrome */
    }
    .nav-tabs {
        --bs-nav-tabs-border-color: var(--border-color);
        --bs-nav-tabs-link-hover-border-color: var(--border-color);
        flex-wrap: nowrap;
        white-space: nowrap;
        border-bottom: none; /* The wrapper will have the border */
    }
    .nav-wrapper .nav-item {
        flex-shrink: 0;
    }
    .nav-tabs .nav-link {
        color: var(--text-secondary);
        background: none;
    }
    .nav-tabs .nav-link.active {
        color: var(--text-primary);
        background-color: var(--hover-bg);
        border-color: var(--border-color) var(--border-color) var(--hover-bg);
    }
    #cityMap {
      width: 100%;
      height: 400px;
      background-color: var(--card-bg);
      border-radius: .75rem;
    }
    .content-card {
        background-color: var(--card-bg);
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 1.5rem;
        border: 1px solid var(--border-color);
    }
    .streak-badge {
      font-size: 0.7em;
      font-weight: bold;
      padding: 0.2em 0.5em;
      border-radius: 0.35rem;
      background-color: #fd7e14;
      color: #fff;
      margin-left: 8px;
      vertical-align: middle;
      display: inline-block;
      line-height: 1;
    }
    .form-select, .form-control {
        background-color: var(--hover-bg);
        border-color: var(--border-color);
        color: var(--text-secondary);
    }
    .form-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23a8b3cf' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
    }
    .form-select:focus, .form-control:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.25rem rgba(77, 171, 247, .25);
        background-color: var(--hover-bg);
        color: var(--text-primary);
    }
    .form-control::placeholder {
        color: var(--text-secondary);
        opacity: 0.7;
    }
    label.form-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
    }
    .sortable-header {
      cursor: pointer;
      user-select: none;
    }
    .sortable-header .sort-icon {
      opacity: 0.5;
      transition: opacity 0.2s;
      vertical-align: middle;
    }
    .sortable-header:hover .sort-icon {
      opacity: 1;
    }
    .sortable-header[aria-sort] .sort-icon {
        opacity: 1;
    }
    .sortable-header .bi-arrow-down-up { display: inline-block; }
    .sortable-header .bi-arrow-down, .sortable-header .bi-arrow-up { display: none; }
    .sortable-header[aria-sort="ascending"] .bi-arrow-up { display: inline-block; }
    .sortable-header[aria-sort="descending"] .bi-arrow-down { display: inline-block; }
    .sortable-header[aria-sort] .bi-arrow-down-up { display: none; }
    .timeline {
        position: relative;
        padding-left: 2rem;
        margin-left: 1rem;
        border-left: 2px solid var(--border-color);
    }
    .timeline-item {
        position: relative;
        padding-bottom: 1.5rem;
    }
    .timeline-item:last-child {
        padding-bottom: 0;
    }
    .timeline-marker {
        position: absolute;
        top: 5px;
        left: calc(-2rem - 1px - 0.6rem);
        width: 1.2rem;
        height: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        background-color: var(--bg-color);
    }
    .trophy-color-text { color: var(--trophy-color); }
    .accent-color-text { color: var(--accent-color); }

    /* Comment Media Styles */
    .comment-media-thumb {
        max-width: 80px;
        max-height: 80px;
        border-radius: 4px;
        margin: 4px;
        cursor: pointer;
        object-fit: cover;
        transition: transform 0.2s;
        display: inline-block;
        vertical-align: middle;
    }
    .comment-media-thumb:hover {
        transform: scale(1.05);
        box-shadow: 0 0 5px var(--accent-color);
    }

    /* Gallery Modal Styles */
    #mediaGalleryModal .modal-content {
      background-color: rgba(0,0,0,0.85);
      backdrop-filter: blur(5px);
    }
    #mediaGalleryModal .btn-close {
      filter: invert(1) grayscale(100%) brightness(200%);
      position: absolute;
      top: 1rem;
      right: 1rem;
      z-index: 20;
    }
    #galleryCarouselInner .carousel-item {
        text-align: center;
    }
    #galleryCarouselInner .carousel-item img,
    #galleryCarouselInner .carousel-item video {
        max-height: 85vh;
        width: auto;
        max-width: 100%;
    }

    /* New Run Detail Modal Styles */
    #runDetailModal .modal-content {
        background-color: #f7f7f7;
        color: #333;
    }
    #runDetailModal .modal-body {
        padding: 0;
        overflow-y: auto;
    }
    #runDetailModal .detail-header {
        position: sticky;
        top: 0;
        background: rgba(255,255,255,0.8);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 10;
        border-bottom: 1px solid #eee;
        padding: 0.75rem 1rem;
    }
    #runDetailModal .detail-header .btn-back {
        background: none;
        border: none;
        font-size: 1.5rem;
        padding: 0;
        line-height: 1;
    }
    #runDetailModal .detail-header .detail-title {
        font-weight: 600;
        font-size: 1.1rem;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
    }
    #runDetailModal #detailHeroDistance .distance-value {
        font-size: 5rem;
        font-weight: 700;
        line-height: 1;
    }
    #runDetailModal #detailHeroDistance .distance-unit {
        font-size: 1rem;
        color: #888;
        margin-left: 0.25rem;
    }
    #runDetailModal .carousel-item img, 
    #runDetailModal .carousel-item #runDetailMap {
        height: 250px;
        object-fit: cover;
        border-radius: 12px;
    }
    #runDetailModal .carousel-control-prev-icon,
    #runDetailModal .carousel-control-next-icon {
        filter: invert(0.5);
    }
    #runDetailModal h4.data-section-title {
        font-weight: 600;
        font-size: 1.2rem;
        margin-bottom: 1rem;
    }
    #runDetailModal .data-point-value {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    #runDetailModal .data-point-label {
        font-size: 0.8rem;
        color: #6c757d;
    }
    #runDetailModal #runDetailComments hr {
        border-top: 1px solid #eee;
    }
    #runDetailModal #runDetailCommentForm {
        background-color: #fff;
        border: 1px solid #eee;
        border-radius: .75rem;
    }
     #runDetailModal #runDetailCommentForm textarea {
        background-color: #f7f7f7;
        color: #333;
     }
  </style>
</head>
<body>

<div class="container position-relative">

  <div class="main-title-container">
    <h1 class="main-title">步履不停 <small class="main-subtitle text-body-secondary"> — 我的四万公里跑量挑战</small></h1>
  </div>

  <div class="nav-wrapper border-bottom border-secondary-subtle mb-4">
    <ul class="nav nav-tabs" id="main-nav-tabs" role="tablist">
        <li class="nav-item" role="presentation">
        <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary-pane" type="button" role="tab" aria-controls="summary-pane" aria-selected="true" data-hash="summary">概览</button>
        </li>
        <li class="nav-item" role="presentation">
        <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-pane" type="button" role="tab" aria-controls="data-pane" aria-selected="false" data-hash="data">记录</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="marathon-tab" data-bs-toggle="tab" data-bs-target="#marathon-pane" type="button" role="tab" aria-controls="marathon-pane" aria-selected="false" data-hash="marathon">赛历</button>
        </li>
        <li class="nav-item" role="presentation">
        <button class="nav-link" id="events-tab" data-bs-toggle="tab" data-bs-target="#events-pane" type="button" role="tab" aria-controls="events-pane" aria-selected="false" data-hash="events">成就</button>
        </li>
        <li class="nav-item" role="presentation">
        <button class="nav-link" id="about-tab" data-bs-toggle="tab" data-bs-target="#about-pane" type="button" role="tab" aria-controls="about-pane" aria-selected="false" data-hash="about">关于</button>
        </li>
    </ul>
  </div>

  <div class="tab-content" id="mainTabContent">
    <div class="tab-pane fade show active" id="summary-pane" role="tabpanel" aria-labelledby="summary-tab" tabindex="0">
        <div class="row g-3 mb-4">
            <div class="col-12 col-md-6 col-lg-5">
                <div class="stat-card-flip-container h-100" id="dist-card-container">
                    <div class="stat-card-flipper h-100">
                      <div class="stat-card-front">
                        <div class="stat-card-content">
                          <div>
                            <div class="stat-label">当前跑量</div>
                            <div class="stat-value">{{ "%.2f"|format(overall_stats.dist_km) }} <small class="small-muted">km</small></div>
                          </div>
                          <div class="stat-details">
                            <div class="stat-label" id="running-quote"></div>
                            <div class="progress mt-1" style="height: 4px;">
                              <div class="progress-bar" role="progressbar" style="width: {{ '%.4f'|format(progress_around_earth) }}%;"></div>
                            </div>
                            <small class="small-muted">进度 {{ "%.4f"|format(progress_around_earth) }}%</small>
                          </div>
                        </div>
                        <div class="flip-icon-container"><i class="bi bi-phone-flip"></i></div>
                      </div>
                      <div class="stat-card-back">
                        <div class="stat-card-content">
                          <div>
                            <div class="stat-label">继续坚持</div>
                            <div class="stat-value">{{ estimated_info.days_left }}</div>
                          </div>
                          <div class="stat-details">
                            <div class="stat-label"><small class="small-muted">预计</small>{{ estimated_info.date_str }}<small>绕地球一圈</small></div>
                          </div>
                        </div>
                        <div class="flip-icon-container"><i class="bi bi-phone-flip"></i></div>
                      </div>
                    </div>
                </div>
            </div><div class="col-6 col-md-6 col-lg-2">
                <div class="stat-card-flip-container h-100" id="count-card-container">
                    <div class="stat-card-flipper h-100">
                      <div class="stat-card-front">
                        <div class="stat-card-content">
                          <div class="stat-label">跑步次数</div>
                          <div class="stat-value">{{ overall_stats.count }}</div>
                        </div>
                        <div class="flip-icon-container"><i class="bi bi-phone-flip"></i></div>
                      </div>
                      <div class="stat-card-back">
                        <div class="stat-card-content">
                          <div class="stat-label">总耗时</div>
                          <div class="stat-value stat-value-small">{{ overall_stats.duration_str }}</div>
                        </div>
                        <div class="flip-icon-container"><i class="bi bi-phone-flip"></i></div>
                      </div>
                    </div>
                  </div>
            </div>
            <div class="col-6 col-md-6 col-lg-2">
                <div class="stat-card-flip-container h-100" id="pace-card-container">
                    <div class="stat-card-flipper h-100">
                      <div class="stat-card-front">
                        <div class="stat-card-content">
                          <div class="stat-label">平均配速</div>
                          <div class="stat-value">{{ overall_stats.pace }}</div>
                        </div>
                        <div class="flip-icon-container"><i class="bi bi-phone-flip"></i></div>
                      </div>
                      <div class="stat-card-back">
                        <div class="stat-card-content">
                          <div class="stat-label">最快配速</div>
                          <div class="stat-value">{{ fastest_pace_info.pace }}</div>
                        </div>
                        <div class="flip-icon-container"><i class="bi bi-phone-flip"></i></div>
                      </div>
                    </div>
                </div>
            </div>
        </div>

        {% if recent_runs %}
        <div class="card mb-4" style="background-color: var(--card-bg); border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div class="card-header bg-transparent border-0 pt-3 ps-4">
                <h5 class="card-title mb-0"><i class="bi bi-stopwatch-fill me-2"></i>最近三次跑步</h5>
            </div>
            <div class="card-body pt-2">
                <div class="row g-3">
                {% for run in recent_runs %}
                <div class="col-lg-4">
                    <div class="p-3 rounded h-100 d-flex flex-column recent-run-card" data-run-id="{{ run.id }}" style="background-color: var(--hover-bg);">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold text-primary-emphasis">{{ "%.2f"|format(run.distance / 1000) }} km</span>
                            <span class="small text-body-secondary">{{ run.date.strftime('%Y-%m-%d %H:%M') }}</span>
                        </div>
                        
                        <div class="d-flex justify-content-around text-center mt-3 flex-grow-1 align-items-center">
                            <div>
                                <div class="stat-label mb-1">配速</div>
                                <div class="fw-bold">{{ run.pace }}</div>
                            </div>
                            <div>
                                <div class="stat-label mb-1">用时</div>
                                <div class="fw-bold">{{ format_duration(run.duration) }}</div>
                            </div>
                            <div>
                                <div class="stat-label mb-1">心率</div>
                                <div class="fw-bold">
                                    {{ run.heart_rate or 'N/A' }}
                                </div>
                            </div>
                            <div>
                                <div class="stat-label mb-1">城市</div>
                                <div class="fw-bold">{{ run.city or 'N/A' }}</div>
                            </div>
                        </div>

                        <div class="mt-auto pt-3 text-end">
                          <a href="#" class="comment-link small text-body-secondary" data-run-id="{{ run.id }}" data-scroll-to-comment="true">💬 说点什么 (<span class="comment-count" data-run-id="{{ run.id }}">0</span>)</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
                </div>
                <div class="text-center mt-3">
                    <a href="#data" id="goto-data-tab" class="text-decoration-none text-body-secondary">查看所有记录 &rarr;</a>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card mb-4" style="background-color: var(--card-bg); border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div class="card-header bg-transparent border-0 pt-3">
                <div class="card-title-container">
                    <h5 class="card-title">跑量分析</h5>
                    <div class="btn-group btn-group-sm" role="group" id="chart-toggle">
                        <button type="button" class="btn active" data-chart="daily">近30天</button>
                        <button type="button" class="btn" data-chart="monthly">近12月</button>
                        <button type="button" class="btn" data-chart="yearly">年度汇总</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
            <div id="dailyChartContainer" style="display: block; height: 300px;">
                <canvas id="dailyDistanceChart" aria-label="最近30天跑步距离统计图表"></canvas>
            </div>
            <div id="monthlyChartContainer" style="display: none; height: 300px;">
                <canvas id="monthlyDistanceChart" aria-label="最近12个月跑步距离统计图表"></canvas>
            </div>
            <div id="yearlyChartContainer" style="display: none; height: 300px;">
                <canvas id="yearlyDistanceChart" aria-label="年度跑步距离统计图表"></canvas>
            </div>
            </div>
        </div>
    </div>
    
    <div class="tab-pane fade" id="data-pane" role="tabpanel" aria-labelledby="data-tab" tabindex="0">
        </div>

    <div class="tab-pane fade" id="marathon-pane" role="tabpanel" aria-labelledby="marathon-tab" tabindex="0">
        </div>

    <div class="tab-pane fade" id="events-pane" role="tabpanel" aria-labelledby="events-tab" tabindex="0">
        </div>
    
    <div class="tab-pane fade" id="about-pane" role="tabpanel" aria-labelledby="about-tab" tabindex="0">
        </div>
  </div>
</div>

<div class="modal fade" id="certificateModal" tabindex="-1" aria-labelledby="certificateModalLabel" aria-hidden="true">
  </div>

<footer class="container text-center py-4 mt-4">
    <small class="text-body-secondary">
        步履不停 &copy; {% if summarized_by_year %}{{ summarized_by_year.keys()|max }}{% endif %}
        {% if last_build_time %} | Last updated: {{ last_build_time }} {% endif %}
    </small>
</footer>



<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
    </div>

<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    </div>

<div class="modal fade" id="runDetailModal" tabindex="-1" aria-labelledby="runDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-body">
                <div class="detail-header d-flex align-items-center">
                    <button type="button" class="btn-back" data-bs-dismiss="modal" aria-label="Close"><i class="bi bi-chevron-left"></i></button>
                    <h5 class="detail-title">跑步详情</h5>
                </div>

                <div id="runDetailLoading" class="text-center p-5">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-secondary">正在加载跑步数据...</p>
                </div>

                <div id="runDetailContent" class="d-none">
                    <div class="container-fluid px-4">
                        <div class="text-center my-4" id="detailHeroDistance">
                            <span class="distance-value">--</span>
                            <span class="distance-unit">公里</span>
                        </div>

                        <div id="runMediaCarousel" class="carousel slide mb-5" data-bs-ride="carousel">
                            <div class="carousel-indicators"></div>
                            <div class="carousel-inner">
                                </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#runMediaCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#runMediaCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>

                        <div class="mb-5">
                            <h4 class="data-section-title">运动数据</h4>
                            <div class="row g-4 text-center" id="detailDataGrid">
                                </div>
                        </div>

                        <div id="runDetailComments" class="pb-4">
                            <hr>
                            <h4 class="data-section-title mt-4">评论</h4>
                            <div id="runDetailCommentList" class="mb-3"></div>
                            <div id="runDetailCommentForm" class="p-3">
                                <h6 class="mb-3">发表评论</h6>
                                <textarea class="form-control" id="runDetailCommentText" rows="3" placeholder="写下你的感想吧..."></textarea>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div id="detailEditProfileTrigger" style="cursor: pointer;" title="点击修改昵称">
                                        <span class="small text-secondary">
                                            发言身份: <span id="detailCommentUserIcon"></span> <span id="detailCommentUserNickname"></span>
                                            <i class="bi bi-pencil-fill small ms-1"></i>
                                        </span>
                                    </div>
                                    <button type="button" class="btn btn-primary btn-sm" id="submitRunDetailComment">
                                        <i class="bi bi-send-fill"></i> 提交
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mediaGalleryModal" tabindex="-1" aria-labelledby="mediaGalleryModalLabel" aria-hidden="true">
  </div>


</body>
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/chartjs-plugin-annotation/3.1.0/chartjs-plugin-annotation.min.js "></script>
<script src="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
	let monthlyDistanceChart = null;
	let dailyDistanceChart = null;
	let yearlyDistanceChart = null;
	let cityMap = null;
    let runDetailMapInstance = null;
    let allRunRows = [];
    const commentApiBase = 'https://kv.linwn.net';

	document.documentElement.setAttribute('data-bs-theme', 'dark');

    // --- USER PROFILE LOGIC, etc. (remains the same as before) ---
    // ...

	document.addEventListener('DOMContentLoaded', function() {
		
    // --- 页面初始化逻辑 ---
    // ... (This part remains largely the same)
    document.getElementById('goto-data-tab')?.addEventListener('click', e => {
        e.preventDefault();
        const dataTab = document.getElementById('data-tab');
        if (dataTab) {
            bootstrap.Tab.getOrCreateInstance(dataTab).show();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    });

    // ... (Other initializations remain the same)

    // --- MODAL AND COMMENT LOGIC ---
    function renderCommentList(container, comments) {
        container.style.color = '#333'; // Ensure text color is readable on light bg
        if (Array.isArray(comments) && comments.length > 0) {
            container.innerHTML = comments.map(c => 
                `<div class="border-bottom py-2">
                    <small class="text-muted">${c.nickname || '🌱 匿名'} · ${new Date(c.ts).toLocaleString()}</small>
                    <div class="mt-1" style="color: #333;">${parseAndRenderMedia(c.text)}</div>
                 </div>`
            ).join('');
        } else {
             container.innerHTML = '<div class="text-muted text-center py-2">暂无评论</div>';
        }
    }
    
    // --- NEW RUN DETAIL MODAL LOGIC ---
    let currentDetailRunId = null;

    function decodePolyline(encoded) {
        if (!encoded) return [];
        let index = 0, len = encoded.length;
        let lat = 0, lng = 0;
        let array = [];
        while (index < len) {
            let b, shift = 0, result = 0;
            do {
                b = encoded.charCodeAt(index++) - 63;
                result |= (b & 0x1f) << shift;
                shift += 5;
            } while (b >= 0x20);
            let dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
            lat += dlat;
            shift = 0; result = 0;
            do {
                b = encoded.charCodeAt(index++) - 63;
                result |= (b & 0x1f) << shift;
                shift += 5;
            } while (b >= 0x20);
            let dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
            lng += dlng;
            array.push([lat * 1e-5, lng * 1e-5]);
        }
        return array;
    }

    async function refreshDetailComments(runId) {
        const listContainer = document.getElementById('runDetailCommentList');
        try {
            const res = await fetch(`${commentApiBase}/comments?runId=${encodeURIComponent(runId)}`);
            if(!res.ok) throw new Error("Failed to fetch comments");
            const data = await res.json();
            renderCommentList(listContainer, data);
        } catch(e) {
            listContainer.innerHTML = '<div class="text-danger">评论加载失败</div>';
        }
    }

    async function showRunDetailModal(runId, scrollToComments = false) {
        currentDetailRunId = runId;
        const modalEl = document.getElementById('runDetailModal');
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        
        document.getElementById('runDetailLoading').style.display = 'block';
        document.getElementById('runDetailContent').classList.add('d-none');
        
        modal.show();

        try {
            // NOTE: Using a static object for this task instead of a live fetch
            // const response = await fetch(`https://static.linwn.net:10088/runpage/data/${runId}/record.json`);
            // if (!response.ok) throw new Error('无法加载跑步数据');
            // const data = await response.json();		
            const data = {
              "start_time": "2025-08-13T06:30:00Z",
              "weather": { "temperature_c": 28.5, "condition": "Cloudy", "wind_speed_kmh": 12.3 },
              "summary": { "distance_km": 10.02, "duration": "01:15:33", "avg_pace": "07'32\"" },
              "route": { "encoded_polyline": "u{~vFvyys@_A`@i@`@q@j@u@j@u@j@w@f@s@d@q@d@o@`@k@Zg@Xm@V]Ra@Te@X]Z]b@a@^a@^a@^g@\\_@b@]f@a@`@e@b@e@d@i@f@i@h@k@h@m@h@m@h@m@h@m@j@m@j@m@j@m@j@m@j@" },
              "photos": [
                { "url": `https://picsum.photos/seed/${runId}/200/300`, "timestamp": "2025-08-13T06:45:12Z", "note": "Sunrise view" },
                { "url": `https://picsum.photos/seed/${runId}a/200/300`, "timestamp": "2025-08-13T07:05:45Z", "note": "Bridge crossing" }
              ]
            };

            // Populate Hero Distance
            document.querySelector('#detailHeroDistance .distance-value').textContent = data.summary.distance_km;

            // Populate Media Carousel
            const carouselInner = document.querySelector('#runMediaCarousel .carousel-inner');
            const carouselIndicators = document.querySelector('#runMediaCarousel .carousel-indicators');
            carouselInner.innerHTML = '';
            carouselIndicators.innerHTML = '';

            carouselInner.innerHTML += `<div class="carousel-item active"><div id="runDetailMap"></div></div>`;
            carouselIndicators.innerHTML += `<button type="button" data-bs-target="#runMediaCarousel" data-bs-slide-to="0" class="active" aria-current="true"></button>`;

            if (runDetailMapInstance) runDetailMapInstance.remove();
            runDetailMapInstance = L.map('runDetailMap', {
                attributionControl: false, zoomControl: false, dragging: false, scrollWheelZoom: false, doubleClickZoom: false, touchZoom: false, boxZoom: false, keyboard: false
            });
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', { subdomains: 'abcd' }).addTo(runDetailMapInstance);

            if (data.route.encoded_polyline) {
                const coordinates = decodePolyline(data.route.encoded_polyline);
                if (coordinates.length > 0) {
                    const polyline = L.polyline(coordinates, { color: '#e54747', weight: 4 }).addTo(runDetailMapInstance);
                    runDetailMapInstance.fitBounds(polyline.getBounds().pad(0.1));
                }
            }

            let photoIndex = 1;
            if (data.photos && data.photos.length > 0) {
                data.photos.forEach(photo => {
                    carouselInner.innerHTML += `<div class="carousel-item"><img src="${photo.url}" class="d-block w-100" alt="跑步照片"></div>`;
                    carouselIndicators.innerHTML += `<button type="button" data-bs-target="#runMediaCarousel" data-bs-slide-to="${photoIndex}"></button>`;
                    photoIndex++;
                });
            }
            document.querySelector('#runMediaCarousel .carousel-control-prev').style.display = photoIndex > 1 ? 'block' : 'none';
            document.querySelector('#runMediaCarousel .carousel-control-next').style.display = photoIndex > 1 ? 'block' : 'none';
            carouselIndicators.style.display = photoIndex > 1 ? 'flex' : 'none';
            
            // Populate Data Grid
            const gridContainer = document.getElementById('detailDataGrid');
            const dataMap = {
                '训练时长': data.summary.duration || '--',
                '平均配速': data.summary.avg_pace || '--',
                '运动消耗': '588 千卡',
                '总时长': '01:33:16',
                '运动负荷': '184',
                '爬升高度': '9 米',
                '平均步频': '130',
                '平均功率': '156 瓦',
                '平均步幅': '1.01 米'
            };
            gridContainer.innerHTML = '';
            for (const [label, value] of Object.entries(dataMap)) {
                gridContainer.innerHTML += `
                    <div class="col-4">
                        <div class="data-point-value">${value}</div>
                        <div class="data-point-label">${label}</div>
                    </div>`;
            }

            await refreshDetailComments(runId);
            
            document.getElementById('runDetailLoading').style.display = 'none';
            document.getElementById('runDetailContent').classList.remove('d-none');
            
            runDetailMapInstance.invalidateSize();
            
            if (scrollToComments) {
                document.getElementById('runDetailComments').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

        } catch (error) {
            document.getElementById('runDetailLoading').innerHTML = `<div class="alert alert-danger">加载失败: ${error.message}</div>`;
        }
    }

    document.getElementById('submitRunDetailComment').addEventListener('click', async () => {
        // This function remains the same
    });
    
    document.addEventListener('click', async e => {
        // This function remains the same
    });

  });

  window.addEventListener('beforeunload', () => {
    // This function remains the same
  });
</script>
</html>
