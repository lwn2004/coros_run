<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>跑步数据中心</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.22.5/bootstrap-table.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <style>
        body { background-color: #f8f9fa; }
        .container-fluid { padding: 20px; }
        .summary-container { overflow: hidden; position: relative; }
        .summary-cards-wrapper { display: flex; transition: transform 0.3s ease-in-out; }
        .summary-card { flex: 0 0 100%; padding: 0 10px; }
        .summary-card .card { text-align: center; }
        .summary-nav { display: none; position: absolute; top: 50%; transform: translateY(-50%); width: 100%; justify-content: space-between; padding: 0 5px; box-sizing: border-box; }
        .summary-nav button { background-color: rgba(0, 0, 0, 0.3); border: none; color: white; border-radius: 50%; width: 30px; height: 30px; }
        .card-title .fas, .card-title .far { margin-right: 8px; }

        @media (min-width: 768px) {
            .summary-cards-wrapper { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; }
            .summary-card { padding: 0; }
        }
        @media (max-width: 767.98px) { .summary-nav { display: flex; } }

        .chart-container { position: relative; height: 40vh; width: 100%; margin-bottom: 20px; }
        #time-nav { margin-bottom: 1rem; }
        .nav-tabs .nav-link.active { font-weight: bold; }
        #stats-summary-text { text-align: center; font-size: 1.1rem; margin-bottom: 1.5rem; color: #495057; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="text-center my-4">
        <h1 class="display-5"><i class="fas fa-chart-line"></i> 跑步数据中心</h1>
    </div>

    <div class="summary-container mb-4">
        <div class="summary-cards-wrapper">
            <div class="summary-card"><div class="card shadow-sm"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">总跑量 (km)</h6><h4 class="card-title" id="total-distance"><i class="fas fa-road text-primary"></i> --</h4></div></div></div>
            <div class="summary-card"><div class="card shadow-sm"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">总次数</h6><h4 class="card-title" id="total-runs"><i class="fas fa-person-running text-success"></i> --</h4></div></div></div>
            <div class="summary-card"><div class="card shadow-sm"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">总用时</h6><h4 class="card-title" id="total-time"><i class="far fa-clock text-info"></i> --</h4></div></div></div>
            <div class="summary-card"><div class="card shadow-sm"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">平均配速</h6><h4 class="card-title" id="avg-pace"><i class="fas fa-stopwatch text-warning"></i> --</h4></div></div></div>
            <div class="summary-card"><div class="card shadow-sm"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">平均心率</h6><h4 class="card-title" id="avg-heartrate"><i class="fas fa-heart-pulse text-danger"></i> --</h4></div></div></div>
        </div>
        <div class="summary-nav"><button id="prev-card"><i class="fas fa-chevron-left"></i></button><button id="next-card"><i class="fas fa-chevron-right"></i></button></div>
    </div>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation"><button class="nav-link active" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats-content" type="button" role="tab"><i class="fas fa-chart-bar"></i> 数据统计</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="records-tab" data-bs-toggle="tab" data-bs-target="#records-content" type="button" role="tab"><i class="fas fa-list-ul"></i> 详细记录</button></li>
    </ul>

    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="stats-content" role="tabpanel">
            <div class="card card-body">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
                    <div class="btn-group" role="group" id="stats-period-filter">
                        <button type="button" class="btn btn-outline-primary" data-period="trend">本月趋势</button>
                        <button type="button" class="btn btn-outline-primary" data-period="month">月</button>
                        <button type="button" class="btn btn-outline-primary active" data-period="16w">16周</button>
                        <button type="button" class="btn btn-outline-primary" data-period="year">年</button>
                        <button type="button" class="btn btn-outline-primary" data-period="all">全部</button>
                    </div>
                    <div id="time-nav" class="btn-group mt-2 mt-md-0" style="display: none;">
                        <button id="prev-time" class="btn btn-secondary"><i class="fas fa-angle-left"></i> 上一个</button>
                        <span id="current-time-display" class="btn btn-light disabled"></span>
                        <button id="next-time" class="btn btn-secondary">下一个 <i class="fas fa-angle-right"></i></button>
                    </div>
                </div>
                <div class="chart-container"><canvas id="statsChart"></canvas></div>
                <div id="stats-summary-text"></div>
                <div id="stats-table-container"><table id="stats-table"></table></div>
            </div>
        </div>
        <div class="tab-pane fade" id="records-content" role="tabpanel">
             <div class="card card-body">
                <div class="btn-group mb-3 flex-wrap" role="group" id="detailed-filter">
                    <button type="button" class="btn btn-outline-primary active" data-filter="all">全部记录</button>
                    <button type="button" class="btn btn-outline-primary" data-filter="today_in_history">历史上的今天</button>
                    <button type="button" class="btn btn-outline-primary" data-filter="training">训练</button>
                    <button type="button" class="btn btn-outline-primary" data-filter="race">比赛</button>
                    <button type="button" class="btn btn-outline-primary" data-filter="half_marathon">>=半马</button>
                    <button type="button" class="btn btn-outline-primary" data-filter="marathon">>=全马</button>
                </div>
                <table id="detailed-table"></table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.22.5/bootstrap-table.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.22.5/locale/bootstrap-table-zh-CN.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/locale/zh-cn.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

<script>
$(function() {
    // --- Globals ---
    let allData = [];
    let statsChart;
    let currentStatsPeriod = '16w';
    let currentDateRef = moment();

    // --- Utility Functions (Robust versions) ---
    const parseMovingTime = (timeStr) => {
        if (!timeStr || typeof timeStr !== 'string') return 0;
        const parts = timeStr.split(':');
        if (parts.length < 3) return 0;
        const hours = parseInt(parts[0], 10), minutes = parseInt(parts[1], 10), seconds = parseFloat(parts[2]);
        if (isNaN(hours) || isNaN(minutes) || isNaN(seconds)) return 0;
        return hours * 3600 + minutes * 60 + seconds;
    };
    const formatSeconds = (totalSeconds, showDays = false) => {
        if (isNaN(totalSeconds) || totalSeconds < 0) return "00:00:00";
        let days = showDays ? Math.floor(totalSeconds / 86400) : 0;
        if (showDays) totalSeconds %= 86400;
        const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
        const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
        const s = String(Math.floor(totalSeconds % 60)).padStart(2, '0');
        return days > 0 ? `${days}天 ${h}:${m}:${s}` : `${h}:${m}:${s}`;
    };
    const formatPace = (secondsPerMeter) => {
        if (!secondsPerMeter || secondsPerMeter <= 0 || !isFinite(secondsPerMeter)) return "N/A";
        const secondsPerKm = secondsPerMeter * 1000;
        const minutes = Math.floor(secondsPerKm / 60);
        const seconds = Math.round(secondsPerKm % 60);
        return `${minutes}'${String(seconds).padStart(2, '0')}"`;
    };

    // --- Main Initializer ---
    fetch('data/all.json')
        .then(response => response.json())
        .then(data => {
            allData = data.map(d => ({...d, start_date_local_moment: moment(d.start_date_local), moving_time_seconds: parseMovingTime(d.moving_time)})).sort((a, b) => b.start_date_local_moment - a.start_date_local_moment);
            initSummaryCards();
            setupMobileSlider();
            initDetailedTable();
            setupDetailedFilters();
            setupStatsControls();
            updateStatsView();
        });

    // --- UI Setup Functions ---
    function initSummaryCards() {
        if (allData.length === 0) return;
        const totalDistance = allData.reduce((s, d) => s + d.distance, 0);
        const totalRuns = allData.length;
        const totalMovingTime = allData.reduce((s, d) => s + d.moving_time_seconds, 0);
        const totalWeightedHr = allData.reduce((s, d) => s + (d.average_heartrate || 0) * d.moving_time_seconds, 0);
        const avgSpeed = totalDistance / totalMovingTime;
        $('#total-distance').html(`<i class="fas fa-road text-primary"></i> ${(totalDistance / 1000).toFixed(2)}`);
        $('#total-runs').html(`<i class="fas fa-person-running text-success"></i> ${totalRuns}`);
        $('#total-time').html(`<i class="far fa-clock text-info"></i> ${formatSeconds(totalMovingTime, true)}`);
        $('#avg-pace').html(`<i class="fas fa-stopwatch text-warning"></i> ${totalMovingTime > 0 ? formatPace(1 / avgSpeed) : "N/A"}`);
        $('#avg-heartrate').html(`<i class="fas fa-heart-pulse text-danger"></i> ${totalMovingTime > 0 ? (totalWeightedHr / totalMovingTime).toFixed(0) : "N/A"}`);
    }

    function setupMobileSlider() { /* Omitted for brevity, logic unchanged */ }

    function initDetailedTable() {
        $('#detailed-table').bootstrapTable({
            columns: [
                { field: 'start_date_local', title: '开始时间', sortable: true },
                { field: 'type', title: '类型', sortable: true },
                { field: 'distance', title: '距离 (km)', sortable: true, formatter: v => typeof v !== 'number' ? 'N/A' : (v / 1000).toFixed(2) },
                { field: 'moving_time', title: '用时', sortable: true, sorter: (a,b) => parseMovingTime(a) - parseMovingTime(b) },
                { field: 'average_speed', title: '平均配速', sortable: true, formatter: v => (typeof v !== 'number' || v <= 0) ? 'N/A' : formatPace(1/v) },
                { field: 'average_heartrate', title: '平均心率', sortable: true, formatter: v => typeof v !== 'number' ? 'N/A' : Math.round(v) },
                { field: 'city', title: '城市', sortable: true },
            ],
            data: allData, pagination: true, search: true, sortName: 'start_date_local', sortOrder: 'desc', showRefresh: true, showToggle: true, showColumns: true, mobileResponsive: true
        });
    }

    function setupDetailedFilters() {
        $('#detailed-filter').on('click', 'button', function() {
            $(this).addClass('active').siblings().removeClass('active');
            const filter = $(this).data('filter');
            let filteredData = allData;
            if (filter === 'today_in_history') {
                const today = moment();
                filteredData = allData.filter(d => d.start_date_local_moment.month() === today.month() && d.start_date_local_moment.date() === today.date());
            } else if (filter === 'training') filteredData = allData.filter(d => d.subtype !== 'race');
            else if (filter === 'race') filteredData = allData.filter(d => d.subtype === 'race');
            else if (filter === 'half_marathon') filteredData = allData.filter(d => d.distance >= 21097.5);
            else if (filter === 'marathon') filteredData = allData.filter(d => d.distance >= 42195);
            $('#detailed-table').bootstrapTable('load', filteredData);
        });
    }
    
    // --- Statistics Tab Logic ---
    function setupStatsControls() {
        $('#stats-period-filter').on('click', 'button', function() {
            $(this).addClass('active').siblings().removeClass('active');
            currentStatsPeriod = $(this).data('period');
            currentDateRef = moment();
            updateStatsView();
        });
        $('#prev-time, #next-time').on('click', function() {
            const direction = $(this).is('#prev-time') ? -1 : 1;
            if (currentStatsPeriod === 'month') currentDateRef.add(direction, 'month');
            else if (currentStatsPeriod === 'year') currentDateRef.add(direction, 'year');
            updateStatsView();
        });
    }

    function updateStatsView() {
        if (!allData.length) return;
        if (currentStatsPeriod === 'trend') {
            handleTrendView();
        } else {
            handleStandardViews();
        }
    }

    function handleTrendView() {
        $('#time-nav, #stats-table-container').hide();
        $('#stats-summary-text').show();
        const { labels, currentMonthCumulative, prevMonthCumulative } = aggregateCumulativeData();
        renderTrendChart(labels, currentMonthCumulative, prevMonthCumulative);
        const todayIndex = moment().date() - 1;
        const currentTotal = currentMonthCumulative[todayIndex] || 0;
        const prevTotal = prevMonthCumulative[todayIndex] || 0;
        $('#stats-summary-text').html(`截至今日，本月已跑 <strong class="text-primary">${(currentTotal / 1000).toFixed(2)} km</strong>，上月同期为 <strong class="text-secondary">${(prevTotal / 1000).toFixed(2)} km</strong>。`);
    }

    function handleStandardViews() {
        $('#stats-table-container, #stats-summary-text').show();
        $('#time-nav').toggle(currentStatsPeriod === 'month' || currentStatsPeriod === 'year');

        const { aggregatedData, labels, dataMap } = aggregateData(currentStatsPeriod);
        renderStatsChart(labels, aggregatedData);
        renderStatsTable(aggregatedData);
        updateNavButtons();
        
        const totalDistance = Array.from(dataMap.values()).reduce((s, item) => s + item.distance, 0);
        let summaryHtml = `本周期总跑量: <strong class="text-primary">${(totalDistance / 1000).toFixed(2)} km</strong>`;
        const numPeriods = labels.length;
        if (numPeriods > 0) {
            const avgDistance = totalDistance / numPeriods;
            const periodNames = { '16w': '周', 'year': '月', 'all': '年' };
            const periodName = periodNames[currentStatsPeriod];
            if(periodName) summaryHtml += `, 平均每${periodName}跑量: <strong class="text-success">${(avgDistance / 1000).toFixed(2)} km</strong>`;
        }
        $('#stats-summary-text').html(summaryHtml);
    }
    
    // --- Data Aggregation ---
    function aggregateCumulativeData() {
        const today = moment();
        const startOfThisMonth = today.clone().startOf('month');
        const startOfLastMonth = today.clone().subtract(1, 'month').startOf('month');
        const endOfLastMonth = startOfLastMonth.clone().endOf('month');
        const daysInMonth = today.daysInMonth();
        const labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
        let currentMonthDaily = new Array(daysInMonth).fill(0), prevMonthDaily = new Array(daysInMonth).fill(0);

        allData.forEach(run => {
            if (run.start_date_local_moment.isBetween(startOfThisMonth, today, null, '[]')) {
                currentMonthDaily[run.start_date_local_moment.date() - 1] += run.distance;
            }
            if (run.start_date_local_moment.isBetween(startOfLastMonth, endOfLastMonth, null, '[]') && run.start_date_local_moment.date() <= daysInMonth) {
                prevMonthDaily[run.start_date_local_moment.date() - 1] += run.distance;
            }
        });
        
        const calculateCumulative = data => data.reduce((acc, val) => { acc.push((acc.length > 0 ? acc[acc.length - 1] : 0) + val); return acc; }, []);
        return { labels, currentMonthCumulative: calculateCumulative(currentMonthDaily), prevMonthCumulative: calculateCumulative(prevMonthDaily) };
    }

    function aggregateData(period) { /* Omitted for brevity, logic unchanged from last correct version */
        let aggregatedData = [], labels = [], dataMap = new Map();
        const addToMap = (key, run) => {
            if (!dataMap.has(key)) dataMap.set(key, { distance: 0, time: 0, weightedHr: 0, count: 0 });
            const current = dataMap.get(key);
            current.distance += run.distance; current.time += run.moving_time_seconds;
            current.weightedHr += (run.average_heartrate || 0) * run.moving_time_seconds; current.count++;
        };
        switch (period) {
            case 'month':
                const startOfMonth = currentDateRef.clone().startOf('month'), endOfMonth = currentDateRef.clone().endOf('month');
                $('#current-time-display').text(currentDateRef.format('YYYY年 MMMM'));
                for (let m = startOfMonth.clone(); m.isSameOrBefore(endOfMonth); m.add(1, 'day')) labels.push(m.format('D'));
                allData.filter(d => d.start_date_local_moment.isBetween(startOfMonth, endOfMonth, null, '[]')).forEach(run => addToMap(run.start_date_local_moment.format('D'), run));
                break;
            case '16w':
                const endOfThisWeek = moment().endOf('isoWeek'), startOf16WeeksAgo = moment().subtract(15, 'weeks').startOf('isoWeek');
                for (let i = 0; i < 16; i++) labels.push(startOf16WeeksAgo.clone().add(i, 'weeks').format('MM/DD'));
                allData.filter(d => d.start_date_local_moment.isBetween(startOf16WeeksAgo, endOfThisWeek, null, '[]')).forEach(run => addToMap(run.start_date_local_moment.clone().startOf('isoWeek').format('MM/DD'), run));
                break;
            case 'year':
                const startOfYear = currentDateRef.clone().startOf('year'), endOfYear = currentDateRef.clone().endOf('year');
                $('#current-time-display').text(currentDateRef.format('YYYY年'));
                labels = moment.monthsShort(); 
                allData.filter(d => d.start_date_local_moment.isBetween(startOfYear, endOfYear, null, '[]')).forEach(run => addToMap(labels[run.start_date_local_moment.month()], run));
                break;
            case 'all':
                const years = [...new Set(allData.map(d => d.start_date_local_moment.year()))].sort();
                labels = years.map(String);
                allData.forEach(run => addToMap(run.start_date_local_moment.year().toString(), run));
                break;
        }
        labels.forEach(label => {
            const data = dataMap.get(label) || { distance: 0, time: 0, weightedHr: 0 };
            aggregatedData.push({ period: label, distance: data.distance, time: data.time, avgHr: data.time > 0 ? Math.round(data.weightedHr / data.time) : 0, avgPace: formatPace(data.distance > 0 ? data.time / data.distance : 0) });
        });
        return { aggregatedData, labels, dataMap };
    }
    
    // --- Chart Rendering ---
    const todayLinePlugin = {
        id: 'todayLine',
        afterDatasetsDraw(chart) {
            if (currentStatsPeriod !== 'trend') return;
            const ctx = chart.ctx;
            const todayIndex = moment().date() - 1;
            if (chart.getDatasetMeta(0).data.length <= todayIndex) return;
            const x = chart.getDatasetMeta(0).data[todayIndex].x;
            const topY = chart.scales.y.top;
            const bottomY = chart.scales.y.bottom;
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(x, topY);
            ctx.lineTo(x, bottomY);
            ctx.lineWidth = 2;
            ctx.strokeStyle = 'rgba(220, 53, 69, 0.8)';
            ctx.setLineDash([5, 5]);
            ctx.stroke();
            ctx.restore();
        }
    };
    Chart.register(todayLinePlugin);

    function renderTrendChart(labels, currentData, prevData) {
        if (statsChart) statsChart.destroy();
        const ctx = document.getElementById('statsChart').getContext('2d');
        const todayIndex = moment().date();
        const processedCurrentData = currentData.map((d, i) => i < todayIndex ? (d / 1000).toFixed(2) : null);
        statsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: '本月累计跑量 (km)', data: processedCurrentData, borderColor: 'rgba(0, 123, 255, 1)', backgroundColor: 'rgba(0, 123, 255, 0.1)', fill: true, tension: 0.1 },
                    { label: '上月累计跑量 (km)', data: prevData.map(d => (d/1000).toFixed(2)), borderColor: 'rgba(108, 117, 125, 1)', backgroundColor: 'rgba(108, 117, 125, 0.1)', fill: true, tension: 0.1, borderDash: [5, 5] }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: '累计公里 (km)' } } }, plugins: { tooltip: { mode: 'index', intersect: false } } }
        });
    }

    function renderStatsChart(labels, data) {
        if (statsChart) statsChart.destroy();
        const ctx = document.getElementById('statsChart').getContext('2d');
        statsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: '跑量 (km)', data: data.map(d => (d.distance / 1000).toFixed(2)), backgroundColor: 'rgba(0, 123, 255, 0.5)', borderColor: 'rgba(0, 123, 255, 1)', borderWidth: 1 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, title: { display: true, text: '公里 (km)' } } },
                plugins: { tooltip: { callbacks: { footer: (items) => { const item = data[items[0].dataIndex]; return [`用时: ${formatSeconds(item.time)}`, `配速: ${item.avgPace}`, `心率: ${item.avgHr || 'N/A'}`]; } } } }
            }
        });
    }

    function renderStatsTable(data) {
        const tableData = data.filter(d => d.distance > 0);
        tableData.reverse();
        const periodTitle = {'month':'日期', '16w':'周 (开始于)', 'year':'月份', 'all':'年份'}[currentStatsPeriod] || '周期';
        $('#stats-table').bootstrapTable('destroy').bootstrapTable({
            columns: [
                { field: 'period', title: periodTitle },
                { field: 'distance', title: '跑量 (km)', formatter: v => (v / 1000).toFixed(2) },
                { field: 'time', title: '用时', formatter: v => formatSeconds(v) },
                { field: 'avgHr', title: '平均心率' },
                { field: 'avgPace', title: '平均配速' },
            ],
            data: tableData
        });
    }

    function updateNavButtons() { /* Omitted for brevity, logic unchanged */
        if (!allData || allData.length === 0) { $('#prev-time, #next-time').hide(); return; }
        const firstRunDate = allData[allData.length - 1].start_date_local_moment;
        if (currentStatsPeriod === 'month') {
            const prevMonth = currentDateRef.clone().subtract(1, 'month');
            const nextMonth = currentDateRef.clone().add(1, 'month');
            $('#prev-time').toggle(prevMonth.endOf('month').isSameOrAfter(firstRunDate, 'day'));
            $('#next-time').toggle(nextMonth.startOf('month').isSameOrBefore(moment(), 'day'));
        } else if (currentStatsPeriod === 'year') {
            const prevYear = currentDateRef.clone().subtract(1, 'year');
            const nextYear = currentDateRef.clone().add(1, 'year');
            $('#prev-time').toggle(prevYear.endOf('year').isSameOrAfter(firstRunDate, 'day'));
            $('#next-time').toggle(nextYear.startOf('year').isSameOrBefore(moment(), 'day'));
        }
    }
});
</script>

</body>
</html>
