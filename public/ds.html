<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>跑步数据中心</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.22.5/bootstrap-table.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <style>
        body { background-color: #f8f9fa; }
        .container-fluid { padding: 15px; }
        .card { transition: box-shadow 0.2s ease-in-out; }
        .card:hover { box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1) !important; }

        /* Section Title Styling */
        .section-title {
            font-weight: 500;
            color: #343a40;
            margin-bottom: 0.75rem;
            padding-left: 5px;
        }
        .section-title .fas { color: #6c757d; margin-right: 8px; }

        /* Summary Cards Carousel */
        .summary-container { overflow: hidden; position: relative; }
        .summary-cards-wrapper { display: flex; transition: transform 0.3s ease-in-out; }
        .summary-card { flex: 0 0 100%; padding: 0; } /* Remove padding */
        .summary-card .card { text-align: center; margin: 0 5px; } /* Add margin for spacing */
        .summary-dots { display: none; text-align: center; padding-top: 10px; }
        .summary-dots .dot { display: inline-block; width: 8px; height: 8px; margin: 0 4px; background-color: #ccc; border-radius: 50%; cursor: pointer; transition: background-color 0.3s; }
        .summary-dots .dot.active { background-color: #0d6efd; }
        
        @media (min-width: 768px) {
            .summary-cards-wrapper { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; }
            .summary-card .card { margin: 0; }
        }
        @media (max-width: 767.98px) { .summary-dots { display: block; } }

        .chart-container { position: relative; height: 30vh; width: 100%; margin-bottom: 20px; }
        @media (min-width: 992px) {
            .chart-container { height: auto; min-height: 400px; margin-bottom: 0; }
        }
        /*#trend-chart-container { height: 350px; }*/

        #stats-summary-text, #trend-summary-text { text-align: center; font-size: 1rem; margin-bottom: 1.5rem; color: #495057; }
        .card-header-tabs { margin-bottom: -0.7rem; border-bottom: 0; padding: 0.5rem 1rem; }

        /* Detailed Records Toolbar Fix */
        .bootstrap-table .fixed-table-toolbar .search,
        .bootstrap-table .fixed-table-toolbar .columns {
            width: auto !important; /* Override default width */
        }
        @media (max-width: 767.98px) {
            .bootstrap-table .fixed-table-toolbar .bs-bars, 
            .bootstrap-table .fixed-table-toolbar .search, 
            .bootstrap-table .fixed-table-toolbar .columns {
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
             .bootstrap-table .fixed-table-toolbar {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
             .bootstrap-table .fixed-table-toolbar .search .form-control {
                width: 150px; /* Adjust search input width on mobile */
            }
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="text-center my-4">
        <h1 class="display-5"><i class="fas fa-chart-line"></i> 跑步数据中心</h1>
    </div>

    <div class="mb-4">
        <div class="summary-container">
            <div class="summary-cards-wrapper">
                <div class="summary-card"><div class="card shadow-sm"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">总跑量 (km)</h6><h4 class="card-title" id="total-distance"><i class="fas fa-road text-primary"></i> --</h4></div></div></div>
                <div class="summary-card"><div class="card shadow-sm"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">总次数</h6><h4 class="card-title" id="total-runs"><i class="fas fa-person-running text-success"></i> --</h4></div></div></div>
                <div class="summary-card"><div class="card shadow-sm"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">总用时</h6><h4 class="card-title" id="total-time"><i class="far fa-clock text-info"></i> --</h4></div></div></div>
                <div class="summary-card"><div class="card shadow-sm"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">平均配速</h6><h4 class="card-title" id="avg-pace"><i class="fas fa-stopwatch text-warning"></i> --</h4></div></div></div>
                <div class="summary-card"><div class="card shadow-sm"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">平均心率</h6><h4 class="card-title" id="avg-heartrate"><i class="fas fa-heart-pulse text-danger"></i> --</h4></div></div></div>
            </div>
        </div>
        <div class="summary-dots"></div>
    </div>
    
    <div id="dynamic-content-area">
        <div id="todays-run-section" style="display: none;" class="mb-4">
            <h4 class="section-title"><i class="fas fa-calendar-day"></i> 今日运动</h4>
            <div class="card shadow-sm" id="todays-run-card">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 col-md-3 mb-2 mb-md-0"><h6 class="card-subtitle text-muted">跑量 (km)</h6><h4 class="card-title" id="today-distance">--</h4></div>
                        <div class="col-6 col-md-3 mb-2 mb-md-0"><h6 class="card-subtitle text-muted">用时</h6><h4 class="card-title" id="today-time">--</h4></div>
                        <div class="col-6 col-md-3"><h6 class="card-subtitle text-muted">配速</h6><h4 class="card-title" id="today-pace">--</h4></div>
                        <div class="col-6 col-md-3"><h6 class="card-subtitle text-muted">心率</h6><h4 class="card-title" id="today-heartrate">--</h4></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <h4 class="section-title"><i class="fas fa-chart-line"></i> 本月趋势</h4>
            <div class="card shadow-sm">
                <div class="card-body">
                    <div id="trend-summary-text"></div>
                    <div class="chart-container" id="trend-chart-container"><canvas id="trendChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>
    
    <h4 class="section-title"><i class="fas fa-database"></i> 数据探索</h4>
    <div class="card shadow-sm">
        <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#stats-content" type="button" role="tab"><i class="fas fa-chart-bar"></i> 数据统计</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#records-content" type="button" role="tab"><i class="fas fa-list-ul"></i> 详细记录</button></li>
        </ul>
        <div class="card-body">
            <div class="tab-content pt-3" id="myTabContent">
                <div class="tab-pane fade show active" id="stats-content" role="tabpanel">
                    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
                        <div class="btn-group" role="group" id="stats-period-filter">
                            <button type="button" class="btn btn-sm btn-outline-primary active" data-period="month">按月</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" data-period="16w">16周</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" data-period="year">按年</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" data-period="all">全部</button>
                        </div>
                        <div id="time-nav" class="btn-group mt-2 mt-md-0" style="display: none;">
                            <button id="prev-time" class="btn btn-secondary btn-sm"><i class="fas fa-angle-left"></i></button>
                            <span id="current-time-display" class="btn btn-light btn-sm disabled"></span>
                            <button id="next-time" class="btn btn-secondary btn-sm"><i class="fas fa-angle-right"></i></button>
                        </div>
                    </div>
                    <div class="row align-items-center">
                        <div class="col-lg-7">
                            <div class="chart-container"><canvas id="statsChart"></canvas></div>
                        </div>
                        <div class="col-lg-5">
                            <div id="stats-summary-text"></div>
                            <div id="stats-table-container"><table id="stats-table"></table></div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="records-content" role="tabpanel">
                    <div class="btn-group mb-3 flex-wrap" role="group" id="detailed-filter">
                        <button type="button" class="btn btn-sm btn-outline-primary active" data-filter="all">全部记录</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-filter="today_in_history">史上今日</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-filter="race">比赛</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-filter="half_marathon">&GreaterEqual;半马</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-filter="marathon">&GreaterEqual;全马</button>
                    </div>
                    <table id="detailed-table"></table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.22.5/bootstrap-table.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.22.5/locale/bootstrap-table-zh-CN.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/locale/zh-cn.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

<script>
$(function() {
    // --- Globals ---
    let allData = [];
    let statsChart, trendChart;
    let currentStatsPeriod = 'month'; 
    let currentDateRef = moment();

    // --- Utility Functions ---
    const parseMovingTime = (timeStr) => {
        if (!timeStr || typeof timeStr !== 'string') return 0;
        const parts = timeStr.split(':');
        if (parts.length < 3) return 0;
        const hours = parseInt(parts[0], 10), minutes = parseInt(parts[1], 10), seconds = parseFloat(parts[2]);
        if (isNaN(hours) || isNaN(minutes) || isNaN(seconds)) return 0;
        return hours * 3600 + minutes * 60 + seconds;
    };
    const formatSeconds = (totalSeconds, showDays = false) => {
        if (isNaN(totalSeconds) || totalSeconds < 0) return "00:00:00";
        let days = showDays ? Math.floor(totalSeconds / 86400) : 0;
        if (showDays) totalSeconds %= 86400;
        const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
        const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
        const s = String(Math.floor(totalSeconds % 60)).padStart(2, '0');
        return days > 0 ? `${days}天 ${h}:${m}:${s}` : `${h}:${m}:${s}`;
    };
    const formatPace = (secondsPerMeter) => {
        if (!secondsPerMeter || secondsPerMeter <= 0 || !isFinite(secondsPerMeter)) return "N/A";
        const secondsPerKm = secondsPerMeter * 1000;
        const minutes = Math.floor(secondsPerKm / 60);
        const seconds = Math.round(secondsPerKm % 60);
        return `${minutes}'${String(seconds).padStart(2, '0')}"`;
    };

    // --- Main Initializer ---
    fetch('data/all.json')
        .then(response => response.json())
        .then(data => {
            allData = data.map(d => ({...d, start_date_local_moment: moment(d.start_date_local), moving_time_seconds: parseMovingTime(d.moving_time)})).sort((a, b) => b.start_date_local_moment - a.start_date_local_moment);
            initSummaryCards();
            displayTodaysRun();
            initTrendSection();
            setupMobileCarousel(); // Replaces setupMobileSlider
            initDetailedTable();
            setupDetailedFilters();
            setupStatsControls();
            updateStatsView();
        });

    // --- UI Setup Functions ---
    function initSummaryCards() {
        if (allData.length === 0) return;
        const totalDistance = allData.reduce((s, d) => s + d.distance, 0);
        const totalRuns = allData.length;
        const totalMovingTime = allData.reduce((s, d) => s + d.moving_time_seconds, 0);
        const totalWeightedHr = allData.reduce((s, d) => s + (d.average_heartrate || 0) * d.moving_time_seconds, 0);
        const avgSpeed = totalDistance / totalMovingTime;
        $('#total-distance').html(`<i class="fas fa-road text-primary"></i> ${(totalDistance / 1000).toFixed(2)}`);
        $('#total-runs').html(`<i class="fas fa-calendar-check text-success"></i> ${totalRuns}`);
        $('#total-time').html(`<i class="far fa-clock text-info"></i> ${formatSeconds(totalMovingTime, true)}`);
        $('#avg-pace').html(`<i class="fas fa-bolt-lightning text-warning"></i> ${totalMovingTime > 0 ? formatPace(1 / avgSpeed) : "N/A"}`);
        $('#avg-heartrate').html(`<i class="fas fa-heart-pulse text-danger"></i> ${totalMovingTime > 0 ? (totalWeightedHr / totalMovingTime).toFixed(0) : "N/A"}`);
    }

    function displayTodaysRun() {
        const todaysRuns = allData.filter(d => d.start_date_local_moment.isSame(moment(), 'day'));
        if (todaysRuns.length > 0) {
            const totalDistance = todaysRuns.reduce((s, d) => s + d.distance, 0);
            const totalTime = todaysRuns.reduce((s, d) => s + d.moving_time_seconds, 0);
            const totalWeightedHr = todaysRuns.reduce((s, d) => s + (d.average_heartrate || 0) * d.moving_time_seconds, 0);
            
            $('#today-distance').text((totalDistance / 1000).toFixed(2));
            $('#today-time').text(formatSeconds(totalTime));
            $('#today-pace').text(totalTime > 0 ? formatPace(totalTime / totalDistance) : "N/A");
            $('#today-heartrate').text(totalTime > 0 ? (totalWeightedHr / totalTime).toFixed(0) : "N/A");

            $('#todays-run-section').show();
        }
    }

    function initTrendSection() {
        if (!allData.length) return;
        const { labels, currentMonthCumulative, prevMonthCumulative } = aggregateCumulativeData();
        renderTrendChart(labels, currentMonthCumulative, prevMonthCumulative);
        const todayIndex = moment().date() - 1;
        const currentTotal = todayIndex < currentMonthCumulative.length ? currentMonthCumulative[todayIndex] || 0 : 0;
        const prevTotal = todayIndex < prevMonthCumulative.length ? prevMonthCumulative[todayIndex] || 0 : 0;
        const diffTotal = ((currentTotal - prevTotal) / 1000).toFixed(2);
        const diffSign = diffTotal >= 0 ? '+' : '';
        const diffColorClass = diffTotal >= 0 ? 'text-success' : 'text-danger'; 
        $('#trend-summary-text').html(`本月已跑 <strong class="text-primary">${(currentTotal / 1000).toFixed(2)} km</strong>，较上月同期 <strong class="${diffColorClass}">${diffSign}${diffTotal} km</strong>。`);
    }

    function setupMobileCarousel() {
        let currentIndex = 0;
        const wrapper = $('.summary-cards-wrapper');
        const items = $('.summary-card');
        const dotsContainer = $('.summary-dots');
        const totalItems = items.length;
        if (totalItems <= 1) return;

        // Create dots
        for (let i = 0; i < totalItems; i++) {
            dotsContainer.append('<span class="dot"></span>');
        }
        const dots = dotsContainer.find('.dot');
        const updateDots = () => {
            dots.removeClass('active').eq(currentIndex).addClass('active');
        };
        updateDots();

        // Swipe functionality
        let touchStartX = 0;
        let touchEndX = 0;
        let isDragging = false;
        
        wrapper.on('touchstart', (e) => {
            if ($(window).width() >= 768) return;
            touchStartX = e.originalEvent.touches[0].clientX;
            isDragging = true;
            wrapper.css('transition', 'none'); // Disable transition while dragging
        });

        wrapper.on('touchmove', (e) => {
             if (!isDragging || $(window).width() >= 768) return;
             const currentX = e.originalEvent.touches[0].clientX;
             const diff = currentX - touchStartX;
             wrapper.css('transform', `translateX(calc(-${currentIndex * 100}% + ${diff}px))`);
        });

        wrapper.on('touchend', (e) => {
            if (!isDragging || $(window).width() >= 768) return;
            isDragging = false;
            touchEndX = e.originalEvent.changedTouches[0].clientX;
            const diff = touchEndX - touchStartX;
            
            wrapper.css('transition', 'transform 0.3s ease-in-out'); // Re-enable transition for snap

            if (Math.abs(diff) > 50) { // Swipe threshold
                if (diff < 0) { // Swipe left
                    currentIndex = Math.min(currentIndex + 1, totalItems - 1);
                } else { // Swipe right
                    currentIndex = Math.max(currentIndex - 1, 0);
                }
            }
            wrapper.css('transform', `translateX(-${currentIndex * 100}%)`);
            updateDots();
        });

         $(window).on('resize', () => {
             if ($(window).width() >= 768) {
                 wrapper.css('transform', 'none');
             } else {
                 wrapper.css('transform', `translateX(-${currentIndex * 100}%)`);
             }
        }).trigger('resize');
    }

    function initDetailedTable() {
        $('#detailed-table').bootstrapTable({
            columns: [
                { field: 'start_date_local', title: '开始时间', sortable: true },
                { field: 'distance', title: '距离 (km)', sortable: true, formatter: v => typeof v !== 'number' ? 'N/A' : (v / 1000).toFixed(2) },
                { field: 'moving_time', title: '用时', sortable: true, sorter: (a,b) => parseMovingTime(a) - parseMovingTime(b), formatter: v => v.split('.')[0] },
                { field: 'average_speed', title: '配速', sortable: true, formatter: v => (typeof v !== 'number' || v <= 0) ? 'N/A' : formatPace(1/v) },
                { field: 'average_heartrate', title: '心率', sortable: true, formatter: v => typeof v !== 'number' ? 'N/A' : Math.round(v) },
                { field: 'city', title: '城市', sortable: true },
            ],
            data: allData, pagination: true, search: true, sortName: 'start_date_local', sortOrder: 'desc', mobileResponsive: true,
            toolbar: '#toolbar', showRefresh: false, showToggle: true, showColumns: true, searchAlign: 'left', buttonsAlign: 'right',
            iconsPrefix: 'fa',
            icons: { refresh: 'fa-sync-alt', toggleOff: 'fa-toggle-off', toggleOn: 'fa-toggle-on', columns: 'fa-th-list', fullscreen: 'fa-arrows-alt' }
        });
    }

    function setupDetailedFilters() {
        $('#detailed-filter').on('click', 'button', function() {
            $(this).addClass('active').siblings().removeClass('active');
            const filter = $(this).data('filter');
            let filteredData = allData;
            if (filter === 'today_in_history') {
                const today = moment();
                filteredData = allData.filter(d => d.start_date_local_moment.month() === today.month() && d.start_date_local_moment.date() === today.date());
            } else if (filter === 'race') filteredData = allData.filter(d => d.subtype === 'race');
            else if (filter === 'half_marathon') filteredData = allData.filter(d => d.distance >= 21097.5);
            else if (filter === 'marathon') filteredData = allData.filter(d => d.distance >= 42195);
            $('#detailed-table').bootstrapTable('load', filteredData);
        });
    }
    
    // --- Statistics Tab Logic ---
    function setupStatsControls() {
        $('#stats-period-filter').on('click', 'button', function() {
            $(this).addClass('active').siblings().removeClass('active');
            currentStatsPeriod = $(this).data('period');
            currentDateRef = moment();
            updateStatsView();
        });
        $('#prev-time, #next-time').on('click', function() {
            const direction = $(this).is('#prev-time') ? -1 : 1;
            if (currentStatsPeriod === 'month') currentDateRef.add(direction, 'month');
            else if (currentStatsPeriod === 'year') currentDateRef.add(direction, 'year');
            updateStatsView();
        });
    }

    function updateStatsView() {
        if (!allData.length) return;
        handleStandardViews();
    }

    function handleStandardViews() {
        $('#stats-table-container, #stats-summary-text').show();
        $('#time-nav').css('display', (currentStatsPeriod === 'month' || currentStatsPeriod === 'year') ? 'inline-flex' : 'none');
        const { aggregatedData, labels, dataMap } = aggregateData(currentStatsPeriod);
        renderStatsChart(labels, aggregatedData);
        renderStatsTable(aggregatedData);
        updateNavButtons();
        const totalDistance = Array.from(dataMap.values()).reduce((s, item) => s + item.distance, 0);
        let summaryHtml = `当前周期总跑量: <strong class="text-primary">${(totalDistance / 1000).toFixed(2)} km</strong>`;
        const numPeriodsWithRuns = Array.from(dataMap.values()).filter(v => v.count > 0).length;
        if (numPeriodsWithRuns > 0) {
            const avgDistance = totalDistance / numPeriodsWithRuns;
            const periodNames = { 'month': '天', '16w': '周', 'year': '月', 'all': '年' };
            const periodName = periodNames[currentStatsPeriod];
            if(periodName) summaryHtml += `, 平均每${periodName}: <strong class="text-success">${(avgDistance / 1000).toFixed(2)} km</strong>`;
        }
        $('#stats-summary-text').html(summaryHtml);
    }
    
    // --- Data Aggregation ---
    function aggregateCumulativeData() {
        const today = moment();
        const startOfThisMonth = today.clone().startOf('month');
        const startOfLastMonth = today.clone().subtract(1, 'month').startOf('month');
        const endOfLastMonth = startOfLastMonth.clone().endOf('month');
        const daysInMonth = today.daysInMonth();
        const labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
        let currentMonthDaily = new Array(daysInMonth).fill(0), prevMonthDaily = new Array(daysInMonth).fill(0);
        allData.forEach(run => {
            if (run.start_date_local_moment.isBetween(startOfThisMonth, today, 'day', '[]')) {
                currentMonthDaily[run.start_date_local_moment.date() - 1] += run.distance;
            }
            if (run.start_date_local_moment.isBetween(startOfLastMonth, endOfLastMonth, 'day', '[]') && run.start_date_local_moment.date() <= daysInMonth) {
                prevMonthDaily[run.start_date_local_moment.date() - 1] += run.distance;
            }
        });
        const calculateCumulative = data => data.reduce((acc, val) => { acc.push((acc.length > 0 ? acc[acc.length - 1] : 0) + val); return acc; }, []);
        return { labels, currentMonthCumulative: calculateCumulative(currentMonthDaily), prevMonthCumulative: calculateCumulative(prevMonthDaily) };
    }

    function aggregateData(period) { 
        let aggregatedData = [], labels = [], dataMap = new Map();
        const addToMap = (key, run) => {
            if (!dataMap.has(key)) dataMap.set(key, { distance: 0, time: 0, weightedHr: 0, count: 0 });
            const current = dataMap.get(key);
            current.distance += run.distance; current.time += run.moving_time_seconds;
            current.weightedHr += (run.average_heartrate || 0) * run.moving_time_seconds; current.count++;
        };
        switch (period) {
            case 'month':
                const startOfMonth = currentDateRef.clone().startOf('month'), endOfMonth = currentDateRef.clone().endOf('month');
                $('#current-time-display').text(currentDateRef.format('YYYY年 MMMM'));
                labels = [];
                for (let m = startOfMonth.clone(); m.isSameOrBefore(endOfMonth); m.add(1, 'day')) {
                    const dayKey = m.format('D');
                    labels.push(dayKey);
                    dataMap.set(dayKey, { distance: 0, time: 0, weightedHr: 0, count: 0 });
                }
                allData.filter(d => d.start_date_local_moment.isBetween(startOfMonth, endOfMonth, null, '[]')).forEach(run => addToMap(run.start_date_local_moment.format('D'), run));
                break;
            case '16w':
                const endOfThisWeek = moment().endOf('isoWeek');
                const startOf16WeeksAgo = moment().subtract(15, 'weeks').startOf('isoWeek');
                labels = [];
                for (let i = 0; i < 16; i++) {
                    const weekKey = startOf16WeeksAgo.clone().add(i, 'weeks').format('MM/DD');
                    labels.push(weekKey);
                    dataMap.set(weekKey, { distance: 0, time: 0, weightedHr: 0, count: 0 });
                }
                allData.filter(d => d.start_date_local_moment.isBetween(startOf16WeeksAgo, endOfThisWeek, null, '[]')).forEach(run => addToMap(run.start_date_local_moment.clone().startOf('isoWeek').format('MM/DD'), run));
                break;
            case 'year':
                const startOfYear = currentDateRef.clone().startOf('year'), endOfYear = currentDateRef.clone().endOf('year');
                $('#current-time-display').text(currentDateRef.format('YYYY年'));
                labels = moment.monthsShort(); 
                labels.forEach(m => dataMap.set(m, { distance: 0, time: 0, weightedHr: 0, count: 0 }));
                allData.filter(d => d.start_date_local_moment.isBetween(startOfYear, endOfYear, null, '[]')).forEach(run => addToMap(labels[run.start_date_local_moment.month()], run));
                break;
            case 'all':
                const years = [...new Set(allData.map(d => d.start_date_local_moment.year()))].sort();
                labels = years.map(String);
                labels.forEach(y => dataMap.set(y, { distance: 0, time: 0, weightedHr: 0, count: 0 }));
                allData.forEach(run => addToMap(run.start_date_local_moment.year().toString(), run));
                break;
        }
        labels.forEach(label => {
            const data = dataMap.get(label) || { distance: 0, time: 0, weightedHr: 0, count: 0 };
            aggregatedData.push({ period: label, distance: data.distance, time: data.time, avgHr: data.time > 0 ? Math.round(data.weightedHr / data.time) : 0, avgPace: formatPace(data.distance > 0 ? data.time / data.distance : 0), count: data.count });
        });
        return { aggregatedData, labels, dataMap };
    }
    
    // --- Chart Rendering ---
    const todayLinePlugin = {
        id: 'todayLine',
        afterDatasetsDraw(chart) {
            if (chart.canvas.id !== 'trendChart') return;
            const ctx = chart.ctx, todayIndex = moment().date() - 1;
            if (chart.getDatasetMeta(0).data.length <= todayIndex) return;
            const x = chart.getDatasetMeta(0).data[todayIndex]?.x;
            if (x === undefined) return;
            const topY = chart.scales.y.top, bottomY = chart.scales.y.bottom;
            ctx.save();
            ctx.beginPath(); ctx.moveTo(x, topY); ctx.lineTo(x, bottomY);
            ctx.lineWidth = 2; ctx.strokeStyle = 'rgba(220, 53, 69, 0.8)'; ctx.setLineDash([5, 5]);
            ctx.stroke(); ctx.restore();
        }
    };
    Chart.register(todayLinePlugin);

    function renderTrendChart(labels, currentData, prevData) {
        if (trendChart) trendChart.destroy();
        const ctx = document.getElementById('trendChart').getContext('2d');
        const todayDate = moment().date();
        const processedCurrentData = currentData.map((d, i) => i < todayDate ? (d / 1000).toFixed(2) : null);
        trendChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [
                { label: '本月累计跑量 (km)', data: processedCurrentData, borderColor: 'rgba(0, 123, 255, 1)', backgroundColor: 'rgba(0, 123, 255, 0.1)', fill: true, tension: 0.1 },
                { label: '上月累计跑量 (km)', data: prevData.map(d => (d/1000).toFixed(2)), borderColor: 'rgba(108, 117, 125, 1)', backgroundColor: 'rgba(108, 117, 125, 0.1)', fill: true, tension: 0.1, borderDash: [5, 5] }
            ]},
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: '累计公里 (km)' } } }, plugins: { tooltip: { mode: 'index', intersect: false } } }
        });
    }

    function renderStatsChart(labels, data) {
        if (statsChart) statsChart.destroy();
        const ctx = document.getElementById('statsChart').getContext('2d');
        const dataValues = data.map(d => (d.distance / 1000).toFixed(2));
        statsChart = new Chart(ctx, { type: 'bar',
            data: { labels, datasets: [{ label: '跑量', data: dataValues, backgroundColor: 'rgba(0, 123, 255, 0.5)', borderColor: 'rgba(0, 123, 255, 1)', borderWidth: 1 }]},
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: '距离 (km)' } } },
                plugins: { tooltip: { callbacks: { footer: (items) => { const item = data[items[0].dataIndex]; let footerText = [`用时: ${formatSeconds(item.time)}`, `配速: ${item.avgPace}`, `心率: ${item.avgHr || 'N/A'}`]; if(item.count > 1) { footerText.unshift(`次数: ${item.count}`); } return footerText; } } }, legend: { display: false }
                }
            }
        });
    }

    function renderStatsTable(data) {
        const tableData = data.filter(d => d.distance > 0).reverse();
        const periodTitle = {'month':'日期', '16w':'周', 'year':'月份', 'all':'年份'}[currentStatsPeriod] || '周期';
        $('#stats-table').bootstrapTable('destroy').bootstrapTable({
            columns: [
                { field: 'period', title: periodTitle }, { field: 'distance', title: '跑量 (km)', formatter: v => (v / 1000).toFixed(2) },
                { field: 'count', title: '次数', visible: currentStatsPeriod !== 'month'},
                { field: 'time', title: '用时', formatter: v => formatSeconds(v) }, { field: 'avgHr', title: '心率' }, { field: 'avgPace', title: '配速' },
            ], data: tableData, classes: 'table table-hover table-sm',
        });
    }

    function updateNavButtons() { 
        if (!allData || allData.length === 0) return;
        const firstRunDate = allData[allData.length - 1].start_date_local_moment;
        const isMonthView = currentStatsPeriod === 'month';
        const isYearView = currentStatsPeriod === 'year';
        const refDate = currentDateRef.clone();
        
        const prevDisabled = isMonthView ? !refDate.subtract(1, 'month').endOf('month').isSameOrAfter(firstRunDate, 'day') : 
                             isYearView ? !refDate.subtract(1, 'year').endOf('year').isSameOrAfter(firstRunDate, 'day') : true;
                             
        const nextDisabled = isMonthView ? !currentDateRef.clone().add(1, 'month').startOf('month').isSameOrBefore(moment(), 'day') :
                             isYearView ? !currentDateRef.clone().add(1, 'year').startOf('year').isSameOrBefore(moment(), 'day') : true;

        $('#prev-time').prop('disabled', prevDisabled);
        $('#next-time').prop('disabled', nextDisabled);
    }
});
</script>

</body>
</html>
