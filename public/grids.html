<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Running Journey</title>

<style>
:root{
  --bg:#f7f9fb;--card:#fff;--text:#111;--sub:#666;
  --primary:#2ea44f;
  --l0:#ebedf0;--l1:#d6f5df;--l2:#b7ebc6;--l3:#8fdfa8;
  --l4:#6cd18a;--l5:#4fc26b;--l6:#36ab56;
  --l7:#2e8f47;--l8:#246b37;--l9:#164b26;
  --tip-bg: rgba(0,0,0,0.85);
}
@media(prefers-color-scheme:dark){
  :root{--bg:#0d1117;--card:#161b22;--text:#e6edf3;--sub:#8b949e;--l0:#21262d;--tip-bg: rgba(255,255,255,0.95);}
}

body{
  margin:0;padding:20px 12px;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  background:var(--bg);color:var(--text);
  display:flex;flex-direction:column;align-items:center;
  min-height: 100vh;
}

.top-bar{
  max-width:500px;width:100%;
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom: 10px;
}
.toggle button{
  padding:6px 12px;border-radius:999px;
  border:1px solid var(--l0);
  background:none;color:var(--sub);cursor:pointer;
  font-size: 14px;
  transition: all 0.2s;
}
.toggle .active{background:var(--primary);color:#fff;border-color:var(--primary)}

.card{
  max-width:500px;width:100%;
  background:var(--card);
  border-radius:16px;
  padding:24px;
  margin-top:10px;
  box-sizing: border-box;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}

.summary-title { font-size: 14px; color: var(--sub); text-transform: uppercase; letter-spacing: 1px;}
.summary-distance { font-size: 42px; font-weight: 800; line-height: 1.1; margin: 8px 0; font-variant-numeric: tabular-nums;}
.unit { font-size: 16px; font-weight: 600; color: var(--sub); margin-left: 4px; }

.progress{height:8px;background:var(--l0);border-radius:4px;margin-top:12px;overflow: hidden;}
.progress span{
    display:block; height:100%; background:linear-gradient(90deg, #40c463, #2ea44f); border-radius:4px;
    width: 0; transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1);
}
.progress-info{font-size:12px;color:var(--sub);display:flex;justify-content:space-between;margin-top:6px;font-variant-numeric: tabular-nums;}

.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:16px;justify-content: center;}
.badge{
  font-size:12px;padding:4px 10px;
  background:var(--l1); color:var(--l9);
  border-radius:99px; font-weight: 500; cursor: help;
}

.calendar{max-width:500px;width:100%;margin-top:20px;}
.month{
  background:var(--card);
  border-radius:14px;
  padding:16px;margin-bottom:16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.03);
  animation: fadeIn 0.5s ease-out;
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.title{font-weight:700;margin-bottom:12px; font-size: 15px; display: flex; justify-content: space-between;}
.grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }

.cell{
  aspect-ratio:1; border-radius:4px;
  background:var(--l0); position:relative;
  display: flex; flex-direction: column; justify-content: center; align-items: center;
  transition: transform 0.1s;
}
.cell:hover { transform: scale(1.05); z-index: 2; border: 1px solid rgba(0,0,0,0.1); }
.cell .label{ font-size: 12px; color: var(--sub); position: absolute; top: 2px; left: 4px; transform: scale(0.85); transform-origin: top left;}
.cell .distance{ font-size: 20px; font-weight: 700; color: #fff; z-index: 2;}

.level-0{background:var(--l0); color: var(--sub) !important;}
.level-1{background:var(--l1); .distance{color:var(--l8)}}
.level-2{background:var(--l2); .distance{color:var(--l9)}}
.level-3{background:var(--l3)} .level-4{background:var(--l4)}
.level-5{background:var(--l5)} .level-6{background:var(--l6)}
.level-7{background:var(--l7)} .level-8{background:var(--l8)}
.level-9{background:var(--l9)}

#tooltip{
  position:fixed;
  background:var(--tip-bg); color:#fff;
  padding:10px 14px;
  border-radius:8px;
  font-size:12px;
  pointer-events:none;
  opacity:0;
  z-index:9999;
  transition: opacity 0.15s;
  white-space: nowrap;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  line-height: 1.6;
  backdrop-filter: blur(4px);
}
@media (prefers-color-scheme:dark){ #tooltip { color: #000; } }

.tip-row { display: flex; gap: 12px; justify-content: space-between; align-items: center; }
.tip-header { border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:4px; margin-bottom: 4px; font-weight: 600; display: flex; justify-content: space-between;}
@media (prefers-color-scheme:dark){ .tip-header { border-color: rgba(0,0,0,0.1); } }

#toTop{
  position:fixed; right:20px; bottom:30px;
  background:var(--primary); color:#fff; border:none;
  width: 44px; height: 44px; border-radius:50%;
  cursor:pointer; display:none;
  font-size: 20px; box-shadow: 0 4px 12px rgba(46,164,79,0.4);
  z-index: 100;
}

#loading-sentinel { height: 20px; margin-top: 10px; }

@media (max-width: 480px) {
  .summary-distance { font-size: 36px; }
  .grid { gap: 4px; }
  .cell .distance { font-size: 11px; }
}
</style>
</head>

<body>

<div class="top-bar">
  <strong>Running Journey</strong>
  <div class="toggle">
    <button id="btnMonth" class="active">Month</button>
    <button id="btnYear">Year</button>
  </div>
</div>

<div class="card">
  <div class="summary-title">Á¥ØËÆ°Ë∑ëÈáè</div>
  <div class="summary-distance">
    <span id="total">0.0</span><span class="unit">km</span>
  </div>
  <div class="progress"><span id="globe"></span></div>
  <div class="progress-info">
    <span>ÁéØÁêÉËøõÂ∫¶</span><span id="ppct">0%</span>
  </div>
  <div class="badges" id="badges"></div>
</div>

<div class="calendar" id="calendar"></div>
<div id="loading-sentinel"></div>
<div id="tooltip"></div>
<button id="toTop">‚Üë</button>

<script>
/**
 * ÈÖçÁΩÆ‰∏éÂ∏∏Èáè
 */
const DATA_URL = 'https://run.linwn.net/data/all.json';
const BATCH_SIZE = 12;

// DOM ÂºïÁî®
const totalEl = document.getElementById('total');
const globeEl = document.getElementById('globe');
const ppctEl = document.getElementById('ppct');
const badgesEl = document.getElementById('badges');
const cal = document.getElementById('calendar');
const tip = document.getElementById('tooltip');
const sentinel = document.getElementById('loading-sentinel');

/**
 * Ê†∏ÂøÉÁä∂ÊÄÅÂ≠òÂÇ®
 */
let runsRaw = {}, monthKeys = [], years = {}, months = {};
let stats = {
    totalKm: 0,
    pb: { val: 0, date: '-' },
    fastest: { paceVal: 9999, paceStr: '--', date: '-' },
    bestMonth: { name: '-', val: 0 },
    streak: { count: 0, start: '-', end: '-' }
};
let renderCursor = 0;
let currentView = 'month';
let observer = null;

/**
 * ËæÖÂä©Â∑•ÂÖ∑ÂáΩÊï∞
 */
const parseDuration = t => {
    if (typeof t === 'number') return t;
    if (!t || typeof t !== 'string') return 0;
    const parts = t.split(':').map(Number);
    if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
    if (parts.length === 2) return parts[0] * 60 + parts[1];
    return 0;
};

const formatTime = s => {
    s = Math.round(Number(s));
    if (!s || isNaN(s)) return '--:--';
    const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sec = s % 60;
    return h > 0 ? `${h}:${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}` : `${m}:${String(sec).padStart(2, '0')}`;
};

const formatPace = (s, km) => {
    if (!s || !km || km === 0) return '--';
    const p = s / km, m = Math.floor(p / 60), sec = Math.floor(p % 60);
    return `${m}'${String(sec).padStart(2, '0')}"`;
};

function animateValue(obj, start, end, duration, suffix) {
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        const ease = 1 - Math.pow(1 - progress, 4);
        obj.innerHTML = (start + (end - start) * ease).toFixed(1) + suffix;
        if (progress < 1) window.requestAnimationFrame(step);
    };
    window.requestAnimationFrame(step);
}

/**
 * Tooltip ÁªëÂÆöÈÄªËæë
 */
function bindTip(el, contentProvider) {
    el.onmouseenter = () => {
        tip.innerHTML = typeof contentProvider === 'function' ? contentProvider() : contentProvider;
        tip.style.opacity = 1;
    };
    el.onmousemove = e => {
        const x = e.clientX + 15, y = e.clientY + 15;
        tip.style.left = Math.min(x, window.innerWidth - 220) + 'px';
        tip.style.top = y + 'px';
    };
    el.onmouseleave = () => tip.style.opacity = 0;
}

/**
 * Êï∞ÊçÆÂ§ÑÁêÜÊ†∏ÂøÉÈÄªËæë
 */
function processData(data) {
    // 1. ÈÅçÂéÜÂπ∂Â°´ÂÖÖÂü∫Á°ÄÁªìÊûÑ
    data.forEach(r => {
        const fullDate = (r.start_date_local || r.start_date).split(' ')[0];
        const km = Number(r.distance || 0) / 1000;
        const movingTime = parseDuration(r.moving_time);
        const paceVal = movingTime / km;

        // ÊûÑÂª∫Êó•ÂéÜÁ¥¢Âºï
        if (!runsRaw[fullDate]) runsRaw[fullDate] = { totalKm: 0, runs: [] };
        runsRaw[fullDate].totalKm += km;
        runsRaw[fullDate].runs.push(r);

        // ÁªüËÆ°Âπ¥/Êúà
        const mKey = fullDate.slice(0, 7), yKey = fullDate.slice(0, 4);
        months[mKey] = (months[mKey] || 0) + km;
        years[yKey] = years[yKey] || {};
        years[yKey][mKey] = (years[yKey][mKey] || 0) + km;

        // Á¥ØËÆ°
        stats.totalKm += km;

        // ËÆ∞ÂΩï PB
        if (km > stats.pb.val) stats.pb = { val: km, date: fullDate };

        // ËÆ∞ÂΩïÊúÄÂø´ÈÖçÈÄü (ÊéíÈô§ÊéâÊûÅÁü≠ÊàñÂºÇÂ∏∏ÁöÑÊï∞ÊçÆ)
        if (paceVal < stats.fastest.paceVal && km > 1) {
            stats.fastest = { paceVal, paceStr: formatPace(movingTime, km), date: fullDate };
        }
    });

    // 2. ÁªüËÆ°ÊúÄÁåõÊúà‰ªΩ
    const topMonth = Object.entries(months).sort((a, b) => b[1] - a[1])[0];
    if (topMonth) stats.bestMonth = { name: topMonth[0], val: topMonth[1] };

    // 3. ËÆ°ÁÆóÂéÜÂè≤ÊúÄÈïøËøûË∑ë (Streak)
    const sortedDates = Object.keys(runsRaw).sort();
    let maxStreak = [], currentStreak = [];

    sortedDates.forEach((d, i) => {
        if (i > 0) {
            const diff = (new Date(d) - new Date(sortedDates[i - 1])) / 86400000;
            if (diff === 1) {
                currentStreak.push(d);
            } else {
                if (currentStreak.length > maxStreak.length) maxStreak = [...currentStreak];
                currentStreak = [d];
            }
        } else {
            currentStreak = [d];
        }
    });
    if (currentStreak.length > maxStreak.length) maxStreak = currentStreak;

    if (maxStreak.length > 0) {
        stats.streak = { count: maxStreak.length, start: maxStreak[0], end: maxStreak[maxStreak.length - 1] };
    }

    // Êúà‰ªΩÈîÆÂêçÊéíÂ∫èÁî®‰∫éÊáíÂä†ËΩΩÊ∏≤Êüì
    monthKeys = Array.from(new Set(Object.keys(runsRaw).map(d => d.slice(0, 7)))).sort().reverse();
}

/**
 * UI Ê∏≤ÊüìÈÄªËæë
 */
function renderSummary() {
    // Ë∑ëÈáèÊï∞Â≠óÂä®Áîª
    animateValue(totalEl, 0, stats.totalKm, 1500, '');

    // ËøõÂ∫¶Êù°
    const earth = 40075, pct = Math.min(stats.totalKm / earth * 100, 100);
    animateValue(ppctEl, 0, pct, 1500, '%');
	const barWidth = Math.min(pct, 100);
    setTimeout(() => globeEl.style.width = barWidth + '%', 100);

    // Ê∏≤Êüì Badges Âπ∂ÁªëÂÆöÁâπÂÆö Tooltip
    const badgeData = [
        { label: `üèÜ ÊúÄÈïø ${stats.pb.val.toFixed(1)} km`, tip: `ËææÊàêÊó•ÊúüÔºö${stats.pb.date}` },
        { label: `‚ö° ÊúÄÂø´ ${stats.fastest.paceStr}`, tip: `ËææÊàêÊó•ÊúüÔºö${stats.fastest.date}` },
        { label: `üî• ÊúÄÁåõ ${stats.bestMonth.name}`, tip: `ÂΩìÊúàË∑ëÈáèÔºö${stats.bestMonth.val.toFixed(1)} km` },
        { label: `üìÖ ËøûÁª≠ ${stats.streak.count} Â§©`, tip: `ËøûË∑ëÂå∫Èó¥Ôºö${stats.streak.start} ~ ${stats.streak.end}` }
    ];

    badgesEl.innerHTML = '';
    badgeData.forEach(item => {
        const b = document.createElement('div');
        b.className = 'badge';
        b.textContent = item.label;
        bindTip(b, `<div style="padding:4px">${item.tip}</div>`);
        badgesEl.appendChild(b);
    });
}

// È¢úËâ≤ÂàÜÁ∫ßÂáΩÊï∞
function getLevel(k, mode) {
    if(mode === 'y') return k>300?9:k>250?8:k>230?7:k>210?6:k>190?5:k>150?4:k>100?3:k>50?2:k>10?1:0;
    return k>40?9:k>25?8:k>20?7:k>16?6:k>12?5:k>8?4:k>5?3:k>3?2:k>0?1:0;
}

function buildDayTooltip(date, dayData) {
    if (!dayData) return '';
    return dayData.runs.map((r, idx) => {
        const dist = (Number(r.distance) / 1000).toFixed(2);
        const sec = parseDuration(r.moving_time);
        const timeStr = formatTime(sec);
        const paceStr = formatPace(sec, Number(r.distance)/1000);
        const hr = r.average_heartrate ? Math.round(r.average_heartrate) : '-';
        const stTime = r.start_date_local ? (r.start_date_local.match(/(\d{2}:\d{2})/) || [])[1] : '';

        return `
            ${idx === 0 ? `<div class="tip-header"><span>${date}</span> <span>${stTime}</span></div>` : 
            `<div style="border-top:1px dashed rgba(255,255,255,0.2);margin:4px 0;padding-top:4px;font-size:11px;color:#bbb">Run ${idx+1} ¬∑ ${stTime}</div>`}
            <div>
                <div class="tip-row"><span style="font-weight:bold;font-size:13px">üèÉ ${dist} km</span> <span style="color:#8fdfa8;font-weight:bold">${paceStr}</span></div>
                <div class="tip-row" style="font-size:11px;color:#ccc;margin-top:2px"><span>‚è± ${timeStr}</span><span>üíì ${hr} bpm</span></div>
            </div>`;
    }).join('');
}

function renderOneMonth(mKey) {
    const [y, mo] = mKey.split('-');
    const monthTotal = months[mKey] || 0;
    const daysInMonth = new Date(y, mo, 0).getDate();
    const firstDay = new Date(y, mo - 1, 1).getDay();

    const box = document.createElement('div');
    box.className = 'month';
    box.innerHTML = `<div class="title"><span>${y}Âπ¥${mo}Êúà</span><span>${monthTotal.toFixed(1)} km</span></div><div class="grid"></div>`;
    const g = box.querySelector('.grid');

    // Â°´ÂÖÖÁ©∫ÁôΩ
    for (let i = 0; i < firstDay; i++) g.appendChild(document.createElement('div'));
    
    // Ê∏≤ÊüìÂ§©Êï∞
    for (let d = 1; d <= daysInMonth; d++) {
        const dateKey = `${y}-${mo}-${String(d).padStart(2, '0')}`;
        const dayData = runsRaw[dateKey];
        const km = dayData ? dayData.totalKm : 0;
        
        const c = document.createElement('div');
        c.className = `cell level-${getLevel(km, 'm')}`;
        c.innerHTML = `<span class="label">${d}</span>`;
        if (km > 0) {
            c.innerHTML += `<span class="distance">${km.toFixed(1)}</span>`;
            bindTip(c, () => buildDayTooltip(dateKey, dayData));
        }
        g.appendChild(c);
    }
    cal.appendChild(box);
}

function renderYearView() {
    cal.innerHTML = '';
    Object.keys(years).sort().reverse().forEach(y => {
        const box = document.createElement('div');
        box.className = 'month';
        const yTotal = Object.values(years[y]).reduce((a,b)=>a+b,0);
        box.innerHTML = `<div class="title"><span>${y}Âπ¥</span><span>${yTotal.toFixed(0)} km</span></div><div class="grid"></div>`;
        const g = box.querySelector('.grid');
        
        Object.entries(years[y]).sort().forEach(([mKey, km]) => {
            const c = document.createElement('div');
            c.className = `cell level-${getLevel(km, 'y')}`;
            c.innerHTML = `<span class="label">${Number(mKey.slice(-2))}Êúà</span><span class="distance">${km.toFixed(0)}</span>`;
            bindTip(c, `<div style="font-weight:bold">${mKey}</div><div>Ë∑ëÈáè: ${km.toFixed(1)} km</div>`);
            g.appendChild(c);
        });
        cal.appendChild(box);
    });
}

/**
 * ÊáíÂä†ËΩΩ‰∏é‰∫§‰∫í
 */
function renderNextBatch() {
    if (currentView !== 'month') return;
    const batch = monthKeys.slice(renderCursor, renderCursor + BATCH_SIZE);
    if (batch.length === 0) return;
    batch.forEach(m => renderOneMonth(m));
    renderCursor += BATCH_SIZE;
}

function initObserver() {
    if (observer) observer.disconnect();
    observer = new IntersectionObserver(entries => {
        if (entries[0].isIntersecting) renderNextBatch();
    }, { rootMargin: '200px' });
    observer.observe(sentinel);
}

// ËßÜÂõæÂàáÊç¢
document.getElementById('btnMonth').onclick = function() {
    if(currentView === 'month') return;
    currentView = 'month';
    this.classList.add('active');
    document.getElementById('btnYear').classList.remove('active');
    cal.innerHTML = ''; renderCursor = 0; sentinel.style.display = 'block';
    renderNextBatch(); initObserver();
};

document.getElementById('btnYear').onclick = function() {
    if(currentView === 'year') return;
    currentView = 'year';
    this.classList.add('active');
    document.getElementById('btnMonth').classList.remove('active');
    sentinel.style.display = 'none';
    renderYearView();
};

// ËøîÂõûÈ°∂ÈÉ®
window.onscroll = () => document.getElementById('toTop').style.display = window.scrollY > 500 ? 'block' : 'none';
document.getElementById('toTop').onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });

/**
 * ÂàùÂßãÂåñÂêØÂä®
 */
fetch(DATA_URL).then(r => r.json()).then(data => {
    processData(data);
    renderSummary();
    renderNextBatch();
    initObserver();
}).catch(e => {
    console.error(e);
    cal.innerHTML = '<div style="padding:20px;color:#999">Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•</div>';
});
</script>
</body>
</html>
