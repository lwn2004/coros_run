<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Running Journey</title>

<style>
:root{
  --bg:#f7f9fb;--card:#fff;--text:#111;--sub:#666;
  --primary:#2ea44f;
  --l0:#ebedf0;--l1:#d6f5df;--l2:#b7ebc6;--l3:#8fdfa8;
  --l4:#6cd18a;--l5:#4fc26b;--l6:#36ab56;
  --l7:#2e8f47;--l8:#246b37;--l9:#164b26;
}
@media(prefers-color-scheme:dark){
:root{--bg:#0d1117;--card:#161b22;--text:#e6edf3;--sub:#8b949e;--l0:#21262d;}
}
body{
  margin:0;padding:32px 14px;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:var(--bg);color:var(--text);
  display:flex;flex-direction:column;align-items:center;
}
.top-bar{
  max-width:500px;width:100%;
  display:flex;justify-content:space-between;align-items:center;
}
.toggle button{
  padding:6px 12px;border-radius:999px;
  border:1px solid var(--l0);
  background:none;color:var(--sub);cursor:pointer;
}
.toggle .active{background:var(--primary);color:#fff;border:none}

.card{
  max-width:500px;width:100%;
  background:var(--card);
  border-radius:16px;
  padding:24px;
  margin-top:16px;
  box-sizing: border-box;
  text-align: center;
}
.summary-title {
	font-size: 14px;
	font-weight: 500;
	color: var(--sub);
	letter-spacing: 0.5px;
	margin-bottom: 12px;
	text-transform: uppercase;
}
.summary-distance {
	font-size: 48px;
	font-weight: 800;
	color: var(--text);
	line-height: 1;
	margin-bottom: 4px;
	font-variant-numeric: tabular-nums;
}
.unit {
	font-size: 18px;
	font-weight: 600;
	color: var(--sub);
	margin-left: 4px;
}
.progress{height:8px;background:var(--l0);border-radius:4px;margin-top:8px}
.progress span{display:block;height:100%;background:var(--primary);border-radius:4px}
.progress-info{font-size:12px;color:var(--sub);display:flex;justify-content:space-between;margin-top:6px}
.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.badge{
  font-size:12px;padding:4px 8px;
  background:rgba(46,164,79,.15);
  color:var(--primary);
  border-radius:6px;
}

.calendar{max-width:500px;width:100%;margin-top:24px}
.month{
  background:var(--card);
  border-radius:14px;
  padding:16px;margin-bottom:18px;
}
.title{font-weight:700;margin-bottom:8px}
.grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:8px;
}
.cell{
  aspect-ratio:1;
  border-radius:4px;
  background:var(--l0);
  position:relative;
}
.cell span.label{
	font-size: 14px;
	color: var(--sub);
	text-transform: uppercase;
	padding: 6px;
}
.cell span.distance{
	font-size: 24px;
	color: #fff;
	padding: 6px;
}
.cell span.pb{
  position:absolute;
  top:2px;right:2px;
  font-size:10px;
}

.level-0{background:var(--l0)}.level-1{background:var(--l1)}
.level-2{background:var(--l2)}.level-3{background:var(--l3)}
.level-4{background:var(--l4)}.level-5{background:var(--l5)}
.level-6{background:var(--l6)}.level-7{background:var(--l7)}
.level-8{background:var(--l8)}.level-9{background:var(--l9)}

#tooltip{
  position:fixed;
  background:#000;color:#fff;
  padding:6px 10px;
  border-radius:6px;
  font-size:12px;
  pointer-events:none;
  opacity:0;
  z-index:9999;
}
#toTop{
  position:fixed;
  right:16px;bottom:16px;
  background:var(--primary);
  color:#fff;border:none;
  padding:10px 12px;
  border-radius:50%;
  cursor:pointer;
  display:none;
}
</style>
</head>

<body>

<div class="top-bar">
  <strong>Running Journey</strong>
  <div class="toggle">
    <button id="btnMonth" class="active">Month</button>
    <button id="btnYear">Year</button>
  </div>
</div>

<div class="card">
  <div class="summary-title">ç´¯è®¡è·‘é‡</div>
  <div class="summary-distance">
            <span id="total">0</span><span class="unit">km</span>
  </div>
  <div class="progress"><span id="globe"></span></div>
  <div class="progress-info">
    <span>ç¯çƒè¿›åº¦</span><span id="ppct">0%</span>
  </div>
  <div class="badges" id="badges"></div>
</div>

<div class="calendar" id="calendar"></div>
<div id="tooltip"></div>
<button id="toTop">â†‘</button>

<script>
const DATA_URL='https://run.linwn.net/data/all.json';
const totalEl=document.getElementById('total');
const globeEl=document.getElementById('globe');
const ppctEl=document.getElementById('ppct');
const badgesEl=document.getElementById('badges');
const cal=document.getElementById('calendar');
const tip=document.getElementById('tooltip');

let runs={},months={},years={};
let pb=0,pbDays=[];

fetch(DATA_URL).then(r=>r.json()).then(data=>{
  data.forEach(r=>{
    const d=r.start_date_local.split(' ')[0];
    const km=r.distance/1000;
    runs[d]=(runs[d]||0)+km;

    const m=d.slice(0,7);
    months[m]=(months[m]||0)+km;

    const y=d.slice(0,4);
    years[y]=years[y]||{};
    years[y][m]=(years[y][m]||0)+km;

    if(km>pb){pb=km;pbDays=[d]}
    else if(km===pb){pbDays.push(d)}
  });
  renderSummary();
  renderMonth();
});

function renderSummary(){
  const total=Object.values(runs).reduce((a,b)=>a+b,0);
  totalEl.textContent=total.toFixed(1);
  globeEl.style.width=Math.min(total/40075*100,100)+'%';
  ppctEl.textContent=Math.min(total/40075*100,100).toFixed(1)+'%';
  let bestMonth=Object.entries(months).sort((a,b)=>b[1]-a[1])[0];

  let streak=0,tmp=0,last=null;
  Object.keys(runs).sort().forEach(d=>{
    if(last && new Date(d)-new Date(last)===86400000) tmp++;
    else tmp=1;
    streak=Math.max(streak,tmp);
    last=d;
  });

  badgesEl.innerHTML=`
    <div class="badge">ğŸ† æœ€é•¿ ${pb.toFixed(1)} km</div>
    <div class="badge">ğŸ”¥ æœ€çŒ› ${bestMonth[0]}</div>
    <div class="badge">ğŸ“… è¿ç»­ ${streak} å¤©</div>`;
}

function level(k, v){//v==='y' means year view,else month view
  if(v==='y'){
    return k>300?9:k>250?8:k>230?7:k>210?6:k>190?5:k>150?4:k>100?3:k>50?2:k>10?1:0;
  }
  else {
    return k>40?9:k>25?8:k>20?7:k>16?6:k>12?5:k>8?4:k>5?3:k>3?2:k>0?1:0;;
  }
}
function bindTip(el,text){
  el.onmouseenter=()=>{tip.textContent=text;tip.style.opacity=1};
  el.onmousemove=e=>{tip.style.left=e.clientX+'px';tip.style.top=e.clientY+'px'};
  el.onmouseleave=()=>tip.style.opacity=0;
}

function renderMonth(){
  cal.innerHTML='';
  Object.entries(months).sort().reverse().forEach(([m,monthKm])=>{
    const [y,mo]=m.split('-');
    const days=new Date(y,mo,0).getDate();
    const firstDay=new Date(y,mo-1,1).getDay(); // Sunday=0

    const box=document.createElement('div');
    box.className='month';
    box.innerHTML=
      `<div class="title">${y}å¹´${mo}æœˆ Â· ${monthKm.toFixed(1)} km</div>
       <div class="grid"></div>`;
    const g=box.querySelector('.grid');

    for(let i=0;i<firstDay;i++){
      g.appendChild(document.createElement('div'));
    }
    for(let d=1;d<=days;d++){
      const key=`${y}-${mo}-${String(d).padStart(2,'0')}`;
      const km=runs[key]||0;
      const c=document.createElement('div');
      c.className='cell level-'+level(km, 'm');
	  c.innerHTML='<span class="label">'+d+'æ—¥</span>';
      if(pbDays.includes(key)){
        //c.innerHTML+='<span class="pb">ğŸ†</span>';
      }
      if(km){
        bindTip(c,`${key} Â· ${km.toFixed(1)} km${pbDays.includes(key)?' Â· PB':''}`);
		c.innerHTML+='<span class="distance">'+km.toFixed(1)+'</span>';
      }
      g.appendChild(c);
    }
    cal.appendChild(box);
  });
}

function renderYear(){
  cal.innerHTML='';
  Object.keys(years).sort().reverse().forEach(y=>{
    const box=document.createElement('div');
    box.className='month';
    box.innerHTML=`<div class="title">${y}</div><div class="grid"></div>`;
    const g=box.querySelector('.grid');
    Object.entries(years[y]).sort().forEach(([m,km])=>{
      const c=document.createElement('div');
      c.className='cell level-'+level(km, 'y');
	  c.innerHTML='<span class="label">'+m.slice(-2)+'æœˆ</span><span class="distance">'+km.toFixed(0)+'</span>';
      bindTip(c,`${m} Â· ${km.toFixed(1)} km`);
      g.appendChild(c);
    });
    cal.appendChild(box);
  });
}

btnMonth.onclick=()=>{
  btnMonth.classList.add('active');
  btnYear.classList.remove('active');
  renderMonth();
};
btnYear.onclick=()=>{
  btnYear.classList.add('active');
  btnMonth.classList.remove('active');
  renderYear();
};

window.onscroll=()=>{
  document.getElementById('toTop').style.display=
    window.scrollY>300?'block':'none';
};
toTop.onclick=()=>window.scrollTo({top:0,behavior:'smooth'});
</script>

</body>
</html>
