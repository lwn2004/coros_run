<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>å¥”è·‘çš„é£é“ƒæœ¨</title>

<style>
/* --- æ ¸å¿ƒå˜é‡å®šä¹‰ --- */
:root {
  --bg: #f7f9fb; --card: #ffffff; --text: #1f2328; --sub: #656d76;
  --border: #d0d7de;
  --primary: #2ea44f;
  
  /* è‰²é˜¶ */
  --l0: #ebedf0; 
  --l1: #9be9a8; --l2: #40c463; --l3: #30a14e; --l4: #216e39;
  
  --shadow: rgba(140, 149, 159, 0.2);
  --font-main: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
}

/* ä¸»é¢˜é…è‰²æ–¹æ¡ˆ (ä¿æŒä¸å˜) */
body[data-theme="orange"] { --primary: #f97316; --l0: #fff7ed; --l1: #ffddb0; --l2: #fdba74; --l3: #f97316; --l4: #c2410c; }
body[data-theme="blue"] { --primary: #3b82f6; --l0: #eff6ff; --l1: #dbeafe; --l2: #60a5fa; --l3: #2563eb; --l4: #1e40af; }
body[data-theme="purple"] { --primary: #8b5cf6; --l0: #f5f3ff; --l1: #ddd6fe; --l2: #a78bfa; --l3: #7c3aed; --l4: #5b21b6; }
body[data-theme="dark"] {
  --bg: #0d1117; --card: #161b22; --text: #e6edf3; --sub: #8b949e;
  --border: #30363d; --primary: #238636;
  --l0: #21262d; --l1: #0e4429; --l2: #006d32; --l3: #26a641; --l4: #39d353;
  --shadow: rgba(0,0,0,0.5);
}

body {
  margin: 0; padding: 20px 12px;
  font-family: var(--font-main);
  background: var(--bg); color: var(--text);
  display: flex; flex-direction: column; align-items: center;
  min-height: 100vh;
  transition: background 0.3s, color 0.3s;
}

/* --- å¸ƒå±€ç»„ä»¶ --- */
.top-bar {
  max-width: 500px; width: 100%;
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 20px; transition: max-width 0.4s ease;
}

.menu-btn {
  background: var(--card); border: 1px solid var(--border);
  width: 40px; height: 40px; border-radius: 8px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  font-size: 20px; color: var(--sub); 
}

/* èœå•æ ·å¼ (ä¿æŒä¸å˜) */
.menu-panel {
  position: fixed; top: 0; right: -320px; width: 280px; height: 100%;
  background: var(--card); z-index: 1000; padding: 30px 24px;
  box-shadow: -4px 0 25px rgba(0,0,0,0.15);
  transition: right 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  overflow-y: auto;
}
.menu-panel.open { right: 0; }
.menu-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.4); z-index: 999; display: none; backdrop-filter: blur(2px);
}
.menu-group { margin-bottom: 30px; }
.menu-group label { display: block; font-size: 13px; font-weight: 600; color: var(--sub); margin-bottom: 12px; }
.toggle-group { display: flex; background: var(--l0); padding: 4px; border-radius: 10px; gap: 4px; }
.toggle-group button { flex: 1; border: none; padding: 10px; border-radius: 8px; background: none; color: var(--sub); cursor: pointer; transition: 0.2s; }
.toggle-group button.active { background: var(--card); color: var(--primary); box-shadow: 0 2px 6px rgba(0,0,0,0.08); font-weight: 700; }
.theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
.theme-btn { border: 2px solid transparent; background: var(--l0); padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: var(--text); }
.theme-btn.active { border-color: var(--primary); background: var(--card); }
.color-dot { width: 12px; height: 12px; border-radius: 50%; }

/* --- æ¦‚è§ˆå¡ç‰‡ --- */
.card {
  max-width: 500px; width: 100%; background: var(--card); 
  border-radius: 20px; padding: 28px; margin-top: 10px; 
  text-align: center; box-shadow: 0 4px 12px var(--shadow);
  border: 1px solid var(--border);
  box-sizing: border-box; /* ç¡®ä¿å®½åº¦è®¡ç®—åŒ…å«å†…è¾¹è· */
  transition: max-width 0.4s ease;
}

.summary-distance { font-size: 48px; font-weight: 800; line-height: 1; margin: 10px 0; letter-spacing: -1px; font-variant-numeric: tabular-nums;}
.unit { font-size: 18px; font-weight: 600; color: var(--sub); margin-left: 6px; }

.progress { height: 10px; background: var(--l0); border-radius: 6px; overflow: hidden; margin-top: 20px; }
.progress span { display: block; height: 100%; background: linear-gradient(90deg, var(--l2), var(--primary)); width: 0; transition: width 1.5s ease-out; }
.progress-info { font-size: 13px; color: var(--sub); display: flex; justify-content: space-between; margin-top: 8px; font-weight: 500; }

.badges { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 24px; justify-content: center; }
.badge { 
  font-size: 12px; padding: 6px 14px; background: var(--l0); color: var(--sub); 
  border-radius: 99px; font-weight: 600; cursor: help; transition: 0.2s; 
}
.badge:hover { background: var(--l1); color: var(--l4); transform: scale(1.05); }

#pb-container { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--border); }
.toggle-pb-btn { background: none; border: none; color: var(--sub); font-size: 13px; margin-top: 16px; cursor: pointer; padding: 6px 12px; border-radius: 6px; transition: 0.2s; }
.toggle-pb-btn:hover { color: var(--primary); background: var(--l0); }

/* --- æ—¥å†éƒ¨åˆ† --- */
.calendar { 
  max-width: 500px; width: 100%; margin-top: 30px; 
  box-sizing: border-box; 
  transition: max-width 0.4s ease; 
}
.month { 
  background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 24px; 
  box-shadow: 0 2px 8px var(--shadow); border: 1px solid var(--border);
  opacity: 0; transform: translateY(30px); transition: opacity 0.6s ease, transform 0.6s ease;
}
.month.is-visible { opacity: 1; transform: translateY(0); }

.title { margin-bottom: 18px; }
.title .main-info { display: flex; justify-content: space-between; font-size: 18px; font-weight: 800; }
.title .sub-info { display: flex; gap: 16px; color: var(--sub); font-size: 13px; margin-top: 4px; font-weight: 500; flex-wrap: wrap; }

.grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }

/* æ ¼å­æ ¸å¿ƒæ ·å¼ */
.cell { 
  aspect-ratio: 1; border-radius: 6px; position: relative; 
  background: var(--l0); cursor: default;
  transform-style: preserve-3d; perspective: 1000px;
}
.cell .content-layer {
  position: absolute; width: 100%; height: 100%;
  display: flex; flex-direction: column; justify-content: space-between;
  padding: 4px; box-sizing: border-box;
  transition: opacity 0.3s ease, transform 0.3s ease;
  backface-visibility: hidden; border-radius: 6px;
}

/* é¢œè‰²ç­‰çº§ */
.level-0 { background: var(--l0); }
.level-1 { background: var(--l1); }
.level-2 { background: var(--l2); }
.level-3 { background: var(--l3); }
.level-4 { background: var(--l4); }

/* æ­£é¢æ ·å¼ */
.cell .front { opacity: 1; transform: rotateX(0deg); z-index: 2; }
.cell .label { font-size: 10px; color: var(--sub); font-weight: 600; }
/* è·ç¦»æ•°å­—æ ·å¼ä¼˜åŒ– */
.cell .distance { 
  align-self: center; margin-top: auto; margin-bottom: auto;
  font-size: 15px; font-weight: 800; color: rgba(255,255,255,0.95); 
  display: flex; align-items: baseline; justify-content: center;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
/* å°å·å•ä½ */
.cell .unit-sm { font-size: 10px; font-weight: 500; margin-left: 2px; opacity: 0.9; }

/* èƒŒé¢è¯¦ç»†ä¿¡æ¯ (é»˜è®¤éšè—) */
.cell .back { 
  opacity: 0; background: var(--card); border: 2px solid var(--primary);
  align-items: center; justify-content: center; z-index: 1; pointer-events: none;
}
.level-0 .distance { display: none; }

/* æŸ±çŠ¶å›¾ */
.bar-view { display: flex; align-items: flex-end; gap: 4px; height: 140px; padding-top: 20px; border-bottom: 1px solid var(--l0); }
.bar-item { flex: 1; /*background: var(--l2);*/ border-radius: 4px 4px 0 0; position: relative; min-height: 4px; }
.bar-item .label { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%) scale(0.8); font-size: 10px; color: var(--sub); }

/* Tooltip */
#tooltip {
  position: fixed; background: rgba(0,0,0,0.85); color: #fff; 
  padding: 8px 12px; border-radius: 8px; font-size: 12px;
  pointer-events: none; opacity: 0; z-index: 9999; 
  transition: opacity 0.15s; white-space: nowrap; backdrop-filter: blur(4px);
}
.tip-row { display: flex; gap: 12px; align-items: center; }

/* --- æ¡Œé¢ç«¯å“åº”å¼ä¼˜åŒ– --- */
@media (min-width: 900px) {
  /* å®½åº¦æ”¾å®½ä¸”ä¿æŒä¸€è‡´ */
  .top-bar, .card, .calendar { max-width: 1000px; }
  
  /* æ ¼å­äº¤äº’ */
  .grid { gap: 10px; }
  .cell { aspect-ratio: 1.25; transition: transform 0.2s; }
  .cell:hover { z-index: 10; transform: scale(1.05); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
  
  /* ç¿»è½¬åŠ¨ç”» */
  .cell.has-run:hover .front { opacity: 0; transform: scale(0.9); }
  .cell.has-run:hover .back { opacity: 1; pointer-events: auto; }

  /* å­—ä½“æ”¾å¤§ */
  .cell .distance { font-size: 26px; letter-spacing: -1px; }
  .cell .unit-sm { font-size: 12px; }

  /* èƒŒé¢è¯¦ç»†ä¿¡æ¯æ’ç‰ˆ */
  .cell .back { display: flex; flex-direction: column; justify-content: center; padding: 4px; }
  .detail-group { text-align: center; line-height: 1.3; width: 100%; }
  .detail-dist { font-size: 22px; font-weight: 900; color: var(--primary); display: block; }
  .detail-meta { font-size: 11px; color: var(--sub); font-weight: 600; display: block; margin-top: 2px;}
  .detail-row { display: flex; gap: 8px; justify-content: center; margin-top: 6px; font-size: 12px; font-weight: 700; color: var(--text); }
  
  /* æ³¨æ„ï¼šä¸å†éšè— tooltipï¼Œè€Œæ˜¯é€šè¿‡ JS æ§åˆ¶ä¸ç»‘å®šç»™æ ¼å­ */
}

/* åŠ¨ç”» */
@keyframes cellAppear { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
.month.is-visible .cell, .month.is-visible .bar-item { animation: cellAppear 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

#toTop { position: fixed; right: 30px; bottom: 30px; background: var(--primary); color: #fff; border: none; width: 50px; height: 50px; border-radius: 50%; display: none; cursor: pointer; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 20px; }
#loading-sentinel { height: 40px; margin-bottom: 40px;}
</style>
</head>

<body>

<div class="top-bar">
  <div style="display:flex; flex-direction:column;">
    <strong style="font-size: 22px; letter-spacing: -0.5px;">å¥”è·‘çš„<span style="color: var(--primary)">é£é“ƒæœ¨</></strong>
    <span style="font-size: 12px; color: var(--sub); font-weight: 500;">æ¯ä¸€æ¬¡å¥”è·‘éƒ½æ˜¯ä¸è‡ªå·±çš„å¯¹è¯</span>
  </div>
  <button class="menu-btn" id="openMenu">â˜°</button>
</div>

<div class="menu-overlay" id="overlay"></div>
<div class="menu-panel" id="menu">
  <h3 style="margin-top:0; margin-bottom:20px; font-size:18px;">è®¾ç½®</h3>
  <div class="menu-group">
    <label>ä¸»é¢˜é£æ ¼</label>
    <div class="theme-grid">
      <button class="theme-btn active" data-val="green"><span class="color-dot" style="background:#2ea44f"></span>ç»¿èŠ±é£é“ƒæœ¨</button>
      <button class="theme-btn" data-val="orange"><span class="color-dot" style="background:#f97316"></span>æ©™èŠ±é£é“ƒæœ¨</button>
      <button class="theme-btn" data-val="blue"><span class="color-dot" style="background:#3b82f6"></span>è“èŠ±é£é“ƒæœ¨</button>
      <button class="theme-btn" data-val="purple"><span class="color-dot" style="background:#8b5cf6"></span>ç´«èŠ±é£é“ƒæœ¨</button>
      <button class="theme-btn" data-val="dark"><span class="color-dot" style="background:#21262d"></span>é»‘èŠ±é£é“ƒæœ¨</button>
    </div>
  </div>
  <div class="menu-group"><label>æ—¶é—´ç»´åº¦</label><div class="toggle-group"><button id="btnMonth" class="active">æœˆè§†å›¾</button><button id="btnYear">å¹´è§†å›¾</button></div></div>
  <div class="menu-group"><label>å±•ç¤ºæ¨¡å¼</label><div class="toggle-group"><button id="btnGrid" class="active">æ—¥å†æ ¼</button><button id="btnBar">è¶‹åŠ¿æŸ±</button></div></div>
</div>

<div class="card">
  <div class="summary-distance"><span id="total">0.0</span><span class="unit">km</span></div>
  <div class="progress"><span id="globe"></span></div>
  <div class="progress-info"><span>ç¯çƒèµ¤é“è¿›åº¦</span><span id="ppct">0%</span></div>
  <div class="badges" id="badges"></div>
  <div class="badges" id="pb-container"></div>
  <button class="toggle-pb-btn" id="togglePb">å±•å¼€ä¸ªäººçºªå½• (PB) â†“</button>
</div>

<div class="calendar" id="calendar"></div>
<div id="loading-sentinel"></div>
<div id="tooltip"></div>
<button id="toTop">â†‘</button>

<script>
// --- é…ç½®åŒº ---
const DATA_URL = 'https://run.linwn.net/data/all.json'; 
const PB_URL = 'https://run.linwn.net/data/pb.json';   
const BATCH_SIZE = 6;

// --- çŠ¶æ€ç®¡ç† ---
let appState = {
  runsRaw: {}, monthKeys: [], years: {}, months: {},
  stats: { totalKm: 0, pb: { val: 0, date: '-' }, fastest: { paceVal: 9999, paceStr: '--', date: '-' }, bestMonth: { name: '-', val: 0 }, streak: { count: 0, start: '-', end: '-' } },
  view: { cursor: 0, type: 'month', mode: 'grid' },
  theme: 'green'
};

function loadSettings() {
  const saved = localStorage.getItem('run_journey_settings');
  if (saved) {
    const p = JSON.parse(saved);
    if(p.theme) switchTheme(p.theme);
    if(p.type) { appState.view.type = p.type; updateToggleState('btnMonth', p.type === 'month'); updateToggleState('btnYear', p.type === 'year'); }
    if(p.mode) { appState.view.mode = p.mode; updateToggleState('btnGrid', p.mode === 'grid'); updateToggleState('btnBar', p.mode === 'bar'); }
  }
}
function saveSettings() {
  localStorage.setItem('run_journey_settings', JSON.stringify({ theme: appState.theme, type: appState.view.type, mode: appState.view.mode }));
}

// --- æ ¸å¿ƒå·¥å…· ---
const parseDuration = t => {
    if (typeof t === 'number') return t;
    const parts = (t || "0:0:0").split(':').map(Number);
    return parts.length === 3 ? parts[0]*3600 + parts[1]*60 + parts[2] : parts[0]*60 + parts[1];
};
const formatTime = s => {
    s = Math.round(s);
    const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sec = s % 60;
    return h > 0 ? `${h}:${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}` : `${m}:${String(sec).padStart(2, '0')}`;
};
const formatPace = (s, km) => {
    if (!s || !km) return '--';
    const p = s / km, m = Math.floor(p / 60), sec = Math.floor(p % 60);
    return `${m}'${String(sec).padStart(2, '0')}"`;
};
const getLevel = (k, mode) => {
    if (k <= 0) return 0;
    const levels = mode === 'y' ? [100, 150, 200, 300] : [3, 7, 12, 21];
    for (let i = levels.length - 1; i >= 0; i--) if (k >= levels[i]) return i + 1;
    return 1;
};

// --- æ•°æ®å¤„ç† ---
function processData(data) {
   data.forEach(r => {
       const fullDate = (r.start_date_local || r.start_date).split(' ')[0];
       const startTime = (r.start_date_local || r.start_date).split(' ')[1]?.slice(0,5) || "--:--";
       const km = Number(r.distance || 0) / 1000;
       const movingTime = parseDuration(r.moving_time);
       const paceVal = movingTime / km;

       if (!appState.runsRaw[fullDate]) appState.runsRaw[fullDate] = { totalKm: 0, runs: [], mainRun: null };
       appState.runsRaw[fullDate].totalKm += km;
       appState.runsRaw[fullDate].runs.push(r);
       
       if (!appState.runsRaw[fullDate].mainRun || km > appState.runsRaw[fullDate].mainRun.dist) {
          appState.runsRaw[fullDate].mainRun = { dist: km, time: movingTime, pace: paceVal, start: startTime, hr: r.average_heartrate };
       }

       const mKey = fullDate.slice(0, 7), yKey = fullDate.slice(0, 4);
       if (!appState.months[mKey]) appState.months[mKey] = { km: 0, time: 0, hrSum: 0, hrCount: 0, dailyMax: 0 };
       appState.months[mKey].km += km;
       appState.months[mKey].time += movingTime;
       appState.months[mKey].dailyMax = Math.max(appState.months[mKey].dailyMax, appState.runsRaw[fullDate].totalKm);
       if (r.average_heartrate) { appState.months[mKey].hrSum += r.average_heartrate; appState.months[mKey].hrCount++; }

       if (!appState.years[yKey]) appState.years[yKey] = { total: 0, months: {}, maxMonth: 0 };
       appState.years[yKey].months[mKey] = (appState.years[yKey].months[mKey] || 0) + km;
       appState.years[yKey].total += km;
       appState.years[yKey].maxMonth = Math.max(appState.years[yKey].maxMonth, appState.years[yKey].months[mKey]);
       
       appState.stats.totalKm += km;
       if (km > appState.stats.pb.val) appState.stats.pb = { val: km, date: fullDate };
       if (paceVal < appState.stats.fastest.paceVal && km > 1) {
           appState.stats.fastest = { paceVal, paceStr: formatPace(movingTime, km), date: fullDate };
       }
   });

   appState.monthKeys = Array.from(new Set(Object.keys(appState.runsRaw).map(d => d.slice(0, 7)))).sort().reverse();
   
   // è®¡ç®— Streak (ç•¥å¾®ç®€åŒ–é€»è¾‘)
   const dates = Object.keys(appState.runsRaw).sort();
   let max = 0, cur = 0, start = '', end = '', tempStart = '';
   for(let i=0; i<dates.length; i++) {
     if(i>0 && (new Date(dates[i]) - new Date(dates[i-1]))/86400000 === 1) {
       cur++; 
     } else {
       if(cur > max) { max = cur; start = tempStart; end = dates[i-1]; }
       cur = 1; tempStart = dates[i];
     }
   }
   if(cur > max) { max = cur; start = tempStart; end = dates[dates.length-1]; }
   if(max > 0) appState.stats.streak = { count: max, start, end };
   
   const topMonth = Object.entries(appState.months).sort((a,b)=>b[1].km - a[1].km)[0];
   if (topMonth) appState.stats.bestMonth = { name: topMonth[0], val: topMonth[1].km };
}

// --- æ¸²æŸ“å‡½æ•° ---
function renderOneMonth(mKey) {
   const [y, mo] = mKey.split('-');
   const mData = appState.months[mKey];
   const daysInMonth = new Date(y, mo, 0).getDate();
   const avgPace = formatPace(mData.time, mData.km);
   const avgHr = mData.hrCount ? Math.round(mData.hrSum / mData.hrCount) + ' bpm' : '--';
   
   const box = document.createElement('div');
   box.className = 'month';
   box.innerHTML = `
       <div class="title">
           <div class="main-info"><span>${y}å¹´${mo}æœˆ</span><span>${mData.km.toFixed(1)} km</span></div>
           <div class="sub-info">
             <span>ğŸƒ Avg. ${avgPace}</span>
             <span>ğŸ’“ Avg. ${avgHr}</span>
             <span>ğŸ“… ${Object.keys(appState.runsRaw).filter(k=>k.startsWith(mKey)).length} Days</span>
           </div>
       </div>
       <div class="${appState.view.mode === 'grid' ? 'grid' : 'bar-view'}"></div>`;
   
   const container = box.querySelector(appState.view.mode === 'grid' ? '.grid' : '.bar-view');
   if (appState.view.mode === 'grid') {
       const firstDay = new Date(y, mo - 1, 1).getDay();
       for (let i = 0; i < firstDay; i++) container.appendChild(document.createElement('div'));
   }

   for (let d = 1; d <= daysInMonth; d++) {
       const dateKey = `${y}-${mo}-${String(d).padStart(2, '0')}`;
       const dayInfo = appState.runsRaw[dateKey];
       const km = dayInfo ? dayInfo.totalKm : 0;
       const el = document.createElement('div');
       const levelClass = `level-${getLevel(km, 'm')}`;
       
       if (appState.view.mode === 'grid') {
           el.className = `cell ${levelClass} ${km > 0 ? 'has-run' : ''}`;
           // Front Layer: å¢åŠ  unit-sm
           let frontHtml = `<div class="content-layer front"><span class="label">${d}</span>`;
           if (km > 0) frontHtml += `<span class="distance">${km.toFixed(1)}<span class="unit-sm">km</span></span>`;
           frontHtml += `</div>`;

           // Back Layer: ä¿æŒè¯¦ç»†ä¿¡æ¯
           let backHtml = '';
           if (km > 0 && dayInfo.mainRun) {
             const mr = dayInfo.mainRun;
             backHtml = `
              <div class="content-layer back">
                <div class="detail-group">
                  <span class="detail-meta">${parseInt(mo)}æœˆ${d}æ—¥ ${mr.start}</span>
                  <span class="detail-dist">${mr.dist.toFixed(2)}<span class="unit-sm">km</span></span>
                  <div class="detail-row">
                    <span>âš¡ ${formatPace(mr.time, mr.dist)}</span>
                    <span>ğŸ’“ ${mr.hr ? Math.round(mr.hr) : '-'}</span>
                  </div>
                  <div class="detail-row" style="color:var(--sub); font-size:10px;">â± ${formatTime(mr.time)}</div>
                </div>
              </div>`;
           } else {
             backHtml = `<div class="content-layer back"></div>`;
           }
           el.innerHTML = frontHtml + backHtml;
       } else {
           el.className = `bar-item ${levelClass}`;
           const h = km > 0 ? Math.max((km / mData.dailyMax) * 100, 5) : 0;
           el.style.height = h + '%';
           if (d === 1 || d === daysInMonth || d % 5 === 0) el.innerHTML = `<span class="label">${d}</span>`;
       }
       
       el.style.animationDelay = `${d * 0.01}s`;
       
       // å…³é”®ä¿®æ”¹ï¼šåªæœ‰ç§»åŠ¨ç«¯ æˆ–è€… éGridæ¨¡å¼ æ‰ç»‘å®šTooltipåˆ°Cell
       // æ¡Œé¢ç«¯ Grid æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨ CSS Flip æ•ˆæœï¼Œä¸ä½¿ç”¨Tooltip
       const isDesktop = window.innerWidth >= 900;
       if (km > 0) {
           if (!isDesktop || appState.view.mode !== 'grid') {
               bindTip(el, () => buildDayTooltip(dateKey, dayInfo));
           }
       }
       container.appendChild(el);
   }
   document.getElementById('calendar').appendChild(box);
   revealObserver.observe(box);
}

function renderYearView() {
   const cal = document.getElementById('calendar');
   cal.innerHTML = '';
   Object.keys(appState.years).sort().reverse().forEach(y => {
       const yData = appState.years[y];
       const box = document.createElement('div');
       box.className = 'month';
       box.innerHTML = `<div class="title"><div class="main-info"><span>${y}å¹´</span><span>${yData.total.toFixed(0)} km</span></div></div>
                        <div class="${appState.view.mode === 'grid' ? 'grid' : 'bar-view'}"></div>`;
       const container = box.querySelector(appState.view.mode === 'grid' ? '.grid' : '.bar-view');
       container.style.gridTemplateColumns = 'repeat(6, 1fr)'; 

       Object.entries(yData.months).sort().forEach(([mKey, km], idx) => {
           const el = document.createElement('div');
           const mNum = parseInt(mKey.split('-')[1]);
           const levelClass = `level-${getLevel(km, 'y')}`;
           if (appState.view.mode === 'grid') {
               el.className = `cell ${levelClass}`;
               el.style.aspectRatio = '1.5';
               el.innerHTML = `<div class="content-layer front"><span class="label">${mNum}æœˆ</span><span class="distance" style="font-size:18px">${km.toFixed(0)}</span></div>`;
           } else {
               el.className = `bar-item ${levelClass}`;
               el.style.height = (km / yData.maxMonth * 100) + '%';
               el.innerHTML = `<span class="label">${mNum}æœˆ</span>`;
           }
           el.style.animationDelay = `${idx * 0.05}s`;
           bindTip(el, `<strong>${mKey}</strong><br>è·‘é‡: ${km.toFixed(1)} km`);
           container.appendChild(el);
       });
       cal.appendChild(box);
       revealObserver.observe(box);
   });
}

// --- äº¤äº’ä¸é€»è¾‘ ---
const revealObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            entry.target.classList.add('is-visible');
            revealObserver.unobserve(entry.target);
        }
    });
}, { threshold: 0.05 });

function animateValue(obj, start, end, duration, suffix) {
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        const ease = 1 - Math.pow(1 - progress, 4);
        obj.innerHTML = (start + (end - start) * ease).toFixed(1) + suffix;
        if (progress < 1) window.requestAnimationFrame(step);
    };
    window.requestAnimationFrame(step);
}

function bindTip(el, content) {
    const tip = document.getElementById('tooltip');
    el.onmouseenter = () => { 
        // ç§»é™¤äº†ä¹‹å‰çš„ windowå®½åº¦åˆ¤æ–­ï¼Œç°åœ¨æ‰€æœ‰ç»‘å®šçš„å…ƒç´ éƒ½ä¼šæ˜¾ç¤ºtooltip
        const html = typeof content === 'function' ? content() : content;
        if(!html) return;
        tip.innerHTML = html; tip.style.opacity = 1; 
    };
    el.onmousemove = e => { 
        tip.style.left = Math.min(e.clientX + 15, window.innerWidth - 200) + 'px'; 
        tip.style.top = (e.clientY + 15) + 'px'; 
    };
    el.onmouseleave = () => tip.style.opacity = 0;
}

function buildDayTooltip(date, dayData) {
    return dayData.runs.map((r, idx) => {
        const dist = (r.distance / 1000).toFixed(2);
        const sec = parseDuration(r.moving_time);
        return `${idx === 0 ? `<div style="font-weight:700;margin-bottom:4px;border-bottom:1px solid rgba(255,255,255,0.2)">${date}</div>` : `<div style="margin:4px 0;border-top:1px dashed rgba(255,255,255,0.2)"></div>`}
            <div class="tip-row"><span>ğŸƒ ${dist} km</span> <span style="color:#dcdcdc">${formatPace(sec, dist)}</span></div>`;
    }).join('');
}

function renderPBs(pbData) {
   const pbContainer = document.getElementById('pb-container');
   const pbMap = { 7: "1km", 6: "3km", 5: "5km", 4: "10km", 2: "åŠé©¬", 1: "å…¨é©¬" };
   const targetTypes = [7, 6, 5, 4, 2, 1];
   const filtered = pbData.filter(item => targetTypes.includes(item.type)).sort((a, b) => targetTypes.indexOf(a.type) - targetTypes.indexOf(b.type));
   filtered.forEach((item, idx) => {
       const b = document.createElement('div');
       b.className = 'badge';
       b.textContent = `${pbMap[item.type]} ${formatTime(item.record)}`;
       b.style.animation = `cellAppear 0.5s ease-out both ${idx * 0.1}s`;
       const dateStr = item.happenDay.toString();
       const formattedDate = `${dateStr.slice(0, 4)}-${dateStr.slice(4, 6)}-${dateStr.slice(6, 8)}`;
       bindTip(b, `<strong>${pbMap[item.type]} PB</strong><br>æ—¶é—´ï¼š${formatTime(item.record)}<br>é…é€Ÿï¼š${formatPace(item.record, item.distance / 1000)}<br>æ—¥æœŸï¼š${formattedDate}`);
       pbContainer.appendChild(b);
   });
}

function renderSummary() {
   animateValue(document.getElementById('total'), 0, appState.stats.totalKm, 1500, '');
   const earth = 40075, pct = Math.min(appState.stats.totalKm / earth * 100, 100);
   animateValue(document.getElementById('ppct'), 0, pct, 1500, '%');
   setTimeout(() => document.getElementById('globe').style.width = pct + '%', 100);

   const bEl = document.getElementById('badges');
   bEl.innerHTML = '';
   const items = [
       { label: `ğŸ† æœ€è¿œ ${appState.stats.pb.val.toFixed(1)} km`, tip: `${appState.stats.pb.date}` },
       { label: `âš¡ æœ€å¿« ${appState.stats.fastest.paceStr}`, tip: `${appState.stats.fastest.date}` },
       { label: `ğŸ”¥ æœ€ä½³ ${appState.stats.bestMonth.name}`, tip: `${appState.stats.bestMonth.val.toFixed(1)} km` },
       { label: `ğŸ“… è¿ç»­ ${appState.stats.streak.count} å¤©`, tip: `${appState.stats.streak.start} ~ ${appState.stats.streak.end}` }
   ];
   items.forEach(item => {
       const b = document.createElement('div');
       b.className = 'badge'; b.textContent = item.label;
       bindTip(b, `<div style="padding:4px">${item.tip}</div>`);
       bEl.appendChild(b);
   });
}

// --- åˆå§‹åŒ–ä¸äº‹ä»¶ ---
const menu = document.getElementById('menu');
const overlay = document.getElementById('overlay');
const toggleMenu = (show) => { menu.classList.toggle('open', show); overlay.style.display = show ? 'block' : 'none'; };
document.getElementById('openMenu').onclick = () => toggleMenu(true);
overlay.onclick = () => toggleMenu(false);

function refresh() {
    document.getElementById('calendar').innerHTML = '';
    appState.view.cursor = 0;
    appState.view.type === 'month' ? renderNextBatch() : renderYearView();
    saveSettings(); 
}

function updateToggleState(id, isActive) {
  const btn = document.getElementById(id);
  if(isActive) {
     Array.from(btn.parentElement.children).forEach(b => b.classList.remove('active'));
     btn.classList.add('active');
  }
}
function switchTheme(themeVal) {
    appState.theme = themeVal;
    document.body.setAttribute('data-theme', themeVal);
    document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.val === themeVal));
    saveSettings();
}

document.getElementById('btnMonth').onclick = function() { appState.view.type = 'month'; updateToggleState(this.id, true); refresh(); };
document.getElementById('btnYear').onclick = function() { appState.view.type = 'year'; updateToggleState(this.id, true); refresh(); };
document.getElementById('btnGrid').onclick = function() { appState.view.mode = 'grid'; updateToggleState(this.id, true); refresh(); };
document.getElementById('btnBar').onclick = function() { appState.view.mode = 'bar'; updateToggleState(this.id, true); refresh(); };
document.querySelectorAll('.theme-btn').forEach(btn => btn.onclick = () => switchTheme(btn.dataset.val));

document.getElementById('togglePb').onclick = function() {
  const container = document.getElementById('pb-container');
  const isHidden = getComputedStyle(container).display === 'none';
  container.style.display = isHidden ? 'flex' : 'none';
  this.textContent = isHidden ? 'æ”¶èµ·ä¸ªäººçºªå½• (PB) â†‘' : 'å±•å¼€ä¸ªäººçºªå½• (PB) â†“';
};

function renderNextBatch() {
   if (appState.view.type !== 'month' || appState.view.cursor >= appState.monthKeys.length) return;
   const batch = appState.monthKeys.slice(appState.view.cursor, appState.view.cursor + BATCH_SIZE);
   batch.forEach(m => renderOneMonth(m));
   appState.view.cursor += BATCH_SIZE;
}

const observer = new IntersectionObserver(e => { if(e[0].isIntersecting) renderNextBatch(); }, { rootMargin: '200px' });
observer.observe(document.getElementById('loading-sentinel'));

window.onscroll = () => document.getElementById('toTop').style.display = window.scrollY > 500 ? 'block' : 'none';
document.getElementById('toTop').onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });

loadSettings(); 
Promise.all([
   fetch(DATA_URL).then(r => r.json()),
   fetch(PB_URL).then(r => r.json())
]).then(([allData, pbData]) => {
   processData(allData);
   renderSummary();
   renderPBs(pbData);
   refresh(); 
});
</script>
</body>
</html>
