<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Running Journey - Pro</title>

<style>
:root{
  --bg:#f7f9fb;--card:#fff;--text:#111;--sub:#666;
  --primary:#2ea44f;
  --l0:#ebedf0;--l1:#d6f5df;--l2:#b7ebc6;--l3:#8fdfa8;
  --l4:#6cd18a;--l5:#4fc26b;--l6:#36ab56;
  --l7:#2e8f47;--l8:#246b37;--l9:#164b26;
  --tip-bg: rgba(0,0,0,0.85);
}
@media(prefers-color-scheme:dark){
  :root{--bg:#0d1117;--card:#161b22;--text:#e6edf3;--sub:#8b949e;--l0:#21262d;--tip-bg: rgba(255,255,255,0.95);}
}

body{
  margin:0;padding:20px 12px;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  background:var(--bg);color:var(--text);
  display:flex;flex-direction:column;align-items:center;
  min-height: 100vh;
}

.top-bar{
  max-width:500px;width:100%;
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom: 10px;
}
.toggle button{
  padding:6px 12px;border-radius:999px;
  border:1px solid var(--l0);
  background:none;color:var(--sub);cursor:pointer;
  font-size: 14px;
  transition: all 0.2s;
}
.toggle .active{background:var(--primary);color:#fff;border-color:var(--primary)}

.card{
  max-width:500px;width:100%;
  background:var(--card);
  border-radius:16px;
  padding:24px;
  margin-top:10px;
  box-sizing: border-box;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}

.summary-title { font-size: 14px; color: var(--sub); text-transform: uppercase; letter-spacing: 1px;}
.summary-distance { font-size: 42px; font-weight: 800; line-height: 1.1; margin: 8px 0; font-variant-numeric: tabular-nums;}
.unit { font-size: 16px; font-weight: 600; color: var(--sub); margin-left: 4px; }

.progress{height:8px;background:var(--l0);border-radius:4px;margin-top:12px;overflow: hidden;}
.progress span{
    display:block; height:100%; background:linear-gradient(90deg, #40c463, #2ea44f); border-radius:4px;
    width: 0; transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1);
}
.progress-info{font-size:12px;color:var(--sub);display:flex;justify-content:space-between;margin-top:6px;font-variant-numeric: tabular-nums;}

.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:16px;justify-content: center;}
.badge{
  font-size:12px;padding:4px 10px;
  background:var(--l1); color:var(--l9);
  border-radius:99px; font-weight: 500; cursor: help;
}

.calendar{max-width:500px;width:100%;margin-top:20px;}
.month{
  background:var(--card);
  border-radius:14px;
  padding:16px;margin-bottom:16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.03);
}

.title{font-weight:700;margin-bottom:12px; font-size: 14px; display: flex; flex-direction: column; gap: 4px;}
.title .main-info { display: flex; justify-content: space-between; font-size: 16px;}
.title .sub-info { display: flex; gap: 12px; color: var(--sub); font-weight: normal; font-size: 12px; align-self: flex-end; text-align: right;}

.grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }

/* 2. æ”¹è¿›ï¼šæ ¼å­é€æ¸æ˜æ˜¾çš„åŠ¨ç”» */
@keyframes cellAppear {
  from { opacity: 0; transform: translateY(8px) scale(0.9); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.cell{
  aspect-ratio:1; border-radius:4px;
  background:var(--l0); position:relative;
  display: flex; flex-direction: column; justify-content: center; align-items: center;
  transition: transform 0.1s;
  opacity: 0; /* åˆå§‹é€æ˜ */
  animation: cellAppear 0.5s ease-out forwards;
}
.cell:hover { transform: scale(1.05); z-index: 2; border: 1px solid rgba(0,0,0,0.1); }
.cell .label{ font-size: 11px; color: var(--sub); position: absolute; top: 2px; left: 4px; transform: scale(0.8); transform-origin: top left;}
.cell .distance{ font-size: 14px; font-weight: 700; color: #fff; z-index: 2;}

/* é¢œè‰²ç­‰çº§æ ·å¼ä¿æŒä¸å˜ï¼Œä½†å¢åŠ ä½é€æ˜åº¦ä¸‹çš„æ–‡å­—æ¸…æ™°åº¦ */
.level-0{background:var(--l0); color: var(--sub) !important;}
.level-1{background:var(--l1); .distance{color:var(--l8)}}
.level-2{background:var(--l2); .distance{color:var(--l9)}}
.level-3{background:var(--l3); .distance{color:var(--l9)}}
.level-4{background:var(--l4)} .level-5{background:var(--l5)}
.level-6{background:var(--l6)} .level-7{background:var(--l7)}
.level-8{background:var(--l8)} .level-9{background:var(--l9)}

#tooltip{
  position:fixed; background:var(--tip-bg); color:#fff;
  padding:10px 14px; border-radius:8px; font-size:12px;
  pointer-events:none; opacity:0; z-index:9999;
  transition: opacity 0.15s; white-space: nowrap;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2); line-height: 1.6; backdrop-filter: blur(4px);
}
@media (prefers-color-scheme:dark){ #tooltip { color: #000; } }

.tip-row { display: flex; gap: 12px; justify-content: space-between; align-items: center; }
.tip-header { border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:4px; margin-bottom: 4px; font-weight: 600; display: flex; justify-content: space-between;}

#toTop{
  position:fixed; right:20px; bottom:30px;
  background:var(--primary); color:#fff; border:none;
  width: 44px; height: 44px; border-radius:50%;
  cursor:pointer; display:none;
  font-size: 20px; box-shadow: 0 4px 12px rgba(46,164,79,0.4); z-index: 100;
}

#loading-sentinel { height: 20px; margin-top: 10px; }

@media (max-width: 480px) {
  .summary-distance { font-size: 36px; }
  .grid { gap: 4px; }
  .cell .distance { font-size: 11px; }
}
</style>
</head>

<body>

<div class="top-bar">
  <strong>Running Journey</strong>
  <div class="toggle">
    <button id="btnMonth" class="active">Month</button>
    <button id="btnYear">Year</button>
  </div>
</div>

<div class="card">
  <div class="summary-title">ç´¯è®¡è·‘é‡</div>
  <div class="summary-distance">
    <span id="total">0.0</span><span class="unit">km</span>
  </div>
  <div class="progress"><span id="globe"></span></div>
  <div class="progress-info">
    <span>ç¯çƒè¿›åº¦</span><span id="ppct">0%</span>
  </div>
  <div class="badges" id="badges"></div>
</div>

<div class="calendar" id="calendar"></div>
<div id="loading-sentinel"></div>
<div id="tooltip"></div>
<button id="toTop">â†‘</button>

<script>
/**
 * é…ç½®ä¸å¸¸é‡
 */
const DATA_URL = '/data/all.json';
const BATCH_SIZE = 8;

// DOM å¼•ç”¨
const totalEl = document.getElementById('total');
const globeEl = document.getElementById('globe');
const ppctEl = document.getElementById('ppct');
const badgesEl = document.getElementById('badges');
const cal = document.getElementById('calendar');
const tip = document.getElementById('tooltip');
const sentinel = document.getElementById('loading-sentinel');

let runsRaw = {}, monthKeys = [], years = {}, months = {};
let stats = {
    totalKm: 0,
    pb: { val: 0, date: '-' },
    fastest: { paceVal: 9999, paceStr: '--', date: '-' },
    bestMonth: { name: '-', val: 0 },
    streak: { count: 0, start: '-', end: '-' }
};
let renderCursor = 0;
let currentView = 'month';
let observer = null;

/**
 * è¾…åŠ©å·¥å…·å‡½æ•°
 */
const parseDuration = t => {
    if (typeof t === 'number') return t;
    if (!t || typeof t !== 'string') return 0;
    const parts = t.split(':').map(Number);
    if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
    if (parts.length === 2) return parts[0] * 60 + parts[1];
    return 0;
};

const formatTime = s => {
    s = Math.round(Number(s));
    if (!s || isNaN(s)) return '--:--';
    const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sec = s % 60;
    return h > 0 ? `${h}:${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}` : `${m}:${String(sec).padStart(2, '0')}`;
};

const formatPace = (s, km) => {
    if (!s || !km || km === 0) return '--';
    const p = s / km, m = Math.floor(p / 60), sec = Math.floor(p % 60);
    return `${m}'${String(sec).padStart(2, '0')}"`;
};

function animateValue(obj, start, end, duration, suffix) {
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        const ease = 1 - Math.pow(1 - progress, 4);
        obj.innerHTML = (start + (end - start) * ease).toFixed(1) + suffix;
        if (progress < 1) window.requestAnimationFrame(step);
    };
    window.requestAnimationFrame(step);
}

function bindTip(el, contentProvider) {
    el.onmouseenter = () => {
        tip.innerHTML = typeof contentProvider === 'function' ? contentProvider() : contentProvider;
        tip.style.opacity = 1;
    };
    el.onmousemove = e => {
        const x = e.clientX + 15, y = e.clientY + 15;
        tip.style.left = Math.min(x, window.innerWidth - 220) + 'px';
        tip.style.top = y + 'px';
    };
    el.onmouseleave = () => tip.style.opacity = 0;
}

/**
 * 1. æ”¹è¿›ï¼šæ•°æ®å¤„ç†åŠ å…¥æœˆå‡é…é€Ÿå’Œå¿ƒç‡ç»Ÿè®¡
 */
function processData(data) {
    data.forEach(r => {
        const fullDate = (r.start_date_local || r.start_date).split(' ')[0];
        const km = Number(r.distance || 0) / 1000;
        const movingTime = parseDuration(r.moving_time);
        const paceVal = movingTime / km;

        if (!runsRaw[fullDate]) runsRaw[fullDate] = { totalKm: 0, runs: [] };
        runsRaw[fullDate].totalKm += km;
        runsRaw[fullDate].runs.push(r);

        const mKey = fullDate.slice(0, 7), yKey = fullDate.slice(0, 4);
        
        // æ‰©å±•æœˆä»½ç»Ÿè®¡æ•°æ®ç»“æ„
        if (!months[mKey]) months[mKey] = { km: 0, time: 0, hrSum: 0, hrCount: 0 };
        months[mKey].km += km;
        months[mKey].time += movingTime;
        if (r.average_heartrate) {
            months[mKey].hrSum += r.average_heartrate;
            months[mKey].hrCount++;
        }

        years[yKey] = years[yKey] || {};
        years[yKey][mKey] = (years[yKey][mKey] || 0) + km;
        stats.totalKm += km;

        if (km > stats.pb.val) stats.pb = { val: km, date: fullDate };
        if (paceVal < stats.fastest.paceVal && km > 1) {
            stats.fastest = { paceVal, paceStr: formatPace(movingTime, km), date: fullDate };
        }
    });

    const topMonth = Object.entries(months).sort((a, b) => b[1].km - a[1].km)[0];
    if (topMonth) stats.bestMonth = { name: topMonth[0], val: topMonth[1].km };

    const sortedDates = Object.keys(runsRaw).sort();
    let maxStreak = [], currentStreak = [];
    sortedDates.forEach((d, i) => {
        if (i > 0) {
            const diff = (new Date(d) - new Date(sortedDates[i - 1])) / 86400000;
            if (diff === 1) { currentStreak.push(d); } 
            else {
                if (currentStreak.length > maxStreak.length) maxStreak = [...currentStreak];
                currentStreak = [d];
            }
        } else { currentStreak = [d]; }
    });
    if (currentStreak.length > maxStreak.length) maxStreak = currentStreak;
    if (maxStreak.length > 0) stats.streak = { count: maxStreak.length, start: maxStreak[0], end: maxStreak[maxStreak.length - 1] };

    monthKeys = Array.from(new Set(Object.keys(runsRaw).map(d => d.slice(0, 7)))).sort().reverse();
}

/**
 * 3. æ”¹è¿›ï¼šè‡ªå®šä¹‰æ ¼å­é¢œè‰²ç­‰çº§ (4 6 8 10 12 15 20 30 42)
 */
function getLevel(k, mode) {
    if(mode === 'y') return k>300?9:k>250?8:k>230?7:k>210?6:k>190?5:k>150?4:k>100?3:k>50?2:k>10?1:0;
    
    if (k <= 0) return 0;
    const levels = [4, 6, 8, 10, 12, 15, 20, 30, 42];
    for (let i = levels.length - 1; i >= 0; i--) {
        if (k >= levels[i]) return i + 1;
    }
    return 1;
}

function renderSummary() {
    animateValue(totalEl, 0, stats.totalKm, 1500, '');
    const earth = 40075, pct = Math.min(stats.totalKm / earth * 100, 100);
    animateValue(ppctEl, 0, pct, 1500, '%');
    setTimeout(() => globeEl.style.width = Math.min(pct, 100) + '%', 100);

    const badgeData = [
        { label: `ğŸ† æœ€é•¿ ${stats.pb.val.toFixed(1)} km`, tip: `è¾¾æˆæ—¥æœŸï¼š${stats.pb.date}` },
        { label: `âš¡ æœ€å¿« ${stats.fastest.paceStr}`, tip: `è¾¾æˆæ—¥æœŸï¼š${stats.fastest.date}` },
        { label: `ğŸ”¥ æœ€çŒ› ${stats.bestMonth.name}`, tip: `å½“æœˆè·‘é‡ï¼š${stats.bestMonth.val.toFixed(1)} km` },
        { label: `ğŸ“… è¿ç»­ ${stats.streak.count} å¤©`, tip: `è¿è·‘åŒºé—´ï¼š${stats.streak.start} ~ ${stats.streak.end}` }
    ];

    badgesEl.innerHTML = '';
    badgeData.forEach(item => {
        const b = document.createElement('div');
        b.className = 'badge';
        b.textContent = item.label;
        bindTip(b, `<div style="padding:4px">${item.tip}</div>`);
        badgesEl.appendChild(b);
    });
}

function renderOneMonth(mKey) {
    const [y, mo] = mKey.split('-');
    const mData = months[mKey];
    const monthTotal = mData.km || 0;
    const avgPace = formatPace(mData.time, mData.km);
    const avgHR = mData.hrCount > 0 ? Math.round(mData.hrSum / mData.hrCount) : '--';
    
    const daysInMonth = new Date(y, mo, 0).getDate();
    const firstDay = new Date(y, mo - 1, 1).getDay();

    const box = document.createElement('div');
    box.className = 'month';
    // 1. æ”¹è¿›ï¼šæœˆè§†å›¾æ ‡é¢˜åŠ å…¥å‡é…é€Ÿå’Œå¹³å‡å¿ƒç‡
    box.innerHTML = `
        <div class="title">
            <div class="main-info"><span>${y}å¹´${mo}æœˆ</span><span>${monthTotal.toFixed(1)} km</span></div>
            <div class="sub-info"><span>Avg.é…é€Ÿ ${avgPace}</span><span>Avg.å¿ƒç‡ ${avgHR} bpm</span></div>
        </div>
        <div class="grid"></div>`;
    const g = box.querySelector('.grid');

    for (let i = 0; i < firstDay; i++) g.appendChild(document.createElement('div'));
    
    for (let d = 1; d <= daysInMonth; d++) {
        const dateKey = `${y}-${mo}-${String(d).padStart(2, '0')}`;
        const dayData = runsRaw[dateKey];
        const km = dayData ? dayData.totalKm : 0;
        
        const c = document.createElement('div');
        c.className = `cell level-${getLevel(km, 'm')}`;
        c.innerHTML = `<span class="label">${d}</span>`;
        // 2. æ”¹è¿›ï¼šè®¾ç½®é€’å¢çš„åŠ¨ç”»å»¶è¿Ÿï¼Œå®ç°é¡ºæ»‘çš„æ¸ç°æ•ˆæœ
        c.style.animationDelay = `${d * 0.02}s`;

        if (km > 0) {
            c.innerHTML += `<span class="distance">${km.toFixed(1)}</span>`;
            bindTip(c, () => buildDayTooltip(dateKey, dayData));
        }
        g.appendChild(c);
    }
    cal.appendChild(box);
}

function buildDayTooltip(date, dayData) {
    if (!dayData) return '';
    return dayData.runs.map((r, idx) => {
        const dist = (Number(r.distance) / 1000).toFixed(2);
        const sec = parseDuration(r.moving_time);
        const timeStr = formatTime(sec);
        const paceStr = formatPace(sec, Number(r.distance)/1000);
        const hr = r.average_heartrate ? Math.round(r.average_heartrate) : '-';
        const stTime = r.start_date_local ? (r.start_date_local.match(/(\d{2}:\d{2})/) || [])[1] : '';

        return `
            ${idx === 0 ? `<div class="tip-header"><span>${date}</span> <span>${stTime}</span></div>` : 
            `<div style="border-top:1px dashed rgba(255,255,255,0.2);margin:4px 0;padding-top:4px;font-size:11px;color:#bbb">Run ${idx+1} Â· ${stTime}</div>`}
            <div>
                <div class="tip-row"><span style="font-weight:bold;font-size:13px">ğŸƒ ${dist} km</span> <span style="color:#8fdfa8;font-weight:bold">${paceStr}</span></div>
                <div class="tip-row" style="font-size:11px;color:#ccc;margin-top:2px"><span>â± ${timeStr}</span><span>ğŸ’“ ${hr} bpm</span></div>
            </div>`;
    }).join('');
}

function renderYearView() {
    cal.innerHTML = '';
    Object.keys(years).sort().reverse().forEach(y => {
        const box = document.createElement('div');
        box.className = 'month';
        const yTotal = Object.values(years[y]).reduce((a,b)=>a+b,0);
        box.innerHTML = `<div class="title"><div class="main-info"><span>${y}å¹´</span><span>${yTotal.toFixed(0)} km</span></div></div><div class="grid"></div>`;
        const g = box.querySelector('.grid');
        
        Object.entries(years[y]).sort().forEach(([mKey, km], idx) => {
            const c = document.createElement('div');
            c.className = `cell level-${getLevel(km, 'y')}`;
            c.style.animationDelay = `${idx * 0.05}s`;
            c.innerHTML = `<span class="label">${Number(mKey.slice(-2))}æœˆ</span><span class="distance">${km.toFixed(0)}</span>`;
            bindTip(c, `<div style="font-weight:bold">${mKey}</div><div>è·‘é‡: ${km.toFixed(1)} km</div>`);
            g.appendChild(c);
        });
        cal.appendChild(box);
    });
}

function renderNextBatch() {
    if (currentView !== 'month') return;
    const batch = monthKeys.slice(renderCursor, renderCursor + BATCH_SIZE);
    if (batch.length === 0) return;
    batch.forEach(m => renderOneMonth(m));
    renderCursor += BATCH_SIZE;
}

function initObserver() {
    if (observer) observer.disconnect();
    observer = new IntersectionObserver(entries => {
        if (entries[0].isIntersecting) renderNextBatch();
    }, { rootMargin: '200px' });
    observer.observe(sentinel);
}

document.getElementById('btnMonth').onclick = function() {
    if(currentView === 'month') return;
    currentView = 'month';
    this.classList.add('active');
    document.getElementById('btnYear').classList.remove('active');
    cal.innerHTML = ''; renderCursor = 0; sentinel.style.display = 'block';
    renderNextBatch(); initObserver();
};

document.getElementById('btnYear').onclick = function() {
    if(currentView === 'year') return;
    currentView = 'year';
    this.classList.add('active');
    document.getElementById('btnMonth').classList.remove('active');
    sentinel.style.display = 'none';
    renderYearView();
};

window.onscroll = () => document.getElementById('toTop').style.display = window.scrollY > 500 ? 'block' : 'none';
document.getElementById('toTop').onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });

fetch(DATA_URL).then(r => r.json()).then(data => {
    processData(data);
    renderSummary();
    renderNextBatch();
    initObserver();
}).catch(e => {
    console.error(e);
    cal.innerHTML = '<div style="padding:20px;color:#999">æ•°æ®åŠ è½½å¤±è´¥</div>';
});
</script>
</body>
</html>
