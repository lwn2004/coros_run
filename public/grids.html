<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Running Journey</title>
    <style>
        :root {
            /* 配色方案：清新现代 */
            --primary-color: #2ea44f;
            --bg-color: #f6f8fa;
            --card-bg: #ffffff;
            --text-main: #24292f;
            --text-sub: #57606a;
            --border-color: #d0d7de;
            
            /* 热力图颜色 (Github 风格) */
            --level-0: #ebedf0;
            --level-1: #9be9a8;
            --level-2: #40c463;
            --level-3: #30a14e;
            --level-4: #216e39;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-main);
            min-height: 100vh;
        }

        /* ----- 顶部卡片 (卡片悬浮感增强) ----- */
        .summary-card {
            background: var(--card-bg);
            border-radius: 16px;
            /* 更细腻的阴影 */
            box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 8px 24px rgba(0,0,0,0.05);
            padding: 32px;
            width: 100%;
            max-width: 500px; /* 稍微收窄一点，更精致 */
            box-sizing: border-box;
            margin-bottom: 40px;
            text-align: center;
            transition: transform 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .summary-card:hover {
            transform: translateY(-2px);
        }

        .summary-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-sub);
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            text-transform: uppercase;
        }

        .summary-distance {
            font-size: 48px; /* 加大数字 */
            font-weight: 800;
            color: var(--text-main);
            line-height: 1;
            margin-bottom: 4px;
            font-variant-numeric: tabular-nums; /* 数字等宽，防止跳动 */
        }

        .unit {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-sub);
            margin-left: 4px;
        }

        /* 进度条美化 */
        .progress-container {
            margin-top: 30px;
            width: 100%;
            position: relative;
        }

        .progress-bar-bg {
            background-color: #ebedf0;
            border-radius: 10px;
            height: 10px;
            width: 100%;
            overflow: hidden;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, #40c463, #2ea44f); /* 渐变色 */
            height: 100%;
            width: 0%;
            border-radius: 10px;
            transition: width 1.2s cubic-bezier(0.22, 1, 0.36, 1);
            position: relative;
        }
        
        /* 进度条末端的高光效果 */
        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.3));
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-sub);
        }

        /* ----- 日历容器 ----- */
        .calendar-container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* 月份块动画 */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .month-block {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(27, 31, 36, 0.05); /* 极淡的边框 */
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
            animation: fadeInUp 0.5s ease-out forwards;
        }

        .month-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .month-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-main);
        }

        .month-stat {
            font-size: 12px;
            color: var(--text-sub);
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px; /* 增加间距 */
        }

        .day-header {
            font-size: 10px;
            color: #8c959f;
            text-align: center;
            font-weight: 500;
            padding-bottom: 4px;
        }

        .day-cell {
            aspect-ratio: 1;
            border-radius: 4px; /* 圆角方块 */
            background-color: var(--level-0);
            transition: transform 0.15s ease, border 0.1s;
            border: 1px solid rgba(27, 31, 36, 0.03);
        }

        /* Hover 交互 */
        .day-cell.active:hover {
            transform: scale(1.15);
            z-index: 2;
            border-color: rgba(0,0,0,0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .level-0 { background-color: var(--level-0); }
        .level-1 { background-color: var(--level-1); }
        .level-2 { background-color: var(--level-2); }
        .level-3 { background-color: var(--level-3); }
        .level-4 { background-color: var(--level-4); }

        /* ----- 图例 ----- */
        .legend {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
            font-size: 11px;
            color: var(--text-sub);
            margin-top: 10px;
            margin-bottom: 10px;
            width: 100%;
            max-width: 500px;
        }
        .legend-item {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            display: inline-block;
        }

        /* ----- 自定义 Tooltip ----- */
        #tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transform: translate(-50%, -120%); /* 居中并在上方 */
        }

        /* ----- Loader ----- */
        #sentinel {
            margin-top: 20px;
            padding: 20px;
            text-align: center;
            color: var(--text-sub);
            font-size: 13px;
        }
        /* 简单的 Loading 动画圆圈 */
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid #ddd;
            border-bottom-color: var(--primary-color);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 响应式微调 */
        @media (max-width: 600px) {
            .summary-card { padding: 24px; }
            .summary-distance { font-size: 40px; }
        }
    </style>
</head>
<body>

    <div id="tooltip"></div>

    <div class="summary-card">
        <div class="summary-title">累计跑量</div>
        <div class="summary-distance">
            <span id="total-dist">0.00</span><span class="unit">km</span>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="progress-fill"></div>
            </div>
            <div class="progress-info">
                <span>环球进度</span>
                <span id="progress-text">0%</span>
            </div>
        </div>
    </div>

    <div class="legend">
        <span>Less</span>
        <span class="legend-item level-0"></span>
        <span class="legend-item level-1"></span>
        <span class="legend-item level-2"></span>
        <span class="legend-item level-3"></span>
        <span class="legend-item level-4"></span>
        <span>More</span>
    </div>

    <div id="calendar-wrapper" class="calendar-container"></div>

    <div id="sentinel">
        <span class="loader"></span>
    </div>

    <script>
        const DATA_URL = 'https://run.linwn.net/data/all.json';
        const EARTH_CIRCUMFERENCE = 40075;
        const BATCH_SIZE = 4;

        let runsData = {}; 
        let allMonths = []; 
        let currentRenderIndex = 0;
        let observer;

        // Tooltip 逻辑
        const tooltip = document.getElementById('tooltip');
        
        function showTooltip(e, text) {
            tooltip.textContent = text;
            tooltip.style.opacity = '1';
            updateTooltipPos(e);
        }

        function hideTooltip() {
            tooltip.style.opacity = '0';
        }

        function updateTooltipPos(e) {
            // 简单的跟随逻辑
            tooltip.style.left = e.clientX + 'px';
            tooltip.style.top = e.clientY + 'px';
        }

        async function init() {
            try {
                const response = await fetch(DATA_URL);
                if (!response.ok) throw new Error('Network error');
                const rawData = await response.json();
                
                processData(rawData);
                renderSummaryCard(rawData);
                prepareCalendarData(rawData);
                
                setupIntersectionObserver();
            } catch (error) {
                console.error(error);
                document.getElementById('sentinel').innerHTML = '<span style="color:red">加载失败</span>';
            }
        }

        function processData(data) {
            data.forEach(run => {
                const dateStr = run.start_date_local.split(' ')[0];
                const distanceKm = run.distance / 1000;
                if (runsData[dateStr]) {
                    runsData[dateStr] += distanceKm;
                } else {
                    runsData[dateStr] = distanceKm;
                }
            });
        }

        function renderSummaryCard(rawData) {
            const totalDistanceMeters = rawData.reduce((acc, run) => acc + run.distance, 0);
            const totalDistanceKm = (totalDistanceMeters / 1000).toFixed(2);
            const percentage = (totalDistanceKm / EARTH_CIRCUMFERENCE * 100).toFixed(4);

            // 数字动画
            animateValue(document.getElementById('total-dist'), 0, parseFloat(totalDistanceKm), 1000);
            
            document.getElementById('progress-text').textContent = `${percentage}%`;
            
            setTimeout(() => {
                document.getElementById('progress-fill').style.width = `${Math.min(percentage, 100)}%`;
            }, 300);
        }

        // 简单的数字滚动动画
        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = (progress * (end - start) + start).toFixed(2);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        function prepareCalendarData(rawData) {
            const dates = rawData.map(r => new Date(r.start_date_local.split(' ')[0]));
            if(dates.length === 0) return;
            const maxDate = new Date(Math.max.apply(null, dates));
            const minDate = new Date(Math.min.apply(null, dates));

            let current = new Date(maxDate.getFullYear(), maxDate.getMonth(), 1);
            const end = new Date(minDate.getFullYear(), minDate.getMonth(), 1);

            while (current >= end) {
                allMonths.push({
                    year: current.getFullYear(),
                    month: current.getMonth()
                });
                current.setMonth(current.getMonth() - 1);
            }
        }

        function renderNextBatch() {
            const wrapper = document.getElementById('calendar-wrapper');
            const fragment = document.createDocumentFragment();
            const nextBatch = allMonths.slice(currentRenderIndex, currentRenderIndex + BATCH_SIZE);
            
            if (nextBatch.length === 0) {
                document.getElementById('sentinel').innerHTML = '<span style="opacity:0.5">—— 这里的山路十八弯，这里的故事跑不完 ——</span>'; // 更有趣的结束语
                observer.disconnect();
                return;
            }

            nextBatch.forEach(({year, month}) => {
                const monthBlock = createMonthBlock(year, month);
                fragment.appendChild(monthBlock);
            });

            wrapper.appendChild(fragment);
            currentRenderIndex += BATCH_SIZE;
        }

        function createMonthBlock(year, month) {
            const block = document.createElement('div');
            block.className = 'month-block';

            // 计算该月总跑量
            let monthTotal = 0;
            // 临时遍历计算该月跑量用于显示在 Header
            const daysInMonthTemp = new Date(year, month + 1, 0).getDate();
            for(let d=1; d<=daysInMonthTemp; d++) {
                 const k = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                 if(runsData[k]) monthTotal += runsData[k];
            }

            // Header 部分
            const header = document.createElement('div');
            header.className = 'month-header';
            
            const title = document.createElement('div');
            title.className = 'month-title';
            title.textContent = `${year}年 ${month + 1}月`;
            
            const stat = document.createElement('div');
            stat.className = 'month-stat';
            stat.textContent = monthTotal > 0 ? `月跑量: ${monthTotal.toFixed(1)} km` : '休息月';

            header.appendChild(title);
            header.appendChild(stat);
            block.appendChild(header);

            // Grid 部分
            const grid = document.createElement('div');
            grid.className = 'month-grid';

            const weeks = ['日', '一', '二', '三', '四', '五', '六'];
            weeks.forEach(w => {
                const h = document.createElement('div');
                h.className = 'day-header';
                h.textContent = w;
                grid.appendChild(h);
            });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const dayCell = document.createElement('div');
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dist = runsData[dateKey] || 0;
                
                dayCell.className = 'day-cell level-0';
                
                if (dist > 0) {
                    dayCell.classList.add('active'); // 标记为有数据的格子
                    if (dist < 3) dayCell.classList.add('level-1');
                    else if (dist < 6) dayCell.classList.add('level-2');
                    else if (dist < 10) dayCell.classList.add('level-3');
                    else dayCell.classList.add('level-4');
                    
                    // 绑定 Tooltip 事件
                    dayCell.addEventListener('mouseenter', (e) => showTooltip(e, `${dateKey} · ${dist.toFixed(2)}km`));
                    dayCell.addEventListener('mousemove', (e) => updateTooltipPos(e));
                    dayCell.addEventListener('mouseleave', hideTooltip);
                }

                grid.appendChild(dayCell);
            }

            block.appendChild(grid);
            return block;
        }

        function setupIntersectionObserver() {
            const options = { root: null, rootMargin: '200px', threshold: 0.1 };
            observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) renderNextBatch();
                });
            }, options);
            observer.observe(document.getElementById('sentinel'));
        }

        init();
    </script>
</body>
</html>
