<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>跑步数据记录</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.24.2/bootstrap-table.min.css">
    <style>
        body {
            padding-top: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
        }
        .gradient-title {
            font-size: 2.5rem; /* 调整字体大小 */
            font-weight: bold;
            /* 创建渐变背景 */
            background: linear-gradient(45deg, #0d6efd, #6f42c1, #e83e8c);
            /* 将背景应用到文字上 */
            -webkit-background-clip: text;
            background-clip: text;
            /* 让文字颜色透明，从而显示背景 */
            color: transparent;
        } 

        .stat-card {
            border: none; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            width: 100%; /* 确保卡片充满轮播项 */
        }
        .stat-card .card-body { display: flex; align-items: center; }
        .stat-card .icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            margin-right: 20px;
        }     
        h1, h2, h3 { font-weight: 600; }
        .carousel-container {
            position: relative;
        }
        .carousel-indicators {
          bottom: -20px;
        }
        .carousel-indicators [data-bs-target] {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background-color: #999;  /* dot color */
          opacity: 0.6;
          transition: opacity 0.3s, transform 0.3s;
        }

        .carousel-indicators .active {
          background-color: #fff;  /* active dot color */
          opacity: 1;
          /*transform: scale(1.3);   /* slightly enlarge active dot */
        }        
        #filters-container {
            /*background-color: #f0f3f5;*/
        }
        #filters-container .btn {
            /*margin: 5px;*/
        }
        #chart-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
        }
        .nav-tabs .nav-link {
            cursor: pointer;
        }
        @media (min-width: 768px) {
            #statsCarousel .carousel-inner {
                display: flex;
            }
            #statsCarousel .carousel-item {
                display: block;
                margin-right: 1.5rem; /* g-4 in bootstrap */
            }
            #statsCarousel .carousel-item:last-child {
                margin-right: 0;
            }
            .carousel-control-prev, .carousel-control-next, .carousel-indicators {
                display: none !important;
            }
        }
        @media (max-width: 767.98px) {
            #statsCarousel {
                margin-left: -0.75rem; /* 抵消 container-fluid 的 p-3 */
                margin-right: -0.75rem;
            }
            .carousel-item {
                padding: 0 0.5rem; /* 给卡片之间留出一点空隙 */
            }
            .carousel-indicators [data-bs-target] {
                background-color: #999;
            }
        #filter-buttons .btn {
            margin-bottom: 0.5rem; /* 在移动端换行时提供间距 */
        }        
    </style>
</head>
<body>
    <div class="container-fluid p-3 p-md-4">
        <div class="d-flex align-items-center mb-4">
        <h1 class="gradient-title">个人跑步数据记录</h1>
        </div>
        <div id="statsCarousel" class="carousel slide d-md-flex mb-4" data-bs-ride="false">
            <div class="carousel-indicators">
                <button type="button" data-bs-target="#statsCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                <button type="button" data-bs-target="#statsCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
                <button type="button" data-bs-target="#statsCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
                <button type="button" data-bs-target="#statsCarousel" data-bs-slide-to="3" aria-label="Slide 4"></button>                
                <button type="button" data-bs-target="#statsCarousel" data-bs-slide-to="4" aria-label="Slide 5"></button>                

            </div>            
            <div class="carousel-inner" id="summary-stats-container">
            </div>           
        </div>
        <hr>
        <h4 class="card-title mb-3">详细记录</h4>
        <ul class="nav nav-tabs mb-3" id="view-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link active" data-view="individual">次</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" data-view="day">日</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" data-view="week">周</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" data-view="month">月</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" data-view="year">年</a>
            </li>
        </ul>
        <div id="filters-container" class="py-3">
            <div id="filters" class="btn-group text-center buttons-toolbar" role="group">
                <button type="button" class="btn btn-sm btn-outline-secondary active" data-filter="all">全部</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" data-filter="today_in_history">历史上的今天</button>
                <button class="btn btn-sm btn-outline-secondary" data-filter="half_marathon">半马</button>
                <button class="btn btn-sm btn-outline-secondary" data-filter="full_marathon">全马</button>
                <button class="btn btn-sm btn-outline-secondary" data-filter="race">比赛</button>
            </div>
        </div>
        <div id="chart-section" class="d-none mb-3">
            <canvas id="distance-chart"></canvas>
            <div id="chart-nav" class="d-none">
                <button id="prev-btn" class="btn btn-sm btn-outline-primary me-3 py-0">&lt; </button>
                <h5 id="chart-title" class="mb-0"></h5>
                <button id="next-btn" class="btn btn-sm btn-outline-primary ms-3 py-0"> &gt;</button>
            </div>            
        </div>
        <table id="run-table"
               data-toggle="table"
               data-sortable="true"
               data-sort-name="start_date_local"
               data-sort-order="desc"
               data-icons-prefix="fa"
               data-icons='{"refresh": "fa-sync-alt", "toggleOff": "fa-toggle-off", "toggleOn": "fa-toggle-on", "columns": "fa-th-list", "search": "fa-search"}'>
        </table>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.24.2/bootstrap-table.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.18/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.18/plugin/isoWeek.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.18/plugin/customParseFormat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.18/plugin/duration.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.18/plugin/utc.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.18/plugin/weekday.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script>
        // --- SETUP ---
        dayjs.extend(dayjs_plugin_isoWeek);
        dayjs.extend(dayjs_plugin_customParseFormat);
        dayjs.extend(dayjs_plugin_duration);
        dayjs.extend(dayjs_plugin_utc);
        dayjs.extend(dayjs_plugin_weekday);
        const $table = $('#run-table');
        let chartInstance = null;
        let currentChartDate = dayjs();
        let currentView = 'individual';
        // --- HELPER FUNCTIONS ---
        const parseDuration = (timeStr) => {
            const parts = timeStr.split(/[:.]/);
            return dayjs.duration({
                hours: parseInt(parts[0], 10),
                minutes: parseInt(parts[1], 10),
                seconds: parseInt(parts[2], 10),
            });
        };
        const formatDuration = (totalSeconds) => {
            if (isNaN(totalSeconds) || totalSeconds <= 0) return '00:00:00';
            const d = dayjs.duration(totalSeconds, 'seconds');
            const hours = Math.floor(d.asHours());
            const minutes = d.minutes();
            const seconds = d.seconds();
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        };
        const formatPace = (speed_mps) => {
            if (!speed_mps || speed_mps <= 0) return 'N/A';
            const secondsPerKm = 1000 / speed_mps;
            const minutes = Math.floor(secondsPerKm / 60);
            const seconds = Math.round(secondsPerKm % 60);
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        };
        function updateSummaryCarousel(data) {
            if (!data || data.length === 0) return;
            const totalRuns = data.count;
            const totalDistance = data.distance;
            const totalDuration = data.moving_time;
            //const totalElevation = data.reduce((sum, run) => sum + run.total_elevation_gain, 0);
            const avgPace = data.avg_pace;
            const avgHeartRate = data.avg_hr;
            const stats = [
                {
                    label: '总里程',
                    value: `${totalDistance.toFixed(2)} km`,
                    icon: 'fa-road',
                    color: '#0d6efd'
                },
                {
                    label: '总次数',
                    value: `${totalRuns} 次`,
                    icon: 'fa-calendar-check',
                    color: '#198754'
                },
                {
                    label: '总时长',
                    value: totalDuration,
                    icon: 'fa-clock',
                    color: '#ffc107'
                },
                {
                    label: '平均配速',
                    value: `${avgPace} /km`,
                    icon: 'fa-bolt-lightning',
                    color: '#dc3545'
                },
                {
                    label: '平均心率',
                    value: `${avgHeartRate}`,
                    icon: 'fa-heart',
                    color: '#6f42c1'
                }
            ];
            let cardsHtml = '';
            stats.forEach((stat, index) => {
                // 第一个item需要加 'active' 类
                const activeClass = index === 0 ? 'active' : '';
                cardsHtml += `
                    <div class="carousel-item ${activeClass} col-md">
                        <div class="card stat-card">
                            <div class="card-body">
                                <div class="icon" style="background-color: ${stat.color};"><i class="fa-solid ${stat.icon}"></i></div>
                                <div>
                                    <h6 class="card-subtitle mb-2 text-muted">${stat.label}</h6>
                                    <h3 class="card-title">${stat.value}</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            $('#summary-stats-container').html(cardsHtml);
            bootstrap.Carousel.getOrCreateInstance('#statsCarousel');
        }        
        // --- MAIN APP LOGIC ---
        function initializeApp(rawData) {
            // --- DATA PROCESSING & RENDERING ---
            const individualColumns = [
                { field: 'start_date_local', title: '日期', sortable: true },
                { field: 'distance_km', title: '距离', sortable: true, formatter: (d) => d.toFixed(2) },
                { field: 'moving_time_formatted', title: '用时', sortable: true },
                { field: 'pace', title: '配速', sortable: true },
                { field: 'average_heartrate', title: '心率', sortable: true, formatter: (hr) => hr ? Math.round(hr) : 'N/A' },
                { field: 'type', title: '类型', sortable: true },
                { field: 'name', title: '名称', sortable: true },
            ];
            const processedIndividualData = rawData.map(run => ({
                ...run,
                distance_km: run.distance / 1000,
                moving_time_formatted: formatDuration(parseDuration(run.moving_time).asSeconds()),
                pace: formatPace(run.average_speed),
            })).sort((a, b) => new Date(b.start_date_local) - new Date(a.start_date_local));
            function renderIndividualView(filter = 'all') {
                currentView = 'individual';
                $('#filters-container').removeClass('d-none');
                $('#chart-section').addClass('d-none');
                if (chartInstance) chartInstance.destroy();
                let dataToLoad = processedIndividualData;
                const today = dayjs();
                switch(filter) {
                    case 'today_in_history':
                        dataToLoad = processedIndividualData.filter(r => {
                            const runDate = dayjs(r.start_date_local);
                            return runDate.month() === today.month() && runDate.date() === today.date();
                        });
                        break;
                    case 'morning_run':
                        dataToLoad = processedIndividualData.filter(r => dayjs(r.start_date_local).hour() < 12);
                        break;
                    case 'long_run':
                        dataToLoad = processedIndividualData.filter(r => r.distance >= 15000);
                        break;
                    case 'race':
                        dataToLoad = processedIndividualData.filter(r => r.subtype === 'Race');
                        break;
                    case 'half_marathon':
                        dataToLoad = processedIndividualData.filter(r => r.distance >= 21097.5);
                        break;
                    case 'full_marathon':
                        dataToLoad = processedIndividualData.filter(r => r.distance >= 42195);
                        break;
                }
                $table.bootstrapTable('destroy').bootstrapTable({
                    columns: individualColumns,
                    data: dataToLoad
                });
            }
            const aggregatedColumns = (period) => [
                { field: 'period_display', title: period, sortable: true },
                { field: 'distance', title: '距离', sortable: true, formatter: (d) => d.toFixed(2) },
                { field: 'moving_time', title: '用时', sortable: true },
                { field: 'avg_hr', title: '心率', sortable: true },
                { field: 'avg_pace', title: '配速', sortable: true },
            ];
            /**
             * 根据指定的时间周期聚合跑步数据。
             * @param {string} period - 聚合周期，可选值为 '日', '周', '月', '年', '全部'.
             * @returns {Array<Object>} 聚合后的数据数组.
             */
            function aggregateData(period) {
                const groups = {};

                rawData.forEach(run => {
                    const date = dayjs(run.start_date_local);
                    let key;

                    // 根据周期确定分组的key
                    if (period === '全部') {
                        key = 'all_time'; // 为“全部”周期设置一个固定的key
                    } else if (period === '日') {
                        key = date.format('YYYY-MM-DD');
                    } else if (period === '周') {
                        key = `${date.isoWeekYear()}-W${String(date.isoWeek()).padStart(2, '0')}`;
                    } else if (period === '月') {
                        key = date.format('YYYY-MM');
                    } else if (period === '年') {
                        key = date.format('YYYY');
                    }

                    // 初始化分组
                    if (!groups[key]) {
                        groups[key] = {
                            distance: 0,
                            moving_time_seconds: 0,
                            hr_x_time: 0, // 用于计算加权平均心率
                            count: 0
                        };
                    }

                    // 累加数据
                    const durationSeconds = parseDuration(run.moving_time).asSeconds();
                    groups[key].distance += run.distance;
                    groups[key].moving_time_seconds += durationSeconds;
                    if (run.average_heartrate) {
                        groups[key].hr_x_time += run.average_heartrate * durationSeconds;
                    }
                    groups[key].count++;
                });

                // 格式化并返回结果
                return Object.keys(groups).map(key => {
                    const group = groups[key];
                    let period_display = key;

                    // 根据周期格式化显示的名称
                    if (period === '全部') {
                        period_display = '全部汇总'; // 为“全部”周期设置显示名称
                    } else if (period === '周') {
                        const [year, weekNum] = key.replace('W', '').split('-');
                        period_display = dayjs().year(parseInt(year)).isoWeek(parseInt(weekNum)).startOf('isoWeek').format('YYYY-MM-DD');
                    }

                    const totalDistanceKm = group.distance / 1000;
                    const totalTimeSeconds = group.moving_time_seconds;
                    const avgSpeedMps = totalTimeSeconds > 0 ? group.distance / totalTimeSeconds : 0;

                    return {
                        period_key: key,
                        period_display: period_display,
                        distance: totalDistanceKm,
                        moving_time: formatDuration(totalTimeSeconds),
                        avg_hr: totalTimeSeconds > 0 && group.hr_x_time > 0 ? Math.round(group.hr_x_time / totalTimeSeconds) : 'N/A',
                        avg_pace: formatPace(avgSpeedMps),
                        count: group.count // 额外返回该周期的活动次数
                    };
                }).sort((a, b) => b.period_key.localeCompare(a.period_key));
            }
            function renderAggregatedView(viewType, labels, data) {
                 currentView = viewType.toLowerCase();
                 currentView = viewType;
                $('#filters-container').addClass('d-none');
                $('#chart-section').removeClass('d-none');
                const chartNav = $('#chart-nav');
                if (currentView === '日' || currentView === '月' || currentView === '周'  || currentView === '年') {
                    chartNav.removeClass('d-none');
                    const format = (currentView === '日') ? 'YYYY 年 MM 月' : 'YYYY 年';
                    if(currentView === '年') {
                         $('#prev-btn, #next-btn').addClass('d-none');
                         $('#chart-title').text('年度数据');
                    } else if(currentView === '周') {
                        $('#prev-btn, #next-btn').addClass('d-none');
                        $('#chart-title').text('近16周');
                    } else {
                         $('#prev-btn, #next-btn').removeClass('d-none');
                         $('#chart-title').text(currentChartDate.format(format));
                    }
                } else {
                    chartNav.addClass('d-none');                    
                }
                const ctx = document.getElementById('distance-chart').getContext('2d');
                if (chartInstance) chartInstance.destroy();
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '距离 (km)',
                            data: data,
                            backgroundColor: 'rgba(0, 123, 255, 0.5)',
                            borderColor: 'rgba(0, 123, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { 
                        scales: {                         
                            x: { ticks: {maxTicksLimit: 8} },
                            y: { beginAtZero: true, title: { display: true, text: '距离 (km)' } },
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
            function setupAggregatedView(period) {
                const aggregated = aggregateData(period);
                let labels = [], data = [];
                if (period === '日') {
                    const start = currentChartDate.startOf('month');
                    const end = currentChartDate.endOf('month');
                    for (let d = start; d.isBefore(end) || d.isSame(end); d = d.add(1, 'day')) {
                        labels.push(d.format('DD'));
                        const dayData = aggregated.find(a => a.period_key === d.format('YYYY-MM-DD'));
                        data.push(dayData ? dayData.distance : 0);
                    }
                } else if (period === '周') {
                    const today = dayjs();
                    for (let i = 15; i >= 0; i--) {
                        const week = today.subtract(i, 'week');
                        const key = `${week.isoWeekYear()}-W${String(week.isoWeek()).padStart(2, '0')}`;
                        labels.push(week.startOf('isoWeek').format('MM-DD'));
                        const weekData = aggregated.find(a => a.period_key === key);
                        data.push(weekData ? weekData.distance : 0);
                    }
                } else if (period === '月') {
                    const year = currentChartDate.year();
                     for (let i = 1; i <= 12; i++) {
                        labels.push(`${i}月`);
                        const key = `${year}-${String(i).padStart(2, '0')}`;
                        const monthData = aggregated.find(a => a.period_key === key);
                        data.push(monthData ? monthData.distance : 0);
                    }
                } else if (period === '年') {
                    const years = [...new Set(rawData.map(r => dayjs(r.start_date_local).year()))].sort();
                    years.forEach(year => {
                        labels.push(year);
                        const yearData = aggregated.find(a => a.period_key == year);
                        data.push(yearData ? yearData.distance : 0);
                    });
                }
                renderAggregatedView(period, labels, data);
                $table.bootstrapTable('destroy').bootstrapTable({
                    columns: aggregatedColumns(period),
                    data: aggregated
                });
            }
            updateSummaryCarousel(aggregateData('全部')[0]);
            // --- EVENT LISTENERS ---
            renderIndividualView();
            $('#view-tabs a').on('click', function(e) {
                e.preventDefault();
                $(this).tab('show');
                const view = $(this).data('view');
                currentChartDate = dayjs();
                switch(view) {
                    case 'individual': renderIndividualView(); break;
                    case 'day': setupAggregatedView('日'); break;
                    case 'week': setupAggregatedView('周'); break;
                    case 'month': setupAggregatedView('月'); break;
                    case 'year': setupAggregatedView('年'); break;
                }
            });
            $('#filters .btn').on('click', function() {
                $('#filters .btn').removeClass('active');
                $(this).addClass('active');
                const filter = $(this).data('filter');
                renderIndividualView(filter);
            });
            $('#prev-btn').on('click', function() {
                const unit = (currentView === '日') ? 'month' : 'year';
                currentChartDate = currentChartDate.subtract(1, unit);
                setupAggregatedView(currentView === '日' ? '日' : '月');
            });
            $('#next-btn').on('click', function() {
                const unit = (currentView === '日') ? 'month' : 'year';
                currentChartDate = currentChartDate.add(1, unit);
                setupAggregatedView(currentView === '日' ? '日' : '月');
            });
        }
        // --- DATA FETCHING AND INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            fetch('data/all.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.length > 0) {
                        initializeApp(data);
                    } else {
                         $('.container').html('<div class="alert alert-warning">数据文件为空或格式不正确。</div>');
                    }
                })
                .catch(error => {
                    console.error("Could not load or parse data:", error);
                    $('.container').html(`<div class="alert alert-danger"><strong>加载数据失败:</strong> 无法获取 data/all.json。 <br>请确认文件存在于正确的路径下，并且您的网页是通过Web服务器访问的（而不是直接打开本地文件）。</div>`);
                });
        });
    </script>
</body>
</html>
