<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>æˆ‘çš„è·‘æ­¥ä»ªè¡¨ç›˜ ğŸƒâ€â™‚ï¸</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.24.2/bootstrap-table.min.css">
    <style>
        body { background-color: #f4f7f6; }
        .stat-card {
            border: none; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            width: 100%; /* ç¡®ä¿å¡ç‰‡å……æ»¡è½®æ’­é¡¹ */
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); }
        .stat-card .card-body { display: flex; align-items: center; }
        .stat-card .icon { font-size: 2.5rem; padding: 15px; border-radius: 50%; margin-right: 20px; color: white; }
        h1, h2, h3 { font-weight: 600; }
        .carousel-container {
            position: relative;
        }
        @media (min-width: 768px) {
            #statsCarousel .carousel-inner, #chartsCarousel .carousel-inner {
                display: flex;
            }
            #statsCarousel .carousel-item, #chartsCarousel .carousel-item {
                display: block;
                margin-right: 1.5rem; /* g-4 in bootstrap */
            }
            #statsCarousel .carousel-item:last-child, #chartsCarousel .carousel-item:last-child {
                margin-right: 0;
            }
            .carousel-control-prev, .carousel-control-next, .carousel-indicators {
                display: none !important;
            }
        }
        @media (max-width: 767.98px) {
            #statsCarousel, #chartsCarousel {
                margin-left: -0.75rem; /* æŠµæ¶ˆ container-fluid çš„ p-3 */
                margin-right: -0.75rem;
            }
            .carousel-item {
                padding: 0 0.5rem; /* ç»™å¡ç‰‡ä¹‹é—´ç•™å‡ºä¸€ç‚¹ç©ºéš™ */
            }
            .carousel-indicators [data-bs-target] {
                background-color: #0d6efd;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid p-3 p-md-4">
        <div class="d-flex align-items-center mb-4">
            <h1 class="mb-0">è·‘æ­¥ä»ªè¡¨ç›˜</h1>
            <i class="bi bi-person-running h1 ms-3 text-primary"></i>
        </div>
        <div id="statsCarousel" class="carousel slide d-md-flex mb-4" data-bs-ride="false">
            <div class="carousel-inner" id="summary-stats-container">
                </div>
            <div class="d-md-none">
                <button class="carousel-control-prev" type="button" data-bs-target="#statsCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#statsCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        </div>
        <div id="chartsCarousel" class="carousel slide d-md-block mb-4" data-bs-ride="false">
            <div class="carousel-indicators">
                <button type="button" data-bs-target="#chartsCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                <button type="button" data-bs-target="#chartsCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
            </div>
            <div class="carousel-inner" id="charts-container">
                <div class="carousel-item active">
                    <div class="card stat-card">
                        <div class="card-body" style="display:block;">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="carousel-item">
                     <div class="card stat-card">
                        <div class="card-body" style="display:block;">
                            <canvas id="paceTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card stat-card">
             <div class="card-body" style="display: block;">
                <h3 class="card-title mb-3">è¯¦ç»†è®°å½•</h3>
                <div class="table-responsive">
                    <table id="runTable"></table>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.24.2/bootstrap-table.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/locale/zh-cn.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/4.4.1/chart.umd.min.js"></script>
    <script>
        moment.locale('zh-cn');
        function paceFormatter(value) {
            if (!value || value <= 0) return '-';
            const paceSeconds = 1000 / value;
            const minutes = Math.floor(paceSeconds / 60);
            const seconds = String(Math.round(paceSeconds % 60)).padStart(2, '0');
            return `${minutes}'${seconds}"`;
        }
        function durationFormatter(value) {
            if (!value) return '-';
            const duration = moment.duration(value, 'seconds');
            const hours = Math.floor(duration.asHours());
            const minutes = duration.minutes();
            const seconds = duration.seconds();
            return `${hours > 0 ? hours + ':' : ''}${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        function dateFormatter(value) {
            if (!value) return '-';
            return moment(value).format('YYYY-MM-DD');
        }
        function distanceFormatter(value) {
            if (!value || value <= 0) return '-';
            return (value / 1000).toFixed(2);
        }
        function elevationFormatter(value) {
            if (!value || value < 0) return '-';
            return `<i class="bi bi-mountain me-1 text-success"></i>${Math.round(value)}m`;
        }
        function typeFormatter(value) {
            const icons = {
                'Race': '<i class="bi bi-trophy-fill text-warning me-2"></i>æ¯”èµ›',
                'Long Run': '<i class="bi bi-sign-turn-right-fill text-info me-2"></i>é•¿è·ç¦»',
                'Easy Run': '<i class="bi bi-wind text-success me-2"></i>è½»æ¾è·‘',
                'Interval': '<i class="bi bi-hourglass-split text-danger me-2"></i>é—´æ­‡è·‘',
                'Workout': '<i class="bi bi-lightning-fill text-primary me-2"></i>è®­ç»ƒ',
                'default': '<i class="bi bi-activity me-2"></i>è·‘æ­¥'
            };
            return icons[value] || icons['default'];
        }
        function nameFormatter(value, row) {
            let pbBadge = '';
            if (row.is_pb_5k || row.is_pb_10k || row.is_pb_hm || row.is_pb_m) {
                pbBadge = '<span class="pb-badge ms-2" title="ä¸ªäººæœ€ä½³çºªå½•!">ğŸ…</span>';
            }
            return `<strong>${value || 'æœªå‘½åè·‘æ­¥'}</strong>${pbBadge}`;
        }
        $(document).ready(function() {
            fetch('data/all.json')
                .then(response => response.json())
                .then(data => {
                    updateSummaryCarousel(data);
                    renderAllCharts(data);
                    initializeRunTable(data);
                })
                .catch(error => {
				    console.error('åŠ è½½è·‘æ­¥æ•°æ®å¤±è´¥:', error);
                    $('#summary-stats').html('<div class="col"><p class="text-danger">æ— æ³•åŠ è½½æ•°æ®ï¼Œè¯·æ£€æŸ¥all.jsonæ–‡ä»¶æ˜¯å¦å­˜åœ¨æˆ–æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚</p></div>');
				});
        });
        function updateSummaryCarousel(data) {
            if (!data || data.length === 0) return;
            const totalRuns = data.length;
            const totalDistance = data.reduce((sum, run) => sum + run.distance, 0);
            const totalDuration = data.reduce((sum, run) => sum + run.moving_time, 0);
            const totalElevation = data.reduce((sum, run) => sum + run.total_elevation_gain, 0);
            const avgPaceSeconds = totalDuration / (totalDistance / 1000);
            const stats = [
                {
                    label: 'æ€»é‡Œç¨‹',
                    value: `${(totalDistance / 1000).toFixed(2)} km`,
                    icon: 'bi-sign-merge-right-fill',
                    color: '#0d6efd'
                },
                {
                    label: 'æ€»æ¬¡æ•°',
                    value: `${totalRuns} æ¬¡`,
                    icon: 'bi-calendar-check-fill',
                    color: '#198754'
                },
                {
                    label: 'æ€»æ—¶é•¿',
                    value: durationFormatter(totalDuration),
                    icon: 'bi-hourglass-top',
                    color: '#ffc107'
                },
                {
                    label: 'å¹³å‡é…é€Ÿ',
                    value: `${paceFormatter(1000/avgPaceSeconds)} /km`,
                    icon: 'bi-speedometer2',
                    color: '#dc3545'
                },
                {
                    label: 'æ€»çˆ¬å‡',
                    value: `${Math.round(totalElevation)} ç±³`,
                    icon: 'bi-mountain',
                    color: '#6f42c1'
                }
            ];
            let cardsHtml = '';
            stats.forEach((stat, index) => {
                // ç¬¬ä¸€ä¸ªiteméœ€è¦åŠ  'active' ç±»
                const activeClass = index === 0 ? 'active' : '';
                cardsHtml += `
                    <div class="carousel-item ${activeClass} col-md">
                        <div class="card stat-card">
                            <div class="card-body">
                                <div class="icon" style="background-color: ${stat.color};"><i class="bi ${stat.icon}"></i></div>
                                <div>
                                    <h6 class="card-subtitle mb-2 text-muted">${stat.label}</h6>
                                    <h3 class="card-title">${stat.value}</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            $('#summary-stats-container').html(cardsHtml);
        }
        // æ–°å¢/ä¿®æ”¹: æ¸²æŸ“æ‰€æœ‰å›¾è¡¨çš„å‡½æ•°
        function renderAllCharts(data) {
            renderMonthlyChart(data);
            renderPaceTrendChart(data); // æ–°å¢çš„å›¾è¡¨
        }
        function renderMonthlyChart(data) {
            const monthlyData = {};
            data.forEach(run => {
                const month = moment(run.start_date_local).format('YYYY-MM');
                if (!monthlyData[month]) monthlyData[month] = 0;
                monthlyData[month] += run.distance / 1000;
            });
            const sortedMonths = Object.keys(monthlyData).sort().slice(-12);
            const chartLabels = sortedMonths.map(m => moment(m).format('MMM'));
            const chartData = sortedMonths.map(m => monthlyData[m].toFixed(2));
            new Chart($('#monthlyChart'), {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'æœˆåº¦è·‘é‡ (km)',
                        data: chartData,
                        backgroundColor: 'rgba(13, 110, 253, 0.6)'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { title: { display: true, text: 'æœ€è¿‘12ä¸ªæœˆè·‘é‡ç»Ÿè®¡' } }
                }
            });
        }
        // æ–°å¢: æ¸²æŸ“é…é€Ÿè¶‹åŠ¿å›¾è¡¨
        function renderPaceTrendChart(data) {
            const monthlyAvgPace = {};
            const monthlyRunCounts = {};
            data.forEach(run => {
                const month = moment(run.start_date_local).format('YYYY-MM');
                if(!monthlyAvgPace[month]) {
                    monthlyAvgPace[month] = 0;
                    monthlyRunCounts[month] = 0;
                }
                // ç´¯åŠ æ¯æ¬¡è·‘æ­¥çš„é…é€Ÿï¼ˆç§’/å…¬é‡Œï¼‰
                monthlyAvgPace[month] += 1000 / run.average_speed;
                monthlyRunCounts[month]++;
            });
            const sortedMonths = Object.keys(monthlyAvgPace).sort().slice(-12);
            const chartLabels = sortedMonths.map(m => moment(m).format('MMM'));
            const chartData = sortedMonths.map(m => {
                // è®¡ç®—æœˆå¹³å‡é…é€Ÿ
                const avgPaceInSeconds = monthlyAvgPace[m] / monthlyRunCounts[m];
                return avgPaceInSeconds;
            });
            new Chart($('#paceTrendChart'), {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'æœˆå¹³å‡é…é€Ÿ',
                        data: chartData,
                        borderColor: 'rgba(220, 53, 69, 0.8)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'æœˆå¹³å‡é…é€Ÿè¶‹åŠ¿' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const paceSeconds = context.raw;
                                    const minutes = Math.floor(paceSeconds / 60);
                                    const seconds = String(Math.round(paceSeconds % 60)).padStart(2, '0');
                                    return `é…é€Ÿ: ${minutes}'${seconds}" /km`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value, index, values) {
                                    // è‡ªå®šä¹‰Yè½´æ ‡ç­¾ï¼Œæ˜¾ç¤ºä¸º M'SS" æ ¼å¼
                                    const minutes = Math.floor(value / 60);
                                    const seconds = String(Math.round(value % 60)).padStart(2, '0');
                                    return `${minutes}'${seconds}"`;
                                }
                            }
                        }
                    }
                }
            });
        }
        function initializeRunTable(data) {
            $('#runTable').bootstrapTable({
                data: data,
                classes: 'table table-hover table-striped',
                search: true,
                pagination: true,
                pageSize: 10,
                pageList: [10, 25, 50, 'all'],
                sortName: 'start_date_local',
                sortOrder: 'desc',
                // æ–°å¢/ä¿®æ”¹: å¯ç”¨æ­¤é€‰é¡¹æ¥æ›´å¥½åœ°å¤„ç†ç§»åŠ¨ç«¯åˆ†é¡µæ 
                smartDisplay: true, 
                columns: [{
                    field: 'name',
                    title: 'è·‘æ­¥åç§°',
                    formatter: nameFormatter,
                    sortable: true
                }, {
                    field: 'start_date_local',
                    title: 'æ—¥æœŸ',
                    formatter: dateFormatter,
                    sortable: true
                }, {
                    field: 'distance',
                    title: 'è·ç¦»(km)',
                    formatter: distanceFormatter,
                    sortable: true
                }, {
                    field: 'average_speed',
                    title: 'é…é€Ÿ',
                    formatter: paceFormatter,
                    sortable: true
                }, {
                    field: 'moving_time',
                    title: 'æ—¶é•¿',
                    formatter: durationFormatter,
                    sortable: true,
                    // æ–°å¢/ä¿®æ”¹: ä½¿ç”¨Bootstrapçš„å“åº”å¼æ˜¾ç¤ºç±»
                    // d-none: é»˜è®¤éšè—
                    // d-md-table-cell: åœ¨ä¸­ç­‰å±å¹•(>=768px)åŠä»¥ä¸Šå°ºå¯¸ï¼Œä»¥è¡¨æ ¼å•å…ƒæ ¼å½¢å¼æ˜¾ç¤º
                    class: 'd-none d-md-table-cell'
                }, {
                    field: 'average_heartrate',
                    title: '<i class="bi bi-heart-pulse-fill text-danger"></i>',
                    sortable: true,
                    class: 'd-none d-md-table-cell'
                }, {
                    field: 'total_elevation_gain',
                    title: 'çˆ¬å‡',
                    formatter: elevationFormatter,
                    sortable: true,
                    // æ–°å¢/ä¿®æ”¹: åœ¨å¤§å±å¹•(>=992px)åŠä»¥ä¸Šæ‰æ˜¾ç¤º
                    class: 'd-none d-lg-table-cell'
                }, {
                    field: 'type',
                    title: 'ç±»å‹',
                    formatter: typeFormatter,
                    sortable: true,
                    class: 'd-none d-lg-table-cell'
                }],
                onClickRow: function (row, $element) {
                    showRunDetails(row);
                }
            });
        }
        // æ˜¾ç¤ºè·‘æ­¥è¯¦æƒ…æ¨¡æ€æ¡†
        function showRunDetails(run) {
            $('#runDetailModalLabel').text(run.name || 'è·‘æ­¥è¯¦æƒ…');
            const modalBody = `
                <div class="row">
                    <div class="col-md-6">
                        <h4><i class="bi bi-calendar3"></i> ${moment(run.start_date_local).format('YYYYå¹´MæœˆDæ—¥ dddd HH:mm')}</h4>
                        <hr>
                        <p><strong><i class="bi bi-sign-merge-right-fill text-primary"></i> è·ç¦»:</strong> ${distanceFormatter(run.distance)} km</p>
                        <p><strong><i class="bi bi-hourglass-split text-warning"></i> æ—¶é•¿:</strong> ${durationFormatter(run.moving_time)}</p>
                        <p><strong><i class="bi bi-speedometer2 text-danger"></i> é…é€Ÿ:</strong> ${paceFormatter(run.average_speed)} /km</p>
                    </div>
                    <div class="col-md-6">
                        <h4><i class="bi bi-graph-up"></i> æ›´å¤šæ•°æ®</h4>
                        <hr>
                        <p><strong><i class="bi bi-heart-pulse-fill text-danger"></i> å¹³å‡å¿ƒç‡:</strong> ${run.average_heartrate || '-'} bpm</p>
                        <p><strong><i class="bi bi-mountain text-success"></i> ç´¯è®¡çˆ¬å‡:</strong> ${Math.round(run.total_elevation_gain || 0)} ç±³</p>
                        <p><strong><i class="bi bi-activity"></i> è·‘æ­¥ç±»å‹:</strong> ${typeFormatter(run.type)}</p>
                    </div>
                </div>
                <div class="mt-3 bg-light p-3 rounded">
                    <h6><i class="bi bi-map"></i> è·‘æ­¥åœ°å›¾ (å ä½)</h6>
                    <p class="text-muted small">æ­¤å¤„æœªæ¥å¯é›†æˆåœ°å›¾æœåŠ¡æ¥æ˜¾ç¤ºè·‘æ­¥è½¨è¿¹ã€‚</p>
                </div>
            `;
            $('#modalBodyContent').html(modalBody);
            $('#runDetailModal').modal('show');
        }
    </script>
</body>
</html>
