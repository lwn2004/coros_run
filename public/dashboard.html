<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>我的跑步仪表盘 🏃‍♂️</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.24.2/bootstrap-table.min.css">
    <style>
        body { background-color: #f4f7f6; }
        .stat-card {
            border: none; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            width: 100%; /* 确保卡片充满轮播项 */
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); }
        .stat-card .card-body { display: flex; align-items: center; }
        .stat-card .icon { font-size: 2.5rem; padding: 15px; border-radius: 50%; margin-right: 20px; color: white; }
        h1, h2, h3 { font-weight: 600; }
        .carousel-container {
            position: relative;
        }
        .chart-container { height: 300px; }
        @media (min-width: 768px) {
            #statsCarousel .carousel-inner, #chartsCarousel .carousel-inner {
                display: flex;
            }
            #statsCarousel .carousel-item, #chartsCarousel .carousel-item {
                display: block;
                margin-right: 1.5rem; /* g-4 in bootstrap */
            }
            #statsCarousel .carousel-item:last-child, #chartsCarousel .carousel-item:last-child {
                margin-right: 0;
            }
            .carousel-control-prev, .carousel-control-next, .carousel-indicators {
                display: none !important;
            }
        }
        @media (max-width: 767.98px) {
            #statsCarousel, #chartsCarousel {
                margin-left: -0.75rem; /* 抵消 container-fluid 的 p-3 */
                margin-right: -0.75rem;
            }
            .carousel-item {
                padding: 0 0.5rem; /* 给卡片之间留出一点空隙 */
            }
            .carousel-indicators [data-bs-target] {
                background-color: #0d6efd;
            }
        #filter-buttons .btn {
            margin-bottom: 0.5rem; /* 在移动端换行时提供间距 */
        }
    </style>
</head>
<body>
    <div class="container-fluid p-3 p-md-4">
        <div class="d-flex align-items-center mb-4">
            <h1 class="mb-0">跑步仪表盘</h1>
            <i class="bi bi-person-running h1 ms-3 text-primary"></i>
        </div>
        <div id="statsCarousel" class="carousel slide d-md-flex mb-4" data-bs-ride="false">
            <div class="carousel-inner" id="summary-stats-container">
            </div>
        </div>
        <div id="chartsCarousel" class="carousel slide d-md-block mb-4" data-bs-ride="false">
            <div class="carousel-indicators">
                <button type="button" data-bs-target="#chartsCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                <button type="button" data-bs-target="#chartsCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
            </div>
            <div class="carousel-inner" id="charts-container">
                <div class="carousel-item active">
                    <div class="card stat-card">
                        <div class="card-body chart-container" style="display:block;">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="carousel-item">
                     <div class="card stat-card">
                        <div class="card-body chart-container" style="display:block;">
                            <canvas id="paceTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card stat-card">
             <div class="card-body" style="display: block;">
                <h3 class="card-title mb-3">详细记录</h3>
                <div id="filter-buttons" class="btn-toolbar mb-3" role="toolbar">
                    <div class="btn-group flex-wrap" role="group">
                        <button type="button" class="btn btn-primary active" data-filter="all">
                            <i class="bi bi-list-ul me-1"></i> 全部记录
                        </button>
                        <button type="button" class="btn btn-outline-primary" data-filter="race">
                            <i class="bi bi-trophy me-1"></i> 比赛
                        </button>
                        <button type="button" class="btn btn-outline-primary" data-filter="hm">
                            <i class="bi bi-signpost-split me-1"></i> > 半马
                        </button>
                        <button type="button" class="btn btn-outline-primary" data-filter="pb">
                            <i class="bi bi-award me-1"></i> 个人最佳
                        </button>
                        <button type="button" class="btn btn-outline-primary" data-filter="this-month">
                            <i class="bi bi-calendar-month me-1"></i> 本月
                        </button>
                        <button type="button" class="btn btn-outline-primary" data-filter="on-this-day">
                            <i class="bi bi-clock-history me-1"></i> 历史上的今天
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table id="runTable"></table>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="runDetailModal" tabindex="-1" aria-labelledby="runDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="runDetailModalLabel">跑步详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBodyContent">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>	
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.24.2/bootstrap-table.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/locale/zh-cn.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script>
        moment.locale('zh-cn');
        function paceFormatter(value) {
            if (!value || value <= 0) return '-';
            const paceSeconds = 1000 / value;
            const minutes = Math.floor(paceSeconds / 60);
            const seconds = String(Math.round(paceSeconds % 60)).padStart(2, '0');
            return `${minutes}'${seconds}"`;
        }
        function durationFormatter(value) {
            if (!value) return '-';
            const duration = moment.duration(value, 'seconds');
            const hours = Math.floor(duration.asHours());
            const minutes = duration.minutes();
            const seconds = duration.seconds();
            return `${hours > 0 ? hours + ':' : ''}${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        function dateFormatter(value) {
            if (!value) return '-';
            return moment(value).format('YYYY-MM-DD');
        }
        function distanceFormatter(value) {
            if (!value || value <= 0) return '-';
            return (value / 1000).toFixed(2);
        }
        function elevationFormatter(value) {
            if (!value || value < 0) return '-';
            return `<i class="bi bi-mountain me-1 text-success"></i>${Math.round(value)}m`;
        }
        function typeFormatter(value) {
            const icons = {
                'Race': '<i class="bi bi-trophy-fill text-warning me-2"></i>比赛',
                'Long Run': '<i class="bi bi-sign-turn-right-fill text-info me-2"></i>长距离',
                'Easy Run': '<i class="bi bi-wind text-success me-2"></i>轻松跑',
                'Interval': '<i class="bi bi-hourglass-split text-danger me-2"></i>间歇跑',
                'Workout': '<i class="bi bi-lightning-fill text-primary me-2"></i>训练',
                'default': '<i class="bi bi-activity me-2"></i>跑步'
            };
            return icons[value] || icons['default'];
        }
        function nameFormatter(value, row) {
            let pbBadge = '';
            if (row.is_pb_5k || row.is_pb_10k || row.is_pb_hm || row.is_pb_m) {
                pbBadge = '<span class="pb-badge ms-2" title="个人最佳纪录!">🏅</span>';
            }
            return `<strong>${value || '未命名跑步'}</strong>${pbBadge}`;
        }
        // 新增/修改: 创建一个全局变量来存储所有跑步数据
        let allRunsData = [];
        $(document).ready(function() {
            fetch('data/all.json')
                .then(response => response.json())
                .then(data => {
                    // 将获取的数据存储到全局变量中
                    allRunsData = data;
                    // 页面加载时，使用完整数据初始化所有组件
                    updateSummaryCarousel(allRunsData);
                    renderAllCharts(allRunsData);
                    initializeRunTable(allRunsData);
                })
                .catch(error => {
				    console.error('加载跑步数据失败:', error);
                    $('#summary-stats').html('<div class="col"><p class="text-danger">无法加载数据，请检查all.json文件是否存在或格式是否正确。</p></div>');
				});
            $('#filter-buttons').on('click', '.btn', function() {
                // 设置按钮的激活状态
                $(this).addClass('active').siblings().removeClass('active');
                $(this).removeClass('btn-outline-primary').addClass('btn-primary')
                    .siblings().removeClass('btn-primary').addClass('btn-outline-primary');
                const filterType = $(this).data('filter');
                applyTableFilter(filterType);
            });
		});
        function updateSummaryCarousel(data) {
            if (!data || data.length === 0) return;
            const totalRuns = data.length;
            const totalDistance = data.reduce((sum, run) => sum + run.distance, 0);
            const totalDuration = data.reduce((sum, run) => sum + moment.duration(run.moving_time, 'seconds'), 0);
            const totalElevation = data.reduce((sum, run) => sum + run.total_elevation_gain, 0);
            const avgPaceSeconds = totalDuration / (totalDistance / 1000);
            const stats = [
                {
                    label: '总里程',
                    value: `${(totalDistance / 1000).toFixed(2)} km`,
                    icon: 'bi-sign-merge-right-fill',
                    color: '#0d6efd'
                },
                {
                    label: '总次数',
                    value: `${totalRuns} 次`,
                    icon: 'bi-calendar-check-fill',
                    color: '#198754'
                },
                {
                    label: '总时长',
                    value: durationFormatter(totalDuration),
                    icon: 'bi-hourglass-top',
                    color: '#ffc107'
                },
                {
                    label: '平均配速',
                    value: `${paceFormatter(1000/avgPaceSeconds)} /km`,
                    icon: 'bi-speedometer2',
                    color: '#dc3545'
                },/*
                {
                    label: '总爬升',
                    value: `${Math.round(totalElevation)} 米`,
                    icon: 'bi-mountain',
                    color: '#6f42c1'
                }*/
            ];
            let cardsHtml = '';
            stats.forEach((stat, index) => {
                // 第一个item需要加 'active' 类
                const activeClass = index === 0 ? 'active' : '';
                cardsHtml += `
                    <div class="carousel-item ${activeClass} col-md">
                        <div class="card stat-card">
                            <div class="card-body">
                                <div class="icon" style="background-color: ${stat.color};"><i class="bi ${stat.icon}"></i></div>
                                <div>
                                    <h6 class="card-subtitle mb-2 text-muted">${stat.label}</h6>
                                    <h3 class="card-title">${stat.value}</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            $('#summary-stats-container').html(cardsHtml);
        }
        // 新增/修改: 渲染所有图表的函数
        function renderAllCharts(data) {
            renderMonthlyChart(data);
            renderPaceTrendChart(data); // 新增的图表
        }
        function renderMonthlyChart(data) {
            const monthlyData = {};
            data.forEach(run => {
                const month = moment(run.start_date_local).format('YYYY-MM');
                if (!monthlyData[month]) monthlyData[month] = 0;
                monthlyData[month] += run.distance / 1000;
            });
            const sortedMonths = Object.keys(monthlyData).sort().slice(-12);
            const chartLabels = sortedMonths.map(m => moment(m).format('MMM'));
            const chartData = sortedMonths.map(m => monthlyData[m].toFixed(2));
            new Chart($('#monthlyChart'), {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: '月度跑量 (km)',
                        data: chartData,
                        backgroundColor: 'rgba(13, 110, 253, 0.6)'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { title: { display: true, text: '最近12个月跑量统计' } }
                }
            });
        }
        // 新增: 渲染配速趋势图表
        function renderPaceTrendChart(data) {
            const monthlyAvgPace = {};
            const monthlyRunCounts = {};
            data.forEach(run => {
                const month = moment(run.start_date_local).format('YYYY-MM');
                if(!monthlyAvgPace[month]) {
                    monthlyAvgPace[month] = 0;
                    monthlyRunCounts[month] = 0;
                }
                // 累加每次跑步的配速（秒/公里）
                monthlyAvgPace[month] += 1000 / run.average_speed;
                monthlyRunCounts[month]++;
            });
            const sortedMonths = Object.keys(monthlyAvgPace).sort().slice(-12);
            const chartLabels = sortedMonths.map(m => moment(m).format('MMM'));
            const chartData = sortedMonths.map(m => {
                // 计算月平均配速
                const avgPaceInSeconds = monthlyAvgPace[m] / monthlyRunCounts[m];
                return avgPaceInSeconds;
            });
            new Chart($('#paceTrendChart'), {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: '月平均配速',
                        data: chartData,
                        borderColor: 'rgba(220, 53, 69, 0.8)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: '月平均配速趋势' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const paceSeconds = context.raw;
                                    const minutes = Math.floor(paceSeconds / 60);
                                    const seconds = String(Math.round(paceSeconds % 60)).padStart(2, '0');
                                    return `配速: ${minutes}'${seconds}" /km`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value, index, values) {
                                    // 自定义Y轴标签，显示为 M'SS" 格式
                                    const minutes = Math.floor(value / 60);
                                    const seconds = String(Math.round(value % 60)).padStart(2, '0');
                                    return `${minutes}'${seconds}"`;
                                }
                            }
                        }
                    }
                }
            });
        }
        function initializeRunTable(data) {
            $('#runTable').bootstrapTable({
                data: data,
                classes: 'table table-hover table-striped',
                search: true,
                pagination: true,
                pageSize: 10,
                pageList: [10, 25, 50, 'all'],
                sortName: 'start_date_local',
                sortOrder: 'desc',
                // 新增/修改: 启用此选项来更好地处理移动端分页栏
                smartDisplay: true, 
                columns: [{
                    field: 'name',
                    title: '跑步名称',
                    formatter: nameFormatter,
                    sortable: true,
                    class: 'd-none d-md-table-cell'					
                }, {
                    field: 'start_date_local',
                    title: '日期',
                    formatter: dateFormatter,
                    sortable: true
                }, {
                    field: 'distance',
                    title: '距离(km)',
                    formatter: distanceFormatter,
                    sortable: true
                }, {
                    field: 'average_speed',
                    title: '配速',
                    formatter: paceFormatter,
                    sortable: true
                }, {
                    field: 'moving_time',
                    title: '时长',
                    formatter: durationFormatter,
                    sortable: true,
                    // 新增/修改: 使用Bootstrap的响应式显示类
                    // d-none: 默认隐藏
                    // d-md-table-cell: 在中等屏幕(>=768px)及以上尺寸，以表格单元格形式显示
                    class: 'd-none d-md-table-cell'
                }, {
                    field: 'average_heartrate',
                    title: '<i class="bi bi-heart-pulse-fill text-danger"></i>',
                    sortable: true,
                    //class: 'd-none d-md-table-cell'
                }, {
                    field: 'total_elevation_gain',
                    title: '爬升',
                    formatter: elevationFormatter,
                    sortable: true,
                    // 新增/修改: 在大屏幕(>=992px)及以上才显示
                    class: 'd-none d-lg-table-cell'
                }, {
                    field: 'type',
                    title: '类型',
                    formatter: typeFormatter,
                    sortable: true,
                    class: 'd-none d-lg-table-cell'
                }],
                onClickRow: function (row, $element) {
                    showRunDetails(row);
                }
            });
		}
        // 显示跑步详情模态框
        function showRunDetails(run) {
            $('#runDetailModalLabel').text(run.name || '跑步详情');
            const modalBody = `
                <div class="row">
                    <div class="col-md-6">
                        <h4><i class="bi bi-calendar3"></i> ${moment(run.start_date_local).format('YYYY年M月D日 dddd HH:mm')}</h4>
                        <hr>
                        <p><strong><i class="bi bi-sign-merge-right-fill text-primary"></i> 距离:</strong> ${distanceFormatter(run.distance)} km</p>
                        <p><strong><i class="bi bi-hourglass-split text-warning"></i> 时长:</strong> ${durationFormatter(run.moving_time)}</p>
                        <p><strong><i class="bi bi-speedometer2 text-danger"></i> 配速:</strong> ${paceFormatter(run.average_speed)} /km</p>
                    </div>
                    <div class="col-md-6">
                        <h4><i class="bi bi-graph-up"></i> 更多数据</h4>
                        <hr>
                        <p><strong><i class="bi bi-heart-pulse-fill text-danger"></i> 平均心率:</strong> ${run.average_heartrate || '-'} bpm</p>
                        <p><strong><i class="bi bi-mountain text-success"></i> 累计爬升:</strong> ${Math.round(run.total_elevation_gain || 0)} 米</p>
                        <p><strong><i class="bi bi-activity"></i> 跑步类型:</strong> ${typeFormatter(run.type)}</p>
                    </div>
                </div>
                <div class="mt-3 bg-light p-3 rounded">
                    <h6><i class="bi bi-map"></i> 跑步地图 (占位)</h6>
                    <p class="text-muted small">此处未来可集成地图服务来显示跑步轨迹。</p>
                </div>
            `;
            $('#modalBodyContent').html(modalBody);
            $('#runDetailModal').modal('show');
        }        
        // 新增/修改: 应用表格筛选的核心函数
        function applyTableFilter(filterType) {
            let filteredData = [];
            switch (filterType) {
                case 'race':
                    filteredData = allRunsData.filter(run => run.type === 'Race');
                    break;
                case 'hm':
                    // 筛选距离在21km到42km之间的记录，以包含GPS误差
                    filteredData = allRunsData.filter(run => run.distance >= 21000 && run.distance < 42000);
                    break;
                case 'pb':
                    // 筛选任何一项PB为true的记录
                    filteredData = allRunsData.filter(run => run.is_pb_5k || run.is_pb_10k || run.is_pb_hm || run.is_pb_m);
                    break;
                case 'this-month':
                    const startOfMonth = moment().startOf('month');
                    const endOfMonth = moment().endOf('month');
                    filteredData = allRunsData.filter(run => {
                        return moment(run.start_date_local).isBetween(startOfMonth, endOfMonth);
                    });
                    break;
                case 'on-this-day':
                    const today = moment();
                    const month = today.month(); // 0-11
                    const day = today.date();
                    filteredData = allRunsData.filter(run => {
                        const runDate = moment(run.start_date_local);
                        // 比较月和日，忽略年份
                        return runDate.month() === month && runDate.date() === day;
                    });
                    break;
                case 'all':
                default:
                    filteredData = allRunsData; // 恢复显示全部数据
                    break;
            }
            // 使用筛选后的数据重新加载表格
            $('#runTable').bootstrapTable('load', filteredData);
        }        
    </script>
</body>
</html>
